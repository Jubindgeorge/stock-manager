<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stock Manager</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<!-- ‚òÅÔ∏è CLOUD SYNC ADDITION -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --sidebar-w: 260px;
  --muted: #6b6f76;
  --accent: #2c3e50;
  --accent-2: #2980b9;
  --danger: #c0392b;
  --badge-green: #2ecc71;
}

/* Reset & base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, system-ui, Arial, sans-serif;
  color: #111;
  background: transparent;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-position: center center;
  background-repeat: no-repeat;
  background-size: 750px auto;
  background-attachment: fixed;
  opacity: 1;
  z-index: -1;
  pointer-events: none;
}

/* App layout */
.app {
  display: none; /* shown after login / restore */
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: var(--sidebar-w);
  position: fixed;
  left: 0;
  top: 0;
  height: 100%;
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(5px);
  padding: 8px;
  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.08);
  overflow: auto;
  z-index: 20;
  border-right: 1px solid rgba(0, 0, 0, 0.04);
  border-radius: 0 10px 10px 0;
}

.sidebar.minimized {
  width: 60px;
  overflow: hidden;
  padding: 8px 4px;
  border-radius: 0 10px 10px 0;
  transition: width 0.3s ease;
}

.sidebar.minimized .sidebar-header div,
.sidebar.minimized .brand-title,
.sidebar.minimized .brand-sub,
.sidebar.minimized .sidebar-logo,
.sidebar.minimized .sidebar-menu,
.sidebar.minimized .sidebar-menu li span,
.sidebar.minimized .sidebar-footer {
  display: none;
}

.sidebar.minimized .sidebar-logo {
  width: 40px;
  height: 40px;
}

.sidebar-header {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 8px;
}

.sidebar-logo {
  width: 96px;
  height: 56px;
  object-fit: cover;
  border-radius: 8px;
}

.brand-title {
  font-size: 18px;
  margin: 0;
}

.brand-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

.sidebar-menu {
  list-style: none;
  padding: 0;
  margin: 12px 0 0;
}

.sidebar-menu li {
  padding: 12px 10px;
  display: flex;
  gap: 10px;
  align-items: center;
  cursor: pointer;
  border-left: 4px solid transparent;
  border-radius: 6px;
  transition: all 0.18s;
  color: #222;
}

.sidebar-menu li:hover {
  background: rgba(60, 120, 200, 0.06);
  transform: translateX(4px);
  border-left-color: rgba(41, 128, 185, 0.8);
}

.sidebar-menu li.active {
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: #fff;
  border-left-color: #fff;
  font-weight: 700;
}

.sidebar.minimized + .main { margin-left: 60px; }

.menu-title {
  font-weight: 700;
  background: rgba(0, 0, 0, 0.05);
}

.modal-box{
  background-color:white; 
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.08);
}  

.menu-title.collapsible {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.menu-title span.arrow {
  display: inline-block;
  font-size: 12px;
  transition: transform 0.2s ease;
}

.menu-title.open .arrow { transform: rotate(180deg); }

.submenu { padding-left: 36px !important; font-size: 14px; }

.subgroup {
  list-style: none;
  padding: 0;
  margin: 0;
  display: none;
}

.subgroup.open { display: block; }

.sidebar-footer {
  margin-top: 18px;
  font-size: 13px;
  color: var(--muted);
}

.admin-only { display: none; }

/* Main content */
.main {
  margin-left: calc(var(--sidebar-w) + 18px);
  width: 70%;
  padding: 18px;
  min-height: 100vh;
  background: transparent;
  transition: margin-left 0.3s ease;
}

.main.sidebar-minimized { margin-left: 60px; }

.top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.search {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.08);
  width: 320px;
  background: rgba(255, 255, 255, 0.55);
}

.small {
  padding: 8px 10px;
  border-radius: 8px;
  border: 2px solid rgba(0, 0, 0, 0.08);
  width: 220px;
  background: rgba(255, 255, 255, 0.66);
}

.btn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}

.btn.secondary { background: var(--accent-2); }
.btn.out { background: #dc2626; }
.btn.info { background: #16a34a; }

/* Pages & tables */
.page {
  background: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(5px);
  border-radius: 12px;
  width: 100%;
  min-height: calc(100vh - 40px);
  padding: 25px;
  border: 1px solid rgba(0, 0, 0, 0.05);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 10px;
  text-align: left;
}

th {
  background: #007bff;
  font-weight: 700;
  color: #fff;
}

.low-stock { color: var(--danger); font-weight: 700; }
.balance-qty { font-weight: bold; }

/* Modals */
.modal-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal {
  background: white;
  padding: 20px;
  border-radius: 12px;
  max-height: 80%;
  overflow-y: auto;
  width: 700px;
  max-width: 92vw;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.modal-close {
  cursor: pointer;
  background: none;
  border: none;
  font-size: 18px;
}

.modal-table {
  width: 100%;
  border-collapse: collapse;
}

.modal-table th,
.modal-table td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

/* Print styling */
@media print {
  body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  .print-bg {
    background-image: url('banner.png') !important;
    background-size: cover !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
  }
}

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #16a34a;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-weight: bold;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.toast.out { background-color: #dc2626; }

.dashboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  margin-top:15px;
}
.dash-card{
  background:#fff;
  border-radius:8px;
  padding:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  text-align:center;
}
.dash-card h3{ font-size:14px; color:#555; }
.dash-card div{ font-size:28px; font-weight:700; margin-top:6px; }

.fg-chart-box {
  height: 260px;
  max-height: 260px;
  overflow: hidden;
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="position:fixed; inset:0; background:#f3f4f6;
display:flex; align-items:center; justify-content:center; z-index:99999;">
  <div style="width:350px; background:white; padding:25px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15)">
    <h2 style="text-align:center">Stock Manager</h2>

    <div id="loginForm">
      <input id="loginUser" placeholder="Username" style="width:100%;padding:8px 10px;margin:10px 0;border: 1px solid rgba(0, 0, 0, 0.08);">
      <input id="loginPass" type="password" placeholder="Password" style="width:100%;padding:8px 10px;margin:10px 0;border: 1px solid rgba(0, 0, 0, 0.08);">
      <button class="btn" style="width:100%;" onclick="login()">Login</button>

      <p style="text-align:center;margin:10px 0;">Don't have an account?
        <span style="color:blue;cursor:pointer;" onclick="showSignup()">Sign Up</span>
      </p>

      <p style="text-align:center;margin:10px 0;">
        <span style="color:blue;cursor:pointer;" onclick="forgotPassword()">Forgot Password?</span>
      </p>

      <p id="loginMsg" style="color:red;text-align:center;margin-top:10px"></p>
    </div>

    <div id="signupForm" style="display:none">
      <input id="signupUser" placeholder="Username" style="width:90%;padding:10px;margin:10px 0">
      <input id="signupPass" type="password" placeholder="Password" style="width:90%;padding:10px;margin-bottom:10px">
      <select id="signupRole" style="width:100%;padding:10px;margin-bottom:10px">
        <option value="user">User</option>
      </select>
      <button class="btn" style="width:98%" onclick="signup()">Create Account</button>
      <p style="text-align:center;margin:10px 0;">Already have an account?
        <span style="color:blue;cursor:pointer;" onclick="showLogin()">Login</span>
      </p>
      <p id="signupMsg" style="color:red;text-align:center;margin-top:10px"></p>
    </div>
  </div>
</div>

<div class="app">
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img id="brandBanner" src="banner.png" class="sidebar-logo" onerror="this.style.display='none'">
      <div>
        <div class="brand-title">STOCK</div>
        <div class="brand-sub">Inventory ‚Ä¢ Public Sheet</div>
      </div>
      <button id="sidebarToggle" class="btn secondary" style="margin-left:auto;padding:4px 6px;font-size:14px">‚Üê</button>
    </div>

    <ul class="sidebar-menu" id="menu">

      <li id="usersMenu" class="menu-title collapsible admin-only">
        üë• Users <span class="arrow">‚ñæ</span>
      </li>
      <ul class="subgroup admin-only">
        <li class="submenu" data-page="userManagement">Manage Users</li>
      </ul>

      <li class="menu-title collapsible">üìä Dashboard <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="dashboardPage">üìä Dashboard</li>
      </ul>

      <li class="menu-title collapsible">üìä Bill Of Materials <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="dashboard">üìä BOM</li>
      </ul>

      <li class="menu-title collapsible">üìà Store <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="products">üì¶ RM List</li>
        <li class="submenu admin-only" data-page="rmAddProduct">‚ûï Add RM Product</li>
        <li class="submenu" data-page="stockIn">‚¨Ü RM Stock In</li>
        <li class="submenu" data-page="stockOut">‚¨á RM Stock Out</li>
      </ul>

      <li class="menu-title collapsible">üßæ FG <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="fgStock">üì¶ FG Stock List</li>
        <li class="submenu admin-only" data-page="fgAddProduct">‚ûï Add FG Product</li>
        <li class="submenu" data-page="fgStockIn">‚¨Ü FG Stock In</li>
        <li class="submenu" data-page="fgStockOut">‚¨á FG Stock Out</li>
      </ul>

      <li class="menu-title collapsible">üßæ Suppliers <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="suppliers">üìã Manage Raw Suppliers</li>
      </ul>

      <li class="menu-title collapsible">üíæ Report <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="history">üìö RM History</li>
        <li class="submenu" data-action="importExcel">üì• Import Excel</li>
        <li class="submenu" data-action="exportExcel">üì§ Export Excel</li>
        <li class="submenu" data-action="printStockReport">üñ®Ô∏è Print RM Stock Report</li>
        <li class="submenu" data-action="printFGStockReport">üñ®Ô∏è Print FG Stock Report</li>
        <li class="submenu" data-action="exportPDF">üìÑ Export PDF</li>
      </ul>

      <div class="sidebar-footer">Data stored locally; cloud optional.</div>
    </ul>
  </aside>

  <main class="main">
    <button onclick="logout()" class="btn out" style="position:fixed;top:10px;right:20px;z-index:999">Logout</button>

    <!-- USER MANAGEMENT -->
    <section id="userManagement" class="page" style="display:none">
      <h2>Manage Users</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Username</th>
            <th>Role/Permission</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px;">
        <input id="newUsername" placeholder="Username">
        <input id="newPassword" type="password" placeholder="Password">
        <select id="newRole">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn admin-only" onclick="addUser()">Add User</button>
      </div>
    </section>

    <!-- BOM / DASH TABLE -->
    <section id="dashboard" class="page" style="display:block">
      <h2>Bill Of Materials</h2>

      <div class="top">
        <div class="dash-search">
          <input type="text" id="dashboardSearch" class="search" placeholder="Search product / group..."
            oninput="handleDashboardSearch(this.value)">
          <button class="btn secondary" onclick="clearDashboardSearch()">Clear</button>
        </div>
      </div>

      <div style="overflow:auto">
        <table id="dashTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Balance</th>
              <th>Threshold</th>
              <th>Last IN</th>
              <th>Last OUT</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MAIN DASHBOARD -->
    <section id="dashboardPage" class="page" style="display:none">
      <h2>Dashboard</h2>

      <div class="dashboard-grid">
        <div class="dash-card">
          <h3>Total RM Products</h3>
          <div id="dashTotalProducts">0</div>
        </div>

        <div class="dash-card">
          <h3>Total RM Stock</h3>
          <div id="dashTotalStock">0</div>
        </div>

        <div class="dash-card">
          <h3>Low Stock Items</h3>
          <div id="dashLowStock">0</div>
        </div>

        <div class="dash-card" onclick="openFGFromDashboard()" style="cursor:pointer">
          <h3>Total FG Balance</h3>
          <div id="dashFGBalance">0</div>
        </div>

        <div class="dash-card" onclick="openFGFromDashboard()" style="cursor:pointer">
          <h3>FG Products</h3>
          <div id="dashFGTotalProducts">0</div>
        </div>

        <div class="dash-card" onclick="openLowFGFromDashboard()" style="cursor:pointer">
          <h3>Low FG Stock</h3>
          <div id="dashFGLowStock">0</div>
        </div>

        <div class="dash-card">
          <h3>Max FG Balance</h3>
          <div id="dashFGMaxBalance">-</div>
        </div>

        <div class="dash-card">
          <h3>Min FG Balance</h3>
          <div id="dashFGMinBalance">-</div>
        </div>
      </div>

      <div id="fgVolumeFilter" style="display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;font-size:14px"></div>

      <div class="fg-chart-box">
        <canvas id="fgStockChart"></canvas>
      </div>
    </section>

    <!-- FG STOCK LIST -->
    <section id="fgStock" class="page" style="display:none">
      <h2>Finished Goods Stock</h2>
      <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
        <input id="fgSearch" class="search" placeholder="Search FG products...">
      </div>
      <div style="overflow:auto; height: calc(100% - 140px);">
        <table id="fgTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Volume</th>
              <th>Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PRODUCTS (RM) -->
    <section id="products" class="page" style="display:none">
      <h2>Raw Material List</h2>

      <div style="margin-bottom:12px">
        <input id="productSearch" class="search" placeholder="Search products...">
      </div>

      <div style="overflow:auto;height:calc(100% - 120px)">
        <table id="productsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Code</th>
              <th>Name</th>
              <th>Category</th>
              <th>Balance</th>
              <th>Threshold</th>
              <th>Barcode</th>
              <th>History</th>
              <th>Edit</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADD RM PRODUCT -->
    <section id="rmAddProduct" class="page" style="display:none">
      <h2>Add Raw Material Product</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px">
        <input id="newCode" class="small" placeholder="Product Code">
        <input id="newName" class="small" placeholder="Product Name">
        <input id="newCategory" class="small" placeholder="Category">
        <input id="newThreshold" class="small" type="number" placeholder="Low Stock Threshold">
        <input id="newBarcode" class="small" placeholder="Barcode">
        <input id="newGroups" class="small" placeholder="Groups (comma separated)">
        <label style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="newExclusive"> Exclusive to first group
        </label>
      </div>

      <button class="btn btn-add" onclick="addRMProduct()">Add Product</button>
    </section>

    <!-- STOCK IN -->
    <section id="stockIn" class="page" style="display:none">
      <h2>RM Stock In</h2>
      <input id="inSearch" class="search" placeholder="Search product">
      <button class="btn secondary" onclick="stockInHistoryModal()">View Stock IN History</button>
      <table id="stockInBody">
        <thead><tr><th>Product</th><th>Balance</th><th>Last IN</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- STOCK OUT -->
    <section id="stockOut" class="page" style="display:none">
      <h2>RM Stock Out</h2>
      <input id="outSearch" class="search" placeholder="Search product">
      <button class="btn info" onclick="stockOutHistoryModal()">View Stock OUT History</button>
      <table id="stockOutBody">
        <thead><tr><th>Product</th><th>Balance</th><th>Last OUT</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- COMBINED HISTORY -->
    <section id="history" class="page" style="display:none">
      <h2>RM Combined History</h2>
      <div style="margin-bottom:12px">
        <input id="historySearch" class="search" placeholder="Search combined history...">
      </div>
      <div style="overflow:auto; height: calc(100% - 120px);">
        <table id="historyTable">
          <thead>
            <tr><th>Date</th><th>Product</th><th>Type</th><th>Qty</th><th>Remark</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SUPPLIERS -->
    <section id="suppliers" class="page" style="display:none">
      <h2>Raw Material Suppliers</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <input id="newSupplierName" class="small" placeholder="Supplier Name">
        <input id="newSupplierContact" class="small" placeholder="Contact Info">
        <button id="addSupplierBtn" class="btn btn-add">Add Supplier</button>
      </div>
      <div style="margin-bottom:12px">
        <input id="supplierSearch" class="search" placeholder="Search suppliers...">
      </div>
      <div style="overflow:auto; height: calc(100% - 150px);">
        <table id="suppliersTable">
          <thead><tr><th>#</th><th>Name</th><th>Contact</th><th>Edit</th><th>Delete</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MODALS -->
    <div id="historyModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modalTitle">Product History</h3>
          <button onclick="closeHistoryModal()" class="modal-close">‚úñ</button>
        </div>
        <div class="modal-body">
          <table class="modal-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Product</th>
                <th>Type</th>
                <th>Qty</th>
                <th>Batch</th>
                <th>Expiry</th>
                <th>Remark</th>
              </tr>
            </thead>
            <tbody id="modalHistoryBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="stockInHistoryModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Stock IN History</h3>
          <button onclick="closeStockInHistory()" class="modal-close">‚úñ</button>
        </div>
        <div class="modal-body">
          <table class="modal-table">
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Remark</th></tr></thead>
            <tbody id="stockInHistoryPopupBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="stockOutHistoryModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Stock OUT History</h3>
          <button onclick="closeStockOutHistory()" class="modal-close">‚úñ</button>
        </div>
        <div class="modal-body">
          <table class="modal-table">
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Remark</th></tr></thead>
            <tbody id="stockOutHistoryPopupBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Stock Modal (RM + FG) -->
    <div id="stockModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modalProductName">Product Name</h3>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <p>Balance: <span id="modalProductBalance" style="font-weight:bold;">0</span> PCS</p>

        <div class="modal-inputs" style="padding:10px;">
          <input id="modalQty" class="small" type="number" placeholder="Enter quantity">
          <input id="modalRemark" class="small" placeholder="Enter remark (optional)">
        </div>

        <div style="padding:10px;" class="modal-actions">
          <button id="modalSave" class="btn">Submit</button>
          <button onclick="closeModal()" class="btn secondary">Close</button>
        </div>
      </div>
    </div>

    <!-- Success Toast -->
    <div id="stockToast" class="toast" style="display:none;"></div>

    <!-- FG STOCK IN -->
    <section id="fgStockIn" class="page" style="display:none">
      <h2>FG Stock In</h2>
      <input id="fgInSearch" class="search" placeholder="Search FG product...">
      <button class="btn secondary" onclick="fgStockInHistoryModal()">View FG IN History</button>

      <table>
        <thead>
          <tr><th>#</th><th>Product</th><th>Balance</th><th>Action</th></tr>
        </thead>
        <tbody id="fgStockInBody"></tbody>
      </table>
    </section>

    <!-- FG STOCK OUT -->
    <section id="fgStockOut" class="page" style="display:none">
      <h2>FG Stock Out</h2>
      <input id="fgOutSearch" class="search" placeholder="Search FG product...">
      <button class="btn info" onclick="fgStockOutHistoryModal()">View FG OUT History</button>

      <table>
        <thead>
          <tr><th>#</th><th>Product</th><th>Balance</th><th>Action</th></tr>
        </thead>
        <tbody id="fgStockOutBody"></tbody>
      </table>
    </section>

    <!-- ADD FG PRODUCT -->
    <section id="fgAddProduct" class="page" style="display:none">
      <h2>Add Finished Goods Product</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px">
        <input id="fgNewName" class="small" placeholder="Product Name">
        <input id="fgNewVolume" class="small" placeholder="Volume / Size">
        <input id="fgNewGroup" class="small" placeholder="Group Prefix (ALKHOR)">
        <input id="fgNewBatch" class="small" placeholder="Batch / Lot No">
        <input id="fgNewExpiry" class="small" type="date">
        <input id="fgNewThreshold" class="small" type="number" placeholder="Low Stock Threshold">
      </div>

      <button class="btn btn-add" onclick="addFGProduct()">Add FG Product</button>
      <hr style="margin:20px 0">
    </section>

  </main>
</div>

<script>
/* =========================
   ‚úÖ GLOBALS
========================= */
let selectedFGVolumes = new Set();
let currentUser = null;
let fgChartInstance = null;

const loginScreen = document.getElementById('loginScreen');
const loginForm   = document.getElementById('loginForm');
const signupForm  = document.getElementById('signupForm');
const loginMsg    = document.getElementById('loginMsg');
const signupMsg   = document.getElementById('signupMsg');

/* =========================
   ‚úÖ FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBTtsOeQTpPwTEn_T9EDqt5i_0eyQuzGOA",
  authDomain: "stock-manager-703e6.firebaseapp.com",
  databaseURL: "https://stock-manager-703e6-default-rtdb.firebaseio.com",
  projectId: "stock-manager-703e6",
  storageBucket: "stock-manager-703e6.firebasestorage.app",
  messagingSenderId: "778548519096",
  appId: "1:778548519096:web:716f903fee993f4d85544d",
  measurementId: "G-G735N8XCQ2"
};

firebase.initializeApp(firebaseConfig);
const cloudDB = firebase.database();
window.cloudDB = cloudDB;

/* =========================
   ‚úÖ UTILITIES
========================= */
function genId(){ return 'id_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000); }
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function fmtDate(iso){
  if(!iso) return '-';
  const p = String(iso).split('-');
  if(p.length !== 3) return String(iso);
  return `${p[2]}/${p[1]}/${p[0]}`;
}
function escapeHtml(s){
  if(s == null) return '';
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
function normalizeGroup(g){
  return String(g || '').trim().toUpperCase().replace(/\s+/g,'');
}
function showToast(message, isError=false){
  const toast = document.getElementById('stockToast');
  if(!toast) return;
  toast.textContent = message;
  toast.classList.toggle('out', isError);
  toast.style.display = 'block';
  requestAnimationFrame(()=> toast.style.opacity = '1');
  setTimeout(()=>{
    toast.style.opacity = '0';
    setTimeout(()=> toast.style.display='none', 300);
  }, 2000);
}

/* =========================
   ‚úÖ OPTIONAL: FIX bannerUrl template issue
   (If you ever used src="${bannerUrl}" it won't work in HTML.)
========================= */
function setBanner(url){
  const img = document.getElementById('brandBanner');
  if(img) img.src = url || 'banner.png';
  // set background watermark
  document.body.style.setProperty('--banner-url', url || 'banner.png');
}
setBanner('banner.png');

/* =========================
   ‚úÖ PAGE NAV
========================= */
function openPage(pageId){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const el = document.getElementById(pageId);
  if(el) el.style.display='block';

  // page-specific renders
  if(pageId === 'dashboardPage'){
    renderMainDashboard();
    renderFGVolumeFilter();
    renderFGChart();
  }
  if(pageId === 'dashboard'){
    renderDashboardGrouped();
  }
  if(pageId === 'suppliers'){
    renderSuppliers();
  }

  refreshAll();
}

/* =========================
   ‚úÖ ADMIN DEFAULT USER
========================= */
const DEFAULT_ADMIN = {
  username: "admin",
  password: "admin123",
  role: "admin",
  permissionLevel: "full",
  createdAt: new Date().toISOString()
};

async function ensureAdminExists(){
  try{
    const snap = await cloudDB.ref('users').orderByChild('role').equalTo('admin').once('value');
    if(!snap.exists()){
      const userId = 'admin_' + Date.now().toString(36);
      await cloudDB.ref('users/' + userId).set(DEFAULT_ADMIN);
      console.log("‚úÖ Default admin created");
    }
  }catch(err){
    console.error("‚ùå ensureAdminExists error:", err);
  }
}
ensureAdminExists();

/* =========================
   ‚úÖ ROLE PERMISSIONS (ADMIN ALWAYS FULL POWER)
========================= */
const ROLE_PERMISSIONS = {
  full: { stockIn:true, stockOut:true,  add:true,  edit:true,  delete:true },
  half: { stockIn:true, stockOut:true, add:true,  edit:true,  delete:false },
  view: { stockIn:true, stockOut:true, add:false, edit:false, delete:false }
};

function getPerms(){
  if(currentUser?.role === 'admin') return ROLE_PERMISSIONS.full;
  return ROLE_PERMISSIONS[currentUser?.permissionLevel] || ROLE_PERMISSIONS.view;
}
function canStockOut(){ return !!getPerms().stockOut; }
function canAdd(){ return !!getPerms().add; }
function canEdit(){ return !!getPerms().edit; }
function canDelete(){ return !!getPerms().delete; }

function showAdminUI(){
  const isAdmin = currentUser?.role === 'admin';
  document.querySelectorAll('.admin-only').forEach(el=>{
    el.style.display = isAdmin ? '' : 'none';
  });
}

function applyPermissions(){
  showAdminUI();
  const p = getPerms();

  document.querySelectorAll('.btn-add').forEach(b => b.style.display = p.add ? 'inline-block' : 'none');
  document.querySelectorAll('.btn-edit').forEach(b => b.style.display = p.edit ? 'inline-block' : 'none');
  document.querySelectorAll('.btn-delete').forEach(b => b.style.display = p.delete ? 'inline-block' : 'none');
  document.querySelectorAll('.btn-stock-out').forEach(b => b.style.display = p.stockOut ? 'inline-block' : 'none');
}

/* =========================
   ‚úÖ AUTH UI
========================= */
function showSignup(){
  loginForm.style.display='none';
  signupForm.style.display='block';
  loginMsg.textContent='';
}
function showLogin(){
  loginForm.style.display='block';
  signupForm.style.display='none';
  signupMsg.textContent='';
}

async function signup(){
  const u = signupUser.value.trim();
  const p = signupPass.value;
  const role = signupRole.value;

  if(!u || !p){ signupMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(snap.exists()){ signupMsg.textContent="Username already taken"; return; }

    const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
    await cloudDB.ref('users/'+userId).set({
      username:u,
      password:p,
      role,
      permissionLevel:'view',
      createdAt:new Date().toISOString()
    });

    signupMsg.style.color="green";
    signupMsg.textContent="Account created! Please login.";
    showLogin();
  }catch(err){
    console.error(err);
    signupMsg.textContent="Signup failed";
  }
}

async function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value;

  if(!u || !p){ loginMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(!snap.exists()){ loginMsg.textContent="Invalid login"; return; }

    const userData = Object.values(snap.val())[0];
    if(userData.password !== p){ loginMsg.textContent="Invalid login"; return; }

    currentUser = userData;
    localStorage.setItem('sms_currentUser', JSON.stringify(currentUser));

    loginScreen.style.display='none';
    document.querySelector('.app').style.display='flex';

    applyPermissions();

    // ‚úÖ open pages
    if(currentUser.role === 'admin'){
      openPage('userManagement');
      renderUsersTable();
    }else{
      openPage('dashboardPage');
    }

  }catch(err){
    console.error(err);
    loginMsg.textContent="Login failed";
  }
}

function logout(){
  localStorage.removeItem('sms_currentUser');
  location.reload();
}

async function forgotPassword(){
  const username = prompt("Enter your username to reset password:");
  if(!username || !username.trim()) return;

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username.trim()).once('value');
    if(!snap.exists()){ alert("Username not found"); return; }

    const userId = Object.keys(snap.val())[0];
    const userData = snap.val()[userId];

    const newPass = prompt(`Enter new password for "${userData.username}":`);
    if(!newPass || !newPass.trim()) return alert("Password cannot be empty");

    await cloudDB.ref('users/'+userId+'/password').set(newPass.trim());
    alert("Password reset success. Login with new password.");
  }catch(err){
    console.error(err);
    alert("Failed to reset password");
  }
}

/* =========================
   ‚úÖ USER MANAGEMENT
========================= */
function changeUserPermission(username, level){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can change roles", true);
    return;
  }
  if(username === 'admin'){
    showToast("Admin permission cannot be changed", true);
    return;
  }

  cloudDB.ref('users').orderByChild('username').equalTo(username).once('value')
    .then(snap=>{
      if(!snap.exists()) return;
      const userId = Object.keys(snap.val())[0];
      cloudDB.ref('users/'+userId+'/permissionLevel').set(level);
      showToast("User permission updated ‚úÖ");
    });
}

async function deleteUser(username){
  if(!confirm(`Delete "${username}"?`)) return;

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
    if(!snap.exists()) return alert("User not found");

    const userId = Object.keys(snap.val())[0];
    const userData = snap.val()[userId];
    if(userData.role === 'admin') return alert("Cannot delete admin");

    await cloudDB.ref('users/'+userId).remove();
    showToast("User deleted ‚úÖ");
    renderUsersTable();
  }catch(err){
    console.error(err);
    alert("Failed to delete user");
  }
}

async function renderUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  if(!tbody) return;

  tbody.innerHTML = '';
  const snap = await cloudDB.ref('users').once('value');
  const users = snap.val() ? Object.values(snap.val()) : [];

  users.forEach((u,i)=>{
    const perm = u.permissionLevel || 'view';
    const isAdminRow = (u.role === 'admin' || u.username === 'admin');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(u.username)}</td>
      <td>
        ${
          isAdminRow
            ? `<b>Full (Admin)</b>`
            : (currentUser?.role === 'admin'
                ? `
                  <select onchange="changeUserPermission('${escapeHtml(u.username)}', this.value)">
                    <option value="full" ${perm==='full'?'selected':''}>Full</option>
                    <option value="half" ${perm==='half'?'selected':''}>Half</option>
                    <option value="view" ${perm==='view'?'selected':''}>View</option>
                  </select>
                `
                : escapeHtml(perm)
              )
        }
      </td>
      <td>
        ${
          (!isAdminRow && currentUser?.role === 'admin')
            ? `<button class="btn out" onclick="deleteUser('${escapeHtml(u.username)}')">Delete</button>`
            : ''
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function addUser(){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can add users", true);
    return;
  }

  const u = (document.getElementById('newUsername')?.value || '').trim();
  const p = (document.getElementById('newPassword')?.value || '');
  const role = (document.getElementById('newRole')?.value || 'user');

  if(!u || !p){ showToast("Username & password required", true); return; }

  const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
  if(snap.exists()){ showToast("Username already exists", true); return; }

  const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
  await cloudDB.ref('users/'+userId).set({
    username: u,
    password: p,
    role,
    permissionLevel: (role === 'admin' ? 'full' : 'view'),
    createdAt: new Date().toISOString()
  });

  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('newRole').value = 'user';

  showToast("User added ‚úÖ");
  renderUsersTable();
}

/* =========================
   ‚úÖ LOCAL STORAGE DATA (RM)
========================= */
const KEY_PRODUCTS = 'sms_products_final_v1';
const KEY_MOVES    = 'sms_movements_final_v1';

let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
let stockMovements = JSON.parse(localStorage.getItem(KEY_MOVES) || '[]');

function saveAll(){
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements));
}

function computeBalance(productId){
  let bal=0;
  stockMovements.forEach(m=>{
    if(m.productId===productId) bal += (m.type==='IN' ? Number(m.quantity||0) : -Number(m.quantity||0));
  });
  return bal>0 ? bal : 0;
}

function lastMovement(productId, type){
  const moves = stockMovements.filter(m=>m.productId===productId && m.type===type);
  if(!moves.length) return '-';
  return moves[moves.length-1].date || '-';
}

/* =========================
   ‚úÖ FG DATA
========================= */
let fgProducts  = JSON.parse(localStorage.getItem('sms_fg_products') || '[]');
let fgMovements = JSON.parse(localStorage.getItem('sms_fg_movements') || '[]');

function saveFGLocal(){
  localStorage.setItem('sms_fg_products', JSON.stringify(fgProducts));
  localStorage.setItem('sms_fg_movements', JSON.stringify(fgMovements));
}

function computeFGBalance(fgId){
  return fgMovements.reduce((sum,m)=>{
    if(m.fgId===fgId){
      return sum + (m.type==='IN'? Number(m.qty||0) : -Number(m.qty||0));
    }
    return sum;
  },0);
}

function initFGVolumeSelection(){
  if(selectedFGVolumes.size) return;
  fgProducts.forEach(f=>{
    const v = (f.volume||'').trim();
    if(v) selectedFGVolumes.add(v);
  });
}

/* =========================
   ‚úÖ DASHBOARD (MAIN CARDS)
========================= */
function getFGLowStockCount(){
  return fgProducts.filter(f => computeFGBalance(f.id) <= (Number(f.threshold ?? 5))).length;
}

function renderMainDashboard(){
  const totalProductsEl = document.getElementById('dashTotalProducts');
  const totalStockEl    = document.getElementById('dashTotalStock');
  const lowStockEl      = document.getElementById('dashLowStock');
  const fgBalanceEl     = document.getElementById('dashFGBalance');

  const fgTotalEl       = document.getElementById('dashFGTotalProducts');
  const fgLowEl         = document.getElementById('dashFGLowStock');
  const fgMaxEl         = document.getElementById('dashFGMaxBalance');
  const fgMinEl         = document.getElementById('dashFGMinBalance');

  if(!totalProductsEl || !totalStockEl || !lowStockEl || !fgBalanceEl) return;

  // RM
  totalProductsEl.textContent = products.length;

  let totalStock = 0;
  let lowStock = 0;
  products.forEach(p=>{
    const bal = computeBalance(p.id);
    totalStock += Number(bal)||0;
    if((Number(bal)||0) <= (Number(p.threshold ?? 5))) lowStock++;
  });

  totalStockEl.textContent = totalStock;
  lowStockEl.textContent = lowStock;

  // FG
  const fgTotal = fgProducts.reduce((sum,f)=> sum + computeFGBalance(f.id), 0);
  fgBalanceEl.textContent = fgTotal;

  if(fgTotalEl) fgTotalEl.textContent = fgProducts.length;
  if(fgLowEl) fgLowEl.textContent = getFGLowStockCount();

  if(fgMaxEl){
    const maxFG = fgProducts.reduce((max, f)=>{
      const bal = computeFGBalance(f.id);
      return (bal > max.balance) ? {name:f.name, balance:bal} : max;
    }, {name:'-', balance:-Infinity});
    fgMaxEl.textContent = (maxFG.balance === -Infinity) ? '-' : `${maxFG.name} (${maxFG.balance})`;
  }

  if(fgMinEl){
    const minFG = fgProducts.reduce((min, f)=>{
      const bal = computeFGBalance(f.id);
      return (bal < min.balance) ? {name:f.name, balance:bal} : min;
    }, {name:'-', balance:Infinity});
    fgMinEl.textContent = (minFG.balance === Infinity) ? '-' : `${minFG.name} (${minFG.balance})`;
  }
}

/* =========================
   ‚úÖ FG FILTER + CHART
========================= */
function renderFGVolumeFilter(){
  const wrap = document.getElementById('fgVolumeFilter');
  if(!wrap) return;

  const volumes = [...new Set(fgProducts.map(f=>(f.volume||'').trim()).filter(v=>v))].sort();
  wrap.innerHTML = '';

  // if nothing selected, select all
  if(!selectedFGVolumes.size){
    volumes.forEach(v=> selectedFGVolumes.add(v));
  }

  volumes.forEach(vol=>{
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems='center';
    label.style.gap='4px';
    label.style.cursor='pointer';

    const checked = selectedFGVolumes.has(vol);

    label.innerHTML = `
      <input type="checkbox" ${checked ? 'checked':''}>
      ${escapeHtml(vol)}
    `;

    label.querySelector('input').onchange = e=>{
      if(e.target.checked) selectedFGVolumes.add(vol);
      else selectedFGVolumes.delete(vol);

      // if user unchecks all -> auto select all again
      if(!selectedFGVolumes.size){
        volumes.forEach(v=> selectedFGVolumes.add(v));
        renderFGVolumeFilter();
      }
      renderFGChart();
    };

    wrap.appendChild(label);
  });
}

function renderFGChart(){
  const canvas = document.getElementById('fgStockChart');
  if(!canvas) return;

  const filteredFG = fgProducts.filter(f => selectedFGVolumes.has((f.volume||'').trim()));
  const labels = filteredFG.map(f => (f.name||'').length>12 ? f.name.slice(0,12)+'‚Ä¶' : f.name);
  const data   = filteredFG.map(f => computeFGBalance(f.id));

  if(fgChartInstance) fgChartInstance.destroy();
  if(!filteredFG.length) return;

  fgChartInstance = new Chart(canvas, {
    type:'bar',
    data:{ labels, datasets:[{ data, borderRadius:8, barThickness:22, backgroundColor:'rgba(41,128,185,0.65)' }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            title:(items)=> filteredFG[items[0].dataIndex].name,
            label:(ctx)=> `Balance: ${ctx.raw}`
          }
        }
      },
      scales:{ x:{ grid:{display:false} }, y:{ beginAtZero:true } }
    }
  });
}

/* =========================
   ‚úÖ FG PAGES (with LOW filter from dashboard)
========================= */
let fgOnlyLow = false;

function openFGFromDashboard(){ fgOnlyLow = false; openPage('fgStock'); }
function openLowFGFromDashboard(){ fgOnlyLow = true; openPage('fgStock'); }

function renderFGStock(){
  const tbody = document.querySelector('#fgTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;

    const bal = computeFGBalance(p.id);
    const thr = Number(p.threshold ?? 5);

    if(fgOnlyLow && !(bal <= thr)) return;

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.volume||'-')}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${bal}</td>
        <td>
          <button class="btn info" onclick="viewFGHistory('${p.id}')">üëÅ View</button>
          ${currentUser?.role === 'admin' ? `
            <button class="btn secondary btn-edit" onclick="editFGProduct('${p.id}')">‚úèÔ∏è Edit</button>
            <button class="btn out btn-delete" onclick="deleteFGProduct('${p.id}')">üóë Delete</button>
          `:''}
        </td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderFGStockIn(){
  const tbody = document.getElementById('fgStockInBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgInSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn" onclick="openFGModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}

function renderFGStockOut(){
  const tbody = document.getElementById('fgStockOutBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgOutSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn out btn-stock-out" onclick="openFGModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function viewFGHistory(fgId){
  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  const modal = document.getElementById('historyModal');
  modal.style.display='flex';
  document.getElementById('modalTitle').textContent = `FG History ‚Äî ${fg.name}`;

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML='';

  fgMovements
    .filter(m=>m.fgId===fgId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.qty||0)}</td>
          <td>${escapeHtml(m.batch||fg.batch||'-')}</td>
          <td>${escapeHtml(m.expiry||fg.expiry||'-')}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

function addFGProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const name = fgNewName.value.trim();
  const rawGroup = fgNewGroup.value.trim();
  if(!name || !rawGroup){ showToast("Name & Group required", true); return; }

  const group = normalizeGroup(rawGroup);

  fgProducts.push({
    id:'fg_' + genId(),
    name,
    group,
    volume: fgNewVolume.value.trim(),
    batch: fgNewBatch.value.trim(),
    expiry: fgNewExpiry.value,
    threshold: Number(fgNewThreshold.value || 5)
  });

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  fgNewName.value=''; fgNewVolume.value=''; fgNewGroup.value=''; fgNewBatch.value='';
  fgNewExpiry.value=''; fgNewThreshold.value='';

  showToast("FG product added ‚úÖ");
}

function editFGProduct(fgId){
  if(!canEdit()){ showToast("No permission to edit", true); return; }

  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  const newName = prompt("Edit Product Name:", fg.name);
  if(newName===null || !newName.trim()) return;

  const newVolume = prompt("Edit Volume / Size:", fg.volume || '');
  if(newVolume===null) return;

  const newGroup = prompt("Edit Group Prefix:", fg.group || '');
  if(newGroup===null || !newGroup.trim()) return;

  const newBatch = prompt("Edit Batch / Lot No:", fg.batch || '');
  if(newBatch===null) return;

  const newExpiry = prompt("Edit Expiry Date (YYYY-MM-DD):", fg.expiry || '');
  if(newExpiry===null) return;

  const newThreshold = prompt("Edit Low Stock Threshold:", fg.threshold ?? 5);
  if(newThreshold===null || isNaN(newThreshold)) return;

  fg.name = newName.trim();
  fg.volume = newVolume.trim();
  fg.group = normalizeGroup(newGroup);
  fg.batch = newBatch.trim();
  fg.expiry = newExpiry.trim();
  fg.threshold = Number(newThreshold);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  showToast("FG updated ‚úÖ");
}

function deleteFGProduct(fgId){
  if(!canDelete()){ showToast("No permission to delete", true); return; }

  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  if(!confirm(`Delete FG "${fg.name}"? (History also deleted)`)) return;

  fgProducts = fgProducts.filter(f=>f.id!==fgId);
  fgMovements = fgMovements.filter(m=>m.fgId!==fgId);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  showToast("FG deleted ‚úÖ");
}

/* =========================
   ‚úÖ RM PAGES
========================= */
function renderProductsTable(){
  const tbody = document.querySelector('#productsTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const localSearch = (document.getElementById('productSearch')?.value || '').trim().toLowerCase();

  let i=1;
  products.forEach(p=>{
    const name = (p.name||'').toLowerCase();
    const cat  = (p.category||'').toLowerCase();
    if(localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) return;

    const bal = computeBalance(p.id);

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${escapeHtml(p.category||'')}</td>
        <td>${bal}</td>
        <td>${Number(p.threshold ?? 5)}</td>
        <td>${escapeHtml(p.barcode||'')}</td>
        <td><button class="btn secondary" onclick="openHistory('${p.id}')">History</button></td>
        <td><button class="btn secondary btn-edit admin-only" onclick="editProduct('${p.id}')">Edit</button></td>
        <td><button class="btn out btn-delete admin-only" onclick="deleteProduct('${p.id}')">Delete</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderStockIn(){
  const tbody = document.querySelector('#stockInBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('inSearch')?.value || '').toLowerCase().trim();

  products.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'IN')}</td>
        <td><button class="btn" onclick="openStockModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}

function renderStockOut(){
  const tbody = document.querySelector('#stockOutBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('outSearch')?.value || '').toLowerCase().trim();

  products.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'OUT')}</td>
        <td><button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderCombinedHistory(){
  const tbody = document.querySelector('#historyTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('historySearch')?.value || '').toLowerCase().trim();

  stockMovements
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = products.find(p=>p.id===m.productId);
      if(!prod) return;

      const okSearch =
        !search ||
        (prod.name||'').toLowerCase().includes(search) ||
        (m.remark||'').toLowerCase().includes(search);

      if(!okSearch) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name||'')}</td>
          <td>${escapeHtml(m.type||'')}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

/* =========================
   ‚úÖ MODALS (RM + FG)
========================= */
let modalCurrent = null;

function openStockModal(productId, type){
  if(type === 'OUT' && !canStockOut()){
    showToast("Stock OUT not allowed for your role", true);
    return;
  }

  modalCurrent = { productId, type };
  const prod = products.find(p=>p.id===productId);
  if(!prod) return;

  document.getElementById('modalProductName').textContent = prod.name;
  document.getElementById('modalProductBalance').textContent = computeBalance(productId);
  document.getElementById('modalQty').value = '';
  document.getElementById('modalRemark').value = '';

  document.getElementById('stockModal').style.display = 'flex';

  document.getElementById('modalSave').onclick = ()=>{
    const qty = Number(document.getElementById('modalQty').value);
    const remark = document.getElementById('modalRemark').value.trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeBalance(productId)){ showToast("Quantity exceeds balance", true); return; }

    stockMovements.push({ id:genId(), productId, type, quantity:qty, date:todayISO(), remark });
    saveAll();
    autoPushToCloud();
    closeModal();
    refreshAll();
    showToast(`RM Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}

function openFGModal(fgId, type){
  if(type === 'OUT' && !canStockOut()){
    showToast("Stock OUT not allowed for your role", true);
    return;
  }

  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  document.getElementById('modalProductName').textContent = fg.name;
  document.getElementById('modalProductBalance').textContent = computeFGBalance(fgId);
  document.getElementById('modalQty').value = '';
  document.getElementById('modalRemark').value = '';
  document.getElementById('stockModal').style.display = 'flex';

  document.getElementById('modalSave').onclick = ()=>{
    const qty = Number(document.getElementById('modalQty').value);
    const remark = document.getElementById('modalRemark').value.trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeFGBalance(fgId)){ showToast("Quantity exceeds FG balance", true); return; }

    fgMovements.push({
      id:genId(),
      fgId,
      type,
      qty,
      batch: fg.batch || '',
      expiry: fg.expiry || '',
      date: todayISO(),
      remark
    });

    saveFGLocal();
    autoPushFGToCloud();
    closeModal();
    refreshAll();
    showToast(`FG Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}

function closeModal(){
  document.getElementById('stockModal').style.display='none';
  modalCurrent = null;
}

/* RM history modal */
function openHistory(productId){
  const prod = products.find(p=>p.id===productId);
  if(!prod) return;

  const modal = document.getElementById('historyModal');
  modal.style.display='flex';

  document.getElementById('modalTitle').textContent = `RM History ‚Äî ${prod.name}`;

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.productId===productId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>-</td>
          <td>-</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

function closeHistoryModal(){
  document.getElementById('historyModal').style.display='none';
}

/* RM Stock IN/OUT History modals */
function stockInHistoryModal(){
  const modal=document.getElementById('stockInHistoryModal');
  modal.style.display='flex';
  const tbody=document.getElementById('stockInHistoryPopupBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.type==='IN')
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = products.find(p=>p.id===m.productId);
      if(!prod) return;
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
function closeStockInHistory(){ document.getElementById('stockInHistoryModal').style.display='none'; }

function stockOutHistoryModal(){
  const modal=document.getElementById('stockOutHistoryModal');
  modal.style.display='flex';
  const tbody=document.getElementById('stockOutHistoryPopupBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.type==='OUT')
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = products.find(p=>p.id===m.productId);
      if(!prod) return;
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
function closeStockOutHistory(){ document.getElementById('stockOutHistoryModal').style.display='none'; }

/* FG IN/OUT History (use historyModal) */
function fgStockInHistoryModal(){
  const modal = document.getElementById("historyModal");
  modal.style.display = "flex";
  document.getElementById("modalTitle").textContent = "FG Stock IN History";

  const tbody = document.getElementById("modalHistoryBody");
  tbody.innerHTML = "";

  fgMovements
    .filter(m => m.type === "IN")
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id === m.fgId);
      if(!fg) return;
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>IN</td>
          <td>${Number(m.qty || 0)}</td>
          <td>${escapeHtml(m.batch || fg.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || fg.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

function fgStockOutHistoryModal(){
  const modal = document.getElementById("historyModal");
  modal.style.display = "flex";
  document.getElementById("modalTitle").textContent = "FG Stock OUT History";

  const tbody = document.getElementById("modalHistoryBody");
  tbody.innerHTML = "";

  fgMovements
    .filter(m => m.type === "OUT")
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id === m.fgId);
      if(!fg) return;
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>OUT</td>
          <td>${Number(m.qty || 0)}</td>
          <td>${escapeHtml(m.batch || fg.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || fg.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

/* =========================
   ‚úÖ RM ADD / EDIT / DELETE
========================= */
function addRMProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const code = (document.getElementById('newCode')?.value || '').trim();
  const name = (document.getElementById('newName')?.value || '').trim();
  const category = (document.getElementById('newCategory')?.value || '').trim();
  const threshold = Number(document.getElementById('newThreshold')?.value || 5);
  const barcode = (document.getElementById('newBarcode')?.value || '').trim();
  const groupsStr = (document.getElementById('newGroups')?.value || '').trim();
  const exclusive = !!document.getElementById('newExclusive')?.checked;

  if(!name){ showToast("Product name required", true); return; }

  const groups = groupsStr
    ? groupsStr.split(',').map(g=>g.trim()).filter(Boolean)
    : [];

  products.push({
    id: 'rm_' + genId(),
    code, name, category,
    threshold: isNaN(threshold) ? 5 : threshold,
    barcode,
    groups,
    exclusive
  });

  saveAll();
  autoPushToCloud();
  refreshAll();

  newCode.value=''; newName.value=''; newCategory.value='';
  newThreshold.value=''; newBarcode.value=''; newGroups.value='';
  newExclusive.checked=false;

  showToast("RM product added ‚úÖ");
}

function editProduct(productId){
  if(!canEdit()){
    showToast("No permission to edit", true);
    return;
  }

  const prod = products.find(p => p.id === productId);
  if(!prod) return;

  const newCode = prompt("Edit product code:", prod.code || "");
  if(newCode === null) return;

  const newName = prompt("Edit product name:", prod.name || "");
  if(newName === null || !newName.trim()){
    showToast("Name required", true);
    return;
  }

  const newCategory = prompt("Edit category:", prod.category || "");
  if(newCategory === null) return;

  const newThreshold = prompt("Edit threshold:", prod.threshold ?? 5);
  if(newThreshold === null || isNaN(Number(newThreshold))){
    showToast("Invalid threshold", true);
    return;
  }

  const newBarcode = prompt("Edit barcode:", prod.barcode || "");
  if(newBarcode === null) return;

  const newGroupsInput = prompt(
    "Edit groups (comma separated):",
    Array.isArray(prod.groups) ? prod.groups.join(', ') : ''
  );
  if(newGroupsInput === null) return;

  const newExclusive = confirm("Exclusive to first group?");

  prod.code = newCode.trim();
  prod.name = newName.trim();
  prod.category = (newCategory || '').trim();
  prod.threshold = Number(newThreshold);
  prod.barcode = (newBarcode || '').trim();
  prod.groups = (newGroupsInput || '')
    .split(',')
    .map(g => g.trim())
    .filter(Boolean);
  prod.exclusive = newExclusive;

  saveAll();
  autoPushToCloud();
  refreshAll();

  showToast("Product updated ‚úÖ");
}

function deleteProduct(productId){
  if(!canDelete()){
    showToast("No permission to delete", true);
    return;
  }

  const prod = products.find(p => p.id === productId);
  if(!prod) return;

  if(!confirm(`Delete "${prod.name}"?\nThis will remove all its stock history.`)) return;

  products = products.filter(p => p.id !== productId);
  stockMovements = stockMovements.filter(m => m.productId !== productId);

  saveAll();
  autoPushToCloud();
  refreshAll();

  showToast("Product deleted ‚úÖ");
}

/* =========================
   ‚úÖ BOM / DASHBOARD GROUPED TABLE
========================= */
let dashboardSearchText = "";
let selectedDashboardGroup = null;
let renamedGroups = JSON.parse(localStorage.getItem('renamedGroups') || '{}');

function handleDashboardSearch(value){
  dashboardSearchText = (value || "").toLowerCase().trim();
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function clearDashboardSearch(){
  const inp = document.getElementById('dashboardSearch');
  if(inp) inp.value = '';
  dashboardSearchText = '';
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function selectDashboardGroup(groupName){
  selectedDashboardGroup = groupName;
  renderDashboardGrouped();
}
function getFGStock(groupName){
  const key = normalizeGroup(groupName);
  let total = 0;
  fgProducts.forEach(fg=>{
    if(normalizeGroup(fg.group) === key){
      total += computeFGBalance(fg.id);
    }
  });
  return total;
}
function renameGroup(groupName){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can rename groups", true);
    return;
  }
  const newName = prompt(`Enter new display name for "${groupName}"`, renamedGroups[groupName] || groupName);
  if(!newName) return;

  renamedGroups[groupName] = newName.trim();
  localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
  saveRenamedGroupsToCloud();
  renderDashboardGrouped();
}
function saveRenamedGroupsToCloud(){
  cloudDB.ref("dashboardRenamedGroups").set(renamedGroups);
}
function loadRenamedGroupsFromCloud(){
  cloudDB.ref("dashboardRenamedGroups").once("value").then(snap=>{
    if(snap.exists()){
      renamedGroups = snap.val() || {};
      localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
      renderDashboardGrouped();
    }
  });
}

// Grouped BOM render (shows groups by default)
function renderDashboardGrouped(){
  const tbody = document.querySelector('#dashTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  const groupsMap = {};

  products.forEach(p=>{
    if(!Array.isArray(p.groups) || !p.groups.length) return;

    p.groups.forEach(g=>{
      if(!groupsMap[g]) groupsMap[g] = [];

      // exclusive products only show in first group
      if(p.exclusive && p.groups[0] !== g) return;

      groupsMap[g].push(p);
    });
  });

  const allGroups = Object.keys(groupsMap).sort((a,b)=>a.localeCompare(b));
  const search = dashboardSearchText;

  // If no groups configured, show info row
  if(!allGroups.length){
    tbody.insertAdjacentHTML('beforeend', `
      <tr><td colspan="6"><b>No BOM groups found.</b> Add "Groups" to RM products (comma separated).</td></tr>
    `);
    return;
  }

  allGroups.forEach(groupName=>{
    const displayName = renamedGroups[groupName] || groupName;

    const groupProducts = groupsMap[groupName].filter(p=>{
      const nm = (p.name||'').toLowerCase();
      const gp = displayName.toLowerCase();
      return !search || nm.includes(search) || gp.includes(search);
    });

    if(!groupProducts.length) return;
    if(selectedDashboardGroup && selectedDashboardGroup !== groupName) return;

    const fgBalance = getFGStock(groupName);

    const groupRow = document.createElement('tr');
    groupRow.innerHTML = `
      <td colspan="6" style="padding:18px;cursor:pointer;background:rgba(0,0,0,0.03)"
          onclick="selectDashboardGroup('${escapeHtml(groupName)}')">
        <b>${escapeHtml(displayName).toUpperCase()}</b>
        <span style="margin-left:40px;color:green;font-weight:bold">
          FG BALANCE: ${fgBalance}
        </span>
        ${
          currentUser?.role === 'admin'
            ? `<button class="btn secondary" style="margin-left:15px;padding:6px 10px"
                 onclick="event.stopPropagation(); renameGroup('${escapeHtml(groupName)}')">
                 Rename
               </button>`
            : ''
        }
      </td>
    `;
    tbody.appendChild(groupRow);

    // show products only when group is selected
    if(selectedDashboardGroup === groupName){
      groupProducts.forEach(p=>{
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td style="padding-left:25px">${escapeHtml(p.name||'')}</td>
            <td class="${bal <= Number(p.threshold ?? 5) ? 'low-stock':''}">${bal}</td>
            <td>${Number(p.threshold ?? 5)}</td>
            <td>${lastMovement(p.id,'IN')}</td>
            <td>${lastMovement(p.id,'OUT')}</td>
            <td>
              <button class="btn secondary" onclick="openHistory('${p.id}')">View</button>
              <button class="btn" onclick="openStockModal('${p.id}','IN')">Add IN</button>
              <button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock OUT</button>
            </td>
          </tr>
        `);
      });
    }
  });

  applyPermissions();
}

/* =========================
   ‚úÖ CLOUD SYNC (RM + FG)
========================= */
function autoPushFGToCloud(){
  cloudDB.ref('fgManager').set({
    products: fgProducts,
    movements: fgMovements,
    syncedAt: new Date().toISOString()
  });
}
function autoPullFGFromCloud(){
  cloudDB.ref('fgManager').once('value').then(snap=>{
    if(!snap.exists()) return;
    fgProducts = snap.val().products || [];
    fgMovements = snap.val().movements || [];
    saveFGLocal();
    initFGVolumeSelection();
    refreshAll();
  });
}

function autoPullFromCloud(){
  cloudDB.ref("stockManager").once("value")
    .then(snapshot=>{
      const data = snapshot.val();
      if(!data) return;
      products = data.products || [];
      stockMovements = data.stockMovements || [];
      saveAll();
      refreshAll();
    })
    .catch(err=> console.error("Auto pull failed:", err));
}
function autoPushToCloud(){
  cloudDB.ref("stockManager").set({
    products,
    stockMovements,
    syncedAt: new Date().toISOString()
  });
}

/* =========================
   ‚úÖ REPORTS + EXPORT/IMPORT
========================= */
function printStockReport(){
  const rows = products
    .slice()
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    .map(p=>({
      Code: p.code || '',
      Product: p.name || '',
      Category: p.category || '',
      Balance: computeBalance(p.id),
      Threshold: Number(p.threshold ?? 5),
      LastIN: lastMovement(p.id,'IN'),
      LastOUT: lastMovement(p.id,'OUT')
    }));

  const w = window.open('', '_blank');
  if(!w) { showToast("Popup blocked by browser", true); return; }

  w.document.write(`
    <html><head><title>RM Stock Report</title>
    <style>
      body{font-family:Arial;padding:18px}
      h2{margin:0 0 12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ccc;padding:8px;text-align:left}
      th{background:#007bff;color:#fff}
    </style>
    </head><body class="print-bg">
    <h2>RM Stock Report</h2>
    <p>Date: ${new Date().toLocaleString()}</p>
    <table>
      <thead><tr>
        <th>Code</th><th>Product</th><th>Category</th><th>Balance</th><th>Threshold</th><th>Last IN</th><th>Last OUT</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.Code)}</td>
            <td>${escapeHtml(r.Product)}</td>
            <td>${escapeHtml(r.Category)}</td>
            <td>${r.Balance}</td>
            <td>${r.Threshold}</td>
            <td>${escapeHtml(r.LastIN)}</td>
            <td>${escapeHtml(r.LastOUT)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function printFGStockReport(){
  const rows = fgProducts
    .slice()
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    .map(f=>({
      Product: f.name || '',
      Volume: f.volume || '',
      Group: f.group || '',
      Balance: computeFGBalance(f.id),
      Threshold: Number(f.threshold ?? 5),
      Batch: f.batch || '',
      Expiry: f.expiry || ''
    }));

  const w = window.open('', '_blank');
  if(!w) { showToast("Popup blocked by browser", true); return; }

  w.document.write(`
    <html><head><title>FG Stock Report</title>
    <style>
      body{font-family:Arial;padding:18px}
      h2{margin:0 0 12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ccc;padding:8px;text-align:left}
      th{background:#16a34a;color:#fff}
    </style>
    </head><body>
    <h2>FG Stock Report</h2>
    <p>Date: ${new Date().toLocaleString()}</p>
    <table>
      <thead><tr>
        <th>Product</th><th>Volume</th><th>Group</th><th>Balance</th><th>Threshold</th><th>Batch</th><th>Expiry</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.Product)}</td>
            <td>${escapeHtml(r.Volume)}</td>
            <td>${escapeHtml(r.Group)}</td>
            <td>${r.Balance}</td>
            <td>${r.Threshold}</td>
            <td>${escapeHtml(r.Batch)}</td>
            <td>${escapeHtml(r.Expiry)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function exportExcel(){
  try{
    const wb = XLSX.utils.book_new();

    const rmProducts = products.map(p=>({
      id:p.id, code:p.code||'', name:p.name||'', category:p.category||'',
      threshold:Number(p.threshold ?? 5), barcode:p.barcode||'',
      groups: Array.isArray(p.groups)? p.groups.join(', ') : '',
      exclusive: !!p.exclusive
    }));
    const rmMoves = stockMovements.map(m=>({
      id:m.id, productId:m.productId, type:m.type, quantity:Number(m.quantity||0),
      date:m.date||'', remark:m.remark||''
    }));
    const fgProds = fgProducts.map(f=>({
      id:f.id, name:f.name||'', volume:f.volume||'', group:f.group||'',
      threshold:Number(f.threshold ?? 5), batch:f.batch||'', expiry:f.expiry||''
    }));
    const fgMoves = fgMovements.map(m=>({
      id:m.id, fgId:m.fgId, type:m.type, qty:Number(m.qty||0),
      date:m.date||'', batch:m.batch||'', expiry:m.expiry||'', remark:m.remark||''
    }));

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rmProducts), 'RM_Products');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rmMoves), 'RM_Movements');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fgProds), 'FG_Products');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fgMoves), 'FG_Movements');

    XLSX.writeFile(wb, `StockManager_${todayISO()}.xlsx`);
    showToast("Excel exported ‚úÖ");
  }catch(e){
    console.error(e);
    showToast("Excel export failed", true);
  }
}

function importExcel(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.xlsx,.xls';
  inp.onchange = (ev)=>{
    const file = ev.target.files?.[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const firstSheetName = wb.SheetNames[0];
        const ws = wb.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:''});

        let added = 0;
        rows.forEach(r=>{
          const name = String(r.name || r.Name || r.PRODUCT || r.Product || '').trim();
          if(!name) return;

          products.push({
            id: 'rm_' + genId(),
            code: String(r.code || r.Code || '').trim(),
            name,
            category: String(r.category || r.Category || '').trim(),
            threshold: Number(r.threshold || r.Threshold || 5) || 5,
            barcode: String(r.barcode || r.Barcode || '').trim(),
            groups: String(r.groups || r.Groups || '').split(',').map(x=>x.trim()).filter(Boolean),
            exclusive: String(r.exclusive || r.Exclusive || '').toLowerCase() === 'true'
          });
          added++;
        });

        saveAll();
        autoPushToCloud();
        refreshAll();
        showToast(`Imported ${added} RM products ‚úÖ`);
      }catch(err){
        console.error(err);
        showToast("Import failed", true);
      }
    };
    reader.readAsArrayBuffer(file);
  };
  inp.click();
}

function exportPDF(){
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');

    const rows = products
      .slice()
      .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
      .map(p=>[
        p.code||'',
        p.name||'',
        p.category||'',
        String(computeBalance(p.id)),
        String(Number(p.threshold ?? 5)),
        lastMovement(p.id,'IN'),
        lastMovement(p.id,'OUT')
      ]);

    doc.text(`RM Stock Report - ${todayISO()}`, 40, 40);

    doc.autoTable({
      startY: 60,
      head: [['Code','Product','Category','Balance','Threshold','Last IN','Last OUT']],
      body: rows,
      styles: { fontSize: 9 }
    });

    doc.save(`RM_Stock_Report_${todayISO()}.pdf`);
    showToast("PDF exported ‚úÖ");
  }catch(e){
    console.error(e);
    showToast("PDF export failed", true);
  }
}

/* =========================
   ‚úÖ SUPPLIERS (local)
========================= */
const KEY_SUPPLIERS = 'sms_suppliers_v1';
let suppliers = JSON.parse(localStorage.getItem(KEY_SUPPLIERS) || '[]');

function saveSuppliers(){
  localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(suppliers));
}

function renderSuppliers(){
  const tbody = document.querySelector('#suppliersTable tbody');
  if(!tbody) return;

  const q = (document.getElementById('supplierSearch')?.value || '').toLowerCase().trim();
  tbody.innerHTML = '';

  const list = suppliers.filter(s=>{
    if(!q) return true;
    return (s.name||'').toLowerCase().includes(q) || (s.contact||'').toLowerCase().includes(q);
  });

  list.forEach((s, idx)=>{
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${idx+1}</td>
        <td>${escapeHtml(s.name||'')}</td>
        <td>${escapeHtml(s.contact||'')}</td>
        <td><button class="btn secondary btn-edit" onclick="editSupplier('${s.id}')">Edit</button></td>
        <td><button class="btn out btn-delete" onclick="deleteSupplier('${s.id}')">Delete</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function addSupplier(){
  if(!canAdd()){ showToast("No permission to add", true); return; }
  const name = (document.getElementById('newSupplierName')?.value || '').trim();
  const contact = (document.getElementById('newSupplierContact')?.value || '').trim();
  if(!name){ showToast("Supplier name required", true); return; }

  suppliers.push({ id:'sup_'+genId(), name, contact });
  saveSuppliers();
  renderSuppliers();
  document.getElementById('newSupplierName').value='';
  document.getElementById('newSupplierContact').value='';
  showToast("Supplier added ‚úÖ");
}
function editSupplier(id){
  if(!canEdit()){ showToast("No permission to edit", true); return; }
  const s = suppliers.find(x=>x.id===id);
  if(!s) return;

  const name = prompt("Supplier name:", s.name||'');
  if(name === null || !name.trim()) return;

  const contact = prompt("Contact info:", s.contact||'');
  if(contact === null) return;

  s.name = name.trim();
  s.contact = contact.trim();
  saveSuppliers();
  renderSuppliers();
  showToast("Supplier updated ‚úÖ");
}
function deleteSupplier(id){
  if(!canDelete()){ showToast("No permission to delete", true); return; }
  if(!confirm("Delete this supplier?")) return;

  suppliers = suppliers.filter(x=>x.id!==id);
  saveSuppliers();
  renderSuppliers();
  showToast("Supplier deleted ‚úÖ");
}

/* =========================
   ‚úÖ EVENTS / MENU / INIT
========================= */
// Sidebar collapsible
document.querySelectorAll('.menu-title.collapsible').forEach(m=>{
  m.addEventListener('click', ()=>{
    m.classList.toggle('open');
    m.nextElementSibling?.classList.toggle('open');
  });
});

// submenu navigation
document.querySelectorAll('.submenu').forEach(sm=>{
  sm.addEventListener('click', ()=>{
    const page = sm.dataset.page;
    const action = sm.dataset.action;
    if(page) openPage(page);
    if(action && typeof window[action]==='function') window[action]();
  });
});

// Searches
document.getElementById('productSearch')?.addEventListener('input', renderProductsTable);
document.getElementById('inSearch')?.addEventListener('input', renderStockIn);
document.getElementById('outSearch')?.addEventListener('input', renderStockOut);
document.getElementById('historySearch')?.addEventListener('input', renderCombinedHistory);
document.getElementById('fgSearch')?.addEventListener('input', renderFGStock);
document.getElementById('fgInSearch')?.addEventListener('input', renderFGStockIn);
document.getElementById('fgOutSearch')?.addEventListener('input', renderFGStockOut);
document.getElementById('supplierSearch')?.addEventListener('input', renderSuppliers);
document.getElementById('addSupplierBtn')?.addEventListener('click', addSupplier);

// Sidebar toggle
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');
const mainWrap = document.querySelector('.main');

if(sidebarToggle && sidebar){
  sidebarToggle.addEventListener('click', ()=>{
    sidebar.classList.toggle('minimized');
    if(mainWrap) mainWrap.classList.toggle('sidebar-minimized');
    sidebarToggle.textContent = sidebar.classList.contains('minimized') ? '‚Üí' : '‚Üê';
  });
}

// ‚úÖ session restore
const savedUser = localStorage.getItem('sms_currentUser');
if(savedUser){
  currentUser = JSON.parse(savedUser);
  loginScreen.style.display='none';
  document.querySelector('.app').style.display='flex';
  applyPermissions();
  openPage('dashboardPage');
}

/* initial pulls */
window.addEventListener('load', ()=>{
  initFGVolumeSelection();
  loadRenamedGroupsFromCloud();
  autoPullFGFromCloud();
  autoPullFromCloud();
  refreshAll();
});

/* =========================
   ‚úÖ REFRESH ALL
========================= */
function refreshAll(){
  renderProductsTable();
  renderStockIn();
  renderStockOut();
  renderCombinedHistory();

  renderFGStock();
  renderFGStockIn();
  renderFGStockOut();

  renderMainDashboard();
  renderDashboardGrouped();
  applyPermissions();
}

/* Expose to window (safe) */
window.handleDashboardSearch = handleDashboardSearch;
window.clearDashboardSearch = clearDashboardSearch;
window.fgStockInHistoryModal = fgStockInHistoryModal;
window.fgStockOutHistoryModal = fgStockOutHistoryModal;
window.printStockReport = printStockReport;
window.printFGStockReport = printFGStockReport;
window.exportExcel = exportExcel;
window.importExcel = importExcel;
window.exportPDF = exportPDF;
window.openFGFromDashboard = openFGFromDashboard;
window.openLowFGFromDashboard = openLowFGFromDashboard;
</script>

</body>
</html>
