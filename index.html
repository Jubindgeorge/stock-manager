<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stock Manager</title>
<link rel="icon" type="image/png" href="tablogo.png">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* =========================================
   Stock Manager CSS (Bootstrap SAFE)
   - Avoids overriding Bootstrap core classes
   - Responsive + Full-screen Dashboard
========================================= */

:root{
  --sidebar-w: 260px;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b6f76;
  --accent:#2c3e50;
  --accent-2:#2980b9;
  --danger:#c0392b;
  --line:#e7e9ee;
  --shadow:0 10px 30px rgba(0,0,0,.08);
  --radius:14px;

  /* Viewport fix (mobile address bar) */
  --vh: 100vh;
}
@supports (height: 100dvh){
  :root{ --vh: 100dvh; }
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:#ffffff;
  color:#111;
}

.muted{ color: var(--muted) !important; }
.right{ text-align:right !important; }
.sm-link{ color:#2563eb; cursor:pointer; font-weight:700; }
.low-stock{ color:#dc2626; font-weight:800; }

/* App wrapper */
.app{ display:none; min-height:var(--vh); }

/* =========================================================
   LOGIN
========================================================= */
.sm-login-screen{
  position:fixed; inset:0;
  background:#f3f4f6;
  display:flex; align-items:center; justify-content:center;
  z-index:99999;
}
.sm-login-card{
  width:360px;
  background:#fff;
  padding:24px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
}
.sm-login-input{
  width:100%;
  padding:10px 12px;
  margin:10px 0;
  border:1px solid rgba(0,0,0,.12);
  border-radius:10px;
}
.sm-msg{ margin-top:10px; text-align:center; font-size:13px; }
.sm-msg-error{ color:#dc2626; }

/* =========================================================
   SIDEBAR
========================================================= */
.sidebar{
  width: var(--sidebar-w);
  position:fixed; left:0; top:0; height:var(--vh);
  background: rgba(205 255 225 / 85%);
  backdrop-filter: blur(6px);
  padding: 10px;
  overflow:auto;
  z-index:20;
  border-right:1px solid rgba(0,0,0,.06);
  box-shadow: 4px 0 20px rgba(0,0,0,.08);
  border-radius: 0 10px 10px 0;
  transition: width .25s ease, padding .25s ease, transform .25s ease;
}

/* minimized sidebar (desktop) */
.sidebar.minimized{
  width:60px;
  padding:10px 6px;
  overflow:hidden;
}
.sidebar.minimized .sidebar-header div,
.sidebar.minimized .brand-title,
.sidebar.minimized .brand-sub,
.sidebar.minimized .sidebar-logo,
.sidebar.minimized .sidebar-menu,
.sidebar.minimized .sidebar-footer{
  display:none;
}

.sidebar-header{
  display:flex; gap:12px; align-items:center;
  margin-bottom:10px;
}
.sidebar-logo{
  width:96px; height:56px; object-fit:cover;
  border-radius:8px;
}
.brand-title{ font-size:18px; font-weight:800; margin:0; }
.brand-sub{ font-size:12px; color:#111; margin-top:2px; }
.sm-btn-compact{ padding:4px 8px !important; }

.sidebar-menu{ list-style:none; padding:0; margin:10px 0 0; }
.sidebar-menu li{
  padding:12px 10px;
  display:flex; gap:10px; align-items:center;
  cursor:pointer;
  border-left:4px solid transparent;
  border-radius:10px;
  transition:all .18s ease;
  color:#222;
}
.sidebar-menu li:hover{
  background: rgba(60,120,200,.06);
  transform: translateX(4px);
  border-left-color: rgba(41,128,185,.8);
}
.menu-link{ font-weight:700; }
.menu-title{
  font-weight:800;
  background: rgba(0,0,0,.05);
}
.menu-title.collapsible{
  display:flex; justify-content:space-between; align-items:center;
}
.menu-title span.arrow{ font-size:12px; transition:transform .2s ease; }
.menu-title.open .arrow{ transform: rotate(180deg); }

.submenu{ padding-left:36px !important; font-size:14px; }
.subgroup{ list-style:none; padding:0; margin:0; display:none; }
.subgroup.open{ display:block; }

.sidebar-footer{ margin-top:16px; font-size:13px; color:var(--muted); }
.admin-only{ display:none; }

/* =========================================================
   MAIN LAYOUT
========================================================= */
.main{
  margin-left: calc(var(--sidebar-w) + 18px);
  padding:18px;
  min-height:var(--vh);
  transition: margin-left .25s ease, padding .25s ease;
}
.sidebar.minimized + .main{ margin-left: 60px; }
body.sm-sidebar-min .main{ margin-left: 60px; }

.sm-logout{
  position:fixed;
  top:10px; right:20px;
  z-index:999;
}

/* =========================================================
   PAGE CONTAINER (normal pages)
========================================================= */
.page{
  background: var(--card);
  border-radius: 12px;
  width:100%;
  min-height: calc(var(--vh) - 40px);
  padding: 20px;
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 6px 25px rgba(0,0,0,.10);
}

/* =========================================================
   FORMS / CARDS (Bootstrap-safe custom)
========================================================= */
.sm-search{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.10);
  width:320px;
  background: rgba(255,255,255,.90);
}
.sm-small{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.12);
  width:220px;
  background: rgba(255,255,255,.95);
}
.sm-card{
  background: var(--card);
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
  border: 1px solid rgba(0,0,0,.04);
  margin-bottom: 12px;
}

/* =========================================================
   TOAST
========================================================= */
#stockToast{
  position:fixed; top:20px; right:20px;
  background:#16a34a; color:#fff;
  padding:10px 20px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.20);
  font-weight:700;
  z-index:10000;
  opacity:0;
  transition:opacity .25s ease;
  display:none;
}
#stockToast.out{ background:#dc2626; }

/* =========================================================
   RM SEARCH DROPDOWN
========================================================= */
.rm-search-wrap{ position:relative; }
.rm-search-input{
  width:100%;
  padding:8px 10px;
  border:1px solid rgba(0,0,0,.15);
  border-radius:10px;
  outline:none;
  background:#fff;
}
.rm-search-dd{
  position:absolute;
  top:calc(100% + 6px);
  left:0; right:0;
  max-height:240px;
  overflow:auto;
  background:#fff;
  border:1px solid rgba(0,0,0,.12);
  border-radius:10px;
  box-shadow:0 10px 20px rgba(0,0,0,.12);
  z-index:9999;
  display:none;
}
.rm-search-item{
  padding:8px 10px;
  cursor:pointer;
  border-bottom:1px solid rgba(0,0,0,.06);
}
.rm-search-item:last-child{ border-bottom:none; }
.rm-search-item:hover{ background:rgba(41,128,185,.10); }
.rm-search-item.active{ background:rgba(41,128,185,.18); font-weight:700; }
.rm-search-empty{ padding:10px; color:var(--muted); font-size:13px; }

/* =========================================================
   SIMPLE MODAL
========================================================= */
.app-modal{ position:fixed; inset:0; z-index:9999; }
.app-modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
.app-modal-box{
  position:relative;
  max-width:950px;
  margin:5vh auto;
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
}
.app-modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #eee;
  margin-bottom:12px;
}
.app-modal-body{ max-height:70vh; overflow:auto; }

/* =========================================================
   CUSTOM BUTTON SKINS (Bootstrap-safe)
========================================================= */
.btn.secondary{
  background:#f3f4f6;
  border:1px solid rgba(0,0,0,.15);
  color:#111;
}
.btn.secondary:hover{ background:#e9edf2; }
.btn.info{
  background:#0ea5e9;
  border:1px solid rgba(0,0,0,.08);
  color:#fff;
}
.btn.info:hover{ filter:brightness(.95); }
.btn.out{
  background:#dc2626;
  border:1px solid rgba(0,0,0,.08);
  color:#fff;
}
.btn.out:hover{ filter:brightness(.95); }

/* =========================================================
   NAV DATE/TIME PILL
========================================================= */
.nav-right{ position:fixed; top:12px; right:120px; z-index:999; }
.nav-datetime{
  display:inline-flex; align-items:center; gap:10px;
  padding:8px 12px;
  border-radius:999px;
  background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.65));
  border:1px solid rgba(0,0,0,.08);
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
  backdrop-filter: blur(8px);
  font-weight:700; font-size:13px; letter-spacing:.2px;
  color:#111; white-space:nowrap; user-select:none;
}
.nav-datetime .dt-date{ font-weight:700; opacity:.85; }
.nav-datetime .dt-dot{
  width:6px; height:6px; border-radius:50%;
  background: var(--accent-2, #2980b9);
  box-shadow: 0 0 0 4px rgba(41,128,185,.15);
}
.nav-datetime .dt-time{ font-weight:800; color: var(--accent, #2c3e50); }

/* =========================================================
   DASHBOARD (Scoped dark theme)
========================================================= */
.dash-wrap{
  --dash-bg: #000;
  --dash-panel: rgba(255,255,255,.06);
  --dash-stroke: rgba(255,255,255,.12);
  --dash-text: rgba(255,255,255,.92);
  --dash-muted: rgba(255,255,255,.70);
  --dash-radius: 18px;
  --dash-shadow: 0 18px 60px rgba(0,0,0,.45);
}

/* Dashboard base colors */
#dashboardPage{
  background: var(--dash-bg) !important;
  color: var(--dash-text) !important;
}

/* Sticky topbar */
#dashboardPage .dash-topbar{
  position: sticky; top:0; z-index:20;
  backdrop-filter: blur(10px);
  background: linear-gradient(to bottom, rgba(0,0,0,.85), rgba(0,0,0,.45));
  border-bottom: 1px solid var(--dash-stroke);
}
#dashboardPage .dash-topbar-inner{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding: 14px 18px;
}
#dashboardPage .dash-title h1{ margin:0; font-size:18px; font-weight:800; }
#dashboardPage .dash-title small{ color: var(--dash-muted); font-size:12px; }

/* Search */
#dashboardPage .dash-search{ flex:1; max-width:520px; position:relative; }
#dashboardPage .dash-search input{
  width:100%;
  padding: 10px 12px 10px 40px;
  border-radius: 999px;
  border:1px solid var(--dash-stroke);
  background: rgba(255,255,255,.06);
  color: var(--dash-text);
  outline:none;
}
#dashboardPage .dash-search input::placeholder{ color: rgba(255,255,255,.45); }
#dashboardPage .dash-search .ico{
  position:absolute; left:14px; top:50%;
  transform: translateY(-50%); opacity:.75;
}

/* User pill */
#dashboardPage .dash-userpill{
  display:flex; align-items:center; gap:10px;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--dash-stroke);
}
#dashboardPage .dash-avatar{
  width: 30px; height: 30px; border-radius: 50%;
  background: linear-gradient(135deg, rgba(124,92,255,.9), rgba(34,197,94,.75));
  box-shadow: 0 10px 20px rgba(0,0,0,.25);
}
#dashboardPage .dash-userpill b{ font-size: 13px; color: var(--dash-text); }
#dashboardPage .dash-userpill span{ color: var(--dash-muted); font-size: 11px; display:block; margin-top:-1px; }

/* Panels + grid */
#dashboardPage .dash-panel{
  border:1px solid var(--dash-stroke);
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
  border-radius: var(--dash-radius);
  box-shadow: var(--dash-shadow);
}
#dashboardPage .dash-panel-head{
  padding: 14px 16px;
  display:flex; align-items:center; justify-content:space-between;
  border-bottom: 1px solid var(--dash-stroke);
}
#dashboardPage .dash-panel-head h2{ margin:0; font-size:14px; font-weight:800; color: var(--dash-text); }
#dashboardPage .dash-panel-head .sub{ color: var(--dash-muted); font-size:12px; }
#dashboardPage .dash-panel-body{ padding: 14px 16px; }

#dashboardPage .dash-grid{
  display:grid;
  grid-template-columns: 1.35fr .65fr;
  gap: 16px;
}
@media (max-width: 980px){
  #dashboardPage .dash-grid{ grid-template-columns: 1fr; }
}

/* KPI cards */
#dashboardPage .dash-kpis{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}
@media (max-width: 980px){ #dashboardPage .dash-kpis{ grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 520px){ #dashboardPage .dash-kpis{ grid-template-columns: 1fr; } }

#dashboardPage .dash-kpi{
  border:1px solid var(--dash-stroke);
  background: rgba(255,255,255,.06);
  border-radius: 16px;
  padding: 14px;
  display:flex; gap: 10px; align-items:flex-start;
}
#dashboardPage .dash-kpi .badge{
  width: 38px; height: 38px;
  border-radius: 12px;
  display:grid; place-items:center;
  background: rgba(124,92,255,.18);
  border:1px solid rgba(124,92,255,.25);
}
#dashboardPage .dash-kpi .badge.green{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.25); }
#dashboardPage .dash-kpi .badge.warn{ background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.25); }
#dashboardPage .dash-kpi .badge.red{ background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.25); }
#dashboardPage .dash-kpi b{ display:block; font-size:18px; font-weight:900; color: var(--dash-text); }
#dashboardPage .dash-kpi small{ color: var(--dash-muted); display:block; margin-top:2px; }
#dashboardPage .dash-kpi .trend{ margin-top: 6px; font-size: 12px; color: rgba(255,255,255,.75); }
#dashboardPage .dash-kpi .trend.up{ color: rgba(34,197,94,.95); }
#dashboardPage .dash-kpi .trend.down{ color: rgba(251,113,133,.95); }

/* Buttons */
#dashboardPage .dash-btn{
  border:1px solid var(--dash-stroke);
  background: rgba(255,255,255,.06);
  color: var(--dash-text);
  padding: 10px 12px;
  border-radius: 14px;
  font-weight: 700;
  font-size: 13px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
}
#dashboardPage .dash-btn:hover{ background: rgba(255,255,255,.10); }
#dashboardPage .dash-btn.primary{
  border-color: rgba(124,92,255,.35);
  background: linear-gradient(135deg, rgba(124,92,255,.70), rgba(124,92,255,.25));
}
#dashboardPage .dash-btn.primary:hover{ filter: brightness(1.05); }

/* List */
#dashboardPage .dash-list{ display:flex; flex-direction:column; gap: 10px; }
#dashboardPage .dash-item{
  display:flex; align-items:flex-start; justify-content:space-between;
  gap: 10px;
  padding: 12px;
  border-radius: 14px;
  border:1px solid var(--dash-stroke);
  background: rgba(255,255,255,.05);
}
#dashboardPage .dash-item .left b{ display:block; font-size:13px; color: var(--dash-text); }
#dashboardPage .dash-item .left small{ color: var(--dash-muted); }

#dashboardPage .dash-pill{
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 11px;
  border: 1px solid var(--dash-stroke);
  background: rgba(255,255,255,.06);
  color: var(--dash-text);
}
#dashboardPage .dash-pill.green{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
#dashboardPage .dash-pill.warn{ border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10); }
#dashboardPage .dash-pill.red{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); }

/* Charts */
#dashboardPage .dash-chartbox{ height: 280px; }
#dashboardPage .dash-chartbox canvas{ width:100% !important; height:100% !important; }

/* =========================================================
   ‚úÖ DASHBOARD FULL SCREEN MODE (only when class exists)
   Add JS: document.body.classList.toggle('sm-on-dashboard', pageId==='dashboardPage')
========================================================= */
body.sm-on-dashboard .main{
  padding: 0 !important;
}

body.sm-on-dashboard #dashboardPage{
  width: 100%;
  height: var(--vh) !important;
  min-height: var(--vh) !important;
  padding: 0 !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  border: none !important;
  overflow: hidden;
}

/* Dashboard container scroll */
body.sm-on-dashboard #dashboardPage .dash-container{
  height: calc(var(--vh) - 64px);
  overflow: auto;
  padding: 16px;
  max-width: 1280px;
  margin: 0 auto;
}

/* Keep topbar height fixed */
body.sm-on-dashboard #dashboardPage .dash-topbar,
body.sm-on-dashboard #dashboardPage .dash-topbar-inner{
  height: 64px;
}

/* =========================================================
   ‚úÖ RESPONSIVE SIDEBAR: overlay on mobile
========================================================= */
@media (max-width: 768px){
  .main{ margin-left: 0 !important; }

  .sidebar{
    transform: translateX(-100%);
    border-radius: 0 12px 12px 0;
  }
  body.sm-sidebar-open .sidebar{
    transform: translateX(0);
  }

  body.sm-on-dashboard #dashboardPage{
    width: 100% !important;
  }
}

/* =========================================================
   PRINT
========================================================= */
@media print{
  body{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
}
.sm-modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.sm-modal-card{
  width:min(950px,95vw);
  max-height:85vh;
  overflow:auto;
  background:#fff;
  border-radius:14px;
  padding:14px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
}

</style>

</head>

<body>

<!-- =========================
     LOGIN SCREEN
========================= -->
<div id="loginScreen" class="sm-login-screen">
  <div class="sm-login-card">
    <h2 class="text-center mb-3">Stock Manager</h2>

    <div id="loginForm">
      <input id="loginUser" class="sm-login-input" placeholder="Username">
      <input id="loginPass" class="sm-login-input" type="password" placeholder="Password">
      <button class="btn btn-primary w-100" onclick="login()">Login</button>

      <p class="text-center mt-3 mb-2">
        Don't have an account?
        <span class="sm-link" onclick="showSignup()">Sign Up</span>
      </p>

      <p class="text-center mb-2">
        <span class="sm-link" onclick="forgotPassword()">Forgot Password?</span>
      </p>

      <p id="loginMsg" class="sm-msg sm-msg-error"></p>
    </div>

    <div id="signupForm" style="display:none">
      <input id="signupUser" class="sm-login-input" placeholder="Username">
      <input id="signupPass" class="sm-login-input" type="password" placeholder="Password">
      <select id="signupRole" class="form-select mb-2">
        <option value="user">User</option>
      </select>
      <button class="btn btn-success w-100" onclick="signup()">Create Account</button>

      <p class="text-center mt-3 mb-0">
        Already have an account?
        <span class="sm-link" onclick="showLogin()">Login</span>
      </p>

      <p id="signupMsg" class="sm-msg sm-msg-error"></p>
    </div>
  </div>
</div>

<!-- =========================
     APP
========================= -->
<div class="app">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img id="brandBanner" src="banner.png" class="sidebar-logo" onerror="this.style.display='none'">
      <div>
        <div class="brand-title">STOCK</div>
        <div class="brand-sub">Inventory ‚Ä¢ Public Sheet</div>
      </div>
      <button id="sidebarToggle" class="btn btn-outline-secondary sm-btn-compact" type="button">‚Üê</button>
    </div>

    <ul class="sidebar-menu" id="menu">

      <li id="usersMenu" class="menu-title collapsible" data-perm="users:manage">
  Users <span class="arrow">‚ñæ</span>
</li>
<ul class="subgroup" data-perm="users:manage">
  <li class="submenu" data-page="userManagement" data-perm="users:manage">Manage Users</li>
</ul>

<li class="menu-link" data-page="dashboardPage" data-perm="dashboard:view">Dashboard</li>

      <li class="menu-title collapsible">Purchase <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="billEntry" data-perm="boe:view">Goods Received Note</li>
<li class="submenu" data-page="suppliers" data-perm="dn:view">RM Suppliers </li>
 </ul>

      <li class="menu-title collapsible">Store <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="rmAddProduct" data-perm="rm:add">Add Product</li>
<li class="submenu" data-page="products" data-perm="rm:view">Stock Ledger</li>
<li class="submenu" data-page="stockIn"  data-perm="rm:stockin">Physical Entry In</li>
<li class="submenu" data-page="stockOut" data-perm="rm:stockout">Physical Entry Out</li>
<li class="submenu" data-page="rmDeliveryNote" data-perm="dn:view">Delivery Note</li>

      </ul>

      <li class="menu-title collapsible">Finished Goods <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
       <li class="submenu" data-page="fgAddProduct" data-perm="fg:add">Add Product</li>
        <li class="submenu" data-page="fgStock"    data-perm="fg:view">Stock Ledger</li>
<li class="submenu" data-page="fgStockIn"  data-perm="fg:stockin">Physical Entry In</li>
<li class="submenu" data-page="fgStockOut" data-perm="fg:stockout">Physical Entry Out</li>
    </ul>

      <li class="menu-title collapsible">Manufacture <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
<li class="submenu" data-page="productionAuto" data-perm="prod:view">Production Entry</li>
        <li class="submenu" data-page="pageProductionRecords">Saved Production</li>
      </ul>

      <li class="menu-title collapsible">Report <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
<li class="submenu" data-page="history" data-perm="rm:history:view">RM History</li>
        <li class="submenu" data-action="importExcel">Import Excel</li>
        <li class="submenu" data-action="exportExcel">Export Excel</li>
        <li class="submenu" data-action="printStockReport">Print RM Stock Report</li>
        <li class="submenu" data-action="printFGStockReport">Print FG Stock Report</li>
        <li class="submenu" data-action="exportPDF">Export PDF</li>
<li class="submenu" data-page="auditPage" data-perm="audit:view">Audit Trail</li>

      </ul>

      <div class="sidebar-footer">Data stored locally; cloud optional.</div>
    </ul>
  </aside>

  <!-- MAIN -->
  <main class="main">
<div class="nav-right">
  <div id="navDateTime" class="nav-datetime" title="Current date & time"></div>
</div>

    <button onclick="logout()" class="btn btn-danger sm-logout">Logout</button>

    <!-- USER MANAGEMENT -->
    <section id="userManagement" class="page" style="display:none">
      <h2>Manage Users</h2>
      <div class="table-responsive">
        <table id="usersTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Username</th><th>Role/Permission</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-2">
        <input id="newUsername" class="form-control" style="max-width:260px" placeholder="Username">
        <input id="newPassword" class="form-control" style="max-width:260px" type="password" placeholder="Password">
        <select id="newRole" class="form-select" style="max-width:220px">
  <option value="viewer">Viewer</option>
  <option value="store">Store</option>
  <option value="production">Production</option>
  <option value="manager">Manager</option>
  <option value="power">Power</option>
  <option value="admin">Admin</option>
</select>

        <button class="btn btn-primary admin-only" onclick="addUser()">Add User</button>
      </div>
    </section>

    <!-- MAIN DASHBOARD -->
   <!-- ‚úÖ NEW DASHBOARD -->
<section id="dashboardPage" class="page dash-wrap" style="display:none;">

  
  <!-- Topbar -->
  <div class="dash-topbar">
    <div class="dash-topbar-inner">
      <div class="dash-title">
        <h1>Stock Manager</h1>
        <small id="dashSubtitle">Live inventory overview</small>
      </div>

      <div class="dash-search d-none d-md-block">
        <span class="ico">üîé</span>
        <input id="dashSearch" placeholder="Search RM / FG / Supplier..." />
      </div>

      <div class="dash-userpill">
        <div class="dash-avatar"></div>
        <div>
          <b id="dashUser">User</b>
          <span id="dashRole">role</span>
        </div>
      </div>
    </div>
  </div>

  <div class="dash-container">
    
    <!-- KPI Row -->
    <div class="dash-kpis mb-3">
      <div class="dash-kpi">
        <div class="badge">üì¶</div>
        <div>
          <b id="kpiRmItems">0</b>
          <small>RM Items</small>
          <div class="trend up" id="kpiRmTrend">+0 today</div>
        </div>
      </div>

      <div class="dash-kpi">
        <div class="badge green">üè≠</div>
        <div>
          <b id="kpiFgItems">0</b>
          <small>FG Items</small>
          <div class="trend up" id="kpiFgTrend">+0 today</div>
        </div>
      </div>

      <div class="dash-kpi">
        <div class="badge warn">‚ö†Ô∏è</div>
        <div>
          <b id="kpiLowStock">0</b>
          <small>Low Stock</small>
          <div class="trend" id="kpiLowHint">Needs attention</div>
        </div>
      </div>

      <div class="dash-kpi">
        <div class="badge red">üßæ</div>
        <div>
          <b id="kpiDocsToday">0</b>
          <small>Docs Today</small>
          <div class="trend" id="kpiDocsHint">BOE / DN / PROD</div>
        </div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="dash-grid">

      <!-- Left: Chart + recent movements -->
      <div class="dash-panel">
        <div class="dash-panel-head">
          <div>
            <h2>Stock Movement (Last 14 days)</h2>
            <div class="sub">IN vs OUT overview</div>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="dash-btn" onclick="openPage?.('billEntry')">‚ûï GRN</button>
            <button class="dash-btn" onclick="openPage?.('rmDeliveryNote')">‚ûñ Delivery Note</button>
            <button class="dash-btn primary" onclick="openPage?.('productionAuto')">üè≠ Production</button>
          </div>
        </div>
        <div class="dash-panel-body">
          <div class="dash-chartbox">
            <canvas id="dashMoveChart"></canvas>
          </div>

          <div style="height:12px"></div>

          <div class="dash-panel dash-panel-inner" style="box-shadow:none;">
            <div class="dash-panel-head" style="border-bottom:1px solid var(--stroke);">
              <div>
                <h2>Recent Activity</h2>
                <div class="sub">Latest movements and documents</div>
              </div>
              <button class="dash-btn" onclick="openPage?.('moves')">View all</button>
            </div>
            <div class="dash-panel-body">
              <div id="dashRecentList" class="dash-list">
                <!-- JS will render items here -->
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Right: Alerts + quick stats -->
      <div style="display:flex; flex-direction:column; gap:16px;">

        <div class="dash-panel">
          <div class="dash-panel-head">
            <div>
              <h2>Low Stock Alerts</h2>
              <div class="sub">Top priority items</div>
            </div>
            <button class="dash-btn" onclick="openPage?.('products')">Open RM</button>
          </div>
          <div class="dash-panel-body">
            <div id="dashLowStockList" class="dash-list">
              <!-- JS will render alerts here -->
            </div>
          </div>
        </div>

        <div class="dash-panel">
          <div class="dash-panel-head">
            <div>
              <h2>Quick Actions</h2>
              <div class="sub">One click navigation</div>
            </div>
          </div>
          <div class="dash-panel-body" style="display:grid; gap:10px;">
            <button class="dash-btn" onclick="openPage('history')">View all</button>

<button class="dash-btn primary" onclick="openPage('products')">üì¶ RM Items</button>
<button class="dash-btn primary" onclick="openPage('fgStock')">üè≠ FG Items</button>
<button class="dash-btn" onclick="openPage('suppliers')">üë§ Suppliers</button>
<button class="dash-btn" onclick="openPage('history')">üìä Reports</button>
        </div>
        </div>

      </div>

    </div>

  </div>
</section>

    
    <!-- RM PRODUCTS -->
    <section id="products" class="page" style="display:none">
      <h2>Raw Material List</h2>

      <div class="mb-3 d-flex gap-2 flex-wrap">
        <input id="productSearch" class="sm-search" placeholder="Search products...">
        <button class="btn btn-outline-secondary" onclick="refreshAll()">Refresh</button>
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="productsTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>#</th><th>Code</th><th>Name</th><th>Category</th><th>Balance</th>
            <th>Threshold</th><th>Barcode</th><th>History</th><th>Edit</th><th>Delete</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADD RM PRODUCT -->
    <section id="rmAddProduct" class="page" style="display:none">
      <h2>Add Raw Material Product</h2>

      <div class="d-flex gap-2 flex-wrap mb-3">
        <input id="newCode" class="sm-small" placeholder="Product Code">
        <input id="newName" class="sm-small" placeholder="Product Name">
        <input id="newCategory" class="sm-small" placeholder="Category">
        <input id="newThreshold" class="sm-small" type="number" placeholder="Low Stock Threshold">
        <input id="newBarcode" class="sm-small" placeholder="Barcode">
        <input id="newGroups" class="sm-small" placeholder="Groups (comma separated)">
        <input id="newQtyPerFG" class="sm-small" type="number" step="0.0001" placeholder="Qty per FG (BOM)">
        <label class="d-flex align-items-center gap-2">
          <input type="checkbox" id="newExclusive"> Exclusive to first group
        </label>
      </div>

<button class="btn btn-primary" onclick="addRMProduct()" data-perm="rm:add">Add Product</button>
    </section>

    <!-- STOCK IN -->
    <section id="stockIn" class="page" style="display:none">
      <h2>RM Stock In</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="inSearch" class="sm-search" placeholder="Search product">
        <button class="btn btn-outline-secondary" onclick="stockInHistoryModal()">View Stock IN History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle" id="stockInBody">
          <thead class="table-light">
          <tr><th>Product Code</th><th>Product Name</th><th>Balance</th><th>Last IN</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- STOCK OUT -->
    <section id="stockOut" class="page" style="display:none">
      <h2>RM Stock Out</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="outSearch" class="sm-search" placeholder="Search product">
        <button class="btn btn-info" onclick="stockOutHistoryModal()">View Stock OUT History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle" id="stockOutBody">
          <thead class="table-light">
          <tr><th>Product Code</th><th>Product Name</th><th>Balance</th><th>Last OUT</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- COMBINED HISTORY -->
    <section id="history" class="page" style="display:none">
      <h2>RM Combined History</h2>
      <div class="mb-3">
        <input id="historySearch" class="sm-search" placeholder="Search combined history...">
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="historyTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr><th>Date</th><th>Product</th><th>Type</th><th>Qty</th><th>Remark</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
<!-- ‚úÖ STOCK IN HISTORY MODAL (GLOBAL) -->
<div id="stockInHistoryModal" class="sm-modal" style="display:none">
  <div class="sm-modal-card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="m-0">Stock IN History</h5>
      <button class="btn btn-sm btn-outline-secondary" onclick="closeStockInHistory()">Close</button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Product</th>
            <th class="text-end">Qty</th>
            <th>Remark</th>
          </tr>
        </thead>
        <tbody id="stockInHistoryPopupBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚úÖ STOCK OUT HISTORY MODAL (GLOBAL) -->
<div id="stockOutHistoryModal" class="sm-modal" style="display:none">
  <div class="sm-modal-card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="m-0">Stock OUT History</h5>
      <button class="btn btn-sm btn-outline-secondary" onclick="closeStockOutHistory()">Close</button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Product</th>
            <th class="text-end">Qty</th>
            <th>Remark</th>
          </tr>
        </thead>
        <tbody id="stockOutHistoryPopupBody"></tbody>
      </table>
    </div>
  </div>
</div>

    <!-- SUPPLIERS -->
    <section id="suppliers" class="page" style="display:none">
      <h2>Raw Material Suppliers</h2>

      <form id="supplierForm" class="d-flex gap-2 flex-wrap align-items-center mb-3" autocomplete="on">
        <div>
          <input id="newSupplierName" class="sm-small form-control" type="text" placeholder="Supplier Name" required>
        </div>
        <div>
          <input id="newSupplierContact" class="sm-small form-control" type="text" placeholder="Address Info">
        </div>
        <div>
          <input id="newSupplierPhone" class="sm-small form-control" type="tel" placeholder="Phone">
        </div>
        <div>
          <input id="newSupplierEmail" class="sm-small form-control" type="email" placeholder="Email">
        </div>
        <button id="addSupplierBtn" type="submit" class="btn btn-primary">Add Supplier</button>
      </form>

      <div class="mb-3">
        <input id="supplierSearch" class="sm-search form-control" type="search" placeholder="Search suppliers..." autocomplete="off">
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="suppliersTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Name</th><th>Address</th><th>Phone</th><th>Email</th><th>Edit</th><th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
<section id="auditPage" class="page" style="display:none">
  <h2>Audit Trail</h2>

  <div class="d-flex gap-2 flex-wrap mb-2">
    <input id="auditSearch" class="sm-search" placeholder="Search action / user / id...">
    <button class="btn btn-outline-secondary" onclick="renderAudit()">Refresh</button>
    <button class="btn btn-outline-danger" onclick="clearAudit()">Clear Log</button>
  </div>

  <div class="table-responsive" style="max-height:65vh">
    <table class="table table-sm table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Date & Time</th>
          <th>User</th>
          <th>Action</th>
          <th>Entity</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="auditBody"></tbody>
    </table>
  </div>
</section>

    <!-- FG STOCK LIST -->
    <section id="fgStock" class="page" style="display:none">
      <h2>Finished Goods Stock</h2>
      <div class="d-flex gap-2 flex-wrap mb-3">
        <input id="fgSearch" class="sm-search" placeholder="Search FG products / Product Code / Volume...">
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="fgTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Product Code</th>
            <th>Barcode</th>
            <th>Product</th>
            <th>Volume</th>
            <th>Balance</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADD FG PRODUCT -->
    <section id="fgAddProduct" class="page" style="display:none">
      <h2>Add Finished Goods Product</h2>

      <div class="d-flex gap-2 flex-wrap mb-3">
        <input id="fgNewProductcode" class="sm-small" placeholder="Product Code">
        <input id="fgNewBarcode" class="sm-small" placeholder="Barcode">
        <input id="fgNewName" class="sm-small" placeholder="Product Name">
        <input id="fgNewVolume" class="sm-small" placeholder="Volume / Size">
        <input id="fgNewGroup" class="sm-small" placeholder="Group Prefix (ALKHOR)">
        <input id="fgNewBatch" class="sm-small" placeholder="Batch / Lot No">
        <input id="fgNewExpiry" class="sm-small" type="date">
        <input id="fgNewThreshold" class="sm-small" type="number" placeholder="Low Stock Threshold">
      </div>

      <button class="btn btn-primary" onclick="addFGProduct()">Add FG Product</button>
    </section>

    <!-- FG STOCK IN -->
    <section id="fgStockIn" class="page" style="display:none">
      <h2>FG Stock In</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="fgInSearch" class="sm-search" placeholder="Search FG product...">
        <button class="btn btn-outline-secondary" onclick="fgStockInHistoryModal()">View FG IN History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr><th>#</th><th>Product Code</th><th>Product</th><th>Balance</th><th>Action</th></tr>
          </thead>
          <tbody id="fgStockInBody"></tbody>
        </table>
      </div>
    </section>

    <!-- FG STOCK OUT -->
    <section id="fgStockOut" class="page" style="display:none">
      <h2>FG Stock Out</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="fgOutSearch" class="sm-search" placeholder="Search FG product...">
        <button class="btn btn-info" onclick="fgStockOutHistoryModal()">View FG OUT History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr><th>#</th><th>Product Code</th><th>Product</th><th>Balance</th><th>Action</th></tr>
          </thead>
          <tbody id="fgStockOutBody"></tbody>
        </table>
      </div>
    </section>

    <!-- BILL OF ENTRY -->
    <section id="billEntry" class="page" style="display:none;">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h2 class="m-0">Goods Received Note</h2>
          <div class="text-muted small">Create, manage and print Bill of Entry (BOE)</div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-secondary" onclick="boeTriggerImport()">üì• Import Excel</button>
          <button class="btn btn-success" onclick="printBOESummaryReport()">üñ®Ô∏è Bills Summary</button>
        </div>
      </div>

      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white d-flex align-items-center justify-content-between">
          <div class="fw-bold">Create / Edit Bill of Entry</div>
          <span id="boeEditBadge" class="badge text-bg-success" style="display:none;">EDITING MODE</span>
        </div>

        <div class="card-body">
          <input id="boeFileInput" type="file" accept=".xlsx,.xls" class="d-none">

          <div class="row g-2 mb-3">
            <div class="col-12 col-md-6">
              <input id="boeNo" class="form-control" placeholder="Bill No / Entry No">
            </div>
            <div class="col-12 col-md-6">
              <input id="boeDate" type="date" class="form-control">
            </div>
            <div class="col-12 col-md-6">
              <select id="boeSupplier" class="form-select"></select>
            </div>
            <div class="col-12 col-md-6">
              <input id="boeSupplierOther" class="form-control" placeholder="Supplier Name (if Other)" style="display:none">
            </div>
          </div>

          <div class="border rounded-3">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>RM Product</th>
                  <th style="width:120px">Qty</th>
                  <th>Remark</th>
                  <th class="text-center" style="width:110px">Remove</th>
                </tr>
              </thead>
              <tbody id="boeItemsBody"></tbody>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-outline-primary" onclick="boeAddRow()">‚ûï Add Item</button>
            <button class="btn btn-primary" onclick="submitBillEntry()">‚úÖ Save Bill & Stock IN</button>
            <button class="btn btn-danger" onclick="resetBillEntryForm()">Clear</button>
          </div>

          <div class="text-muted small mt-2">
            Tip: Add multiple items then save once to stock-in all at the same time.
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <div class="fw-bold">Saved Bills</div>
          <input id="boeSearch" class="form-control" style="max-width:320px" placeholder="Search bill / supplier...">
        </div>

        <div class="card-body p-0">
          <div class="table-responsive" style="max-height:55vh; overflow:auto;">
            <table id="boeTable" class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th>Date</th>
                  <th>Product Code</th>
                  <th>Bill No</th>
                  <th>Product Name</th>
                  <th>Supplier</th>
                  <th class="text-end">Total Qty</th>
                  <th class="text-center">Items</th>
                  <th style="min-width:240px">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-white text-muted small">
          Tip: Use search to filter bills instantly.
        </div>
      </div>
    </section>

    <!-- PRODUCTION ENTRY -->
    <section class="page" id="productionAuto" style="display:none">
      <div class="sm-card d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div>
          <div class="h5 mb-1 fw-semibold">Production Entry</div>
          <div class="text-muted small">FG IN + RM OUT, with optional RM Damage.</div>
        </div>
        <div class="small text-muted">Tip: Search FG ‚Üí enter Qty ‚Üí check BOM ‚Üí Save</div>
      </div>

      <div class="sm-card">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Production No</label>
            <input id="prodNo" class="form-control" placeholder="PROD-001">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Date</label>
            <input id="prodDate" type="date" class="form-control">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">FG Product</label>
            <div class="position-relative" id="prodFGWrap">
              <input id="productionFGSearch" class="form-control" placeholder="Search FG..." autocomplete="off">
              <div id="prodFGList" class="list-group position-absolute w-100 shadow"
                   style="z-index:2000; max-height:260px; overflow:auto; display:none;"></div>
              <select id="prodFG" class="d-none"></select>
            </div>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label fw-semibold">FG Qty</label>
            <input id="prodFGQty" type="number" class="form-control text-end" min="0" step="0.01" value="1">
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Production Remark (optional)</label>
            <input id="prodRemark" class="form-control" placeholder="Batch / Operator / Shift...">
          </div>
        </div>
      </div>

      <div class="sm-card">
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-2">
          <div class="fw-semibold">BOM Consumption <span class="text-muted fw-normal">(FG BOM √ó FG Qty)</span></div>
          <div class="text-muted small">Damage is added to usage.</div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="min-width:240px">RM Product</th>
                <th class="text-end" style="min-width:120px">Required</th>
                <th class="text-end" style="min-width:140px">Damage</th>
                <th class="text-end" style="min-width:120px">Net Used</th>
                <th class="text-muted small">Balance</th>
              </tr>
            </thead>
            <tbody id="prodBOMBody">
              <tr><td colspan="5" class="text-muted">Select FG to load BOM.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="sm-card d-flex justify-content-end gap-2 flex-wrap">
        <button class="btn btn-outline-secondary" type="button" onclick="resetProductionForm()">Reset</button>
        <button class="btn btn-primary" type="button" onclick="submitProduction()">Save Production</button>
      </div>
    </section>

    <!-- PRODUCTION RECORDS -->
    <section class="page" id="pageProductionRecords" style="display:none">
      <div class="sm-card">
        <b>Production Records</b>
        <div class="muted">View production entries and their RM Used/Damage.</div>
      </div>

      <div class="sm-card" style="overflow:auto">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th>Date</th><th>Prod No</th><th>FG</th><th class="text-end">FG Qty</th>
              <th class="text-end">RM Lines</th><th>Created By</th><th>Actions</th>
            </tr>
            </thead>
            <tbody id="prodTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RM DELIVERY NOTE -->
    <section id="rmDeliveryNote" class="page" style="display:none">
      <h2>RM Delivery Note (Warehouse ‚Üí Factory)</h2>

<div class="d-flex flex-column gap-3 align-items-stretch">

        <div class="sm-card" style="flex:1;min-width:320px">
          <h3 class="mb-2">Create Delivery Note</h3>

        <div class="d-flex gap-2 flex-wrap mb-2">
  <input id="dnNo" class="sm-small" placeholder="Delivery Note No">
  <input id="dnDate" class="sm-small" type="date">
  <input id="dnFrom" class="sm-small" placeholder="From (Warehouse)" value="Main Store">
  <input id="dnTo" class="sm-small" placeholder="To (Factory)" value="Factory">
  <input id="dnPlan" class="sm-small" placeholder="Production Plan (optional)">
  <input id="dnProdRef" class="sm-small" placeholder="Production Ref (optional)">
</div>


          <div class="mb-2">
            <input id="dnRemark" class="sm-search" placeholder="General Remark (optional)">
          </div>

          <div >
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
              <tr>
  <th style="min-width:240px">RM Product</th>
  <th style="width:120px">Qty</th>
  <th>Remark</th>
  <th style="width:80px">Remove</th>
</tr>

              </thead>
              <tbody id="dnItemsBody"></tbody>
            </table>
          </div>

          <div class="d-flex gap-2 flex-wrap mt-2">
            <button class="btn btn-outline-secondary" onclick="dnAddRow()">‚ûï Add Item</button>
            <button class="btn btn-primary" onclick="submitDeliveryNote()">‚úÖ Save Delivery Note</button>
            <button class="btn btn-danger" onclick="resetDeliveryNoteForm()">Clear</button>
          </div>
        </div>

        <div class="sm-card" style="flex:1;min-width:320px">
          <h3 class="mb-2">Saved Delivery Notes</h3>
          <input id="dnSearch" class="sm-search mb-2" placeholder="Search DN no / remark...">

          <div class="table-responsive border rounded-3" style="max-height:520px">
            <table id="dnTable" class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
              <tr><th>Date</th><th>DN No</th><th>To</th><th>Items</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- DN VIEW MODAL -->
    <div id="dnViewModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <div>
            <div id="dnViewTitle" style="font-weight:700;font-size:16px;">Delivery Note</div>
            <div id="dnViewMeta" style="font-size:12px;color:#666;margin-top:4px;"></div>
          </div>
          <button type="button" class="btn out" onclick="closeDNView()" style="padding:6px 10px;">Close</button>
        </div>

        <div style="padding:12px 14px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <button type="button" class="btn secondary" onclick="printDNFromModal()">Print</button>
          </div>

          <div style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:10px;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:#f7f7f7;">
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">RM Product</th>
                  <th style="text-align:right;padding:10px;border-bottom:1px solid #eee;width:120px;">Qty</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Remark</th>
                </tr>
              </thead>
              <tbody id="dnViewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALS (History / Stock Modal) -->
    <div id="historyModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(980px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <h3 id="modalTitle" style="margin:0;font-size:16px;">History</h3>
          <button class="btn out" onclick="closeHistoryModal()" style="padding:6px 10px;">Close</button>
        </div>
        <div style="padding:12px 14px; max-height:70vh; overflow:auto;">
          <table class="table table-sm">
            <thead class="table-light">
              <tr>
                <th>Date</th><th>Product</th><th>Type</th><th>Qty</th><th>Batch</th><th>Expiry</th><th>Remark</th>
              </tr>
            </thead>
            <tbody id="modalHistoryBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="stockModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(520px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <h3 id="modalProductName" style="margin:0;font-size:16px;">Product</h3>
          <button class="btn out" onclick="closeStockModal()" style="padding:6px 10px;">Close</button>
        </div>
        <div style="padding:12px 14px;">
          <p class="mb-2">Balance: <span id="modalProductBalance" class="fw-bold">0</span></p>
          <div class="d-flex gap-2 flex-wrap">
            <input id="modalQty" class="form-control" type="number" placeholder="Enter quantity">
            <input id="modalRemark" class="form-control" placeholder="Enter remark (optional)">
          </div>
          <div class="d-flex gap-2 mt-3">
            <button id="modalSave" class="btn btn-primary">Submit</button>
            <button onclick="closeStockModal()" class="btn btn-outline-secondary">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GENERIC APP MODAL -->
    <div id="modal" class="app-modal" style="display:none">
      <div class="app-modal-backdrop" onclick="closeModal()"></div>
      <div class="app-modal-box">
        <div class="app-modal-header">
          <h5 id="modalTitle2">Modal</h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="closeModal()">‚úñ</button>
        </div>
        <div id="modalBody" class="app-modal-body"></div>
      </div>
    </div>

    <!-- BOE VIEW MODAL -->
    <div id="boeViewModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <div>
            <div id="boeViewTitle" style="font-weight:700;font-size:16px;">Bill of Entry</div>
            <div id="boeViewMeta" style="font-size:12px;color:#666;margin-top:4px;"></div>
          </div>
          <button type="button" class="btn out" onclick="BOE.closeView()" style="padding:6px 10px;">Close</button>
        </div>

        <div style="padding:12px 14px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <button type="button" class="btn secondary" onclick="BOE.printFromView()">Print</button>
            <button type="button" class="btn secondary" onclick="BOE.editFromView()">Edit</button>
          </div>

          <div style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:10px;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:#f7f7f7;">
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">RM Product</th>
                  <th style="text-align:right;padding:10px;border-bottom:1px solid #eee;width:120px;">Qty</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Remark</th>
                </tr>
              </thead>
              <tbody id="boeViewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="stockToast"></div>

  </main>
</div>


<script>
/* =========================
   ‚úÖ GLOBALS
========================= */
let selectedFGVolumes = new Set();
let currentUser = null;
let fgChartInstance = null;

const loginScreen = document.getElementById('loginScreen');
const loginForm   = document.getElementById('loginForm');
const signupForm  = document.getElementById('signupForm');
const loginMsg    = document.getElementById('loginMsg');
const signupMsg   = document.getElementById('signupMsg');

/* =========================
   ‚úÖ FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBTtsOeQTpPwTEn_T9EDqt5i_0eyQuzGOA",
  authDomain: "stock-manager-703e6.firebaseapp.com",
  databaseURL: "https://stock-manager-703e6-default-rtdb.firebaseio.com",
  projectId: "stock-manager-703e6",
  storageBucket: "stock-manager-703e6.firebasestorage.app",
  messagingSenderId: "778548519096",
  appId: "1:778548519096:web:716f903fee993f4d85544d",
  measurementId: "G-G735N8XCQ2"
};

firebase.initializeApp(firebaseConfig);
const cloudDB = firebase.database();
window.cloudDB = cloudDB;
const CLOUD_PATH_RM = "stockManager/v1";
/* =========================
   ‚úÖ UTILITIES
========================= */
function genId(){ return 'id_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000); }
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function fmtDate(iso){
  if(!iso) return '-';
  const p = String(iso).split('-');
  if(p.length !== 3) return String(iso);
  return `${p[2]}/${p[1]}/${p[0]}`;
}
function escapeHtml(s){
  if(s == null) return '';
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
function normalizeGroup(g){
  return String(g || '').trim().toUpperCase().replace(/\s+/g,'');
}
function showToast(message, isError=false){
  const toast = document.getElementById('stockToast');
  if(!toast) return;
  toast.textContent = message;
  toast.classList.toggle('out', isError);
  toast.style.display = 'block';
  requestAnimationFrame(()=> toast.style.opacity = '1');
  setTimeout(()=>{
    toast.style.opacity = '0';
    setTimeout(()=> toast.style.display='none', 300);
  }, 2000);
}

/* =========================
   ‚úÖ OPTIONAL: FIX bannerUrl template issue
   (If you ever used src="${bannerUrl}" it won't work in HTML.)
========================= */
function setBanner(url){
  const img = document.getElementById('brandBanner');
  if(img) img.src = url || 'banner.png';
  // set background watermark
  document.body.style.setProperty('--banner-url', url || 'banner.png');
}
setBanner('banner.png');


function isUserTypingInForms(){
  const el = document.activeElement;
  if(!el) return false;

  // If cursor is inside any of these forms, DO NOT re-render/reset them
  const inForms = el.closest('#rmDeliveryNote, #billEntry, #productionAuto');
  const isField = el.matches('input, textarea, select');

  return !!(inForms && isField);
}

/* =========================
   ‚úÖ PAGE NAV
========================= */
function openPage(pageId){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const el = document.getElementById(pageId);
  if(el) el.style.display='block';

  // page-specific renders
  if(pageId === 'dashboardPage'){
    renderMainDashboard();
   
  }
  if(pageId === 'dashboard'){
    renderDashboardGrouped();
  }
if(pageId === 'suppliers'){
  initSuppliersUI?.();
  autoPullSuppliersFromCloud?.();   // optional but helpful
  renderSuppliers?.();
}
  if(pageId === 'pageProductionRecords'){
    renderProductionsTable();
  }

if(pageId === 'productionEntry'){
  renderProdFGDropdown();
  if(!document.getElementById('prodDate').value) document.getElementById('prodDate').value = todayISO();

  if(!document.getElementById('prodRMBody').children.length) prodAddRMRow();
  if(!document.getElementById('prodRMReturnBody').children.length) prodAddRMReturnRow();

  renderProductionsTable();
  setAutoProductionNo();      
}
if(pageId === 'billEntry'){
  renderBOESupplierDropdown();
  if(!document.getElementById('boeDate').value) document.getElementById('boeDate').value = todayISO();

  // ‚úÖ AUTO BOE NUMBER
  setAutoBOENo(false);

  if(!document.getElementById('boeItemsBody').children.length) boeAddRow();
  BOE.renderTable();
}

if(pageId === 'productionAuto'){
  renderProdFGDropdown();
  renderBOM();

  // ‚úÖ AUTO PRODUCTION NUMBER
  if(!document.getElementById('prodDate').value) document.getElementById('prodDate').value = todayISO();
  setAutoPRODNo(false);
}

if(pageId === 'rmDeliveryNote'){
  if(!document.getElementById('dnDate').value) document.getElementById('dnDate').value = todayISO();

  // ‚úÖ AUTO DN NUMBER
  setAutoDNNo(false);

  if(!document.getElementById('dnItemsBody').children.length) dnAddRow();
  renderDNTable();
}

if(pageId === 'auditPage') renderAudit();

RBAC.applyUI();


  refreshAll();
}

/* =========================
   ‚úÖ ADMIN DEFAULT USER
========================= */
const DEFAULT_ADMIN = {
  username: "admin",
  password: "admin123",
  role: "admin",
  permissionLevel: "full",
  createdAt: new Date().toISOString()
};

async function ensureAdminExists(){
  try{
    // ‚úÖ check by username "admin" (most reliable)
    const snap = await cloudDB.ref('users')
      .orderByChild('username')
      .equalTo('admin')
      .once('value');

    if(!snap.exists()){
      const userId = 'admin_' + Date.now().toString(36);
      await cloudDB.ref('users/' + userId).set({
        username: "admin",
        password: "admin123",
        role: "admin",
        permissionLevel: "full",
        createdAt: new Date().toISOString()
      });
      console.log("‚úÖ Default admin created");
    }
  }catch(err){
    console.error("‚ùå ensureAdminExists error:", err);
  }
}
ensureAdminExists();


/* =========================
   ‚úÖ ROLE PERMISSIONS (ADMIN ALWAYS FULL POWER)
========================= */
const ROLE_PERMISSIONS = {
  full: { stockIn:true, stockOut:true,  add:true,  edit:true,  delete:true },
  half: { stockIn:true, stockOut:true, add:true,  edit:true,  delete:false },
  view: { stockIn:true, stockOut:true, add:false, edit:false, delete:false }
};

function getPerms(){
  if(currentUser?.role === 'admin') return ROLE_PERMISSIONS.full;
  return ROLE_PERMISSIONS[currentUser?.permissionLevel] || ROLE_PERMISSIONS.view;
}
function canStockOut(){ return !!getPerms().stockOut; }
function canAdd(){ return !!getPerms().add; }
function canEdit(){ return !!getPerms().edit; }
function canDelete(){ return !!getPerms().delete; }

function showAdminUI(){
  const isAdmin = currentUser?.role === 'admin';
  document.querySelectorAll('.admin-only').forEach(el=>{
    el.style.display = isAdmin ? '' : 'none';
  });
}

/* =========================================================
   ‚úÖ RBAC v2 (Admin + Power User + roles)
========================================================= */

const RBAC = (() => {
  const ROLE = {
    admin: ["*"],

    power: [
      "dashboard:view",

      "rm:view","rm:add","rm:edit","rm:delete","rm:stockin","rm:stockout","rm:history:view","rm:report:print",
      "fg:view","fg:add","fg:edit","fg:delete","fg:stockin","fg:stockout","fg:report:print",
      "boe:view","boe:create","boe:edit","boe:delete","boe:print",
      "dn:view","dn:create","dn:edit","dn:delete","dn:print",
      "prod:view","prod:create","prod:print",
      "suppliers:view","suppliers:add","suppliers:edit","suppliers:delete",
      "audit:view"
    ],

    manager: [
      "dashboard:view",
      "rm:view","rm:add","rm:edit","rm:stockin","rm:stockout","rm:history:view",
      "fg:view","fg:add","fg:edit","fg:stockin","fg:stockout",
      "boe:view","boe:create","boe:edit","boe:print",
      "dn:view","dn:create","dn:print",
      "prod:view","prod:create",
      "suppliers:view","suppliers:add","suppliers:edit",
      "audit:view"
    ],

    store: [
      "dashboard:view",
      "rm:view","rm:stockin","rm:stockout","rm:history:view",
      "boe:view","boe:create","boe:print",
      "dn:view","dn:create","dn:print",
      "suppliers:view",
      "audit:view"
    ],

    production: [
      "dashboard:view",
      "rm:view","rm:history:view",
      "fg:view",
      "prod:view","prod:create",
      "audit:view"
    ],

    viewer: [
      "dashboard:view",
      "rm:view","rm:history:view",
      "fg:view",
      "boe:view",
      "dn:view",
      "prod:view",
      "suppliers:view",
      "audit:view"
    ]
  };

  function getRoleName(){
    return String(currentUser?.role || "viewer").toLowerCase();
  }

  function listPerms(){
    return ROLE[getRoleName()] || ROLE.viewer;
  }

  function can(perm){
    const p = String(perm || "").trim();
    if(!p) return false;

    const perms = listPerms();
    if(perms.includes("*")) return true;

    const [mod, act] = p.split(":");
    if(mod && act && perms.includes(`${mod}:*`)) return true;

    return perms.includes(p);
  }

  function requirePerm(perm, msg="No permission"){
    if(!can(perm)){
      showToast?.(msg, true);
      throw new Error(`RBAC_BLOCKED: ${perm}`);
    }
  }

  function applyUI(){
    // ‚úÖ preferred: explicit permission on element
    document.querySelectorAll("[data-perm]").forEach(el => {
      const perm = el.getAttribute("data-perm");
      el.style.display = can(perm) ? "" : "none";
    });

    // ‚úÖ keep admin-only areas
    document.querySelectorAll(".admin-only").forEach(el => {
      el.style.display = (getRoleName() === "admin") ? "" : "none";
    });
  }

  return { ROLE, can, requirePerm, applyUI, getRoleName };
})();

window.RBAC = RBAC;

/* =========================================================
   ‚úÖ applyPermissions() REWRITE (RBAC-driven)
   - Fixes: Power role FG Add not showing
========================================================= */

function applyPermissions(){
  showAdminUI?.();

  // 1) Apply explicit [data-perm] gating everywhere
  RBAC.applyUI();

  // 2) Backward compatible: old class buttons
  //    We decide which module we are in by checking which page is visible.
  const pageIsVisible = (id) => {
    const el = document.getElementById(id);
    if(!el) return false;
    return el.style.display !== "none" && !el.classList.contains("d-none");
  };

  // Map module -> default perms for old class buttons
  let mod = null;
  if(pageIsVisible("fgPage") || pageIsVisible("fgSection") || pageIsVisible("fgProductsPage")) mod = "fg";
  else if(pageIsVisible("rmPage") || pageIsVisible("rmSection") || pageIsVisible("productsPage")) mod = "rm";
  else if(pageIsVisible("billEntry") || pageIsVisible("boePage")) mod = "boe";
  else if(pageIsVisible("deliveryNote") || pageIsVisible("dnPage")) mod = "dn";
  else if(pageIsVisible("productionPage") || pageIsVisible("prodPage")) mod = "prod";
  else if(pageIsVisible("suppliersPage") || pageIsVisible("supplierPage")) mod = "suppliers";

  // If we can't detect module, do nothing to avoid hiding wrong buttons
  if(!mod) return;

  // Action -> perm
  const permFor = (action) => {
    if(mod === "boe"){
      if(action === "add") return "boe:create";
      if(action === "edit") return "boe:edit";
      if(action === "delete") return "boe:delete";
      return "";
    }
    if(mod === "dn"){
      if(action === "add") return "dn:create";
      if(action === "edit") return "dn:edit";
      if(action === "delete") return "dn:delete";
      return "";
    }
    if(mod === "prod"){
      if(action === "add") return "prod:create";
      if(action === "edit") return "prod:edit";   // (if you have it later)
      if(action === "delete") return "prod:delete"; // (if you have it later)
      return "";
    }
    if(mod === "suppliers"){
      if(action === "add") return "suppliers:add";
      if(action === "edit") return "suppliers:edit";
      if(action === "delete") return "suppliers:delete";
      return "";
    }
    // rm / fg default
    if(action === "add") return `${mod}:add`;
    if(action === "edit") return `${mod}:edit`;
    if(action === "delete") return `${mod}:delete`;
    if(action === "stockOut") return `${mod}:stockout`;
    return "";
  };

  // Apply old class gating safely
  document.querySelectorAll('.btn-add').forEach(b => {
    if(b.hasAttribute("data-perm")) return; // already handled
    b.style.display = RBAC.can(permFor("add")) ? "inline-block" : "none";
  });

  document.querySelectorAll('.btn-edit').forEach(b => {
    if(b.hasAttribute("data-perm")) return;
    b.style.display = RBAC.can(permFor("edit")) ? "inline-block" : "none";
  });

  document.querySelectorAll('.btn-delete').forEach(b => {
    if(b.hasAttribute("data-perm")) return;
    b.style.display = RBAC.can(permFor("delete")) ? "inline-block" : "none";
  });

  document.querySelectorAll('.btn-stock-out').forEach(b => {
    if(b.hasAttribute("data-perm")) return;
    b.style.display = RBAC.can(permFor("stockOut")) ? "inline-block" : "none";
  });
}




/* =========================
   ‚úÖ AUTH UI
========================= */
function showSignup(){
  loginForm.style.display='none';
  signupForm.style.display='block';
  loginMsg.textContent='';
}
function showLogin(){
  loginForm.style.display='block';
  signupForm.style.display='none';
  signupMsg.textContent='';
}

async function signup(){
  const u = signupUser.value.trim();
  const p = signupPass.value;
  const role = signupRole.value;

  if(!u || !p){ signupMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(snap.exists()){ signupMsg.textContent="Username already taken"; return; }

    const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
    await cloudDB.ref('users/'+userId).set({
      username:u,
      password:p,
      role,
      permissionLevel:'view',
      createdAt:new Date().toISOString()
    });

    signupMsg.style.color="green";
    signupMsg.textContent="Account created! Please login.";
    showLogin();
  }catch(err){
    console.error(err);
    signupMsg.textContent="Signup failed";
  }
}

async function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value;

  if(!u || !p){ loginMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(!snap.exists()){ loginMsg.textContent="Invalid login"; return; }

    const userData = Object.values(snap.val())[0];
    if(userData.password !== p){ loginMsg.textContent="Invalid login"; return; }

    currentUser = userData;
localStorage.setItem('sms_currentUser', JSON.stringify(currentUser));

loginScreen.style.display='none';
document.querySelector('.app').style.display='flex';

// ‚úÖ apply permissions UI
RBAC.applyUI();

// open page
openPage(currentUser.role === 'admin' ? 'userManagement' : 'dashboardPage');


    applyPermissions();

    // ‚úÖ open pages
    if(currentUser.role === 'admin'){
      openPage('userManagement');
      renderUsersTable();
    }else{
      openPage('dashboardPage');
    }

  }catch(err){
    console.error(err);
    loginMsg.textContent="Login failed";
  }}

function logout(){
  localStorage.removeItem('sms_currentUser');
  location.reload();
}

async function forgotPassword(){
  const username = prompt("Enter your username to reset password:");
  if(!username || !username.trim()) return;

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username.trim()).once('value');
    if(!snap.exists()){ alert("Username not found"); return; }

    const userId = Object.keys(snap.val())[0];
    const userData = snap.val()[userId];

    const newPass = prompt(`Enter new password for "${userData.username}":`);
    if(!newPass || !newPass.trim()) return alert("Password cannot be empty");

    await cloudDB.ref('users/'+userId+'/password').set(newPass.trim());
    alert("Password reset success. Login with new password.");
  }catch(err){
    console.error(err);
    alert("Failed to reset password");
  }
}

/* =========================
   ‚úÖ USER MANAGEMENT
========================= */
function changeUserPermission(username, level){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can change roles", true);
    return;
  }
  if(username === 'admin'){
    showToast("Admin permission cannot be changed", true);
    return;
  }

  cloudDB.ref('users').orderByChild('username').equalTo(username).once('value')
    .then(snap=>{
      if(!snap.exists()) return;
      const userId = Object.keys(snap.val())[0];
      cloudDB.ref('users/'+userId+'/permissionLevel').set(level);
      showToast("User permission updated ‚úÖ");
    });
}

async function deleteUser(username){
  RBAC.requirePerm("users:manage", "Only admin can manage users");

  if(!confirm(`Delete "${username}"?`)) return;

  try{
    // Find user record
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
    if(!snap.exists()) return alert("User not found");

    const userId = Object.keys(snap.val())[0];
    const userData = snap.val()[userId];

    // ‚ùå Never delete main admin account
    if(String(userData.username).toLowerCase() === 'admin'){
      return alert("Cannot delete main admin (username: admin).");
    }

    // ‚úÖ If deleting an admin, ensure at least 1 admin remains
    if(String(userData.role || '').toLowerCase() === 'admin'){
      const all = await cloudDB.ref('users').once('value');
      const users = all.val() ? Object.values(all.val()) : [];
      const adminCount = users.filter(u => String(u.role || '').toLowerCase() === 'admin').length;

      if(adminCount <= 1){
        return alert("You cannot delete the last remaining admin.");
      }

      if(!confirm(`"${username}" is an ADMIN.\nDelete this admin user?`)) return;
    }

    await cloudDB.ref('users/' + userId).remove();
    showToast("User deleted ‚úÖ");
    renderUsersTable();
  }catch(err){
    console.error(err);
    alert("Failed to delete user");
  }
}

async function renderUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  if(!tbody) return;

  tbody.innerHTML = '';

  const snap = await cloudDB.ref('users').once('value');
  const raw  = snap.val() || {};
  const users = Object.values(raw)
    .filter(Boolean)
    .sort((a,b)=> String(a.username||'').localeCompare(String(b.username||'')));

  const meRole = String(currentUser?.role || '').toLowerCase();
  const iAmAdmin = (meRole === 'admin');

  users.forEach((u, idx) => {
    const username = String(u.username || '').trim();
    const role = String(u.role || 'viewer').toLowerCase();

    // ‚úÖ Only this exact username is "protected admin"
    const isProtectedAdmin = (username.toLowerCase() === 'admin');

    // ‚úÖ Admin can manage everyone except the protected admin account
    const canManageRow = iAmAdmin && !isProtectedAdmin;

    // Role cell
    const roleCell = isProtectedAdmin
      ? `<b>Admin</b>`
      : (canManageRow
          ? `
            <select class="form-select form-select-sm"
                    onchange="changeUserRole('${escapeHtml(username)}', this.value)">
              <option value="viewer" ${role==='viewer'?'selected':''}>Viewer</option>
              <option value="store" ${role==='store'?'selected':''}>Store</option>
              <option value="production" ${role==='production'?'selected':''}>Production</option>
              <option value="manager" ${role==='manager'?'selected':''}>Manager</option>
              <option value="power" ${role==='power'?'selected':''}>Power</option>
              <option value="admin" ${role==='admin'?'selected':''}>Admin</option>
            </select>
          `
          : `<b>${escapeHtml(role)}</b>`
        );

    // ‚úÖ Allow deleting extra admins too (anything except username=admin)
    const canDeleteRow = iAmAdmin && !isProtectedAdmin;

    const actionsCell = `
      ${canDeleteRow
        ? `<button class="btn btn-sm btn-danger"
                   onclick="deleteUser('${escapeHtml(username)}')">Delete</button>`
        : ''
      }
    `;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${escapeHtml(username)}</td>
      <td>${roleCell}</td>
      <td>${actionsCell}</td>
    `;
    tbody.appendChild(tr);
  });
}

function changeUserRole(username, role){
  RBAC.requirePerm("users:manage", "Only admin can manage users");
  if(username === 'admin') return showToast("Admin role cannot be changed", true);

  cloudDB.ref('users').orderByChild('username').equalTo(username).once('value')
    .then(snap=>{
      if(!snap.exists()) return;
      const userId = Object.keys(snap.val())[0];
      cloudDB.ref('users/'+userId+'/role').set(String(role||'viewer'));
      showToast("User role updated ‚úÖ");
      renderUsersTable();
    });
}

async function addUser(){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can add users", true);
    return;
  }

  const u = (document.getElementById('newUsername')?.value || '').trim();
  const p = (document.getElementById('newPassword')?.value || '');
  const role = (document.getElementById('newRole')?.value || 'user');

  if(!u || !p){ showToast("Username & password required", true); return; }

  const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
  if(snap.exists()){ showToast("Username already exists", true); return; }

  const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
 await cloudDB.ref('users/'+userId).set({
  username: u,
  password: p,
  role,                 // ‚úÖ save role
  createdAt: new Date().toISOString()
});


  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('newRole').value = 'user';

  showToast("User added ‚úÖ");
  renderUsersTable();
}

// =========================
// ‚úÖ AUDIT LOG (time + username + changes)
// =========================
const KEY_AUDIT = "sm_audit_v1";
let auditLog = JSON.parse(localStorage.getItem(KEY_AUDIT) || "[]");

// ISO time in Dubai local display (still stores ISO)
function nowISO(){ return new Date().toISOString(); }
function who(){ return (currentUser?.username || currentUser?.user || "unknown"); }

function saveAudit(){
  localStorage.setItem(KEY_AUDIT, JSON.stringify(auditLog));
}

// action examples: "BOE_CREATE", "BOE_EDIT", "BOE_DELETE", "PROD_CREATE", ...
function logChange(action, entityId, details = {}){
  auditLog.push({
    id: "log_" + genId(),
    at: nowISO(),
    by: who(),
    action,
    entityId,
    details
  });

  // optional: keep log size under control
  if(auditLog.length > 5000) auditLog = auditLog.slice(auditLog.length - 5000);

  saveAudit();
}

/* =========================
   ‚úÖ LOCAL STORAGE DATA (RM)
========================= */
const KEY_PRODUCTS = 'sms_products_final_v1';
const KEY_MOVES    = 'sms_movements_final_v1';

let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
let stockMovements = JSON.parse(localStorage.getItem(KEY_MOVES) || '[]');

function saveAll(){
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements));
}

function computeBalance(productId){
  let bal=0;
  stockMovements.forEach(m=>{
    if(m.productId===productId) bal += (m.type==='IN' ? Number(m.quantity||0) : -Number(m.quantity||0));
  });
  return bal>0 ? bal : 0;
}

function lastMovement(productId, type){
  const moves = stockMovements.filter(m=>m.productId===productId && m.type===type);
  if(!moves.length) return '-';
  return moves[moves.length-1].date || '-';
}

/* =========================
   ‚úÖ FG DATA
========================= */
let fgProducts  = JSON.parse(localStorage.getItem('sms_fg_products') || '[]');
let fgMovements = JSON.parse(localStorage.getItem('sms_fg_movements') || '[]');

function saveFGLocal(){
  localStorage.setItem('sms_fg_products', JSON.stringify(fgProducts));
  localStorage.setItem('sms_fg_movements', JSON.stringify(fgMovements));
}

function computeFGBalance(fgId){
  return fgMovements.reduce((sum,m)=>{
    if(m.fgId===fgId){
      return sum + (m.type==='IN'? Number(m.qty||0) : -Number(m.qty||0));
    }
    return sum;
  },0);
}

function initFGVolumeSelection(){
  if(selectedFGVolumes.size) return;
  fgProducts.forEach(f=>{
    const v = (f.volume||'').trim();
    if(v) selectedFGVolumes.add(v);
  });
}



function setText(id, val){
  const el = document.getElementById(id);
  if (el) el.textContent = (val ?? '');
}

function safeTodayISO(){
  if (typeof todayISO === 'function') return todayISO();
  return new Date().toISOString().slice(0,10);
}

function safeFmtDate(d){
  if (typeof fmtDate === 'function') return fmtDate(d);
  return (d || '');
}

function safeEscape(s){
  if (typeof escapeHtml === 'function') return escapeHtml(String(s ?? ''));
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

/* =========================
   ‚úÖ DASHBOARD (MAIN CARDS)
========================= */
function renderMainDashboard(){
  // ‚úÖ Real sources from your app
  const rm    = Array.isArray(window.products) ? window.products : [];
  const fg    = Array.isArray(window.fgProducts) ? window.fgProducts : [];
  const moves = Array.isArray(window.stockMovements) ? window.stockMovements : [];

  const bills = Array.isArray(window.savedBills) ? window.savedBills : [];
  const dns   = Array.isArray(window.deliveryNotes) ? window.deliveryNotes : [];
  const prod  = Array.isArray(window.productions) ? window.productions : [];

  // ‚úÖ IMPORTANT: prefer window.currentUser, but also accept global currentUser
  const user = window.currentUser || (typeof currentUser !== 'undefined' ? currentUser : {}) || {};

  // --- topbar user ---
  setText('dashUser', user.username || user.name || 'User');
  setText('dashRole', user.role || user.permissionLevel || 'user');

  // --- KPI calcs ---
  const canBalance = (typeof computeBalance === 'function');
  const low = rm.filter(p => {
    const bal = canBalance ? Number(computeBalance(p.id) || 0) : 0;
    return bal <= Number(p.threshold || 0);
  });

  const today = safeTodayISO();
  const docsToday =
    bills.filter(b => (b.date || b.boeDate) === today).length +
    dns.filter(d => (d.date || d.dnDate) === today).length +
    prod.filter(p => (p.date || p.prodDate) === today).length;

  setText('kpiRmItems', rm.length);
  setText('kpiFgItems', fg.length);
  setText('kpiLowStock', low.length);
  setText('kpiDocsToday', docsToday);

  // --- Recent Activity (last 6 moves) ---
  const recent = moves.slice().sort((a,b)=>{
    return String(b.createdAt||b.ts||b.date||'').localeCompare(String(a.createdAt||a.ts||a.date||''));
  }).slice(0,6);

  const recentBox = document.getElementById('dashRecentList');
  if (recentBox){
    recentBox.innerHTML = recent.length ? recent.map(m=>{
      const p = rm.find(x=>x.id===m.productId);
      const name = p?.name || 'Item';
      const title = `${m.type} ‚Ä¢ ${name}`;
      const sub = `${safeFmtDate(m.date)} ‚Ä¢ Qty: ${Number(m.quantity||0)}`;
      const pill = (String(m.type).toUpperCase()==='OUT') ? 'warn' : 'green';

      return `
        <div class="dash-item">
          <div class="left">
            <b>${safeEscape(title)}</b>
            <small>${safeEscape(sub)}</small>
          </div>
          <div class="dash-pill ${pill}">${safeEscape(m.type)}</div>
        </div>
      `;
    }).join('') : `
      <div class="dash-item">
        <div class="left">
          <b>No activity yet</b>
          <small>Start by adding BOE / DN / Production</small>
        </div>
      </div>
    `;
  }

  // --- Low stock list (top 6) ---
  const lowBox = document.getElementById('dashLowStockList');
  if (lowBox){
    lowBox.innerHTML = (low.slice(0,6).map(p=>{
      const bal = (typeof computeBalance === 'function') ? Number(computeBalance(p.id) || 0) : 0;
      const th  = Number(p.threshold || 0);
      const cls = bal <= 0 ? 'red' : 'warn';

      return `
        <div class="dash-item">
          <div class="left">
            <b>${safeEscape(p.name || 'RM')}</b>
            <small>Balance: ${bal} ‚Ä¢ Threshold: ${th}</small>
          </div>
          <div class="dash-pill ${cls}">${bal <= 0 ? 'OUT' : 'LOW'}</div>
        </div>
      `;
    }).join('')) || `
      <div class="dash-item">
        <div class="left">
          <b>All good</b>
          <small>No low stock items</small>
        </div>
        <div class="dash-pill green">OK</div>
      </div>
    `;
  }

  // --- Chart ---
  if (typeof buildDashMoveChart === 'function'){
    buildDashMoveChart(moves);
  }
}


function buildDashMoveChart(moves){
  if(!window.Chart) return;
  const ctx = document.getElementById('dashMoveChart');
  if(!ctx) return;

  // Example: last 14 days labels
  const days = [...Array(14)].map((_,i)=>{
    const d = new Date(); d.setDate(d.getDate()-(13-i));
    return d.toISOString().slice(5,10); // MM-DD
  });

  const inMap = Object.create(null);
  const outMap = Object.create(null);

  (moves||[]).forEach(m=>{
 const d = String(m.date||'').slice(5,10);

    const q = Number(m.quantity ?? m.qty ?? 0);

    if(!d) return;
    if((m.type||'').toUpperCase()==='IN') inMap[d]=(inMap[d]||0)+q;
    if((m.type||'').toUpperCase()==='OUT') outMap[d]=(outMap[d]||0)+q;
  });

  const inData = days.map(d=> inMap[d]||0);
  const outData = days.map(d=> outMap[d]||0);

  // destroy old
  if(window._dashChart) window._dashChart.destroy();

  window._dashChart = new Chart(ctx, {
    type:'line',
    data:{
      labels: days,
      datasets:[
        { label:'IN', data: inData, tension:.35 },
        { label:'OUT', data: outData, tension:.35 }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:'rgba(255,255,255,.8)' } } },
      scales:{
        x:{ ticks:{ color:'rgba(255,255,255,.6)' }, grid:{ color:'rgba(255,255,255,.06)' } },
        y:{ ticks:{ color:'rgba(255,255,255,.6)' }, grid:{ color:'rgba(255,255,255,.06)' } }
      }
    }
  });
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

/* =========================
   ‚úÖ FG FILTER + CHART
========================= */
function renderFGVolumeFilter(){
  const wrap = document.getElementById('fgVolumeFilter');
  if(!wrap) return;

  const volumes = [...new Set(fgProducts.map(f=>(f.volume||'').trim()).filter(v=>v))].sort();
  wrap.innerHTML = '';

  // if nothing selected, select all
  if(!selectedFGVolumes.size){
    volumes.forEach(v=> selectedFGVolumes.add(v));
  }

  volumes.forEach(vol=>{
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems='center';
    label.style.gap='4px';
    label.style.cursor='pointer';

    const checked = selectedFGVolumes.has(vol);

    label.innerHTML = `
      <input type="checkbox" ${checked ? 'checked':''}>
      ${escapeHtml(vol)}
    `;

    label.querySelector('input').onchange = e=>{
      if(e.target.checked) selectedFGVolumes.add(vol);
      else selectedFGVolumes.delete(vol);

      // if user unchecks all -> auto select all again
      if(!selectedFGVolumes.size){
        volumes.forEach(v=> selectedFGVolumes.add(v));
        renderFGVolumeFilter();
      }
      renderFGChart();
    };

    wrap.appendChild(label);
  });
}

function renderFGChart(){
  const canvas = document.getElementById('fgStockChart');
  if(!canvas) return;

  const filteredFG = fgProducts.filter(f => selectedFGVolumes.has((f.volume||'').trim()));
  const labels = filteredFG.map(f => (f.name||'').length>12 ? f.name.slice(0,12)+'‚Ä¶' : f.name);
  const data   = filteredFG.map(f => computeFGBalance(f.id));

  if(fgChartInstance) fgChartInstance.destroy();
  if(!filteredFG.length) return;

  fgChartInstance = new Chart(canvas, {
    type:'bar',
    data:{ labels, datasets:[{ data, borderRadius:8, barThickness:22, backgroundColor:'rgba(41,128,185,0.65)' }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            title:(items)=> filteredFG[items[0].dataIndex].name,
            label:(ctx)=> `Balance: ${ctx.raw}`
          }
        }
      },
      scales:{ x:{ grid:{display:false} }, y:{ beginAtZero:true } }
    }
  });
}

/* =========================
   ‚úÖ FG PAGES (with LOW filter from dashboard)
========================= */
let fgOnlyLow = false;

function openFGFromDashboard(){ fgOnlyLow = false; openPage('fgStock'); }
function openLowFGFromDashboard(){ fgOnlyLow = true; openPage('fgStock'); }

function renderFGStock(){
  const tbody = document.querySelector('#fgTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;

    const bal = computeFGBalance(p.id);
    const thr = Number(p.threshold ?? 5);

    if(fgOnlyLow && !(bal <= thr)) return;

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
	<td>${escapeHtml(p.productcode||'-')}</td>
	<td>${escapeHtml(p.barcode||'-')}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.volume||'-')}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${bal}</td>
        <td>
          <button class="btn info" onclick="viewFGHistory('${p.id}')">üëÅ View</button>
          ${currentUser?.role === 'admin' ? `
            <button class="btn secondary btn-edit" onclick="editFGProduct('${p.id}')">‚úèÔ∏è Edit</button>
            <button class="btn out btn-delete" onclick="deleteFGProduct('${p.id}')">üóë Delete</button>
          `:''}
        </td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderFGStockIn(){
  const tbody = document.getElementById('fgStockInBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgInSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
	<td>${escapeHtml(p.productcode||'-')}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn" onclick="openFGModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}

function renderFGStockOut(){
  const tbody = document.getElementById('fgStockOutBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgOutSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
	<td>${escapeHtml(p.productcode||'-')}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn out btn-stock-out" onclick="openFGModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function viewFGHistory(fgId){
  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  const modal = document.getElementById('historyModal');
  modal.style.display='flex';
  document.getElementById('modalTitle').textContent = `FG History ‚Äî ${fg.name}`;

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML='';

  fgMovements
    .filter(m=>m.fgId===fgId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
    <td>${fmtDateTime(m.createdAt || (m.date ? m.date+"T00:00:00.000Z" : ""))}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.qty||0)}</td>
          <td>${escapeHtml(m.batch||fg.batch||'-')}</td>
          <td>${escapeHtml(m.expiry||fg.expiry||'-')}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}






































/* =========================
   ‚úÖ BOE / GRN MODULE (DROP-IN REWRITE) ‚Äî FIXED
   Fixes:
   - BOE.saveBills() exists
   - window.saveBills exists immediately (Auto pull won't fail)
   - BOE is guaranteed global for onclick="BOE.view(...)"
========================= */

window.BOE = (() => {
  const KEY_BILLS = 'sms_bills_v1';

  // ‚úÖ keep backward compatibility with older code that uses `savedBills`
  window.savedBills = JSON.parse(localStorage.getItem(KEY_BILLS) || '[]');
  let bills = window.savedBills;

  let editingId = null;
  let lastViewedId = null;

  // ---------- tiny helpers ----------
  const esc = (s) => (s == null ? '' : String(s)).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));

  const rmCode = (p) => String(p?.code || p?.productCode || p?.sku || p?.barcode || '').trim();
  const rmName = (p) => String(p?.name || 'Unnamed').trim();
  const rmLabel = (p) => (rmCode(p) ? `(${rmCode(p)}) ${rmName(p)}` : rmName(p)).trim();

  // ‚úÖ FIX: proper saveBills + exposed immediately
  function saveBills() {
    window.savedBills = bills; // keep both in sync
    localStorage.setItem(KEY_BILLS, JSON.stringify(bills));
  }
  window.saveBills = saveBills; // ‚úÖ Auto pull / old code can call saveBills()

  function canStockIn(){
    if (currentUser?.role === 'admin') return true;
    if (typeof getPerms === 'function') return !!getPerms().stockIn;
    return true;
  }

  function getSupplierNameFromUI(){
    const sel = document.getElementById('boeSupplier');
    const other = document.getElementById('boeSupplierOther');
    if(!sel) return '';

    if(sel.value === '__OTHER__') return (other?.value || '').trim();

    const list = (window.suppliers && Array.isArray(window.suppliers)) ? window.suppliers : [];
    const s = list.find(x => x.id === sel.value);
    return (s?.name || sel.value || '').trim();
  }

  // ---------- supplier dropdown ----------
  function renderSupplierDropdown(){
    const sel = document.getElementById('boeSupplier');
    const other = document.getElementById('boeSupplierOther');
    if(!sel) return;

    const list = (window.suppliers && Array.isArray(window.suppliers)) ? window.suppliers : [];
    sel.innerHTML = `<option value="">Select Supplier</option>`;

    list.forEach(s=>{
      sel.insertAdjacentHTML('beforeend', `<option value="${esc(s.id)}">${esc(s.name)}</option>`);
    });

    sel.insertAdjacentHTML('beforeend', `<option value="__OTHER__">Other...</option>`);

    sel.onchange = () => {
      if(!other) return;
      if(sel.value === '__OTHER__'){
        other.style.display = '';
        other.focus();
      }else{
        other.style.display = 'none';
        other.value = '';
      }
    };
  }

  // ---------- RM Search dropdown per row (must pick) ----------
  function initRowSearch(tr){
    const input = tr.querySelector('[data-boe="productSearch"]');
    const dd = tr.querySelector('.rm-search-dd');
    if(!input || !dd) return;
    if(input._inited) return;
    input._inited = true;

    let results = [];
    let active = -1;

    const close = () => { dd.style.display='none'; dd.innerHTML=''; active=-1; };
    const open  = () => { dd.style.display='block'; };

    const clearSelection = () => {
      input.dataset.productId = '';
      input.setAttribute('data-product-id','');
    };

    const render = (list) => {
      results = list;
      if(!list.length){
        dd.innerHTML = `<div class="rm-search-empty">No matches</div>`;
        open(); return;
      }
      dd.innerHTML = list.map((p,i)=>`
        <div class="rm-search-item" data-i="${i}">
          ${esc(rmLabel(p))}
        </div>
      `).join('');
      open();
    };

    const search = () => {
      const q = (input.value||'').toLowerCase().trim();
      const all = [...products].sort((a,b)=> rmLabel(a).localeCompare(rmLabel(b)));

      if(!q) return render(all.slice(0,25));

      const out = all.filter(p=>{
        const t = rmLabel(p).toLowerCase();
        const c = rmCode(p).toLowerCase();
        return t.includes(q) || c.includes(q);
      }).slice(0,50);

      render(out);
    };

    const select = (p) => {
      input.value = rmLabel(p);
      input.dataset.productId = p.id;
      input.setAttribute('data-product-id', p.id);
      close();
    };

    const highlight = () => {
      const items = [...dd.querySelectorAll('.rm-search-item')];
      items.forEach((el,i)=> el.classList.toggle('active', i===active));
      const act = dd.querySelector(`.rm-search-item[data-i="${active}"]`);
      act?.scrollIntoView({block:'nearest'});
    };

    input.addEventListener('focus', search);
    input.addEventListener('input', ()=>{ clearSelection(); search(); });

    input.addEventListener('keydown', (e)=>{
      const isOpen = dd.style.display !== 'none';
      if((e.key==='ArrowDown' || e.key==='Enter') && !isOpen){ search(); return; }
      if(!isOpen) return;

      if(e.key==='ArrowDown'){ e.preventDefault(); active = Math.min(active+1, results.length-1); highlight(); }
      if(e.key==='ArrowUp'){ e.preventDefault(); active = Math.max(active-1, 0); highlight(); }
      if(e.key==='Escape'){ close(); }
      if(e.key==='Enter'){
        if(active>=0 && results[active]){ e.preventDefault(); select(results[active]); }
      }
    });

    dd.addEventListener('mousedown', (e)=>{
      const item = e.target.closest('.rm-search-item');
      if(!item) return;
      e.preventDefault();
      const i = Number(item.dataset.i);
      if(Number.isFinite(i) && results[i]) select(results[i]);
    });

    const onDocDown = (e)=>{ if(!tr.contains(e.target)) close(); };
    document.addEventListener('mousedown', onDocDown);
    tr._cleanup = ()=> document.removeEventListener('mousedown', onDocDown);
  }

  // ---------- rows ----------
  function addRow(prefill=null){
    const body = document.getElementById('boeItemsBody');
    if(!body) return;

    const rowId = 'boeRow_' + genId();

    const productId = String(prefill?.productId || '').trim();
    const qty = (prefill?.qty ?? '');
    const remark = (prefill?.remark ?? '');

    let prefillText = '';
    if(productId){
      const p = products.find(x=>x?.id === productId);
      if(p) prefillText = rmLabel(p);
    }

    body.insertAdjacentHTML('beforeend', `
      <tr id="${rowId}">
        <td>
          <div class="rm-search-wrap">
            <input class="rm-search-input small"
              placeholder="Search RM..."
              autocomplete="off"
              data-boe="productSearch"
              data-product-id="${esc(productId)}"
              value="${esc(prefillText)}">
            <div class="rm-search-dd"></div>
          </div>
        </td>

        <td><input class="small" type="number" min="0" step="1" style="width:100%" data-boe="qty" value="${esc(String(qty))}"></td>
        <td><input class="small" style="width:100%" data-boe="remark" value="${esc(String(remark))}" placeholder="Remark (optional)"></td>

        <td style="text-align:center">
          <button class="btn out" style="padding:6px 10px" type="button" data-boe="remove">X</button>
        </td>
      </tr>
    `);

    const tr = document.getElementById(rowId);
    if(!tr) return;

    initRowSearch(tr);

    tr.querySelector('[data-boe="remove"]')?.addEventListener('click', ()=>{
      if(typeof tr._cleanup === 'function') tr._cleanup();
      tr.remove();
      if(!document.getElementById('boeItemsBody')?.children.length) addRow();
    });
  }

  function resetForm(){
    editingId = null;
    const badge = document.getElementById('boeEditBadge');
    if(badge) badge.style.display = 'none';

    const no = document.getElementById('boeNo');
    const dt = document.getElementById('boeDate');
    const sp = document.getElementById('boeSupplier');
    const other = document.getElementById('boeSupplierOther');
    const body = document.getElementById('boeItemsBody');

    if(no) no.value = '';
    if(dt) dt.value = todayISO();
    if(sp) sp.value = '';
    if(other){ other.value=''; other.style.display='none'; }
    if(body) body.innerHTML = '';

    addRow();
  }

  function getItemsFromUI(){
    const body = document.getElementById('boeItemsBody');
    if(!body) return [];

    const out = [];
    [...body.querySelectorAll('tr')].forEach(tr=>{
      const rmInp  = tr.querySelector('[data-boe="productSearch"]');
      const qtyInp = tr.querySelector('[data-boe="qty"]');
      const remInp = tr.querySelector('[data-boe="remark"]');

      const productId = String(rmInp?.dataset.productId || rmInp?.getAttribute('data-product-id') || '').trim();
      const qty = Number(qtyInp?.value || 0);
      const remark = (remInp?.value || '').trim();

      if(!productId) return;
      if(qty <= 0) return;

      out.push({ productId, qty, remark });
    });
    return out;
  }

  // ---------- stock link ----------
  function revertLinkedStock(billId){
    stockMovements = stockMovements.filter(m => m.billId !== billId);
  }

function postStock(bill){
  (bill.items||[]).forEach(it=>{
    stockMovements.push({
      id: genId(),
      productId: it.productId,
      type: 'IN',
      quantity: Number(it.qty || 0),
      date: bill.date,
      remark: `BOE ${bill.billNo}${it.remark ? ' - ' + it.remark : ''}`,
      billId: bill.id,

      // ‚úÖ time + user
      createdAt: new Date().toISOString(),
      createdBy: who()
    });
  });
}



  // ---------- create/edit ----------
  function submit(){
  if(editingId) RBAC.requirePerm("boe:edit", "You cannot edit BOE");
  else RBAC.requirePerm("boe:create", "You cannot create BOE");

    if(!canStockIn()){ showToast("Stock IN not allowed for your role", true); return; }

    const billNo = (document.getElementById('boeNo')?.value || '').trim();
    const billDate = (document.getElementById('boeDate')?.value || todayISO());
    const supplierId = (document.getElementById('boeSupplier')?.value || '').trim();
    const supplierName = getSupplierNameFromUI();

    if(!billNo) return showToast("Bill No is required", true);
    if(!billDate) return showToast("Bill Date is required", true);
    if(!supplierId) return showToast("Select supplier (or Other)", true);
    if(supplierId === '__OTHER__' && !supplierName) return showToast("Enter supplier name", true);

    const items = getItemsFromUI();
    if(!items.length) return showToast("Add at least 1 item (select RM + qty > 0)", true);

    // EDIT
    if(editingId){
      const idx = bills.findIndex(b=>b.id === editingId);
      if(idx === -1){ editingId=null; return showToast("Bill not found (edit)", true); }

      const old = bills[idx];
      revertLinkedStock(old.id);

      const updated = {
        ...old,
        billNo,
        date: billDate,
        supplierId,
        supplierName,
        items,
        updatedAt: new Date().toISOString(),
        updatedBy: currentUser?.username || ''
      };

      bills[idx] = updated;
      saveBills();          // ‚úÖ FIX
      postStock(updated);
logChange("BOE_EDIT", updated.id, {
  billNo: updated.billNo,
  date: updated.date,
  supplier: updated.supplierName,
  lines: (updated.items || []).length
});

      saveAll?.();
      autoPushToCloud?.();
      refreshAll?.();

      showToast("Bill updated & stock re-posted ‚úÖ");
      resetForm();
      renderTable();
      return;
    }

    // CREATE
    const bill = {
      id: 'boe_' + genId(),
      billNo,
      date: billDate,
      supplierId,
      supplierName,
      items,
      createdAt: new Date().toISOString(),
      createdBy: currentUser?.username || ''
    };

    bills.push(bill);
    saveBills();            // ‚úÖ FIX
    postStock(bill);
logChange("BOE_CREATE", bill.id, {
  billNo: bill.billNo,
  date: bill.date,
  supplier: bill.supplierName,
  lines: (bill.items || []).length
});

    saveAll?.();
    autoPushToCloud?.();
    refreshAll?.();

    showToast("Bill saved & Stock IN created ‚úÖ");
    resetForm();
    renderTable();
  }

  // ---------- list/table ----------
  const totalQty = (b)=> (b.items||[]).reduce((s,it)=> s + Number(it.qty||0), 0);

  function renderTable(){
    const tbody = document.querySelector('#boeTable tbody');
    if(!tbody) return;

    const q = (document.getElementById('boeSearch')?.value || '').toLowerCase().trim();
    tbody.innerHTML = '';

    const list = [...bills].sort((a,b)=> new Date(b.date) - new Date(a.date));
    const isAdmin = currentUser?.role === 'admin';

    const codesSummary = (b)=>{
      const set = new Set();
      (b.items||[]).forEach(it=>{
        const p = products.find(x=>x.id===it.productId);
        const c = rmCode(p);
        if(c) set.add(c);
      });
      return [...set].join(', ');
    };

    const namesSummary = (b)=>{
      const set = new Set();
      (b.items||[]).forEach(it=>{
        const p = products.find(x=>x.id===it.productId);
        const n = rmName(p);
        if(n) set.add(n);
      });
      return [...set].join(', ');
    };

    list.forEach(b=>{
      const match =
        !q ||
        String(b.billNo||'').toLowerCase().includes(q) ||
        String(b.supplierName||'').toLowerCase().includes(q) ||
        codesSummary(b).toLowerCase().includes(q) ||
        namesSummary(b).toLowerCase().includes(q);

      if(!match) return;

      const codesText = esc(codesSummary(b) || '-');
      const namesText = esc(namesSummary(b) || '-');

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${fmtDate(b.date)}</td>
          <td title="${codesText}">${codesText}</td>
          <td>${esc(b.billNo||'')}</td>
          <td title="${namesText}">${namesText}</td>
          <td>${esc(b.supplierName||'')}</td>
          <td>${totalQty(b)}</td>
          <td>${(b.items||[]).length}</td>
          <td>
            <button class="btn info" type="button" onclick="BOE.view('${esc(b.id)}')">View</button>
            <button class="btn secondary" type="button" onclick="BOE.print('${esc(b.id)}')">Print</button>
            ${isAdmin ? `<button class="btn secondary" type="button" onclick="BOE.openEdit('${esc(b.id)}')">Edit</button>` : ``}
            ${isAdmin ? `<button class="btn out" type="button" onclick="BOE.remove('${esc(b.id)}')">Delete</button>` : ``}
          </td>
        </tr>
      `);
    });

    applyPermissions?.();
  }

  // ---------- view modal ----------
  function view(billId){
    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    lastViewedId = billId;

    document.getElementById('boeViewTitle').textContent = `Bill of Entry ‚Äî ${b.billNo}`;
    document.getElementById('boeViewMeta').innerHTML =
      `<b>Date:</b> ${fmtDate(b.date)} &nbsp; | &nbsp; <b>Supplier:</b> ${esc(b.supplierName||'')}
       ${b.createdBy ? ` &nbsp; | &nbsp; <b>By:</b> ${esc(b.createdBy)}` : ''}`;

    const body = document.getElementById('boeViewBody');
    body.innerHTML = '';

    (b.items||[]).forEach(it=>{
      const p = products.find(x=>x.id===it.productId);
      body.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${esc(p ? rmLabel(p) : 'Unknown')}</td>
          <td>${Number(it.qty||0)}</td>
          <td>${esc(it.remark||'')}</td>
        </tr>
      `);
    });

    document.getElementById('boeViewModal').style.display = 'flex';
  }

  function closeView(){ document.getElementById('boeViewModal').style.display = 'none'; }
  function printFromView(){ if(lastViewedId) print(lastViewedId); }
  function editFromView(){ if(lastViewedId){ openEdit(lastViewedId); closeView(); } }

  // ---------- edit/delete ----------
  function openEdit(billId){
    if(currentUser?.role !== 'admin') return showToast("Only admin can edit bills", true);

    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    openPage?.('billEntry');

    editingId = billId;
    const badge = document.getElementById('boeEditBadge');
    if(badge) badge.style.display = '';

    document.getElementById('boeNo').value = b.billNo || '';
    document.getElementById('boeDate').value = b.date || todayISO();

    renderSupplierDropdown();

    const supplierSel = document.getElementById('boeSupplier');
    const other = document.getElementById('boeSupplierOther');

    if(supplierSel){
      const has = [...supplierSel.options].some(o => o.value === b.supplierId);
      if(has){
        supplierSel.value = b.supplierId;
        if(other){ other.style.display='none'; other.value=''; }
      }else{
        supplierSel.value = '__OTHER__';
        if(other){ other.style.display=''; other.value = b.supplierName || ''; }
      }
      supplierSel.dispatchEvent(new Event('change'));
    }

    const body = document.getElementById('boeItemsBody');
    body.innerHTML = '';
    (b.items||[]).forEach(it=> addRow({ productId: it.productId, qty: it.qty, remark: it.remark }));
    if(!body.children.length) addRow();

    showToast("Editing BOE ‚Äî update and Save ‚úÖ");
  }

  function remove(billId){
  RBAC.requirePerm("boe:delete", "You cannot delete BOE");

    if(currentUser?.role !== 'admin') return showToast("Only admin can delete bills", true);

    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    if(!confirm(`Delete BOE "${b.billNo}"?\nThis will also remove linked RM Stock IN movements.`)) return;

    bills = bills.filter(x=>x.id !== billId);
    window.savedBills = bills; // keep compatibility consistent
    saveBills();               // ‚úÖ FIX
    revertLinkedStock(billId);
logChange("BOE_DELETE", billId, {
  billNo: b.billNo,
  date: b.date,
  supplier: b.supplierName
});

    saveAll?.();
    autoPushToCloud?.();
    refreshAll?.();

    showToast("Bill deleted & stock reverted ‚úÖ");
    renderTable();
  }

  // ---------- print ----------
  function print(billId){
    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    const hasPDF = !!(window.jspdf?.jsPDF);
    const hasAutoTable = !!(window.jspdf?.jsPDF && window.jspdf?.jsPDF.API?.autoTable);

    if(hasPDF){
      const doc = new window.jspdf.jsPDF();
      doc.setFontSize(14);
      doc.text(`Goods Received Note (BOE) - ${b.billNo}`, 14, 16);
      doc.setFontSize(10);
      doc.text(`Date: ${fmtDate(b.date)}    Supplier: ${b.supplierName || ''}`, 14, 24);

      const rows = (b.items||[]).map((it, idx)=>{
        const p = products.find(x=>x.id===it.productId);
        return [ String(idx+1), p ? rmLabel(p) : 'Unknown', String(Number(it.qty||0)), it.remark || '' ];
      });

      if(hasAutoTable){
        doc.autoTable({ startY: 30, head: [['#','RM Product','Qty','Remark']], body: rows });
      }else{
        let y = 34;
        rows.forEach(r=>{ doc.text(`${r[0]}. ${r[1]} | Qty: ${r[2]} | ${r[3]}`, 14, y); y += 6; });
      }
      doc.save(`BOE_${b.billNo}.pdf`);
      return;
    }

    const w = window.open('', '_blank');
    const itemsHtml = (b.items||[]).map(it=>{
      const p = products.find(x=>x.id===it.productId);
      return `<tr><td>${esc(p ? rmLabel(p) : 'Unknown')}</td><td>${Number(it.qty||0)}</td><td>${esc(it.remark||'')}</td></tr>`;
    }).join('');

    w.document.write(`
      <html><head><title>BOE ${esc(b.billNo)}</title>
      <style>
        body{font-family:Arial;padding:16px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ddd;padding:8px;font-size:12px}
        th{background:#f3f3f3}
      </style>
      </head><body>
        <h2>Goods Received Note (BOE) - ${esc(b.billNo)}</h2>
        <div><b>Date:</b> ${fmtDate(b.date)} &nbsp; <b>Supplier:</b> ${esc(b.supplierName||'')}</div>
        <br/>
        <table>
          <thead><tr><th>RM Product</th><th>Qty</th><th>Remark</th></tr></thead>
          <tbody>${itemsHtml}</tbody>
        </table>
        <script>window.print();<\/script>
      </body></html>
    `);
    w.document.close();
  }

  function printSummary(){
    const list = [...bills].sort((a,b)=> new Date(b.date)-new Date(a.date));
    const hasPDF = !!(window.jspdf?.jsPDF);
    const hasAutoTable = !!(window.jspdf?.jsPDF && window.jspdf?.jsPDF.API?.autoTable);

    if(!hasPDF){ alert("jsPDF not found for summary print."); return; }

    const doc = new window.jspdf.jsPDF();
    doc.setFontSize(14);
    doc.text(`BOE Summary Report`, 14, 16);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 24);

    const rows = list.map((b, i)=>[
      String(i+1),
      fmtDate(b.date),
      b.billNo,
      b.supplierName || '',
      String((b.items||[]).reduce((s,it)=> s + Number(it.qty||0), 0)),
      String((b.items||[]).length)
    ]);

    if(hasAutoTable){
      doc.autoTable({ startY: 30, head: [['#','Date','Bill No','Supplier','Total Qty','Lines']], body: rows });
    }
    doc.save(`BOE_Summary.pdf`);
  }

  // ---------- Excel import (kept as-is; uses saveBills()) ----------
  function parseExcelDateToISO(v){
    if(v instanceof Date && !isNaN(v)) return v.toISOString().split('T')[0];
    if(typeof v === 'number' && isFinite(v)){
      const d = new Date(Date.UTC(1899, 11, 30) + v * 86400000);
      return d.toISOString().split('T')[0];
    }
    const s = String(v || '').trim();
    if(!s) return '';
    const d2 = new Date(s);
    if(!isNaN(d2)) return d2.toISOString().split('T')[0];

    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(m){
      const dd = String(m[1]).padStart(2,'0');
      const mm = String(m[2]).padStart(2,'0');
      const yy = m[3];
      return `${yy}-${mm}-${dd}`;
    }
    return '';
  }

  function findProductIdByCodeOrName(val){
    const s = String(val || '').trim().toLowerCase();
    if(!s) return '';

    let p = products.find(x => String(x.code||'').trim().toLowerCase() === s);
    if(p) return p.id;

    p = products.find(x => String(x.name||'').trim().toLowerCase() === s);
    if(p) return p.id;

    p = products.find(x => String(x.name||'').toLowerCase().includes(s));
    return p ? p.id : '';
  }

  function importExcel(file){
    if(!window.XLSX){ showToast("XLSX library not loaded", true); return; }
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval:'', raw:true });

        if(!json.length){ showToast("Excel is empty", true); return; }

        const rows = json.map(r=>{
          const obj = {};
          Object.keys(r).forEach(k=> obj[String(k).trim().toLowerCase()] = r[k]);
          return obj;
        });

        const groups = new Map();
        let unmatched = 0;

        rows.forEach(r=>{
          const billNo = String(r.billno ?? r['bill no'] ?? r.entryno ?? r['entry no'] ?? '').trim();
          const dateISO = parseExcelDateToISO(r.date ?? r.billdate ?? r['bill date'] ?? '') || todayISO();
          const supplier = String(r.supplier ?? r.suppliername ?? r['supplier name'] ?? '').trim();

          const prodVal = r.product ?? r.productname ?? r['product name'] ?? r.code ?? r.productcode ?? r['product code'] ?? '';
          const qty = Number(r.qty ?? r.quantity ?? 0);
          const remark = String(r.remark ?? r.notes ?? '').trim();

          if(!billNo || !supplier || !prodVal || !(qty > 0)) return;

          const productId = findProductIdByCodeOrName(prodVal);
          if(!productId){ unmatched++; return; }

          const key = `${billNo}__${dateISO}__${supplier}`;
          if(!groups.has(key)){
            groups.set(key, { billNo, date: dateISO, supplierName: supplier, supplierId: '__OTHER__', items: [] });
          }
          groups.get(key).items.push({ productId, qty, remark });
        });

        if(!groups.size){ showToast("No valid BOE rows found", true); return; }

        let created = 0;
        groups.forEach(g=>{
          const bill = {
            id: 'boe_' + genId(),
            billNo: g.billNo,
            date: g.date,
            supplierId: g.supplierId,
            supplierName: g.supplierName,
            items: g.items,
            createdAt: new Date().toISOString(),
            createdBy: currentUser?.username || ''
          };
          bills.push(bill);
          postStock(bill);
          created++;
        });

        saveBills(); // ‚úÖ FIX
        saveAll?.();
        autoPushToCloud?.();
        refreshAll?.();
        renderTable();

        showToast(unmatched ? `Imported ${created} BOE ‚úÖ (Unmatched: ${unmatched})` : `Imported ${created} BOE ‚úÖ`);
      }catch(err){
        console.error(err);
        showToast("Import failed", true);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // ---------- init ----------
  function init(){
    renderSupplierDropdown();
    const dt = document.getElementById('boeDate');
    if(dt && !dt.value) dt.value = todayISO();

    const body = document.getElementById('boeItemsBody');
    if(body && !body.children.length) addRow();

    document.getElementById('boeSearch')?.addEventListener('input', renderTable);

    document.getElementById('boeFileInput')?.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(f) importExcel(f);
      e.target.value = '';
    });

    renderTable();
  }

  return {
    init,
    renderSupplierDropdown,
    addRow,
    resetForm,
    submit,
    renderTable,
    view,
    closeView,
    print,
    printFromView,
    editFromView,
    openEdit,
    remove,
    printSummary,
    importExcel,
    saveBills // ‚úÖ FIX: BOE.saveBills() now exists
  };
})();

/* ‚úÖ alias for convenience */
const BOE = window.BOE;

/* =========================
   ‚úÖ WRAPPERS (so your existing onclick still works)
========================= */
function renderBOESupplierDropdown(){ BOE.renderSupplierDropdown(); }
function boeAddRow(){
  // Always use the BOE module row (search input + dropdown)
  if (window.BOE && typeof BOE.addRow === "function") {
    BOE.addRow();
    return;
  }
  console.error("BOE.addRow not available");
}




function submitBillEntry(){
  BOE.submit();                 // BOE.submit already calls BOE.saveBills()
  autoPushToCloud();            // ‚úÖ push bills + everything
}

function resetBillEntryForm(){ BOE.resetForm(); }
function renderBillsTable(){
  const tb = document.getElementById('boeTableBody');
  if(!tb) return;

  tb.innerHTML = (bills && bills.length) ? '' : `
    <tr><td colspan="8" class="text-muted">No bills found</td></tr>
  `;

  (bills || []).forEach(b=>{
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(b.date||'')}</td>
        <td>${escapeHtml(b.productCode||'')}</td>
        <td><b>${escapeHtml(b.boeNo||'')}</b></td>
        <td>${escapeHtml(b.productName||'')}</td>
        <td>${escapeHtml(b.supplier||'')}</td>
        <td class="text-end">${Number(b.totalQty||0)}</td>
        <td class="text-center">${(b.items||[]).length}</td>
        <td>...</td>
      </tr>
    `);
  });
}


function closeBOEView(){ BOE.closeView(); }
function printBOEFromView(){ BOE.printFromView(); }
function editBOEFromView(){ BOE.editFromView(); }
function printBOESummaryReport(){ BOE.printSummary(); }

function boeTriggerImport(){
  const inp = document.getElementById('boeFileInput');
  if(!inp) return;
  inp.value = '';
  inp.click();
}

/* ‚úÖ Call once (safe even if pages hidden) */
BOE.init();








/* =========================================================
   ‚úÖ PRODUCTION MODULE (FULL REWRITE)
   - FG IN + RM OUT saved properly (local + cloud)
   - No dependency on broken saveBills()
   - Works with your existing:
     products, stockMovements, fgProducts, fgMovements,
     computeBalance(), saveFGLocal(), autoPushFGToCloud(),
     autoPushToCloud(), refreshAll(), showToast(), escapeHtml(),
     genId(), todayISO(), nowISO(), who()
========================================================= */

/* ---------- STORAGE KEYS ---------- */
const KEY_PROD = 'sms_productions_v1';
window.KEY_PROD = KEY_PROD;

/* ---------- STATE ---------- */
let productions = JSON.parse(localStorage.getItem(KEY_PROD) || '[]');
window.productions = productions;

/* ---------- SAFE SAVERS (NO bills here) ---------- */
function saveProductions(){
  localStorage.setItem(KEY_PROD, JSON.stringify(productions || []));
  window.productions = productions;
}
window.saveProductions = saveProductions;

function saveAllRM(){
  // ‚úÖ RM only (do NOT call saveBills here)
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products || []));
  localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements || []));
}
window.saveAllRM = saveAllRM;

function saveFG(){
  saveFGLocal?.();
  autoPushFGToCloud?.();
}
window.saveFG = saveFG;

/* ---------- PERMISSION ---------- */
function canProduction(){
  // allow if no login
  if(!window.currentUser) return true;

  const role = String(window.currentUser.role || '').toLowerCase();
  return role === 'admin' || role === 'manager' || role === 'production';
}
window.canProduction = canProduction;

/* ---------- BOM HELPERS ----------
   Your rule: RM.groups matches FG.group (normalized)
---------------------------------- */
function bomKey(v){
  return normalizeGroup(v); // your normalizeGroup(): trim + uppercase + remove spaces
}

function getBOMRMForFG(fgId){
  const fg = (Array.isArray(fgProducts) ? fgProducts : []).find(x => String(x.id) === String(fgId));
  if(!fg) return { fg:null, key:'', list:[] };

  const key = bomKey(fg.group); // ‚úÖ ONLY fg.group

  const list = (Array.isArray(products) ? products : []).filter(rm=>{
    const gs = Array.isArray(rm.groups) ? rm.groups : [];
    if(!gs.length) return false;

    // exclusive => first group only
    const use = rm.exclusive ? [gs[0]] : gs;
    return use.some(g => bomKey(g) === key);
  });

  return { fg, key, list };
}
window.getBOMRMForFG = getBOMRMForFG;

/* ---------- UI: Render BOM Table ---------- */
function renderBOM(){
  const fgId  = String(document.getElementById('prodFG')?.value || '').trim();
  const fgQty = Number(document.getElementById('prodFGQty')?.value || 0) || 0;
  const body  = document.getElementById('prodBOMBody');
  if(!body) return;

  body.innerHTML = '';

  if(!fgId){
    body.innerHTML = `<tr><td colspan="5" class="text-muted">Select FG product</td></tr>`;
    return;
  }

  const { fg, key, list } = getBOMRMForFG(fgId);

  if(!fg){
    body.innerHTML = `<tr><td colspan="5" class="text-muted">FG not found</td></tr>`;
    return;
  }
  if(!key){
    body.innerHTML = `<tr><td colspan="5" class="text-muted">This FG has no group set</td></tr>`;
    return;
  }
  if(!list.length){
    body.innerHTML = `<tr><td colspan="5" class="text-muted">
      No RM found in group: <b>${escapeHtml(key)}</b><br>
      (Add same group inside RM ‚Üí Groups field)
    </td></tr>`;
    return;
  }

  list.forEach(rm=>{
    // qtyPerFG optional. If not present, default 1
    const per = Number(rm.qtyPerFG || 1);
    const req = per * fgQty;

    body.insertAdjacentHTML('beforeend', `
      <tr data-rm="${escapeHtml(String(rm.id))}">
        <td><b>${escapeHtml(rm.name || 'Unknown')}</b></td>

        <td class="text-end reqQty">${Number(req.toFixed(6))}</td>

        <td class="text-end">
          <input class="form-control form-control-sm damQty"
                 type="number" min="0" step="0.0001" value="0"
                 oninput="calcNetUsed(this)">
        </td>

        <td class="text-end netUsed">${Number(req.toFixed(6))}</td>

        <td class="text-muted small">
          Bal: <span class="rmBal">${Number(computeBalance(rm.id) || 0)}</span>
        </td>
      </tr>
    `);
  });
}
window.renderBOM = renderBOM;

/* ---------- UI: Net used calc ---------- */
function calcNetUsed(el){
  const tr = el.closest('tr');
  if(!tr) return;

  const req = Number(tr.querySelector('.reqQty')?.textContent || 0);
  let dmg = Number(tr.querySelector('.damQty')?.value || 0);

  if(dmg < 0) dmg = 0;
  if(dmg > req) dmg = req;

  tr.querySelector('.damQty').value = String(dmg);
  const net = Math.max(0, req - dmg);
  tr.querySelector('.netUsed').textContent = Number(net.toFixed(6));
}
window.calcNetUsed = calcNetUsed;

/* ---------- Collect RM Lines from Table ---------- */
function collectRMLines(){
  const rows = [...document.querySelectorAll('#prodBOMBody tr[data-rm]')];
  return rows.map(tr=>{
    const rmId = String(tr.dataset.rm || '').trim();
    const req  = Number(tr.querySelector('.reqQty')?.textContent || 0);
    const dmg  = Number(tr.querySelector('.damQty')?.value || 0);
    const net  = Number((req - dmg).toFixed(6));
    return { rmId, req, dmg, net };
  }).filter(l => l.rmId);
}

/* ---------- Validation ---------- */
function validateProductionInput(prodNo, fgId, fgQty, rmLines){
  if(!prodNo) return "Production No required";
  if(!fgId) return "Select FG product";
  if(!(fgQty > 0)) return "FG Qty must be > 0";
  if(!rmLines.length) return "No BOM rows found";

  for(const l of rmLines){
    if(l.dmg < 0) return "Damage cannot be negative";
    if(l.dmg > l.req) return "Damage cannot exceed Required";

    // Only validate balance for net used (req - dmg)
    if(l.net > 0){
      const bal = Number(computeBalance(l.rmId) || 0);
      if(l.net > bal){
        const p = products.find(x => x.id === l.rmId);
        return `RM stock insufficient: ${p?.name || 'RM'} (Bal ${bal})`;
      }
    }
  }
  return "";
}

/* ---------- SUBMIT PRODUCTION (THE MAIN ONE) ---------- */
function submitProduction(){
  if(!canProduction()){
    showToast("No permission to create production", true);
    return;
  }

  const prodNo   = String(document.getElementById('prodNo')?.value || '').trim();
  const prodDate = String(document.getElementById('prodDate')?.value || todayISO());
  const fgId     = String(document.getElementById('prodFG')?.value || '').trim();
  const fgQty    = Number(document.getElementById('prodFGQty')?.value || 0);
  const remark   = String(document.getElementById('prodRemark')?.value || '').trim();

  const rmLines = collectRMLines();

  const err = validateProductionInput(prodNo, fgId, fgQty, rmLines);
  if(err){
    showToast(err, true);
    return;
  }

  const fg = (fgProducts || []).find(x => x.id === fgId);
  const productionId = 'prod_' + genId();

  // 1) Save production record
  const record = {
    id: productionId,
    prodNo,
    date: prodDate,
    fgId,
    fgName: fg?.name || '',
    fgQty,
    remark,
    rmLines: rmLines.map(({rmId, req, dmg}) => ({ rmId, req, dmg })), // store clean
    createdAt: nowISO?.() || new Date().toISOString(),
    createdBy: who?.() || (currentUser?.username || '')
  };

  productions.push(record);

  // 2) FG IN movement
  fgMovements.push({
    id: genId(),
    fgId,
    type: 'IN',
    qty: fgQty,
    date: prodDate,
    remark: `PROD ${prodNo}${remark ? ' - ' + remark : ''}`,
    productionId,
    createdAt: nowISO?.() || new Date().toISOString(),
    createdBy: who?.() || (currentUser?.username || '')
  });

    // 3) RM OUT movements
  rmLines.forEach(l=>{
    const rmProd = products.find(x => x.id === l.rmId);
    const rmName = rmProd?.name || 'RM';

    // net used
    if(l.net > 0){
      const mvId = genId();
      stockMovements.push({
        id: mvId,
        productId: l.rmId,
        type: 'OUT',
        quantity: Number(l.net.toFixed(6)),
        date: prodDate,
        remark: `PROD ${prodNo} RM Used${rmName ? ' - ' + rmName : ''}`,
        productionId,
        createdAt: nowISO?.() || new Date().toISOString(),
        createdBy: who?.() || (currentUser?.username || '')
      });

      // ‚úÖ audit
      logChange("RM_OUT", l.rmId, {
        productionId,
        prodNo,
        date: prodDate,
        rm: rmName,
        qty: Number(l.net.toFixed(6)),
        kind: "USED"
      });
    }

    // damage out
    if(l.dmg > 0){
      const mvId2 = genId();
      stockMovements.push({
        id: mvId2,
        productId: l.rmId,
        type: 'OUT',
        quantity: Number(l.dmg.toFixed(6)),
        date: prodDate,
        remark: `PROD ${prodNo} RM Damage${rmName ? ' - ' + rmName : ''}`,
        productionId,
        createdAt: nowISO?.() || new Date().toISOString(),
        createdBy: who?.() || (currentUser?.username || '')
      });

      // ‚úÖ audit
      logChange("RM_OUT", l.rmId, {
        productionId,
        prodNo,
        date: prodDate,
        rm: rmName,
        qty: Number(l.dmg.toFixed(6)),
        kind: "DAMAGE"
      });
    }
  });

  // ‚úÖ also log FG IN (nice for audit)
  logChange("FG_IN", fgId, {
    productionId,
    prodNo,
    date: prodDate,
    fg: fg?.name || '',
    qty: fgQty
  });


  // 4) Persist (local)
  saveProductions();
  saveAllRM();
  saveFG();

  // 5) Persist (cloud) ‚Äî VERY IMPORTANT so autoPull doesn't wipe your RM OUT
  autoPushToCloud?.();

  // 6) UI
  refreshAll?.();
  showToast("Production saved ‚úÖ");

  // reset form
  const prodNoEl = document.getElementById('prodNo');
  const remEl    = document.getElementById('prodRemark');
  const fgEl     = document.getElementById('prodFG');
  const qtyEl    = document.getElementById('prodFGQty');
  const bomBody  = document.getElementById('prodBOMBody');

  if(prodNoEl) prodNoEl.value = '';
  if(remEl) remEl.value = '';
  if(fgEl) fgEl.value = '';
  if(qtyEl) qtyEl.value = 1;
  if(bomBody) bomBody.innerHTML = `<tr><td colspan="5" class="text-muted">Select FG product</td></tr>`;

  // go to records page if you use it
  openPage?.('pageProductionRecords');
  renderProductionsTable?.();
}
window.submitProduction = submitProduction;

/* ---------- TABLE: Production Records ---------- */
function renderProductionsTable(){
  const tb = document.getElementById('prodTableBody');
  if(!tb) return;

  const list = Array.isArray(window.productions) ? window.productions : [];
  const rows = list.slice().sort((a,b)=> (b.date||'').localeCompare(a.date||''));

  tb.innerHTML = rows.length ? '' : `<tr><td colspan="7" class="muted">No production records</td></tr>`;

  rows.forEach(p=>{
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(p.date||'')}</td>
        <td><b>${escapeHtml(p.prodNo||'')}</b></td>
        <td>${escapeHtml(p.fgName||'')}</td>
        <td class="right">${Number(p.fgQty||0)}</td>
        <td class="right">${(p.rmLines||[]).length}</td>
        <td>${escapeHtml(p.createdBy||'')}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" onclick="viewProduction('${escapeHtml(p.id)}')">
            View
          </button>
        </td>
      </tr>
    `);
  });
}
window.renderProductionsTable = renderProductionsTable;

/* ---------- DROPDOWN: FG list ---------- */
function renderProdFGDropdown(){
  const sel = document.getElementById('prodFG');
  if(!sel) return;

  const list = Array.isArray(window.fgProducts) ? window.fgProducts : [];
  sel.innerHTML = `<option value="">Select FG Product</option>`;

  list
    .slice()
    .sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')))
    .forEach(f=>{
      sel.insertAdjacentHTML(
        'beforeend',
        `<option value="${escapeHtml(f.id)}">${escapeHtml(f.name || 'Unnamed')}</option>`
      );
    });
}
window.renderProdFGDropdown = renderProdFGDropdown;

/* ---------- EVENTS (BOM refresh) ---------- */
function wireProductionEvents(){
  const fgSel = document.getElementById('prodFG');
  const qtyEl = document.getElementById('prodFGQty');

  if(fgSel) fgSel.onchange = renderBOM;
  if(qtyEl) qtyEl.oninput  = renderBOM;
}
document.addEventListener('DOMContentLoaded', wireProductionEvents);
window.wireProductionEvents = wireProductionEvents;


function renderFGOptions(){
  const sel = document.getElementById('prodFG');
  if(!sel) return;

  const list = Array.isArray(window.fgProducts) ? window.fgProducts : [];
  sel.innerHTML = `<option value="">-- Select FG --</option>` + list.map(p =>
    `<option value="${escapeHtml(String(p.id))}">${escapeHtml(p.name || 'Unnamed')}</option>`
  ).join('');
}
window.renderFGOptions = renderFGOptions;

function initFGSearchSelect(){
  const input = document.getElementById('productionFGSearch');
  const box   = document.getElementById('prodFGList');
  const sel   = document.getElementById('prodFG');
  if(!input || !box || !sel) return;

  const getList = () => (Array.isArray(window.fgProducts) ? window.fgProducts : []);

  function openBox(){ box.style.display = 'block'; }
  function closeBox(){ box.style.display = 'none'; }

  function draw(filterText){
    const q = String(filterText || '').trim().toLowerCase();
    const items = getList()
      .filter(p => (p.name || '').toLowerCase().includes(q) || String(p.code||'').toLowerCase().includes(q))
      .slice(0, 50);

    if(!items.length){
      box.innerHTML = `<div class="list-group-item text-muted small">No results</div>`;
      openBox();
      return;
    }

    box.innerHTML = items.map(p => `
      <button type="button" class="list-group-item list-group-item-action"
              data-id="${escapeHtml(String(p.id))}"
              data-name="${escapeHtml(p.name || '')}">
        <div class="fw-semibold">${escapeHtml(p.name || 'Unnamed')}</div>
        ${p.code ? `<div class="small text-muted">${escapeHtml(String(p.code))}</div>` : ``}
      </button>
    `).join('');

    openBox();
  }

  // typing search
  input.addEventListener('input', () => draw(input.value));
  input.addEventListener('focus', () => draw(input.value));

  // choose item
  box.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-id]');
    if(!btn) return;
    const id = btn.dataset.id;
    const name = btn.dataset.name || '';

    // set hidden select value so your existing renderBOM works
    sel.value = id;

    // show chosen name in input
    input.value = name;

    closeBox();
    renderBOM?.(); // ‚úÖ triggers your BOM render
  });

  // close when clicking outside
  document.addEventListener('click', (e) => {
    if(!e.target.closest('#prodFGWrap')) closeBox();
  });

  // if something else changes select programmatically
  sel.addEventListener('change', () => {
    const opt = sel.options[sel.selectedIndex];
    input.value = opt?.textContent?.trim() || '';
    renderBOM?.();
  });
}
window.initFGSearchSelect = initFGSearchSelect;


/* =========================
   ‚úÖ AUTO PRODUCTION NUMBER (LOCAL)
   Format: PROD-YYYYMMDD-###  e.g. PROD-20260115-001
========================= */

function prodDateKey(iso){
  const d = String(iso || todayISO()).trim();      // YYYY-MM-DD
  return d.replaceAll('-', '');                    // YYYYMMDD
}

function nextProdSeqForDate(dateISO){
  const key = prodDateKey(dateISO);

  // find max seq used today in productions[]
  let max = 0;
  (window.productions || []).forEach(p=>{
    const no = String(p.prodNo || '');
    const m = no.match(/^PROD-(\d{8})-(\d{3,})$/);
    if(m && m[1] === key){
      const n = parseInt(m[2], 10);
      if(n > max) max = n;
    }
  });

  return max + 1;
}

function formatProdNo(dateISO, seq){
  const key = prodDateKey(dateISO);
  return `PROD-${key}-${String(seq).padStart(3,'0')}`;
}

function setAutoProductionNo(force=false){
  const noEl = document.getElementById('prodNo');
  const dtEl = document.getElementById('prodDate');
  if(!noEl || !dtEl) return;

  if(!dtEl.value) dtEl.value = todayISO();

  const current = (noEl.value || '').trim();

  // only overwrite if empty OR force=true OR it looks like old auto format
  const looksAuto = /^PROD-\d{8}-\d{3,}$/.test(current);

  if(force || !current || looksAuto){
    const seq = nextProdSeqForDate(dtEl.value);
    noEl.value = formatProdNo(dtEl.value, seq);
  }
}




















/* ---------- Simple App Modal Helpers (uses your existing #modal) ---------- */
function openModal(title, html){
  const modal = document.getElementById('modal');
  if(!modal) return;

  const t = document.getElementById('modalTitle2');
  const b = document.getElementById('modalBody');

  if(t) t.textContent = title || 'Modal';
  if(b) b.innerHTML = html || '';

  modal.style.display = 'block';
}
function closeAppModal(){
  const modal = document.getElementById('modal');
  if(modal) modal.style.display = 'none';
}
// if your close button calls closeModal(), keep it:
window.closeModal = window.closeModal || closeAppModal;

function viewProduction(id){
  const list = Array.isArray(window.productions) ? window.productions : [];
  const p = list.find(x => String(x.id) === String(id));
  if(!p){
    showToast("Production not found", true);
    return;
  }

  const lines = (p.rmLines || []).map(l=>{
    const rm = products.find(x=>x.id===l.rmId);
    const net = Number((Number(l.req||0) - Number(l.dmg||0)).toFixed(6)); // net used
    return `
      <tr>
        <td>${escapeHtml(rm?.name || 'Unknown')}</td>
        <td class="text-end"><b>${net}</b></td>
        <td class="text-end">${Number(l.dmg || 0)}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="3" class="text-muted">No lines</td></tr>`;

  // ‚úÖ fallback modal ids (supports both your modalTitle2 or modalTitle)
  const modal = document.getElementById('modal');
  if(!modal){
    alert("Modal element #modal not found");
    return;
  }
  const titleEl = document.getElementById('modalTitle2') || document.getElementById('modalTitle');
  const bodyEl  = document.getElementById('modalBody');

  if(titleEl) titleEl.textContent = `Production ${p.prodNo || ''}`;
  if(bodyEl){
    bodyEl.innerHTML = `
      <div class="row g-2">
        <div class="col-12 col-md-3"><div class="text-muted small">Date</div><b>${escapeHtml(p.date||'')}</b></div>
        <div class="col-12 col-md-6"><div class="text-muted small">FG</div><b>${escapeHtml(p.fgName||'')}</b></div>
        <div class="col-12 col-md-3"><div class="text-muted small">FG Qty</div><b>${Number(p.fgQty||0)}</b></div>
        <div class="col-12"><div class="text-muted small">Remark</div><div>${escapeHtml(p.remark||'')}</div></div>

        <div class="col-12 mt-2" style="overflow:auto">
          <b>RM Lines</b>
          <table class="table table-sm mt-2">
            <thead class="table-light">
              <tr>
                <th>RM</th>
                <th class="text-end">Net Used</th>
                <th class="text-end">Damage</th>
              </tr>
            </thead>
            <tbody>${lines}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  modal.style.display = 'block';
}
window.viewProduction = viewProduction;


function saveProductions(){
  localStorage.setItem(KEY_PROD, JSON.stringify(productions));
  window.productions = productions; // ‚úÖ keep synced
}



















/* =========================
   ‚úÖ RM DELIVERY NOTE (DN) - CLEAN WORKING REWRITE
   - Searchable RM picker per row
   - ONE Production Plan field (header level)
   - Save / View / Print / Delete
========================= */
const KEY_DN = 'sms_delivery_notes_v1';
let deliveryNotes = JSON.parse(localStorage.getItem(KEY_DN) || '[]');

function saveDeliveryNotes(){
  localStorage.setItem(KEY_DN, JSON.stringify(deliveryNotes));
}

/* ---------- helpers ---------- */
function dnGenId(){
  return (typeof genId === 'function')
    ? genId()
    : (Date.now().toString(16) + Math.random().toString(16).slice(2));
}
function dnTodayISO(){
  return (typeof todayISO === 'function') ? todayISO() : new Date().toISOString().slice(0,10);
}
function dnFmtDateSafe(d){
  return (typeof fmtDate === 'function') ? fmtDate(d) : (d || '');
}
function dnToast(msg, bad=false){
  if(typeof showToast === 'function') showToast(msg, bad);
  else alert(msg);
}
function dnOneLineText(s){
  return String(s ?? '')
    .replace(/<br\s*\/?>/gi, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

/* =========================
   ‚úÖ RESET FORM
========================= */
function resetDeliveryNoteForm(){
  const no   = document.getElementById('dnNo');
  const dt   = document.getElementById('dnDate');
  const from = document.getElementById('dnFrom');
  const to   = document.getElementById('dnTo');
  const pref = document.getElementById('dnProdRef');
  const plan = document.getElementById('dnPlan');     // ‚úÖ single plan input
  const rem  = document.getElementById('dnRemark');
  const body = document.getElementById('dnItemsBody');

  if(no) no.value = '';
  if(dt) dt.value = dnTodayISO();
  if(from) from.value = from.value || 'Main Store';
  if(to) to.value = to.value || 'Factory';
  if(pref) pref.value = '';
  if(plan) plan.value = '';
  if(rem) rem.value = '';
  if(body) body.innerHTML = '';

  dnAddRow();
}

/* =========================
   ‚úÖ SEARCHABLE PRODUCT PICKER (per row)
========================= */
function dnSortedProducts(){
  if(!Array.isArray(products)) return [];
  return [...products].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
}
function dnProductLabel(p){
  const code = p?.code ? `(${p.code}) ` : '';
  return code + (p?.name || '');
}
function dnBuildSearchPickerHTML(selectedId=''){
  const p = Array.isArray(products) ? products.find(x => String(x.id) === String(selectedId)) : null;
  const label = p ? dnProductLabel(p) : '';
  return `
    <div class="dn-pick">
      <input class="dn-pick-input" type="text" placeholder="Search RM Product..."
        value="${escapeHtml(label)}" autocomplete="off" data-dn="productSearch">
      <input type="hidden" data-dn="product" value="${escapeHtml(selectedId)}">
      <div class="dn-pick-list" data-dn="productList"></div>
    </div>
  `;
}
function dnRenderPickerList(listEl, query=''){
  const q = (query || '').toLowerCase().trim();
  const arr = dnSortedProducts();

  const filtered = !q
    ? arr.slice(0, 60)
    : arr.filter(p=>{
        const name = (p.name||'').toLowerCase();
        const code = (p.code||'').toLowerCase();
        const group= (p.group||'').toLowerCase();
        return name.includes(q) || code.includes(q) || group.includes(q);
      }).slice(0, 80);

  if(!filtered.length){
    listEl.innerHTML = `<div class="dn-pick-item">No results</div>`;
    listEl.style.display = 'block';
    return;
  }

  listEl.innerHTML = filtered.map(p=>`
    <div class="dn-pick-item" data-id="${escapeHtml(p.id)}">
      <div>${escapeHtml(dnProductLabel(p))}</div>
      <div class="dn-pick-muted">${escapeHtml(p.group || '')}</div>
    </div>
  `).join('');
  listEl.style.display = 'block';
}
function dnBindRowProductPicker(tr){
  const searchInp = tr.querySelector('[data-dn="productSearch"]');
  const hiddenInp = tr.querySelector('[data-dn="product"]');
  const listEl    = tr.querySelector('[data-dn="productList"]');
  if(!searchInp || !hiddenInp || !listEl) return;

  const open = ()=> dnRenderPickerList(listEl, searchInp.value);

  searchInp.addEventListener('focus', open);
  searchInp.addEventListener('input', open);

  listEl.addEventListener('click', (e)=>{
    const item = e.target.closest('.dn-pick-item');
    if(!item?.dataset?.id) return;

    const id = item.dataset.id;
    const p = Array.isArray(products) ? products.find(x=> String(x.id) === String(id)) : null;

    hiddenInp.value = id;
    searchInp.value = dnProductLabel(p);
    listEl.style.display = 'none';
  });

  document.addEventListener('click', (e)=>{
    if(!tr.contains(e.target)) listEl.style.display = 'none';
  });
}

/* =========================
   ‚úÖ ADD / REMOVE ROWS
========================= */
function dnAddRow(prefill=null){
  const body = document.getElementById('dnItemsBody');
  if(!body) return;

  const rowId = 'dnRow_' + dnGenId();
  const selectedProductId = prefill?.productId || '';
  const qty    = prefill?.qty ?? '';
  const remark = prefill?.remark ?? '';

  body.insertAdjacentHTML('beforeend', `
    <tr id="${rowId}">
      <td style="min-width:240px">
        ${dnBuildSearchPickerHTML(selectedProductId)}
      </td>

      <td style="width:120px">
        <input class="small" type="number" min="0" step="1" style="width:100%" data-dn="qty"
          value="${escapeHtml(qty)}">
      </td>

      <td>
        <input class="small" style="width:100%" data-dn="remark"
          value="${escapeHtml(remark)}" placeholder="Remark (optional)">
      </td>

      <td style="width:80px;text-align:center">
        <button class="btn out" style="padding:6px 10px" onclick="dnRemoveRow('${rowId}')">X</button>
      </td>
    </tr>
  `);

  const tr = document.getElementById(rowId);
  dnBindRowProductPicker(tr);
}
function dnRemoveRow(rowId){
  const tr = document.getElementById(rowId);
  if(tr) tr.remove();

  const body = document.getElementById('dnItemsBody');
  if(body && body.children.length === 0) dnAddRow();
}

/* =========================
   ‚úÖ GET ITEMS FROM UI
========================= */
function getDNItemsFromUI(){
  const body = document.getElementById('dnItemsBody');
  if(!body) return [];

  const items = [];
  [...body.querySelectorAll('tr')].forEach(tr=>{
    const prodEl = tr.querySelector('[data-dn="product"]'); // hidden
    const qtyInp = tr.querySelector('[data-dn="qty"]');
    const remInp = tr.querySelector('[data-dn="remark"]');

    const productId = (prodEl?.value || '').trim();
    const qty = Number(qtyInp?.value || 0);
    const remark = (remInp?.value || '').trim();

    if(productId && qty > 0){
      items.push({ productId, qty, remark });
    }
  });

  return items;
}
function dnTotalQty(dn){
  return (dn.items || []).reduce((s,it)=> s + Number(it.qty||0), 0);
}

/* =========================
   ‚úÖ SUBMIT / SAVE DN
========================= */
let lastDNViewedId = null;

function submitDeliveryNote(){
  const dnNo = (document.getElementById('dnNo')?.value || '').trim();
  const dnDate = (document.getElementById('dnDate')?.value || dnTodayISO());
  const from = (document.getElementById('dnFrom')?.value || '').trim();
  const to = (document.getElementById('dnTo')?.value || '').trim();
  const prodRef = (document.getElementById('dnProdRef')?.value || '').trim();
  const productionPlan = dnOneLineText(document.getElementById('dnPlan')?.value || '');
  const generalRemark = (document.getElementById('dnRemark')?.value || '').trim();

  if(!dnNo){ dnToast("DN No is required", true); return; }
  if(!dnDate){ dnToast("DN Date is required", true); return; }
  if(!to){ dnToast("To (Factory) is required", true); return; }

  const items = getDNItemsFromUI();
  if(!items.length){ dnToast("Add at least 1 RM item (qty > 0)", true); return; }

  const dn = {
    id: 'dn_' + dnGenId(),
    dnNo,
    date: dnDate,
    from,
    to,
    productionPlan,   // ‚úÖ single plan saved here
    prodRef,
    generalRemark,
    items,
    createdAt: new Date().toISOString(),
    createdBy: currentUser?.username || ''
  };

  deliveryNotes.push(dn);
  saveDeliveryNotes();

  autoPushToCloud?.();
  refreshAll?.();

  dnToast("Delivery Note saved ‚úÖ");
  resetDeliveryNoteForm();
}

/* =========================
   ‚úÖ RENDER DN LIST
========================= */
function renderDNTable(){
  const tbody = document.querySelector('#dnTable tbody');
  if(!tbody) return;

  const q = (document.getElementById('dnSearch')?.value || '').toLowerCase().trim();
  tbody.innerHTML = '';

  const list = [...deliveryNotes].sort((a,b)=> new Date(b.date) - new Date(a.date));

  list.forEach(dn=>{
    const hay = `${dn.dnNo||''} ${dn.to||''} ${dn.prodRef||''} ${dn.productionPlan||''} ${dn.generalRemark||''}`.toLowerCase();
    if(q && !hay.includes(q)) return;

    
    const itemsCount = (dn.items || []).length;
    const canDel = (currentUser?.role === 'admin');

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${dnFmtDateSafe(dn.date)}</td>
        <td>${escapeHtml(dn.dnNo)}</td>
        <td>${escapeHtml(dn.to || '')}</td>
        <td>${itemsCount}</td>
        <td>
          <button class="btn info" onclick="viewDN('${escapeHtml(dn.id)}')">View</button>
          <button class="btn secondary" onclick="printDN('${escapeHtml(dn.id)}')">Print</button>
          ${canDel ? `<button class="btn out" onclick="deleteDN('${escapeHtml(dn.id)}')">Delete</button>` : ``}
        </td>
      </tr>
    `);
  });

  applyPermissions?.();
}

/* =========================
   ‚úÖ VIEW DN MODAL
========================= */
function viewDN(id){
  const dn = deliveryNotes.find(x=>x.id===id);
  if(!dn) return;

  lastDNViewedId = id;

  document.getElementById('dnViewTitle').textContent = `Delivery Note ‚Äî ${dn.dnNo}`;

  // ‚úÖ meta includes Production Plan (correctly inside template)
  document.getElementById('dnViewMeta').innerHTML =
    `<b>Date:</b> ${dnFmtDateSafe(dn.date)}
     &nbsp; | &nbsp; <b>From:</b> ${escapeHtml(dn.from || '-')}
     &nbsp; | &nbsp; <b>To:</b> ${escapeHtml(dn.to || '-')}
     ${dn.productionPlan ? ` &nbsp; | &nbsp; <b>Plan:</b> ${escapeHtml(dn.productionPlan)}` : ''}
     ${dn.prodRef ? ` &nbsp; | &nbsp; <b>Production Ref:</b> ${escapeHtml(dn.prodRef)}` : ''}
     ${dn.createdBy ? ` &nbsp; | &nbsp; <b>By:</b> ${escapeHtml(dn.createdBy)}` : ''}
     ${dn.generalRemark ? `<br><b>Remark:</b> ${escapeHtml(dn.generalRemark)}` : ''}`;

  const body = document.getElementById('dnViewBody');
  body.innerHTML = '';

  (dn.items || []).forEach(it=>{
    const p = Array.isArray(products) ? products.find(x=>x.id===it.productId) : null;
    body.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(p?.name || 'Unknown')}</td>
        <td>${Number(it.qty||0)}</td>
        <td>${escapeHtml(it.remark||'')}</td>
      </tr>
    `);
  });

  document.getElementById('dnViewModal').style.display = 'flex';
}
function closeDNView(){
  document.getElementById('dnViewModal').style.display = 'none';
}
function printDNFromModal(){
  if(lastDNViewedId) printDN(lastDNViewedId);
}

/* =========================
   ‚úÖ PRINT DN (PLAN SINGLE LINE)
========================= */
function printDN(id){
  const dn = deliveryNotes.find(x=>x.id===id);
  if(!dn) return;

  const rows = (dn.items || []).map((it, idx)=>{
    const p = Array.isArray(products) ? products.find(x=>x.id===it.productId) : null;
    return { sr: idx+1, product: p?.name || 'Unknown', qty: Number(it.qty||0), remark: it.remark || '' };
  });

  const totalQty = rows.reduce((s,r)=> s + Number(r.qty||0), 0);

  const w = window.open('', '_blank');
  if(!w){ dnToast("Popup blocked by browser", true); return; }

  const logoUrl = "pdflogo.png";
  const planLine = dnOneLineText(dn.productionPlan || '');

  w.document.write(`
  <html>
  <head>
    <title>Delivery Note ${escapeHtml(dn.dnNo)}</title>
    <style>
      :root{ --border:#d9d9df; --muted:#555; --head:#0d6efd; }
      *{ box-sizing:border-box; }
      body{ font-family:Arial,sans-serif; padding:20px; color:#111; }

      .banner{ border:1px solid var(--border); border-radius:14px; padding:10px 14px; margin-bottom:14px; }
      .banner img{ width:100%; max-height:110px; object-fit:contain; display:block; }

      .titleRow{ text-align:center; margin:6px 0 12px; }
      .titleRow h1{ margin:0; font-size:22px; letter-spacing:1px; }

      .metaBox{ border:1px solid var(--border); border-radius:14px; padding:12px 14px; margin-bottom:12px; }
      .metaGrid{ display:grid; grid-template-columns:1fr 1fr; gap:8px 18px; font-size:13px; }
      .metaItem{ display:flex; gap:8px; }
      .metaKey{ width:120px; color:var(--muted); font-weight:700; }
      .metaVal{ flex:1; word-break:break-word; }
      .metaVal1{ flex:1; word-break:break-word;font-weight:900; }

      /* ‚úÖ Force production plan to ONE line */
      .oneLine{ white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; }

      table{
        width:100%;
        table-layout:fixed;
        border-collapse:separate;
        border-spacing:0;
        border:1px solid var(--border);
        border-radius:14px;
        overflow:hidden;
        font-size:13px;
      }
      thead th{ background:var(--head); color:#fff; padding:10px; text-align:left; }
      tbody td{ border-top:1px solid var(--border); padding:9px 10px; vertical-align:top; }
      tbody tr:nth-child(even) td{ background:#fafafb; }

      .col-sr{ width:60px; text-align:center; }
      .col-qty{ width:120px; text-align:right; font-weight:700; }
      .col-rem{ width:240px; }

      .num{ text-align:right; }
      .center{ text-align:center; }
      .totalRow td{ background:#f2f6ff !important; font-weight:700; }

      .foot{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; margin-top:18px; }
      .sign{
                padding:12px;
        min-height:78px;
        display:flex;
        flex-direction:column;
        justify-content:flex-end;
      }
      .line{ margin-top:10px; border-top:1px dashed #999; }
      .small{ font-size:12px; color:var(--muted); margin-top:6px; }
    </style>
  </head>
  <body>

    <div class="banner"><img src="${logoUrl}" alt="Logo"></div>
    <div class="titleRow"><h1>DELIVERY NOTE</h1></div>

    <div class="metaBox">
      <div class="metaGrid">
        <div class="metaItem"><div class="metaKey">DN No</div><div class="metaVal">${escapeHtml(dn.dnNo)}</div></div>
        <div class="metaItem"><div class="metaKey">Date</div><div class="metaVal">${escapeHtml(dnFmtDateSafe(dn.date))}</div></div>
        <div class="metaItem"><div class="metaKey">From</div><div class="metaVal">${escapeHtml(dn.from || '-')}</div></div>
        <div class="metaItem"><div class="metaKey">To</div><div class="metaVal">${escapeHtml(dn.to || '-')}</div></div>

        ${planLine ? `
        <div class="metaItem" style="grid-column:1/-1">
          <div class="metaKey">Production Plan</div>
          <div class="metaVal1 oneLine" title="${escapeHtml(planLine)}">${escapeHtml(planLine)}</div>
        </div>` : ``}

        ${dn.prodRef ? `<div class="metaItem"><div class="metaKey">Production Ref</div><div class="metaVal1">${escapeHtml(dn.prodRef)}</div></div>` : ``}
               ${dn.generalRemark ? `
        <div class="metaItem" style="grid-column:1/-1">
          <div class="metaKey">Remark</div>
          <div class="metaVal">${escapeHtml(dn.generalRemark)}</div>
        </div>` : ``}
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th class="col-sr">Sr</th>
          <th>Product Name</th>
          <th class="col-qty">Quantity</th>
          <th class="col-rem">Remark</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td class="col-sr center">${r.sr}</td>
            <td>${escapeHtml(r.product)}</td>
            <td class="col-qty num">${Number(r.qty||0)}</td>
            <td class="col-rem">${escapeHtml(r.remark || '')}</td>
          </tr>
        `).join('')}

        
      </tbody>
    </table>
<div style="margin-top:30px;">
    <div class="foot">
      <div class="sign"><b>Prepared By</b><div class="line"></div><div class="small">Name / Sign</div></div>
      <div class="sign"></div>
      <div class="sign"><b>Received By (Factory)</b><div class="line"></div><div class="small">Name / Sign</div></div>
    </div></div>

    <script>window.onload=()=>window.print();<\/script>
  </body>
  </html>
  `);

  w.document.close();
}

/* =========================
   ‚úÖ DELETE DN
========================= */
function deleteDN(id){
  if(currentUser?.role !== 'admin'){
    dnToast("Only admin can delete DN", true);
    return;
  }
  const dn = deliveryNotes.find(x=>x.id===id);
  if(!dn) return;

  if(!confirm(`Delete DN "${dn.dnNo}"?`)) return;


  deliveryNotes = deliveryNotes.filter(x=>x.id!==id);
  saveDeliveryNotes();

  autoPushToCloud?.();
  refreshAll?.();

  dnToast("DN deleted ‚úÖ");
}


function dnProductDatalistHTML(){
  if(!Array.isArray(products) || !products.length){
    return `<datalist id="dnRmList"></datalist>`;
  }
  const sorted = [...products].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  return `
    <datalist id="dnRmList">
      ${sorted.map(p=>{
        const code = p.code ? `(${p.code}) ` : '';
        // value shows in search box; keep id in data attr later
        return `<option value="${escapeHtml(code + (p.name||''))}" data-id="${escapeHtml(p.id)}"></option>`;
      }).join('')}
    </datalist>
  `;
}




function dnSortedProducts(){
  if(!Array.isArray(products)) return [];
  return [...products].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
}

function dnProductLabel(p){
  const code = p?.code ? `(${p.code}) ` : '';
  return code + (p?.name || '');
}

function dnBuildSearchPickerHTML(selectedId=''){
  const p = products?.find(x => x.id === selectedId);
  const label = p ? dnProductLabel(p) : '';

  return `
    <div class="dn-pick">
      <input class="dn-pick-input" type="text" placeholder="Search RM Product..." value="${escapeHtml(label)}" autocomplete="off" data-dn="productSearch">
      <input type="hidden" data-dn="product" value="${escapeHtml(selectedId)}">
      <div class="dn-pick-list" data-dn="productList"></div>
    </div>
  `;
}

function dnRenderPickerList(listEl, query=''){
  const q = (query || '').toLowerCase().trim();
  const arr = dnSortedProducts();

  const filtered = !q ? arr.slice(0, 60) : arr.filter(p=>{
    const name = (p.name||'').toLowerCase();
    const code = (p.code||'').toLowerCase();
    const group= (p.group||'').toLowerCase();
    return name.includes(q) || code.includes(q) || group.includes(q);
  }).slice(0, 80);

  if(!filtered.length){
    listEl.innerHTML = `<div class="dn-pick-item">No results</div>`;
    listEl.style.display = 'block';
    return;
  }

  listEl.innerHTML = filtered.map(p=>{
    return `
      <div class="dn-pick-item" data-id="${escapeHtml(p.id)}">
        <div>${escapeHtml(dnProductLabel(p))}</div>
        <div class="dn-pick-muted">${escapeHtml((p.group||'') + (p.group ? '' : ''))}</div>
      </div>
    `;
  }).join('');
  listEl.style.display = 'block';
}

function dnBindRowProductPicker(tr){
  const searchInp = tr.querySelector('[data-dn="productSearch"]');
  const hiddenInp = tr.querySelector('[data-dn="product"]');
  const listEl    = tr.querySelector('[data-dn="productList"]');
  if(!searchInp || !hiddenInp || !listEl) return;

  // open list on focus
  searchInp.addEventListener('focus', ()=> dnRenderPickerList(listEl, searchInp.value));

  // filter while typing
  searchInp.addEventListener('input', ()=> dnRenderPickerList(listEl, searchInp.value));

  // choose item
  listEl.addEventListener('click', (e)=>{
    const item = e.target.closest('.dn-pick-item');
    if(!item || !item.dataset.id) return;

    const id = item.dataset.id;
    const p = products.find(x=> String(x.id) === String(id));
    hiddenInp.value = id;
    searchInp.value = dnProductLabel(p);

    listEl.style.display = 'none';
  });

  // close on outside click
  document.addEventListener('click', (e)=>{
    if(!tr.contains(e.target)) listEl.style.display = 'none';
  });
}


function addFGProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const elCode = document.getElementById('fgNewProductcode');
  const elBar  = document.getElementById('fgNewBarcode');
  const elName = document.getElementById('fgNewName');
  const elVol  = document.getElementById('fgNewVolume');
  const elGrp  = document.getElementById('fgNewGroup');
  const elBat  = document.getElementById('fgNewBatch');
  const elExp  = document.getElementById('fgNewExpiry');
  const elThr  = document.getElementById('fgNewThreshold');

  const name = (elName?.value || "").trim();
  const rawGroup = (elGrp?.value || "").trim();

  if(!name || !rawGroup){ showToast("Name & Group required", true); return; }

  fgProducts.push({
    id: 'fg_' + genId(),
    name,
    group: normalizeGroup(rawGroup),
    productcode: (elCode?.value || "").trim(),
    barcode: (elBar?.value || "").trim(),
    volume: (elVol?.value || "").trim(),
    batch: (elBat?.value || "").trim(),
    expiry: (elExp?.value || "").trim(),
    threshold: Number(elThr?.value || 5)
  });

  saveFGLocal();
  autoPushFGToCloud?.();
  refreshAll();

  if(elName) elName.value = '';
  if(elVol) elVol.value = '';
  if(elGrp) elGrp.value = '';
  if(elBat) elBat.value = '';
  if(elExp) elExp.value = '';
  if(elThr) elThr.value = '';
  if(elCode) elCode.value = '';
  if(elBar) elBar.value = '';

  showToast("FG product added ‚úÖ");
}



function editFGProduct(fgId){
  if(!canEdit()){ showToast("No permission to edit", true); return; }

  const fg = fgProducts.find(f => f.id === fgId);
  if(!fg) return;

  const newProductcode = prompt("Edit Product Code:", fg.productcode || "");
  if(newProductcode === null) return;
  if(!newProductcode.trim()){ showToast("Product code required", true); return; }

  const newBarcode = prompt("Edit Product barcode:", fg.barcode || "");
  if(newBarcode === null) return;
  if(!newBarcode.trim()){ showToast("Barcode required", true); return; } // ‚úÖ fixed: no newName here

  const newName = prompt("Edit Product Name:", fg.name || "");
  if(newName === null) return;
  if(!newName.trim()){ showToast("Name required", true); return; }

  const newVolume = prompt("Edit Volume / Size:", fg.volume || "");
  if(newVolume === null) return;

  const newGroup = prompt("Edit Group Prefix:", fg.group || "");
  if(newGroup === null) return;
  if(!newGroup.trim()){ showToast("Group required", true); return; }

  const newBatch = prompt("Edit Batch / Lot No:", fg.batch || "");
  if(newBatch === null) return;

  const newExpiry = prompt("Edit Expiry Date (YYYY-MM-DD):", fg.expiry || "");
  if(newExpiry === null) return;

  const newThreshold = prompt("Edit Low Stock Threshold:", String(fg.threshold ?? 5));
  if(newThreshold === null) return;
  if(isNaN(Number(newThreshold))){ showToast("Threshold must be a number", true); return; }

  fg.name       = newName.trim();
  fg.productcode= newProductcode.trim();
  fg.barcode    = newBarcode.trim();
  fg.volume     = (newVolume || '').trim();
  fg.group      = normalizeGroup(newGroup);
  fg.batch      = (newBatch || '').trim();
  fg.expiry     = (newExpiry || '').trim();
  fg.threshold  = Number(newThreshold);

  saveFGLocal();
  autoPushFGToCloud?.();
  refreshAll?.();
  showToast("FG updated ‚úÖ");
}


function deleteFGProduct(fgId){
  if(!canDelete()){ showToast("No permission to delete", true); return; }

  const fg = fgProducts.find(f => f.id === fgId);
  if(!fg) return;

  if(!confirm(`Delete FG "${fg.name}"? (History also deleted)`)) return;

  fgProducts = fgProducts.filter(f => f.id !== fgId);
  fgMovements = fgMovements.filter(m => m.fgId !== fgId);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  showToast("FG deleted ‚úÖ");
}

/* =========================
   ‚úÖ RM PAGES
========================= */
function renderProductsTable(){
  const tbody = document.querySelector('#productsTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const localSearch = (document.getElementById('productSearch')?.value || '').trim().toLowerCase();

  let i=1;
  products.forEach(p=>{
    const name = (p.name||'').toLowerCase();
    const cat  = (p.category||'').toLowerCase();
    if(localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) return;

    const bal = computeBalance(p.id);

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${escapeHtml(p.category||'')}</td>
        <td>${bal}</td>
        <td>${Number(p.threshold ?? 5)}</td>
        <td>${escapeHtml(p.barcode||'')}</td>
        <td><button class="btn secondary" onclick="openHistory('${p.id}')">History</button></td>
        <td><button class="btn secondary btn-edit admin-only" onclick="editProduct('${p.id}')">Edit</button></td>
        <td><button class="btn out btn-delete admin-only" onclick="deleteProduct('${p.id}')">Delete</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderStockIn(){
  const tbody = document.querySelector('#stockInBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('inSearch')?.value || '').toLowerCase().trim();

  products.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
	<td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'IN')}</td>
        <td><button class="btn" onclick="openStockModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}

function renderStockOut(){
  const tbody = document.querySelector('#stockOutBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('outSearch')?.value || '').toLowerCase().trim();

  products.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
	<td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'OUT')}</td>
        <td><button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderCombinedHistory(){
  const tbody = document.querySelector('#historyTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('historySearch')?.value || '').toLowerCase().trim();

  stockMovements
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = products.find(p=>p.id===m.productId);
      if(!prod) return;

      const okSearch =
        !search ||
        (prod.name||'').toLowerCase().includes(search) ||
        (m.remark||'').toLowerCase().includes(search);

      if(!okSearch) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
    <td>${fmtDateTime(m.createdAt || (m.date ? m.date+"T00:00:00.000Z" : ""))}</td>
          <td>${escapeHtml(prod.name||'')}</td>
          <td>${escapeHtml(m.type||'')}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

/* =========================
   ‚úÖ MODALS (RM + FG)
========================= */
let modalCurrent = null;

function openStockModal(productId, type){
  if(type === 'OUT' && !canStockOut()){
    showToast("Stock OUT not allowed for your role", true);
    return;
  }

  modalCurrent = { productId, type };
  const prod = products.find(p=>p.id===productId);
  if(!prod) return;

  document.getElementById('modalProductName').textContent = prod.name;
  document.getElementById('modalProductBalance').textContent = computeBalance(productId);
  document.getElementById('modalQty').value = '';
  document.getElementById('modalRemark').value = '';

  document.getElementById('stockModal').style.display = 'flex';

  document.getElementById('modalSave').onclick = ()=>{
    const qty = Number(document.getElementById('modalQty').value);
    const remark = document.getElementById('modalRemark').value.trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeBalance(productId)){ showToast("Quantity exceeds balance", true); return; }

stockMovements.push({
  id: genId(),
  productId,
  type,
  quantity: qty,
  date: todayISO(),
  remark,

  createdAt: new Date().toISOString(),
  createdBy: who()
});

logChange(type === 'IN' ? "RM_STOCK_IN" : "RM_STOCK_OUT", productId, {
  qty,
  remark
});

    saveAll();
    autoPushToCloud();
    closeModal();
    refreshAll();
    showToast(`RM Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}

function openFGModal(fgId, type){
  if(type === 'OUT' && !canStockOut()){
    showToast("Stock OUT not allowed for your role", true);
    return;
  }

  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  document.getElementById('modalProductName').textContent = fg.name;
  document.getElementById('modalProductBalance').textContent = computeFGBalance(fgId);
  document.getElementById('modalQty').value = '';
  document.getElementById('modalRemark').value = '';
  document.getElementById('stockModal').style.display = 'flex';

  document.getElementById('modalSave').onclick = ()=>{
    const qty = Number(document.getElementById('modalQty').value);
    const remark = document.getElementById('modalRemark').value.trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeFGBalance(fgId)){ showToast("Quantity exceeds FG balance", true); return; }

 fgMovements.push({
  id: genId(),
  fgId,
  type,
  qty,
  batch: fg.batch || '',
  expiry: fg.expiry || '',
  date: todayISO(),
  remark,

  createdAt: nowISO(),
  createdBy: who()
});

logChange(type === 'IN' ? "FG_STOCK_IN" : "FG_STOCK_OUT", fgId, {
  qty,
  remark
});
saveFGLocal();

    autoPushFGToCloud();
    closeModal();
    refreshAll();
    showToast(`FG Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}

function closeModal(){
  // Close Stock IN/OUT modal (existing)
  const stockModal = document.getElementById('stockModal');
  if(stockModal) stockModal.style.display = 'none';

  // Close Generic App Modal (production view)
  const appModal = document.getElementById('modal');
  if(appModal) appModal.style.display = 'none';

  modalCurrent = null;
}
window.closeModal = closeModal;

/* RM history modal */
function openHistory(productId){
  const prod = products.find(p=>p.id===productId);
  if(!prod) return;

  const modal = document.getElementById('historyModal');
  modal.style.display='flex';

  document.getElementById('modalTitle').textContent = `RM History ‚Äî ${prod.name}`;

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.productId===productId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
    <td>${fmtDateTime(m.createdAt || (m.date ? m.date+"T00:00:00.000Z" : ""))}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>-</td>
          <td>-</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

function closeHistoryModal(){
  document.getElementById('historyModal').style.display='none';
}

/* RM Stock IN/OUT History modals */
function stockInHistoryModal(){
  const modal = document.getElementById('stockInHistoryModal');
  if(!modal){
    console.error('Missing element: #stockInHistoryModal (add the modal HTML or fix the id)');
    return;
  }

  const tbody = document.getElementById('stockInHistoryPopupBody');
  if(!tbody){
    console.error('Missing element: #stockInHistoryPopupBody (fix tbody id in HTML)');
    return;
  }

  modal.style.display = 'flex';
  tbody.innerHTML = '';

  (Array.isArray(stockMovements) ? stockMovements : [])
    .filter(m => m?.type === 'IN')
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .forEach(m=>{
      const prod = (Array.isArray(products) ? products : []).find(p=>p.id === m.productId);
      if(!prod) return;

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
    <td>${fmtDateTime(m.createdAt || (m.date ? m.date+"T00:00:00.000Z" : ""))}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td class="text-end">${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

function closeStockInHistory(){
  const el = document.getElementById('stockInHistoryModal');
  if(el) el.style.display = 'none';
}
function stockOutHistoryModal(){
  const modal = document.getElementById('stockOutHistoryModal');
  if(!modal){
    console.error('Missing element: #stockOutHistoryModal');
    return;
  }

  const tbody = document.getElementById('stockOutHistoryPopupBody');
  if(!tbody){
    console.error('Missing element: #stockOutHistoryPopupBody');
    return;
  }

  modal.style.display='flex';
  tbody.innerHTML='';

  (Array.isArray(stockMovements) ? stockMovements : [])
    .filter(m=>m?.type==='OUT')
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = (Array.isArray(products) ? products : []).find(p=>p.id===m.productId);
      if(!prod) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
    <td>${fmtDateTime(m.createdAt || (m.date ? m.date+"T00:00:00.000Z" : ""))}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td class="text-end">${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

function closeStockOutHistory(){
  const el = document.getElementById('stockOutHistoryModal');
  if(el) el.style.display='none';
}
function parseISOIgnoreTZ(value){
  if(!value) return null;

  const s = String(value).trim();

  // YYYY-MM-DD
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d, 0, 0, 0);
  }

  // YYYY-MM-DDTHH:mm(:ss)?(.ms)?(Z or +xx:yy)?
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2})(?::(\d{2}))?)?/);
  if(m){
    const y  = Number(m[1]);
    const mo = Number(m[2]);
    const d  = Number(m[3]);
    const hh = Number(m[4] || 0);
    const mi = Number(m[5] || 0);
    const ss = Number(m[6] || 0);
    // IMPORTANT: create as LOCAL time (ignore Z / offsets completely)
    return new Date(y, mo-1, d, hh, mi, ss);
  }

  // fallback
  const x = new Date(s);
  return isNaN(x) ? null : x;
}

function fmtDateTime(iso){
  if(!iso) return '-';
  const d = new Date(iso);
  if(isNaN(d)) return String(iso);
  return new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Asia/Dubai',
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(d);
}


/* FG IN/OUT History (use historyModal) */
function fgStockInHistoryModal(){
  const modal = document.getElementById("historyModal");
  modal.style.display = "flex";
  document.getElementById("modalTitle").textContent = "FG Stock IN History";

  const tbody = document.getElementById("modalHistoryBody");
  tbody.innerHTML = "";

  fgMovements
    .filter(m => m.type === "IN")
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id === m.fgId);
      if(!fg) return;
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
    <td>${fmtDateTime(m.createdAt || (m.date ? m.date+"T00:00:00.000Z" : ""))}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>IN</td>
          <td>${Number(m.qty || 0)}</td>
          <td>${escapeHtml(m.batch || fg.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || fg.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

function fgStockOutHistoryModal(){
  const modal = document.getElementById("historyModal");
  modal.style.display = "flex";
  document.getElementById("modalTitle").textContent = "FG Stock OUT History";

  const tbody = document.getElementById("modalHistoryBody");
  tbody.innerHTML = "";

  fgMovements
    .filter(m => m.type === "OUT")
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id === m.fgId);
      if(!fg) return;
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
    <td>${fmtDateTime(m.createdAt || (m.date ? m.date+"T00:00:00.000Z" : ""))}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>OUT</td>
          <td>${Number(m.qty || 0)}</td>
          <td>${escapeHtml(m.batch || fg.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || fg.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

/* =========================
   ‚úÖ RM ADD / EDIT / DELETE
========================= */
function addRMProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const code = (document.getElementById('newCode')?.value || '').trim();
  const name = (document.getElementById('newName')?.value || '').trim();
  const category = (document.getElementById('newCategory')?.value || '').trim();
  const threshold = Number(document.getElementById('newThreshold')?.value || 5);
  const barcode = (document.getElementById('newBarcode')?.value || '').trim();
  const groupsStr = (document.getElementById('newGroups')?.value || '').trim();
  const exclusive = !!document.getElementById('newExclusive')?.checked;

  if(!name){ showToast("Product name required", true); return; }

  const groups = groupsStr
    ? groupsStr.split(',').map(g=>g.trim()).filter(Boolean)
    : [];

  products.push({
    id: 'rm_' + genId(),
    code, name, category,
    threshold: isNaN(threshold) ? 5 : threshold,
    barcode,
    groups,
    exclusive
  });

  saveAll();
  autoPushToCloud();
  refreshAll();

  newCode.value=''; newName.value=''; newCategory.value='';
  newThreshold.value=''; newBarcode.value=''; newGroups.value='';
  newExclusive.checked=false;

  showToast("RM product added ‚úÖ");
}

function editProduct(productId){
  if(!canEdit()){
    showToast("No permission to edit", true);
    return;
  }

  const prod = products.find(p => p.id === productId);
  if(!prod) return;

  const newCode = prompt("Edit product code:", prod.code || "");
  if(newCode === null) return;

  const newName = prompt("Edit product name:", prod.name || "");
  if(newName === null || !newName.trim()){
    showToast("Name required", true);
    return;
  }

  const newCategory = prompt("Edit category:", prod.category || "");
  if(newCategory === null) return;

  const newThreshold = prompt("Edit threshold:", prod.threshold ?? 5);
  if(newThreshold === null || isNaN(Number(newThreshold))){
    showToast("Invalid threshold", true);
    return;
  }

  const newBarcode = prompt("Edit barcode:", prod.barcode || "");
  if(newBarcode === null) return;

  const newGroupsInput = prompt(
    "Edit groups (comma separated):",
    Array.isArray(prod.groups) ? prod.groups.join(', ') : ''
  );
  if(newGroupsInput === null) return;

  const newExclusive = confirm("Exclusive to first group?");

  prod.code = newCode.trim();
  prod.name = newName.trim();
  prod.category = (newCategory || '').trim();
  prod.threshold = Number(newThreshold);
  prod.barcode = (newBarcode || '').trim();
  prod.groups = (newGroupsInput || '')
    .split(',')
    .map(g => g.trim())
    .filter(Boolean);
  prod.exclusive = newExclusive;

  saveAll();
  autoPushToCloud();
  refreshAll();

  showToast("Product updated ‚úÖ");
}

function deleteProduct(productId){
  if(!canDelete()){
    showToast("No permission to delete", true);
    return;
  }

  const prod = products.find(p => p.id === productId);
  if(!prod) return;

  if(!confirm(`Delete "${prod.name}"?\nThis will remove all its stock history.`)) return;

  products = products.filter(p => p.id !== productId);
  stockMovements = stockMovements.filter(m => m.productId !== productId);
logChange("PROD_DELETE", id, {
  prodNo: p.prodNo,
  date: p.date,
  fgName: p.fgName,
  fgQty: p.fgQty
});

  saveAll();
  autoPushToCloud();
  refreshAll();

  showToast("Product deleted ‚úÖ");
}

/* =========================
   ‚úÖ BOM / DASHBOARD GROUPED TABLE
========================= */
let dashboardSearchText = "";
let selectedDashboardGroup = null;
let renamedGroups = JSON.parse(localStorage.getItem('renamedGroups') || '{}');

function handleDashboardSearch(value){
  dashboardSearchText = (value || "").toLowerCase().trim();
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function clearDashboardSearch(){
  const inp = document.getElementById('dashboardSearch');
  if(inp) inp.value = '';
  dashboardSearchText = '';
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function selectDashboardGroup(groupName){
  selectedDashboardGroup = groupName;
  renderDashboardGrouped();
}
function getFGStock(groupName){
  const key = normalizeGroup(groupName);
  let total = 0;
  fgProducts.forEach(fg=>{
    if(normalizeGroup(fg.group) === key){
      total += computeFGBalance(fg.id);
    }
  });
  return total;
}
function renameGroup(groupName){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can rename groups", true);
    return;
  }
  const newName = prompt(`Enter new display name for "${groupName}"`, renamedGroups[groupName] || groupName);
  if(!newName) return;

  renamedGroups[groupName] = newName.trim();
  localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
  saveRenamedGroupsToCloud();
  renderDashboardGrouped();
}
function saveRenamedGroupsToCloud(){
  cloudDB.ref("dashboardRenamedGroups").set(renamedGroups);
}
function loadRenamedGroupsFromCloud(){
  cloudDB.ref("dashboardRenamedGroups").once("value").then(snap=>{
    if(snap.exists()){
      renamedGroups = snap.val() || {};
      localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
      renderDashboardGrouped();
    }
  });
}

// Grouped BOM render (shows groups by default)
function renderDashboardGrouped(){
  const tbody = document.querySelector('#dashTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  const groupsMap = {};

  products.forEach(p=>{
    if(!Array.isArray(p.groups) || !p.groups.length) return;

    p.groups.forEach(g=>{
      if(!groupsMap[g]) groupsMap[g] = [];

      // exclusive products only show in first group
      if(p.exclusive && p.groups[0] !== g) return;

      groupsMap[g].push(p);
    });
  });

  const allGroups = Object.keys(groupsMap).sort((a,b)=>a.localeCompare(b));
  const search = dashboardSearchText;

  // If no groups configured, show info row
  if(!allGroups.length){
    tbody.insertAdjacentHTML('beforeend', `
      <tr><td colspan="6"><b>No BOM groups found.</b> Add "Groups" to RM products (comma separated).</td></tr>
    `);
    return;
  }

  allGroups.forEach(groupName=>{
    const displayName = renamedGroups[groupName] || groupName;

    const groupProducts = groupsMap[groupName].filter(p=>{
      const nm = (p.name||'').toLowerCase();
      const gp = displayName.toLowerCase();
      return !search || nm.includes(search) || gp.includes(search);
    });

    if(!groupProducts.length) return;
    if(selectedDashboardGroup && selectedDashboardGroup !== groupName) return;

    const fgBalance = getFGStock(groupName);

    const groupRow = document.createElement('tr');
    groupRow.innerHTML = `
      <td colspan="6" style="padding:18px;cursor:pointer;background:rgba(0,0,0,0.03)"
          onclick="selectDashboardGroup('${escapeHtml(groupName)}')">
        <b>${escapeHtml(displayName).toUpperCase()}</b>
        <span style="margin-left:40px;color:green;font-weight:bold">
          FG BALANCE: ${fgBalance}
        </span>
        ${
          currentUser?.role === 'admin'
            ? `<button class="btn secondary" style="margin-left:15px;padding:6px 10px"
                 onclick="event.stopPropagation(); renameGroup('${escapeHtml(groupName)}')">
                 Rename
               </button>`
            : ''
        }
      </td>
    `;
    tbody.appendChild(groupRow);

    // show products only when group is selected
    if(selectedDashboardGroup === groupName){
      groupProducts.forEach(p=>{
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
		<td>${escapeHtml(p.code||'')}</td>
            <td style="padding-left:25px">${escapeHtml(p.name||'')}</td>
            <td class="${bal <= Number(p.threshold ?? 5) ? 'low-stock':''}">${bal}</td>
            <td>${Number(p.threshold ?? 5)}</td>
            <td>${lastMovement(p.id,'IN')}</td>
            <td>${lastMovement(p.id,'OUT')}</td>
            <td>
              <button class="btn secondary" onclick="openHistory('${p.id}')">View</button>
              <button class="btn" onclick="openStockModal('${p.id}','IN')">Add IN</button>
              <button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock OUT</button>
            </td>
          </tr>
        `);
      });
    }
  });
buildGroupIndexes();     // ‚úÖ important (connects BOM to grouping)
  hydrateProductionFG();   

  applyPermissions();
}
function groupKey(v){
  return normalizeGroup(v); // UPPERCASE + remove spaces
}

function normGroup(g){
  return String(g || '').trim().toLowerCase();
}
function groupFromName(name){
  return String(name || '').trim().split(/\s+/)[0]?.toLowerCase() || '';
}
function buildGroupIndexes(){
  if(!window._idx) window._idx = {};
  window._idx.fgById = new Map();
  window._idx.rmByGroup = new Map();

  // FG list
  const fgList = Array.isArray(fgProducts) ? fgProducts : [];
  fgList.forEach(f => window._idx.fgById.set(String(f.id), f));

  // RM list
  const rmList = Array.isArray(products) ? products : [];
  rmList.forEach(rm=>{
    const arr = Array.isArray(rm.groups) ? rm.groups : [];
    if(!arr.length) return;

    // if exclusive: only first group
    const groupsToUse = rm.exclusive ? [arr[0]] : arr;

    groupsToUse.forEach(g=>{
      const k = groupKey(g);
      if(!k) return;
      if(!window._idx.rmByGroup.has(k)) window._idx.rmByGroup.set(k, []);
      window._idx.rmByGroup.get(k).push(rm);
    });
  });
}

function hydrateProductionFG(){
  const sel = document.getElementById('prodFG');
  if(!sel) return;

  const fgList = Array.from(window._idx.fgById.values());

  sel.innerHTML = `<option value="">-- Select FG --</option>` +
    fgList
      .slice()
      .sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(f => `<option value="${escapeHtml(String(f.id))}">${escapeHtml(f.name||'')}</option>`)
      .join('');
}

function loadBills(){
  try { bills = JSON.parse(localStorage.getItem(KEY_BILLS) || "[]"); }
  catch { bills = []; }
}
function saveBills(){
  localStorage.setItem(KEY_BILLS, JSON.stringify(bills || []));
}

function loadProductions(){
  try { productions = JSON.parse(localStorage.getItem(KEY_PROD) || "[]"); }
  catch { productions = []; }
}
function saveProductions(){
  localStorage.setItem(KEY_PROD, JSON.stringify(productions || []));
}

function saveAllRM(){
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products || []));
  localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements || []));
  saveBills();
  saveProductions();
}

/* =========================
   ‚úÖ CLOUD SYNC (RM + FG) ‚Äî SAFE GLOBAL VERSION
   Works even if your main data lives inside an IIFE
========================= */
function getBillsForCloud(){
  // ‚úÖ BOE module stores bills here
  try{
    const ls = JSON.parse(localStorage.getItem("sms_bills_v1") || "[]");
    if(Array.isArray(ls)) return ls;
  }catch(e){}

  // fallback
  if(Array.isArray(window.savedBills)) return window.savedBills;
  if(Array.isArray(window.BOE?.saveBills) && Array.isArray(window.BOE?.bills)) return window.BOE.bills;

  return [];
}

function toArray(v){
  if(Array.isArray(v)) return v;
  if(v && typeof v === "object") return Object.values(v);
  return [];
}

/* =========================
   ‚úÖ CLOUD SYNC (RM + FG + Suppliers + BOE + DN + Production)
========================= */
function autoPushToCloud(){
  if(!window.cloudDB) return;

  const payload = {
    products: (products || []),
    stockMovements: (stockMovements || []),
    fgProducts: (fgProducts || []),
    fgMovements: (fgMovements || []),

    suppliers: (window.suppliers || []),

    bills: (window.savedBills || []),          // from BOE module
    productions: (window.productions || []),
    deliveryNotes: (window.deliveryNotes || []) // if you make it global; else remove
  };

  cloudDB.ref(CLOUD_PATH_RM).set(payload)
    .then(()=> console.log("‚òÅÔ∏è pushed:", CLOUD_PATH_RM))
    .catch(err=> console.error("‚òÅÔ∏è push failed:", err));
}
window.autoPushToCloud = autoPushToCloud;

async function autoPullFromCloud(){
  if(!window.cloudDB) return;

  try{
    const snap = await cloudDB.ref(CLOUD_PATH_RM).once("value");
    const data = snap.val();
    if(!data){ console.warn("‚òÅÔ∏è no data at:", CLOUD_PATH_RM); return; }

    if(Array.isArray(data.products)) products = data.products;
    if(Array.isArray(data.stockMovements)) stockMovements = data.stockMovements;

    if(Array.isArray(data.fgProducts)) fgProducts = data.fgProducts;
    if(Array.isArray(data.fgMovements)) fgMovements = data.fgMovements;

    if(Array.isArray(data.suppliers)) window.suppliers = data.suppliers;

    if(Array.isArray(data.bills)) {
      window.savedBills = data.bills;
      localStorage.setItem("sms_bills_v1", JSON.stringify(window.savedBills));
    }

    if(Array.isArray(data.productions)) {
      window.productions = data.productions;
      localStorage.setItem("sms_productions_v1", JSON.stringify(window.productions));
    }

    // persist locals
    localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products || []));
    localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements || []));
    saveFGLocal?.();
    saveSuppliers?.();

    // refresh UI
    refreshAll?.();
    renderSuppliers?.();
    BOE?.renderTable?.();
    renderBOESupplierDropdown?.();

    console.log("‚òÅÔ∏è pulled:", CLOUD_PATH_RM);
  }catch(err){
    console.error("‚òÅÔ∏è pull failed:", err);
  }
}
window.autoPullFromCloud = autoPullFromCloud;


function autoPullFromCloud(){
  if (typeof cloudDB === "undefined" || !cloudDB) return Promise.resolve();

  return cloudDB.ref("stockManager").once("value")
    .then(snapshot=>{
      const data = snapshot.val();
      if(!data) return;

      products = data.products || [];
      stockMovements = data.stockMovements || [];
      productions = data.productions || [];

      // bills are owned by BOE module
      if (Array.isArray(data.bills)) {
        localStorage.setItem("sms_bills_v1", JSON.stringify(data.bills));
        window.savedBills = data.bills;
      }

      // audit log
      auditLog = Array.isArray(data.auditLog) ? data.auditLog : auditLog;
      saveAudit();

      saveAll?.();
      saveProductions?.();
      refreshAll?.();

      // refresh BOE table if module exists
      BOE?.renderTable?.();
    })
    .catch(err => console.error("Auto pull failed:", err));
}


function autoPullFGFromCloud(){
  if (typeof cloudDB === "undefined" || !cloudDB) return Promise.resolve();

  return cloudDB.ref("fgManager").once("value")
    .then(snap=>{
      if(!snap.exists()) return;

      const data = snap.val() || {};
      const normArr = (v) => Array.isArray(v) ? v : (v && typeof v === "object" ? Object.values(v) : []);

window.fgProducts  = normArr(data.products);
window.fgMovements = normArr(data.movements);

// ‚úÖ keep local variables in sync (very important)
fgProducts  = window.fgProducts;
fgMovements = window.fgMovements;


      // ‚úÖ call your existing save/render hooks
      window.saveFG?.();
      window.saveFGLocal?.();
      window.initFGVolumeSelection?.();
      window.refreshAll?.();
    })
    .catch(err=>{
      console.error("autoPullFGFromCloud failed:", err);
      window.showToast?.("FG pull failed (check Firebase rules)", true);
    });
renderProdFGDropdown?.();
renderBOM?.(); // optional (if FG already selected)

}

// ===== FG CLOUD PATHS =====
const CLOUD_PATH_BASE = "stockManager/v1";
const CLOUD_PATH_FG_PRODUCTS = `${CLOUD_PATH_BASE}/fgProducts`;
const CLOUD_PATH_FG_MOVES    = `${CLOUD_PATH_BASE}/fgMovements`;

// ===== PUSH FG TO CLOUD =====
async function autoPushFGToCloud(){
  try{
    if(!window.cloudDB) return;
    await cloudDB.ref(CLOUD_PATH_FG_PRODUCTS).set(Array.isArray(fgProducts) ? fgProducts : []);
    await cloudDB.ref(CLOUD_PATH_FG_MOVES).set(Array.isArray(fgMovements) ? fgMovements : []);
    console.log("‚úÖ FG pushed to cloud");
  }catch(err){
    console.error("‚ùå FG push failed:", err);
  }
}
window.autoPushFGToCloud = autoPushFGToCloud;









/* =========================
   ‚úÖ REPORTS + EXPORT/IMPORT
========================= */
function printStockReport(){
  const rows = products
    .slice()
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    .map(p=>({
      Code: p.code || '',
      Product: p.name || '',
           Balance: computeBalance(p.id),
      Threshold: Number(p.threshold ?? 5),
      LastIN: lastMovement(p.id,'IN'),
      LastOUT: lastMovement(p.id,'OUT')
    }));

  const w = window.open('', '_blank');
  if(!w) { showToast("Popup blocked by browser", true); return; }

  w.document.write(`
    <html><head><title>RM Stock Report</title>
    <style>
      body{font-family:Arial;padding:18px}
      h2{margin:0 0 12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ccc;padding:8px;text-align:left}
      th{background:#007bff;color:#fff}
    </style>
    </head><body class="print-bg">
    <h2>RM Stock Report</h2>
    <p>Date: ${new Date().toLocaleString()}</p>
    <table>
      <thead><tr>
        <th>Code</th><th>Product</th><th>Category</th><th>Balance</th><th>Threshold</th><th>Last IN</th><th>Last OUT</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.Code)}</td>
            <td>${escapeHtml(r.Product)}</td>
            <td>${escapeHtml(r.Category)}</td>
            <td>${r.Balance}</td>
            <td>${r.Threshold}</td>
            <td>${escapeHtml(r.LastIN)}</td>
            <td>${escapeHtml(r.LastOUT)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function printFGStockReport(){
  const rows = fgProducts
    .slice()
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    .map(f=>({
      Product: f.name || '',
      Volume: f.volume || '',
      Group: f.group || '',
      Balance: computeFGBalance(f.id),
      Threshold: Number(f.threshold ?? 5),
      Batch: f.batch || '',
      Expiry: f.expiry || ''
    }));

  const w = window.open('', '_blank');
  if(!w) { showToast("Popup blocked by browser", true); return; }

  w.document.write(`
    <html><head><title>FG Stock Report</title>
    <style>
      body{font-family:Arial;padding:18px}
      h2{margin:0 0 12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ccc;padding:8px;text-align:left}
      th{background:#16a34a;color:#fff}
    </style>
    </head><body>
    <h2>FG Stock Report</h2>
    <p>Date: ${new Date().toLocaleString()}</p>
    <table>
      <thead><tr>
        <th>Product</th><th>Volume</th><th>Group</th><th>Balance</th><th>Threshold</th><th>Batch</th><th>Expiry</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.Product)}</td>
            <td>${escapeHtml(r.Volume)}</td>
            <td>${escapeHtml(r.Group)}</td>
            <td>${r.Balance}</td>
            <td>${r.Threshold}</td>
            <td>${escapeHtml(r.Batch)}</td>
            <td>${escapeHtml(r.Expiry)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function exportExcel(){
  try{
    const wb = XLSX.utils.book_new();

    const rmProducts = products.map(p=>({
      id:p.id, code:p.code||'', name:p.name||'', category:p.category||'',
      threshold:Number(p.threshold ?? 5), barcode:p.barcode||'',
      groups: Array.isArray(p.groups)? p.groups.join(', ') : '',
      exclusive: !!p.exclusive
    }));
    const rmMoves = stockMovements.map(m=>({
      id:m.id, productId:m.productId, type:m.type, quantity:Number(m.quantity||0),
      date:m.date||'', remark:m.remark||''
    }));
    const fgProds = fgProducts.map(f=>({
      id:f.id, name:f.name||'', volume:f.volume||'', group:f.group||'',
      threshold:Number(f.threshold ?? 5), batch:f.batch||'', expiry:f.expiry||''
    }));
    const fgMoves = fgMovements.map(m=>({
      id:m.id, fgId:m.fgId, type:m.type, qty:Number(m.qty||0),
      date:m.date||'', batch:m.batch||'', expiry:m.expiry||'', remark:m.remark||''
    }));

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rmProducts), 'RM_Products');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rmMoves), 'RM_Movements');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fgProds), 'FG_Products');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fgMoves), 'FG_Movements');

    XLSX.writeFile(wb, `StockManager_${todayISO()}.xlsx`);
    showToast("Excel exported ‚úÖ");
  }catch(e){
    console.error(e);
    showToast("Excel export failed", true);
  }
}

function importExcel(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.xlsx,.xls';
  inp.onchange = (ev)=>{
    const file = ev.target.files?.[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const firstSheetName = wb.SheetNames[0];
        const ws = wb.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:''});

        let added = 0;
        rows.forEach(r=>{
          const name = String(r.name || r.Name || r.PRODUCT || r.Product || '').trim();
          if(!name) return;

          products.push({
            id: 'rm_' + genId(),
            code: String(r.code || r.Code || '').trim(),
            name,
            category: String(r.category || r.Category || '').trim(),
            threshold: Number(r.threshold || r.Threshold || 5) || 5,
            barcode: String(r.barcode || r.Barcode || '').trim(),
            groups: String(r.groups || r.Groups || '').split(',').map(x=>x.trim()).filter(Boolean),
            exclusive: String(r.exclusive || r.Exclusive || '').toLowerCase() === 'true'
          });
          added++;
        });

        saveAll();
        autoPushToCloud();
        refreshAll();
        showToast(`Imported ${added} RM products ‚úÖ`);
      }catch(err){
        console.error(err);
        showToast("Import failed", true);
      }
    };
    reader.readAsArrayBuffer(file);
  };
  inp.click();
}

function exportPDF(){
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');

    const rows = products
      .slice()
      .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
      .map(p=>[
        p.code||'',
        p.name||'',
        p.category||'',
        String(computeBalance(p.id)),
        String(Number(p.threshold ?? 5)),
        lastMovement(p.id,'IN'),
        lastMovement(p.id,'OUT')
      ]);

    doc.text(`RM Stock Report - ${todayISO()}`, 40, 40);

    doc.autoTable({
      startY: 60,
      head: [['Code','Product','Category','Balance','Threshold','Last IN','Last OUT']],
      body: rows,
      styles: { fontSize: 9 }
    });

    doc.save(`RM_Stock_Report_${todayISO()}.pdf`);
    showToast("PDF exported ‚úÖ");
  }catch(e){
    console.error(e);
    showToast("PDF export failed", true);
  }
}




/* =========================================================
   ‚úÖ PATCH: SUPPLIERS MODULE (FIX EMPTY TABLE + NO SAVE)
   - Prevents form reload
   - Adds localStorage key + window.suppliers
   - Adds render / add / edit / delete
   - Optional cloud sync
========================================================= */

const KEY_SUPPLIERS = "sms_suppliers_v1";
window.KEY_SUPPLIERS = KEY_SUPPLIERS;

// ‚úÖ global state
window.suppliers = JSON.parse(localStorage.getItem(KEY_SUPPLIERS) || "[]");

// ---------- helpers ----------
function saveSuppliers(){
  localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(window.suppliers || []));
}
window.saveSuppliers = saveSuppliers;

// Optional cloud sync (safe)
async function autoPushSuppliersToCloud(){
  try{
    if(!window.cloudDB || !window.CLOUD_PATH_RM) return;
    await cloudDB.ref(`${CLOUD_PATH_RM}/suppliers`).set(window.suppliers || []);
  }catch(err){
    console.warn("Suppliers push failed:", err);
  }
}
window.autoPushSuppliersToCloud = autoPushSuppliersToCloud;

async function autoPullSuppliersFromCloud(){
  try{
    if(!window.cloudDB || !window.CLOUD_PATH_RM) return;
    const snap = await cloudDB.ref(`${CLOUD_PATH_RM}/suppliers`).once("value");
    const cloudList = snap.val();

    // accept array only
    if(Array.isArray(cloudList)){
      window.suppliers = cloudList.filter(Boolean);
      saveSuppliers();
    }
  }catch(err){
    console.warn("Suppliers pull failed:", err);
  }
}
window.autoPullSuppliersFromCloud = autoPullSuppliersFromCloud;

// ---------- render ----------
function renderSuppliers(){
  const tbody = document.querySelector("#suppliersTable tbody");
  if(!tbody) return;

  const q = (document.getElementById("supplierSearch")?.value || "").toLowerCase().trim();
  const list = Array.isArray(window.suppliers) ? window.suppliers : [];

  // sort by name
  const sorted = list.slice().sort((a,b)=> String(a.name||"").localeCompare(String(b.name||"")));

  tbody.innerHTML = "";
  let i = 1;

  sorted.forEach(s=>{
    const name = String(s.name||"");
    const contact = String(s.contact||"");
    const phone = String(s.phone||"");
    const email = String(s.email||"");

    const match =
      !q ||
      name.toLowerCase().includes(q) ||
      contact.toLowerCase().includes(q) ||
      phone.toLowerCase().includes(q) ||
      email.toLowerCase().includes(q);

    if(!match) return;

    const canEdit = window.RBAC?.can ? RBAC.can("suppliers:edit") : true;
    const canDel  = window.RBAC?.can ? RBAC.can("suppliers:delete") : true;

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(contact)}</td>
        <td>${escapeHtml(phone)}</td>
        <td>${escapeHtml(email)}</td>
        <td>
          ${canEdit ? `<button class="btn btn-sm btn-outline-secondary" onclick="editSupplier('${escapeHtml(s.id)}')">Edit</button>` : ``}
        </td>
        <td>
          ${canDel ? `<button class="btn btn-sm btn-danger" onclick="deleteSupplier('${escapeHtml(s.id)}')">Delete</button>` : ``}
        </td>
      </tr>
    `);
  });

  // keep RBAC UI consistent
  window.RBAC?.applyUI?.();
}
window.renderSuppliers = renderSuppliers;

// ---------- add ----------
function addSupplier(){
  // permission
  if(window.RBAC?.can && !RBAC.can("suppliers:add")){
    showToast("No permission to add supplier", true);
    return;
  }

  const nameEl = document.getElementById("newSupplierName");
  const contactEl = document.getElementById("newSupplierContact");
  const phoneEl = document.getElementById("newSupplierPhone");
  const emailEl = document.getElementById("newSupplierEmail");

  const name = (nameEl?.value || "").trim();
  const contact = (contactEl?.value || "").trim();
  const phone = (phoneEl?.value || "").trim();
  const email = (emailEl?.value || "").trim();

  if(!name){
    showToast("Supplier name required", true);
    return;
  }

  // prevent duplicates by name (optional)
  const exists = (window.suppliers || []).some(s => String(s.name||"").toLowerCase() === name.toLowerCase());
  if(exists){
    showToast("Supplier already exists", true);
    return;
  }

  window.suppliers.push({
    id: "sup_" + genId(),
    name,
    contact,
    phone,
    email,
    createdAt: new Date().toISOString(),
    createdBy: (currentUser?.username || "")
  });

  saveSuppliers();
  autoPushSuppliersToCloud();

  // clear
  if(nameEl) nameEl.value = "";
  if(contactEl) contactEl.value = "";
  if(phoneEl) phoneEl.value = "";
  if(emailEl) emailEl.value = "";

  renderSuppliers();
  // update BOE supplier dropdown too
  window.renderBOESupplierDropdown?.();

  showToast("Supplier added ‚úÖ");
}
window.addSupplier = addSupplier;

// ---------- edit ----------
function editSupplier(id){
  if(window.RBAC?.can && !RBAC.can("suppliers:edit")){
    showToast("No permission to edit supplier", true);
    return;
  }

  const s = (window.suppliers || []).find(x => String(x.id) === String(id));
  if(!s) return;

  const name = prompt("Supplier name:", s.name || "");
  if(name === null) return;

  const contact = prompt("Address info:", s.contact || "");
  if(contact === null) return;

  const phone = prompt("Phone:", s.phone || "");
  if(phone === null) return;

  const email = prompt("Email:", s.email || "");
  if(email === null) return;

  s.name = String(name||"").trim();
  s.contact = String(contact||"").trim();
  s.phone = String(phone||"").trim();
  s.email = String(email||"").trim();
  s.updatedAt = new Date().toISOString();
  s.updatedBy = (currentUser?.username || "");

  saveSuppliers();
  autoPushSuppliersToCloud();
  renderSuppliers();
  window.renderBOESupplierDropdown?.();
  showToast("Supplier updated ‚úÖ");
}
window.editSupplier = editSupplier;

// ---------- delete ----------
function deleteSupplier(id){
  if(window.RBAC?.can && !RBAC.can("suppliers:delete")){
    showToast("No permission to delete supplier", true);
    return;
  }

  const s = (window.suppliers || []).find(x => String(x.id) === String(id));
  if(!s) return;

  if(!confirm(`Delete supplier "${s.name}"?`)) return;

  window.suppliers = (window.suppliers || []).filter(x => String(x.id) !== String(id));
  saveSuppliers();
  autoPushSuppliersToCloud();
  renderSuppliers();
  window.renderBOESupplierDropdown?.();
  showToast("Supplier deleted ‚úÖ");
}
window.deleteSupplier = deleteSupplier;

// ---------- init wiring (IMPORTANT) ----------
function initSuppliersUI(){
  // stop form submit reload (THIS is the main bug in many cases)
  const form = document.getElementById("supplierForm");
  if(form && !form._wired){
    form._wired = true;
    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      addSupplier();
    });
  }

  // live search
  const search = document.getElementById("supplierSearch");
  if(search && !search._wired){
    search._wired = true;
    search.addEventListener("input", renderSuppliers);
  }
}
window.initSuppliersUI = initSuppliersUI;

// Call once when script loads (safe)
initSuppliersUI();




window.Dashboard = window.Dashboard || {
  refresh(){
    try{
      refreshAll?.();
      const el = document.getElementById("dashUpdatedAt");
      if(el) el.textContent = new Date().toLocaleString();
      showToast("Dashboard refreshed ‚úÖ");
    }catch(e){
      console.error(e);
      showToast("Dashboard refresh error", true);
    }
  }
};

/* =========================================================
   ‚úÖ AUTO DOCUMENT NUMBER GENERATOR - NO +1 ON REFRESH
   - "peek" shows next number (draft) without consuming
   - "consume" commits only when you SAVE
========================================================= */

const AutoDocNo = (() => {
  const seqKey   = 'sms_auto_docno_v1';        // committed last seq per day
  const draftKey = 'sms_auto_docno_draft_v1';  // draft number per day

  const state  = JSON.parse(localStorage.getItem(seqKey) || '{}');
  const drafts = JSON.parse(localStorage.getItem(draftKey) || '{}');

  const save = () => {
    localStorage.setItem(seqKey, JSON.stringify(state));
    localStorage.setItem(draftKey, JSON.stringify(drafts));
  };

  const dateKey = (iso) => String(iso || todayISO()).trim().replace(/-/g, '');

  const looksAuto = (val, prefix) => {
    const re = new RegExp(`^${prefix}-\\d{8}-\\d{3,}$`, 'i');
    return re.test(String(val || '').trim());
  };

  const maxSeqFromList = (values, prefix, dkey) => {
    const re = new RegExp(`^${prefix}-${dkey}-(\\d+)$`, 'i');
    let max = 0;
    (values || []).forEach(v => {
      const m = String(v || '').trim().match(re);
      if (m) {
        const n = parseInt(m[1], 10);
        if (n > max) max = n;
      }
    });
    return max;
  };

  const getExistingMax = (prefix, dkey) => {
    const prodVals = (window.productions || []).map(p => p?.prodNo);
    const boeVals  = (window.savedBills || []).map(b => b?.billNo);
    const dnVals   = (window.deliveryNotes || []).map(d => d?.dnNo);

    if (prefix === 'PROD') return maxSeqFromList(prodVals, prefix, dkey);
    if (prefix === 'BOE')  return maxSeqFromList(boeVals,  prefix, dkey);
    if (prefix === 'DN')   return maxSeqFromList(dnVals,   prefix, dkey);

    return Math.max(
      maxSeqFromList(prodVals, prefix, dkey),
      maxSeqFromList(boeVals,  prefix, dkey),
      maxSeqFromList(dnVals,   prefix, dkey)
    );
  };

  const format = (prefix, isoDate, seq, pad = 3) => {
    const dkey = dateKey(isoDate);
    return `${prefix}-${dkey}-${String(seq).padStart(pad, '0')}`;
  };

  // ‚úÖ show number WITHOUT committing (+1 only stored as draft)
  const peekSeq = (prefix, isoDate) => {
    const dkey = dateKey(isoDate);

    const draft = Number(drafts?.[prefix]?.[dkey] || 0);
    if (draft) return draft;

    const mapMax  = Number(state?.[prefix]?.[dkey] || 0);
    const dataMax = getExistingMax(prefix, dkey);
    const next = Math.max(mapMax, dataMax) + 1;

    drafts[prefix] = drafts[prefix] || {};
    drafts[prefix][dkey] = next;
    save();

    return next;
  };

  // ‚úÖ commit ONLY when saved successfully
  const consume = (prefix, isoDate) => {
    const dkey = dateKey(isoDate);
    const draft = Number(drafts?.[prefix]?.[dkey] || 0);
    if (!draft) return;

    state[prefix] = state[prefix] || {};
    state[prefix][dkey] = Math.max(Number(state[prefix][dkey] || 0), draft);

    delete drafts[prefix][dkey];
    save();
  };

  const clearDraft = (prefix, isoDate) => {
    const dkey = dateKey(isoDate);
    if (drafts[prefix]) delete drafts[prefix][dkey];
    save();
  };

  const set = ({ inputId, dateId, prefix, pad = 3, force = false }) => {
    const input = document.getElementById(inputId);
    const dateEl = document.getElementById(dateId);
    if (!input || !dateEl) return;

    if (!dateEl.value) dateEl.value = todayISO();

    const cur = String(input.value || '').trim();

    // don't overwrite manual text unless force
    if (!force && cur && !looksAuto(cur, prefix)) return;

    // if already auto and not force => keep it (no refresh +1)
    if (!force && cur && looksAuto(cur, prefix)) return;

    const seq = peekSeq(prefix, dateEl.value);
    input.value = format(prefix, dateEl.value, seq, pad);
  };

  // ‚úÖ prevent duplicate listeners
  const wired = new Set();

  const wire = ({ inputId, dateId, prefix, pad = 3 }) => {
    const dateEl = document.getElementById(dateId);
    const input  = document.getElementById(inputId);
    if (!dateEl || !input) return;

    const key = `${prefix}|${inputId}|${dateId}`;
    if (wired.has(key)) return;
    wired.add(key);

    dateEl.addEventListener('change', () => {
      // new date => new draft number
      clearDraft(prefix, dateEl.value);
      set({ inputId, dateId, prefix, pad, force: true });
    });
  };

  return { set, wire, consume, clearDraft };
})();


// ‚úÖ helper wrappers (call these from openPage)
function setAutoBOENo(force=false){
  AutoDocNo.set({ inputId:'boeNo', dateId:'boeDate', prefix:'GRN', pad:3, force });
  AutoDocNo.wire({ inputId:'boeNo', dateId:'boeDate', prefix:'GRN', pad:3 });
}

function setAutoDNNo(force=false){
  AutoDocNo.set({ inputId:'dnNo', dateId:'dnDate', prefix:'DN', pad:3, force });
  AutoDocNo.wire({ inputId:'dnNo', dateId:'dnDate', prefix:'DN', pad:3 });
}

function setAutoPRODNo(force=false){
  AutoDocNo.set({ inputId:'prodNo', dateId:'prodDate', prefix:'PR', pad:3, force });
  AutoDocNo.wire({ inputId:'prodNo', dateId:'prodDate', prefix:'PR', pad:3 });
}





/* =========================
   ‚úÖ EVENTS / MENU / INIT
========================= */
// Sidebar collapsible
document.querySelectorAll('.menu-title.collapsible').forEach(m=>{
  m.addEventListener('click', ()=>{
    m.classList.toggle('open');
    m.nextElementSibling?.classList.toggle('open');
  });
});

// submenu navigation
document.querySelectorAll('.submenu').forEach(sm=>{
  sm.addEventListener('click', ()=>{
    const page = sm.dataset.page;
    const action = sm.dataset.action;
    if(page) openPage(page);
    if(action && typeof window[action]==='function') window[action]();
  });
});
document.querySelectorAll('[data-page]').forEach(el=>{
  el.addEventListener('click', ()=>{
    const page = el.dataset.page;
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    document.getElementById(page).style.display='block';
    refreshAll?.();
  });
});

function startNavClock(){
  const el = document.getElementById('navDateTime');
  if(!el) return;

  const tick = ()=>{
    const now = new Date();
    el.innerHTML = `
      <span class="dt-date">${now.toLocaleDateString('en-GB',{ timeZone:'Asia/Dubai' })}</span>
      <span class="dt-dot"></span>
      <span class="dt-time">${now.toLocaleTimeString('en-GB',{ timeZone:'Asia/Dubai', hour12:true })}</span>
    `;
  };

  tick();
  setInterval(tick, 1000);
}
startNavClock();

// start it
document.addEventListener('DOMContentLoaded', startNavClock);
// ‚úÖ Time helpers (store ISO, display Dubai)
function nowISO(){ return new Date().toISOString(); }

function fmtDateTime(iso){
  if(!iso) return '-';
  try{
    return new Date(iso).toLocaleString('en-GB', {
      timeZone: 'Asia/Dubai',
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit',
      hour12: true
    });
  }catch(e){
    return iso;
  }
}

function who(){ return (currentUser?.username || "unknown"); }

function renderAudit(){
  const tb = document.getElementById('auditBody');
  if(!tb) return;

  const q = (document.getElementById('auditSearch')?.value || '').toLowerCase().trim();
  const list = (Array.isArray(auditLog) ? auditLog : []).slice()
    .sort((a,b)=> String(b.at||'').localeCompare(String(a.at||'')));

  tb.innerHTML = '';

  list.forEach(row=>{
    const detailsText = JSON.stringify(row.details || {});
    const hay = `${row.at} ${row.by} ${row.action} ${row.entityId} ${detailsText}`.toLowerCase();
    if(q && !hay.includes(q)) return;

    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(fmtDateTime(row.at))}</td>
        <td>${escapeHtml(row.by || '')}</td>
        <td><b>${escapeHtml(row.action || '')}</b></td>
        <td class="text-muted">${escapeHtml(row.entityId || '')}</td>
        <td><code style="font-size:11px">${escapeHtml(detailsText)}</code></td>
      </tr>
    `);
  });

  if(!tb.children.length){
    tb.innerHTML = `<tr><td colspan="5" class="text-muted">No audit records</td></tr>`;
  }
}

function clearAudit(){
  if(!confirm("Clear audit log?")) return;
  auditLog = [];
  saveAudit();
  renderAudit();
}





// Searches
document.getElementById('productSearch')?.addEventListener('input', renderProductsTable);
document.getElementById('inSearch')?.addEventListener('input', renderStockIn);
document.getElementById('outSearch')?.addEventListener('input', renderStockOut);
document.getElementById('historySearch')?.addEventListener('input', renderCombinedHistory);
document.getElementById('fgSearch')?.addEventListener('input', renderFGStock);
document.getElementById('fgInSearch')?.addEventListener('input', renderFGStockIn);
document.getElementById('fgOutSearch')?.addEventListener('input', renderFGStockOut);
document.getElementById('supplierSearch')?.addEventListener('input', renderSuppliers);
document.getElementById('addSupplierBtn')?.addEventListener('click', addSupplier);
document.getElementById('boeSearch')?.addEventListener('input', renderBillsTable);
document.getElementById('prodSearch')?.addEventListener('input', renderProductionsTable);
document.getElementById('dnSearch')?.addEventListener('input', renderDNTable);
document.getElementById('prodFG')?.addEventListener('change', renderBOM);
document.getElementById('prodFGQty')?.addEventListener('input', renderBOM);
document.getElementById('prodDate')?.addEventListener('change', ()=> setAutoProductionNo(true));


// Sidebar toggle
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');
const mainWrap = document.querySelector('.main');

if(sidebarToggle && sidebar){
  sidebarToggle.addEventListener('click', ()=>{
    sidebar.classList.toggle('minimized');
    if(mainWrap) mainWrap.classList.toggle('sidebar-minimized');
    sidebarToggle.textContent = sidebar.classList.contains('minimized') ? '‚Üí' : '‚Üê';
  });
}

// ‚úÖ session restore
const savedUser = localStorage.getItem('sms_currentUser');
if(savedUser){
  currentUser = JSON.parse(savedUser);
  loginScreen.style.display='none';
document.querySelector('.app').style.display='flex';

RBAC.applyUI();
applyPermissions();

if(currentUser.role === 'admin'){
  openPage('userManagement');
  renderUsersTable();
}else{
  openPage('dashboardPage');
}

}

/* initial pulls */
window.addEventListener('load', ()=>{
  initFGVolumeSelection();
  loadRenamedGroupsFromCloud();
  autoPullFGFromCloud();
  autoPullFromCloud();
  refreshAll();
});

/* =========================
   ‚úÖ REFRESH ALL
========================= */
function refreshAll(){
  buildGroupIndexes();   // ‚úÖ must come before BOM + dropdown
  hydrateProductionFG(); // ‚úÖ dropdown uses _idx

  renderProductsTable();
  renderStockIn();
  renderStockOut();
  renderCombinedHistory();

  renderFGStock();
  renderFGStockIn();
  renderFGStockOut();

  renderProductionsTable();
  renderDNTable();

  renderMainDashboard();
  renderDashboardGrouped();
  renderBillsTable();

renderFGOptions();
initFGSearchSelect();
 renderSuppliers();
  applyPermissions();
}
/* =========================
   ‚úÖ PATCH PACK (PASTE AT END)
   Fixes:
   - bills scope (renderBillsTable -> BOE.renderTable)
   - autoPullFromCloud duplicate + wrong path
   - deleteProduct logChange crash
   - printStockReport Category bug
   - deliveryNotes cloud sync (window.deliveryNotes)
========================= */
(() => {

  /* ---------- 1) Ensure Delivery Notes are global ---------- */
  try{
    if (typeof window.deliveryNotes === "undefined" && typeof deliveryNotes !== "undefined") {
      window.deliveryNotes = deliveryNotes;
    }
  }catch(e){}

  // keep window.deliveryNotes synced whenever you save
  if (typeof window.saveDeliveryNotes === "function") {
    const _saveDN = window.saveDeliveryNotes;
    window.saveDeliveryNotes = function(){
      _saveDN();
      try{ window.deliveryNotes = deliveryNotes; }catch(e){}
    };
  }

  /* ---------- 2) Bills table must use BOE module ---------- */
  window.renderBillsTable = function(){
    window.BOE?.renderTable?.();
  };

  // make boe search drive the BOE table (NOT old renderBillsTable logic)
  document.getElementById('boeSearch')?.addEventListener('input', ()=> window.BOE?.renderTable?.());

  /* ---------- 3) Fix deleteProduct() crash ---------- */
  window.deleteProduct = function(productId){
    if(!window.canDelete?.()){
      window.showToast?.("No permission to delete", true);
      return;
    }

    const prod = (window.products || []).find(p => p.id === productId);
    if(!prod) return;

    if(!confirm(`Delete "${prod.name}"?\nThis will remove all its stock history.`)) return;

    window.products = (window.products || []).filter(p => p.id !== productId);
    window.stockMovements = (window.stockMovements || []).filter(m => m.productId !== productId);

    // ‚úÖ correct audit
    window.logChange?.("RM_DELETE", productId, { code: prod.code || "", name: prod.name || "" });

    window.saveAll?.();
    window.autoPushToCloud?.();
    window.refreshAll?.();
    window.showToast?.("Product deleted ‚úÖ");
  };

  /* ---------- 4) Fix printStockReport Category bug ---------- */
  window.printStockReport = function(){
    const rows = (window.products || [])
      .slice()
      .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
      .map(p=>({
        Code: p.code || '',
        Product: p.name || '',
        Category: p.category || '',
        Balance: window.computeBalance?.(p.id) ?? 0,
        Threshold: Number(p.threshold ?? 5),
        LastIN: window.lastMovement?.(p.id,'IN') ?? '-',
        LastOUT: window.lastMovement?.(p.id,'OUT') ?? '-'
      }));

    const w = window.open('', '_blank');
    if(!w) { window.showToast?.("Popup blocked by browser", true); return; }

    w.document.write(`
      <html><head><title>RM Stock Report</title>
      <style>
        body{font-family:Arial;padding:18px}
        h2{margin:0 0 12px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ccc;padding:8px;text-align:left}
        th{background:#007bff;color:#fff}
      </style>
      </head><body>
      <h2>RM Stock Report</h2>
      <p>Date: ${new Date().toLocaleString()}</p>
      <table>
        <thead><tr>
          <th>Code</th><th>Product</th><th>Category</th><th>Balance</th><th>Threshold</th><th>Last IN</th><th>Last OUT</th>
        </tr></thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${window.escapeHtml?.(r.Code) || r.Code}</td>
              <td>${window.escapeHtml?.(r.Product) || r.Product}</td>
              <td>${window.escapeHtml?.(r.Category) || r.Category}</td>
              <td>${r.Balance}</td>
              <td>${r.Threshold}</td>
              <td>${window.escapeHtml?.(r.LastIN) || r.LastIN}</td>
              <td>${window.escapeHtml?.(r.LastOUT) || r.LastOUT}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <script>window.onload=()=>window.print();<\/script>
      </body></html>
    `);
    w.document.close();
  };

  /* ---------- 5) KEEP ONLY ONE autoPullFromCloud (use CLOUD_PATH_RM) ---------- */
  window.autoPullFromCloud = async function(){
    if(!window.cloudDB) return;

    const PATH = window.CLOUD_PATH_RM || "stockManager/v1"; // ‚úÖ must match your autoPushToCloud()

    try{
      const snap = await window.cloudDB.ref(PATH).once("value");
      const data = snap.val();
      if(!data){
        console.warn("‚òÅÔ∏è no data at:", PATH);
        return;
      }

      // assign globals
      if(Array.isArray(data.products)) window.products = data.products;
      if(Array.isArray(data.stockMovements)) window.stockMovements = data.stockMovements;

      if(Array.isArray(data.fgProducts)) window.fgProducts = data.fgProducts;
      if(Array.isArray(data.fgMovements)) window.fgMovements = data.fgMovements;

      if(Array.isArray(data.suppliers)) window.suppliers = data.suppliers;
      if(Array.isArray(data.bills)) window.savedBills = data.bills;
      if(Array.isArray(data.productions)) window.productions = data.productions;
      if(Array.isArray(data.deliveryNotes)) window.deliveryNotes = data.deliveryNotes;

      // sync local vars (if they exist)
      try{ products = window.products; }catch(e){}
      try{ stockMovements = window.stockMovements; }catch(e){}
      try{ fgProducts = window.fgProducts; }catch(e){}
      try{ fgMovements = window.fgMovements; }catch(e){}
      try{ productions = window.productions; }catch(e){}
      try{ deliveryNotes = window.deliveryNotes; }catch(e){}

      // persist
      localStorage.setItem(KEY_PRODUCTS, JSON.stringify(window.products || []));
      localStorage.setItem(KEY_MOVES, JSON.stringify(window.stockMovements || []));
      localStorage.setItem("sms_fg_products", JSON.stringify(window.fgProducts || []));
      localStorage.setItem("sms_fg_movements", JSON.stringify(window.fgMovements || []));
      localStorage.setItem("sms_bills_v1", JSON.stringify(window.savedBills || []));
      localStorage.setItem(KEY_PROD, JSON.stringify(window.productions || []));
      localStorage.setItem(KEY_DN, JSON.stringify(window.deliveryNotes || []));
      localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(window.suppliers || []));

      // refresh UI
      window.refreshAll?.();
      window.BOE?.renderTable?.();
      window.renderBOESupplierDropdown?.();
      window.renderSuppliers?.();

      console.log("‚òÅÔ∏è pulled OK:", PATH);
    }catch(err){
      console.error("‚òÅÔ∏è pull failed:", err);
    }
  };

  /* ---------- 6) BOE init should run after DOM ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    window.BOE?.init?.();
  });

})();



/* Expose to window (safe) */
window.handleDashboardSearch = handleDashboardSearch;
window.clearDashboardSearch = clearDashboardSearch;
window.fgStockInHistoryModal = fgStockInHistoryModal;
window.fgStockOutHistoryModal = fgStockOutHistoryModal;
window.printStockReport = printStockReport;
window.printFGStockReport = printFGStockReport;
window.exportExcel = exportExcel;
window.importExcel = importExcel;
window.exportPDF = exportPDF;
window.openFGFromDashboard = openFGFromDashboard;
window.openLowFGFromDashboard = openLowFGFromDashboard;
window.renderProductionsTable = renderProductionsTable;
window.viewProduction = viewProduction;

</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
