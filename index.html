<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stock Manager</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<!-- ‚òÅÔ∏è CLOUD SYNC ADDITION -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --sidebar-w:260px;
  --muted:#6b6f76;
  --accent:#2c3e50;
  --accent-2:#2980b9;
  --danger:#c0392b;
  --badge-green:#2ecc71;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;color:#111;background:transparent;}
body::before{content:"";position:fixed;inset:0;background-position:center center;background-repeat:no-repeat;background-size:750px auto;background-attachment:fixed;opacity:1;z-index:-1;pointer-events:none;}
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-w);position:fixed;left:0;top:0;height:100%;background:rgba(255,255,255,0.65);backdrop-filter:blur(5px);padding:8px;box-shadow:4px 0 20px rgba(0,0,0,.08);overflow:auto;z-index:20;border-right:1px solid rgba(0,0,0,0.04);border-radius:0 10px 10px 0;}
.sidebar-header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.sidebar-logo{width:96px;height:56px;object-fit:cover;border-radius:8px}
.brand-title{font-size:18px;margin:0}
.brand-sub{font-size:12px;color:var(--muted);margin-top:4px}
.sidebar-menu{list-style:none;padding:0;margin:12px 0 0}
.sidebar-menu li{padding:12px 10px;display:flex;gap:10px;align-items:center;cursor:pointer;border-left:4px solid transparent;border-radius:6px;transition:all .18s;color:#222;}
.menu-title{font-weight:700;background:rgba(0,0,0,0.05);}
.submenu{padding-left:36px !important;font-size:14px;}
.subgroup{list-style:none;padding:0;margin:0;display:none;}
.subgroup.open{display:block;}
.menu-title.collapsible{display:flex;justify-content:space-between;align-items:center;}
.arrow{font-size:12px;transition:transform .2s ease;}
.menu-title.open .arrow{transform:rotate(180deg);}
.sidebar-menu li:hover{ background:rgba(60,120,200,0.06); transform:translateX(4px); border-left-color: rgba(41,128,185,0.8); }
.sidebar-menu li.active{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; border-left-color:#fff; font-weight:700; }
.sidebar-footer{margin-top:18px;font-size:13px;color:var(--muted)}
.main{margin-left:calc(var(--sidebar-w) + 18px);width:70%; padding:18px; min-height:100vh; background: transparent;}
.top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.search{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);width:320px; background: rgba(255,255,255,0.55); }
.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.secondary{background:var(--accent-2)}
.btn.out{background:#dc2626}
.btn.info{background:#16a34a}
.page {background:rgba(255,255,255,0.5);backdrop-filter:blur(5px);border-radius:12px;width:100%;min-height:calc(100vh - 40px);padding:25px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 6px 25px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:20px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left;white-space: nowrap}
th{background:rgba(255,255,255,0.6);font-weight:700;width:50%}
.low-stock{color:var(--danger);font-weight:700}
.balance-qty{font-weight:bold}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:9999;}
.modal-box,.modal{background:white;padding:20px;border-radius:12px;max-height:80%;overflow-y:auto;width:600px;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.modal-close{cursor:pointer;background:none;border:none;font-size:18px;}
.modal-table{width:100%;border-collapse:collapse;}
.modal-table th,.modal-table td{border:1px solid #ccc;padding:8px;text-align:left;}
@media print {
    body {
        -webkit-print-color-adjust: exact; /* Chrome/Safari */
        print-color-adjust: exact;         /* Firefox */
    }
    .print-bg {
        background-image: url('banner.png') !important;
        background-size: cover !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
    }
}
/* Collapsible sidebar */
.sidebar.minimized {
    width: 60px;
    overflow: hidden;
    padding: 8px 4px;
    border-radius: 0 10px 10px 0;
    transition: width 0.3s ease;
}
.sidebar.minimized .sidebar-header div,
.sidebar.minimized .brand-title,
.sidebar.minimized .brand-sub,
.sidebar.minimized .sidebar-logo,
.sidebar.minimized .sidebar-menu,
.sidebar.minimized .sidebar-menu li span,
.sidebar.minimized .sidebar-footer {
    display: none; /* Hide text */
}
.sidebar.minimized .sidebar-logo {
    width: 40px;
    height: 40px;
}
.main {
    margin-left: calc(var(--sidebar-w) + 16px);
    transition: margin-left 0.3s ease;
}
.main.sidebar-minimized {
    margin-left: 60px;
}
.menu-title span.arrow {
    display: inline-block;
}
.admin-only{display:none;}
</style>
</head>

<body>
<div id="loginScreen" style="position:fixed; inset:0; background:#f3f4f6;
display:flex; align-items:center; justify-content:center; z-index:99999;">
  <div style="width:350px; background:white; padding:25px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15)">
    <h2 style="text-align:center">Stock Manager</h2>
    
    <div id="loginForm">
      <input id="loginUser" placeholder="Username" style="width:90%;padding:10px;margin:10px 0">
      <input id="loginPass" type="password" placeholder="Password" style="width:90%;padding:10px;margin-bottom:10px">
      <button class="btn" style="width:98%" onclick="login()">Login</button>
      <p style="text-align:center;margin:10px 0;">Don't have an account? <span style="color:blue;cursor:pointer;" onclick="showSignup()">Sign Up</span></p><p style="text-align:center;margin:10px 0;">
    <span style="color:blue;cursor:pointer;" onclick="forgotPassword()">Forgot Password?</span>
</p>

      <p id="loginMsg" style="color:red;text-align:center;margin-top:10px"></p>
    </div>

    <div id="signupForm" style="display:none">
      <input id="signupUser" placeholder="Username" style="width:90%;padding:10px;margin:10px 0">
      <input id="signupPass" type="password" placeholder="Password" style="width:90%;padding:10px;margin-bottom:10px">
      <select id="signupRole" style="width:100%;padding:10px;margin-bottom:10px">
        <option value="user">User</option>
              </select>
      <button class="btn" style="width:98%" onclick="signup()">Create Account</button>
      <p style="text-align:center;margin:10px 0;">Already have an account? <span style="color:blue;cursor:pointer;" onclick="showLogin()">Login</span></p>

      <p id="signupMsg" style="color:red;text-align:center;margin-top:10px"></p>

    </div>

  </div>
</div>


<div class="app">
<aside class="sidebar">
<div class="sidebar-header">
    <img src="banner.png" class="sidebar-logo" onerror="this.style.display='none'">
    <div>
        <div class="brand-title">STOCK</div>
        <div class="brand-sub">Inventory ‚Ä¢ Public Sheet</div>
    </div>
    <button id="sidebarToggle" class="btn secondary" style="margin-left:auto;padding:4px 6px;font-size:14px">‚Üê</button>
</div>


<ul class="sidebar-menu" id="menu">

<li id="usersMenu" class="menu-title collapsible admin-only">
  üë• Users <span class="arrow">‚ñæ</span>
</li>
<ul class="subgroup admin-only">
  <li class="submenu" data-page="userManagement">Manage Users</li>
</ul>
<li class="menu-title collapsible" data-page="dashboard">üìä Dashboard<span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="dashboard">üìä Dashboard</li>
<li class="submenu" data-action="printStockReport">üñ®Ô∏è Print Stock Report</li>
<li class="submenu" data-action="exportPDF">üìÑ Export PDF</li>
</ul>
<li class="menu-title collapsible">üì¶ Products<span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="products">üì¶ Add Products</li>
</ul>
<li class="menu-title collapsible">üìà Stock <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="stockIn">‚¨Ü Stock In</li>
<li class="submenu" data-page="stockOut">‚¨á Stock Out</li>
<li class="submenu" data-page="history">üìö Combined History</li>
</ul>
  <li class="menu-title collapsible">üßæ FG Stock <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
  <li class="submenu" data-page="fgStock">üì¶ FG Stock</li>
</ul>

<li class="menu-title collapsible">üíæ Backup <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-action="importExcel">üì• Import Excel</li>
<li class="submenu" data-action="exportExcel">üì§ Export Excel</li>

</ul>
<div class="sidebar-footer">Data stored locally; cloud optional.</div>
</ul>
</aside>

<main class="main"><!-- DASHBOARD -->
<button onclick="logout()" class="btn out" style="position:fixed;top:10px;right:20px;z-index:999">Logout</button>
<section id="userManagement" class="page" style="display:none">
  <h2>Manage Users</h2>
  <table id="usersTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Username</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:12px;">
    <input id="newUsername" placeholder="Username">
    <input id="newPassword" type="password" placeholder="Password">
    <select id="newRole">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <button class="btn admin-only" onclick="addUser()">Add User</button>
  </div>
</section>

<section id="dashboard" class="page" style="display:block">
<h2>Dashboard</h2>
<div class="top">
<div class="dash-search">
    <input type="text" id="globalSearch" class="search" placeholder="Global search...">
</div></div>
<div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
<div>Category:
<select id="categoryFilter" class="small">
<option value="">All</option>
</select>
</div>
<div>Low threshold:
<input id="globalThreshold" type="number" class="small" value="5" style="width:80px">
</div>
<div style="margin-left:auto" class="small" id="status">Status: Local</div>
</div>
<div style="overflow:auto">
<table id="dashTable">
<thead>
<tr>
    <th>Product / Group</th>
 <th>Balance</th>
   <th>threshold</th>
<th>Last IN</th><th>Last OUT</th>
    <th colspan="3">Actions</th>
   

</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>
<section id="fgStock" class="page" style="display:none">
  <h2>Finished Goods Stock</h2>
  <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
    <input type="file" id="fgExcelInput" accept=".xlsx,.xls">
    <input id="fgSearch" class="search" placeholder="Search FG products...">
  </div>
  <div style="overflow:auto; height: calc(100% - 140px);">
    <table id="fgTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Product</th>
          <th>Volume</th>
          <th>Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Modal for daily stock -->
<div id="fgModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;max-height:80%;overflow:auto; width:90%;">
    <h3 id="fgModalTitle">Product Stock Details</h3>
    <table id="modalTable">
      <thead>
        <tr id="modalHead"></tr>
      </thead>
      <tbody id="modalBody"></tbody>
    </table>
    <button onclick="document.getElementById('fgModal').style.display='none'">Close</button>
  </div>
</div>

<!-- PRODUCTS -->
<section id="products" class="page" style="display:none">
<h2>Add Products</h2>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
    <input id="newCode" class="small" placeholder="Product Code" style="width:120px">
    <input id="newName" class="small" placeholder="Product Name">
    <input id="newCategory" class="small" placeholder="Category">
    <input id="newThreshold" class="small" placeholder="Threshold" type="number" style="width:110px">
    <input id="newBarcode" class="small" placeholder="Barcode" style="width:150px">
    <input id="newGroups" class="small" placeholder="Groups (comma separated)">
    <label style="display:flex;align-items:center;gap:4px;">
      <input type="checkbox" id="newExclusive"> Exclusive to first group
    </label>
    <button id="addProductBtn" class="btn admin-only">Add Product</button>
</div>



<div style="margin-bottom:12px">
<input id="productSearch" class="search" placeholder="Search products...">
</div>
<div style="overflow:auto; height: calc(100% - 170px);">
<table id="productsTable">
<thead>
<tr>
    <th>#</th>
    <th>Product Code</th>
    <th>Name</th>
    <th>Category</th>
    <th>Balance</th>
    <th>Threshold</th>
    <th>Barcode</th>
    <th>History</th>
    <th>Edit</th>
    <th>Delete</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>

<!-- STOCK IN -->
<section id="stockIn" class="page" style="display:none">
<h2>Stock In</h2>
<input id="inSearch" class="search" placeholder="Search product">
<button class="btn secondary" onclick="stockInHistoryModal()">View Stock IN History</button>
<table id="stockInBody">
<thead><tr><th>Product</th><th>Balance</th><th>Last IN</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- STOCK OUT -->
<section id="stockOut" class="page" style="display:none">
<h2>Stock Out</h2>
<input id="outSearch" class="search" placeholder="Search product">
<button class="btn info" onclick="stockOutHistoryModal()">View Stock OUT History</button>
<table id="stockOutBody">
<thead><tr><th>Product</th><th>Balance</th><th>Last OUT</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- COMBINED HISTORY -->
<section id="history" class="page" style="display:none">
<h2>Combined History</h2>
<div style="margin-bottom:12px">
<input id="historySearch" class="search" placeholder="Search combined history...">
</div>
<div style="overflow:auto; height: calc(100% - 120px);">
<table id="historyTable"><thead><tr><th>Date</th><th>Product</th><th>Type</th><th>Qty</th></tr></thead><tbody></tbody></table>
</div>
</section>

<!-- MODALS -->
<div id="historyModal" class="modal-backdrop">
<div class="modal-box">
<div class="modal-header">
<h3 id="modalTitle">Product History</h3>
<button onclick="closeHistoryModal()" class="modal-close">‚úñ</button>
</div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Type</th><th>Qty</th></tr></thead>
<tbody id="modalHistoryBody"></tbody></table>
</div>
</div>
</div>

<div id="stockInHistoryModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3>Stock IN History</h3><button onclick="closeStockInHistory()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Product</th><th>Qty</th></tr></thead>
<tbody id="stockInHistoryPopupBody"></tbody>
</table>
</div>
</div>
</div>

<div id="stockOutHistoryModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3>Stock OUT History</h3><button onclick="closeStockOutHistory()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Product</th><th>Qty</th></tr></thead>
<tbody id="stockOutHistoryPopupBody"></tbody>
</table>
</div>
</div>
</div>

<div id="stockModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3 id="modalTitle">Stock </h3><button onclick="closeModal()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<p>Product: <b id="modalProductName"></b></p>
<p>Balance: <b id="modalProductBalance"></b></p>
<input id="modalQty" type="number" placeholder="Enter quantity">
<p id="successMsg" class="success"></p>
</div>
<div class="modal-actions">
<button class="btn secondary" onclick="closeModal()">Cancel</button>
<button class="btn" id="modalSave">Save</button>
</div>
</div>
</div>

<script>
let fgProducts = [];

let currentUser = null;
const savedUser = localStorage.getItem('sms_currentUser');
if (savedUser) {
    currentUser = JSON.parse(savedUser);
    document.getElementById('loginScreen').style.display = 'none';
    document.querySelector('.app').style.display = 'flex';
}


/* üî¥ REPLACE WITH YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBTtsOeQTpPwTEn_T9EDqt5i_0eyQuzGOA",
  authDomain: "stock-manager-703e6.firebaseapp.com",
  databaseURL: "https://stock-manager-703e6-default-rtdb.firebaseio.com",
  projectId: "stock-manager-703e6",
  storageBucket: "stock-manager-703e6.firebasestorage.app",
  messagingSenderId: "778548519096",
  appId: "1:778548519096:web:716f903fee993f4d85544d",
  measurementId: "G-G735N8XCQ2"
};

firebase.initializeApp(firebaseConfig);
const cloudDB = firebase.database(); // Use the same variable as in your functions
window.cloudDB = cloudDB;  
console.log("‚úÖ Firebase initialized");

async function ensureAdminExists() {
    try {
        const snapshot = await cloudDB.ref('users').orderByChild('role').equalTo('admin').once('value');
        if(!snapshot.exists()) {
            const userId = 'admin_' + Date.now().toString(36);
            await cloudDB.ref('users/' + userId).set(DEFAULT_ADMIN);
            console.log("Default admin created");
        } else {
            console.log("Admin already exists");
        }
    } catch(err) {
        console.error("Error checking/creating admin:", err);
    }
}

// Call this on app load
ensureAdminExists();



function applyPermissions() {
    if (!currentUser) return;

    const isAdmin = currentUser.role === 'admin';

    document.querySelectorAll('.admin-only').forEach(el => {
        // Use inline-block to make buttons appear properly
        el.style.display = isAdmin ? 'inline-block' : 'none';
    });

    // Protect admin-only pages
    if (!isAdmin && document.getElementById('userManagement').style.display === 'block') {
        document.getElementById('userManagement').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
    }
}

/* ==========================
   üîê ADVANCED LOGIN SYSTEM
========================== */
const DEFAULT_ADMIN = {
    username: "admin",
    password: "admin123",  // change this after first login
    role: "admin",
    createdAt: new Date().toISOString()
};


// Show forms
function showSignup(){ loginForm.style.display='none'; signupForm.style.display='block'; loginMsg.textContent=''; }
function showLogin(){ loginForm.style.display='block'; signupForm.style.display='none'; signupMsg.textContent=''; }

const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const loginMsg = document.getElementById('loginMsg');
const signupMsg = document.getElementById('signupMsg');

async function signup() {
  const u = signupUser.value.trim();
  const p = signupPass.value;
  const role = signupRole.value;

  if(!u || !p) { signupMsg.textContent="Enter username & password"; return; }

  try {
    const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(snapshot.exists()){ signupMsg.textContent="Username already taken"; return; }

    const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
    await cloudDB.ref('users/'+userId).set({username:u,password:p,role,createdAt:new Date().toISOString()});

    signupMsg.style.color="green"; signupMsg.textContent="Account created! Please login.";
    showLogin();
  } catch(err){
    console.error(err);
    signupMsg.textContent="Signup failed";
  }
}

async function login() {
  const u = loginUser.value.trim();
  const p = loginPass.value;

  if(!u || !p){ loginMsg.textContent="Enter username & password"; return; }

  try {
    const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(!snapshot.exists()){ loginMsg.textContent="Invalid login"; return; }

    const userData = Object.values(snapshot.val())[0]; // get first match
    if(userData.password !== p){ loginMsg.textContent="Invalid login"; return; }

    currentUser = userData;
    localStorage.setItem('sms_currentUser', JSON.stringify(currentUser));

    loginScreen.style.display='none';
    document.querySelector('.app').style.display='flex';
    applyPermissions();

    // Show Users page automatically if admin
    if(currentUser.role === 'admin') {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('userManagement').style.display = 'block';
        renderUsersTable();
    }

  } catch(err){
    console.error(err);
    loginMsg.textContent="Login failed";
  }
document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
document.getElementById('dashboard').style.display = 'block';
renderDashboardGrouped();
}

function logout(){
  localStorage.removeItem('sms_currentUser');
  location.reload();
}

async function addUser() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value;
    const role = document.getElementById('newRole').value;

    if(!username || !password) {
        alert("Enter username and password");
        return;
    }

    try {
        // Check if username exists
        const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
        if(snapshot.exists()) {
            alert("Username already taken");
            return;
        }

        const userId = 'u_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000);
        await cloudDB.ref('users/' + userId).set({
            username,
            password,
            role,
            createdAt: new Date().toISOString()
        });

        alert("User added successfully!");
        // Optionally, clear inputs
        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';

        // Refresh users table if you have a function for that
        renderUsersTable();

    } catch(err) {
        console.error(err);
        alert("Failed to add user");
    }
}

async function forgotPassword() {
    const username = prompt("Enter your username to reset password:");
    if(!username || !username.trim()) return;

    try {
        const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(username.trim()).once('value');
        if(!snapshot.exists()){
            alert("Username not found");
            return;
        }

        const userId = Object.keys(snapshot.val())[0];
        const userData = snapshot.val()[userId];

        // For simplicity, we just ask for a new password
        const newPass = prompt(`Enter new password for "${userData.username}":`);
        if(!newPass || !newPass.trim()) return alert("Password cannot be empty");

        await cloudDB.ref('users/' + userId + '/password').set(newPass.trim());
        alert("Password successfully reset. You can now login with the new password.");
    } catch(err){
        console.error(err);
        alert("Failed to reset password");
    }
}

// Delete a user (cannot delete admin)
async function deleteUser(username) {
    if(!confirm(`Are you sure you want to delete "${username}"?`)) return;

    try {
        const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
        if(!snapshot.exists()) return alert("User not found");

        const userId = Object.keys(snapshot.val())[0];
        const userData = snapshot.val()[userId];

        if(userData.role === 'admin') return alert("Cannot delete admin");

        await cloudDB.ref('users/' + userId).remove();
        alert("User deleted successfully!");
        renderUsersTable(); // refresh table
    } catch(err) {
        console.error(err);
        alert("Failed to delete user");
    }
}

// Render users table
async function renderUsersTable() {
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    const snapshot = await cloudDB.ref('users').once('value');
    const users = snapshot.val() ? Object.values(snapshot.val()) : [];

    users.forEach((u,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${u.username}</td>
            <td>${u.role}</td>
<td>
  ${u.role !== 'admin' && currentUser.role==='admin' ? `<button class="btn out" onclick="deleteUser('${u.username}')">Delete</button>` : ''}
</td>
        `;
        tbody.appendChild(tr);
    });
}


// FULL JS LOGIC START
const KEY_GROUP_ALIASES = 'sms_group_aliases_v1';
let groupAliases = JSON.parse(localStorage.getItem(KEY_GROUP_ALIASES) || '{}');

function saveGroupAliases() {
    localStorage.setItem(KEY_GROUP_ALIASES, JSON.stringify(groupAliases));
}

const KEY_PRODUCTS='sms_products_final_v1';
const KEY_MOVES='sms_movements_final_v1';
let products=JSON.parse(localStorage.getItem(KEY_PRODUCTS)||'[]');
let stockMovements=JSON.parse(localStorage.getItem(KEY_MOVES)||'[]');
if(!localStorage.getItem(KEY_PRODUCTS)){
let products = [
    {id:'p1', name:'Product A', category:'Cat1', threshold:5, groups:['Group1'], exclusive:true},
    {id:'p2', name:'Product B', category:'Cat1', threshold:10, groups:['Group1','Group2'], exclusive:false},
    {id:'p3', name:'Product C', category:'Cat2', threshold:8, groups:['Group2'], exclusive:true},
    {id:'p4', name:'Product D', category:'Cat2', threshold:7, groups:['Group2','Group3'], exclusive:false},
    {id:'p5', name:'Product E', category:'Cat3', threshold:12, groups:['Group3'], exclusive:true}
];

    stockMovements = [
        {id:genId(),productId:products[0].id,type:'IN',quantity:20,date:todayISO()},
        {id:genId(),productId:products[1].id,type:'IN',quantity:15,date:todayISO()},
        {id:genId(),productId:products[2].id,type:'IN',quantity:100,date:todayISO()}
    ];
    saveAll();
}

function saveAll(){localStorage.setItem(KEY_PRODUCTS,JSON.stringify(products));localStorage.setItem(KEY_MOVES,JSON.stringify(stockMovements));document.getElementById('status')&&(document.getElementById('status').textContent='Status: Local saved');}
function genId(){return'id_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);}
function todayISO(){return new Date().toISOString().split('T')[0];}
function fmtDate(iso){if(!iso)return'-';const p=iso.split('-');return`${p[2]}/${p[1]}/${p[0]}`;}
function escapeHtml(s){if(s==null)return'';return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function computeBalance(productId){
    let bal=0;
    stockMovements.forEach(m=>{
        if(m.productId===productId){bal += m.type==='IN'? m.quantity : -m.quantity;}
    });
    return bal>0?bal:0;
}

function lastMovement(productId,type){
    const moves = stockMovements.filter(m=>m.productId===productId && m.type===type);
    if(!moves.length) return '-';
    return moves[moves.length-1].date;
}function populateCategoryFilter() {
    const catSelect = document.getElementById('categoryFilter');
    if(!catSelect) return;
    const cats = [...new Set(products.map(p=>p.category).filter(c=>c))];
    catSelect.innerHTML = '<option value="">All</option>';
    cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.toLowerCase();
        opt.textContent = c;
        catSelect.appendChild(opt);
    });
}


// FG stock for a group of products
function getFGStock(groupName){
    let totalFG = 0;
    products.forEach(p=>{
        if(!Array.isArray(p.groups)) return;
        if(p.groups.includes(groupName)){
            totalFG += p.fgStock || 0; // assuming each product has fgStock property
        }
    });
    return totalFG;
}

// Render dashboard (products RAW only)
// Load renamed groups from localStorage
let renamedGroups = JSON.parse(localStorage.getItem('renamedGroups') || '{}');

// Save renamed groups to localStorage
function saveRenamedGroups() {
    localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
}
function searchDashboard() {
    const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase().trim();
    renderDashboardGrouped(searchTerm);
}

// Dashboard rendering
function renderDashboardGrouped(){
    const tbody = document.querySelector('#dashTable tbody');
    tbody.innerHTML='';

    const search = (document.getElementById('globalSearch').value||'').toLowerCase().trim();

    const groupsMap = {};
    products.forEach(p=>{
        if(!Array.isArray(p.groups)) return;
        p.groups.forEach(groupName=>{
            if(!groupsMap[groupName]) groupsMap[groupName]=[];
            if(p.exclusive && p.groups[0]!==groupName) return;
            groupsMap[groupName].push(p);
        });
    });

    Object.keys(groupsMap).sort().forEach(groupName=>{
        const groupProducts = groupsMap[groupName].filter(p=>{
            const name = p.name.toLowerCase();
            if(search && !name.includes(search) && !(renamedGroups[groupName]||groupName).toLowerCase().includes(search)) return false;
            return true;
        });
        if(!groupProducts.length) return;

        const displayName = renamedGroups[groupName] ? renamedGroups[groupName] : groupName;
        const fgBalance = getFGStock(groupName);

const groupRow = document.createElement('tr');
groupRow.classList.add('group-row');

let renameBtn = '';
if(currentUser && currentUser.role === 'admin') {
    renameBtn = `<button style="margin-left:10px;" onclick="renameGroup('${groupName}')">Rename</button>`;
}

groupRow.innerHTML = `
    <td colspan="6">
        <b>${displayName.toUpperCase()}</b> 
        <span style="margin-left:20px; color:green;">FG BALANCE: ${fgBalance}</span>
        ${renameBtn}
    </td>
`;
tbody.appendChild(groupRow);


        groupProducts.forEach(p=>{
            const bal = computeBalance(p.id); // RAW stock
            const lastIn = lastMovement(p.id,'IN');
            const lastOut = lastMovement(p.id,'OUT');

            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding-left:20px;">${p.name}</td>
                <td>${bal}</td>
                <td>${p.threshold}</td>
                <td>${lastIn}</td>
                <td>${lastOut}</td>
                <td>
                    <button class="btn secondary" onclick="alert('View ${p.name}')">View</button>
                    <button class="btn" onclick="alert('Add IN ${p.name}')">Add IN</button>
                    <button class="btn" onclick="alert('Stock OUT ${p.name}')">Stock OUT</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    });
}// Rename group **only for dashboard display**
function renameGroup(groupName){
    const newName = prompt('Enter new display name for "' + groupName + '"');
    if(!newName) return;

    renamedGroups[groupName] = newName;
    saveRenamedGroups(); // save to localStorage
    renderDashboardGrouped(); // re-render dashboard
}




// Read Excel
document.getElementById('fgExcelInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {defval:''});

        fgProducts = json.map((row, i) => {
            // find keys case-insensitively
            const descKey = Object.keys(row).find(k => k.toLowerCase() === 'description');
            const volKey = Object.keys(row).find(k => k.toLowerCase() === 'volume');
            const balKey = Object.keys(row).find(k => k.toLowerCase() === 'balance');

            const daily = {};
            Object.keys(row).forEach(k => {
                if(/\d{2}\/\d{2}\/\d{4}/.test(k)) daily[k] = Number(row[k] || 0);
            });

            return {
                id: 'fg_' + i,
                description: descKey ? row[descKey] : `Unknown ${i+1}`,
                volume: volKey ? row[volKey] : '',
                balance: balKey ? Number(row[balKey] || 0) : 0,
                dailyStock: daily
            };
        });

        renderFGStock();
    };
    reader.readAsArrayBuffer(file);
});

// Render Table
function renderFGStock() {
    const tbody = document.querySelector('#fgTable tbody');
    tbody.innerHTML = '';
    const search = (document.getElementById('fgSearch').value || '').toLowerCase().trim();

    // Group by first word of description (case-insensitive)
    const groups = {};
    fgProducts.forEach(p => {
        const desc = p.description.trim();
        if(search && !desc.toLowerCase().includes(search)) return;
        const key = desc.split(' ')[0].toUpperCase(); // CAPITAL letters
        if(!groups[key]) groups[key] = [];
        groups[key].push(p);
    });

    let index = 1;
    Object.keys(groups).sort().forEach(key => {
        groups[key].forEach(p => {
            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${index++}</td>
                    <td>${key}</td>
                    <td>${p.description}</td>
                    <td>${p.volume}</td>
                    <td>${p.balance}</td>
                    <td><button onclick="showModal('${p.id}')">View</button></td>
                </tr>
            `);
        });
    });
}

// Search input
document.getElementById('fgSearch').addEventListener('input', renderFGStock);

// Show Modal for daily stock
function showModal(id){
    const product = fgProducts.find(p=>p.id===id);
    if(!product) return;

    document.getElementById('fgModalTitle').innerText = product.description;
    const modalHead = document.getElementById('modalHead');
    const modalBody = document.getElementById('modalBody');

    modalHead.innerHTML = '<th>Date</th><th>Stock</th>';
    modalBody.innerHTML = '';

    Object.entries(product.dailyStock).forEach(([date, val])=>{
        modalBody.insertAdjacentHTML('beforeend', `<tr><td>${date}</td><td>${val}</td></tr>`);
    });

    document.getElementById('fgModal').style.display = 'flex';
}

// Helper
function escapeHtml(text){
    return text.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function renderProductsTable() {
    const tbody = document.querySelector('#productsTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('productSearch').value || '').trim().toLowerCase();

    products.forEach((p,i) => {
        const name = p.name.toLowerCase();
        const cat = (p.category || '').toLowerCase();
        if((localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) ||
           (globalSearch && !name.includes(globalSearch) && !cat.includes(globalSearch))) return;

        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend',`
<tr>
    <td>${i+1}</td>
    <td>${escapeHtml(p.code || '')}</td>
    <td>${escapeHtml(p.name)}</td>
    <td>${escapeHtml(p.category)}</td>
    <td>${bal}</td>
    <td>${p.threshold || 5}</td>
    <td>${escapeHtml(p.barcode || '')}</td>
    <td><button class="btn secondary" onclick="openHistory('${p.id}')">History</button></td>
    <td><button class="btn secondary admin-only" onclick="editProduct('${p.id}')">Edit</button></td>
    <td><button class="btn secondary admin-only" onclick="deleteProduct('${p.id}')">Delete</button></td>
</tr>
`);

    });
}

function renderStockIn() {
    const tbody = document.querySelector('#stockInBody tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('inSearch').value || '').trim().toLowerCase();

    products.forEach(p => {
        const name = p.name.toLowerCase();
        if((localSearch && !name.includes(localSearch)) || (globalSearch && !name.includes(globalSearch))) return;
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${escapeHtml(p.name)}</td>
                <td>${bal}</td>
                <td>${lastMovement(p.id,'IN')}</td>
                <td><button class="btn" onclick="openStockModal('${p.id}','IN')">Add</button></td>
            </tr>
        `);
    });
}
function renderStockOut() {
    const tbody = document.querySelector('#stockOutBody tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('outSearch').value || '').trim().toLowerCase();

    products.forEach(p => {
        const name = p.name.toLowerCase();
        if((localSearch && !name.includes(localSearch)) || (globalSearch && !name.includes(globalSearch))) return;
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${escapeHtml(p.name)}</td>
                <td>${bal}</td>
                <td>${lastMovement(p.id,'OUT')}</td>
                <td><button class="btn out" onclick="openStockModal('${p.id}','OUT')">Remove</button></td>
            </tr>
        `);
    });
}

function renderCombinedHistory() {
    const tbody = document.querySelector('#historyTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('historySearch').value || '').trim().toLowerCase();

    stockMovements.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m => {
        const prod = products.find(p => p.id === m.productId);
        if(!prod) return;
        const name = prod.name.toLowerCase();
        const cat = (prod.category||'').toLowerCase();
        if((localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) ||
           (globalSearch && !name.includes(globalSearch) && !cat.includes(globalSearch))) return;

        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${fmtDate(m.date)}</td>
                <td>${escapeHtml(prod.name)}</td>
                <td>${m.type}</td>
                <td>${m.quantity}</td>
            </tr>
        `);
    });
}


// MODALS
let modalCurrent=null;
function openStockModal(productId,type){modalCurrent={productId,type};const prod=products.find(p=>p.id===productId);if(!prod)return;document.getElementById('modalProductName').textContent=prod.name;document.getElementById('modalProductBalance').textContent=computeBalance(productId);document.getElementById('modalQty').value='';document.getElementById('stockModal').style.display='flex';document.getElementById('modalSave').onclick=()=>{let qty=Number(document.getElementById('modalQty').value);if(qty<=0){alert('Invalid quantity');return;}if(type==='OUT'&&qty>computeBalance(productId)){alert('Quantity exceeds balance');return;}stockMovements.push({id:genId(),productId,type,quantity:qty,date:todayISO()});saveAll();closeModal();refreshAll();};}
function closeModal(){document.getElementById('stockModal').style.display='none';modalCurrent=null;}
function openHistory(productId){const modal=document.getElementById('historyModal');modal.style.display='flex';const tbody=document.getElementById('modalHistoryBody');tbody.innerHTML='';stockMovements.filter(m=>m.productId===productId).sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m=>{tbody.insertAdjacentHTML('beforeend',`<tr><td>${fmtDate(m.date)}</td><td>${m.type}</td><td>${m.quantity}</td></tr>`);});}
function closeHistoryModal(){document.getElementById('historyModal').style.display='none';}
function stockInHistoryModal(){const modal=document.getElementById('stockInHistoryModal');modal.style.display='flex';const tbody=document.getElementById('stockInHistoryPopupBody');tbody.innerHTML='';stockMovements.filter(m=>m.type==='IN').sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m=>{const prod=products.find(p=>p.id===m.productId);if(!prod)return;tbody.insertAdjacentHTML('beforeend',`<tr><td>${fmtDate(m.date)}</td><td>${escapeHtml(prod.name)}</td><td>${m.quantity}</td></tr>`);});}
function closeStockInHistory(){document.getElementById('stockInHistoryModal').style.display='none';}
function stockOutHistoryModal(){const modal=document.getElementById('stockOutHistoryModal');modal.style.display='flex';const tbody=document.getElementById('stockOutHistoryPopupBody');tbody.innerHTML='';stockMovements.filter(m=>m.type==='OUT').sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m=>{const prod=products.find(p=>p.id===m.productId);if(!prod)return;tbody.insertAdjacentHTML('beforeend',`<tr><td>${fmtDate(m.date)}</td><td>${escapeHtml(prod.name)}</td><td>${m.quantity}</td></tr>`);});}
function closeStockOutHistory(){document.getElementById('stockOutHistoryModal').style.display='none';}

// NAV
document.querySelectorAll('.menu-title.collapsible').forEach(m=>{m.addEventListener('click',()=>{m.classList.toggle('open');m.nextElementSibling.classList.toggle('open');});});
document.querySelectorAll('.submenu').forEach(sm=>{sm.addEventListener('click',()=>{const page=sm.dataset.page;const action=sm.dataset.action;if(page){document.querySelectorAll('.page').forEach(p=>p.style.display='none');document.getElementById(page).style.display='block';refreshAll();}if(action){window[action]?.();}});});

// ADD PRODUCT
document.getElementById('addProductBtn').addEventListener('click', () => {
    const code = document.getElementById('newCode').value.trim();
    const name = document.getElementById('newName').value.trim();
    const category = document.getElementById('newCategory').value.trim();
    const threshold = Number(document.getElementById('newThreshold').value || 5);
    const barcode = document.getElementById('newBarcode').value.trim();
    const groupsInput = document.getElementById('newGroups').value.trim();
    const exclusive = document.getElementById('newExclusive').checked;

    if (!name) { alert("Product name required"); return; }

    // Split groups by comma
    const groups = groupsInput ? groupsInput.split(',').map(g => g.trim()).filter(g => g) : [];

    const newProduct = {
        id: genId(),
        code,
        name,
        category,
        threshold,
        barcode,
        groups,
        exclusive  // new field to mark exclusive product
    };

    products.push(newProduct);
    saveAll();
    renderProductsTable();
    renderDashboardGrouped();

    // Clear form
    document.getElementById('newCode').value = '';
    document.getElementById('newName').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('newThreshold').value = '';
    document.getElementById('newBarcode').value = '';
    document.getElementById('newGroups').value = '';
    document.getElementById('newExclusive').checked = false;
});


// SEARCHES
document.getElementById('productSearch').addEventListener('input',renderProductsTable);
document.getElementById('inSearch').addEventListener('input',renderStockIn);
document.getElementById('outSearch').addEventListener('input',renderStockOut);
document.getElementById('historySearch').addEventListener('input',renderCombinedHistory);
document.getElementById('globalSearch').addEventListener('input',()=>{renderDashboardGrouped();renderProductsTable();renderStockIn();renderStockOut();renderCombinedHistory();});
document.getElementById('categoryFilter').addEventListener('change', () => {
    renderDashboardGrouped();
});document.getElementById('globalThreshold').addEventListener('input',renderDashboardGrouped);

// EXPORT / IMPORT
function exportExcel(){const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(products.map(p=>({Name:p.name,Category:p.category,Threshold:p.threshold,Balance:computeBalance(p.id)})));XLSX.utils.book_append_sheet(wb,ws,'Products');XLSX.writeFile(wb,'products.xlsx');}
function importExcel(){const inp=document.createElement('input');inp.type='file';inp.accept='.xlsx,.xls';inp.onchange=()=>{const f=inp.files[0];const reader=new FileReader();reader.onload=e=>{const data=new Uint8Array(e.target.result);const wb=XLSX.read(data,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];const json=XLSX.utils.sheet_to_json(ws);json.forEach(p=>{if(p.Name)products.push({id:genId(),name:p.Name,category:p.Category||'',threshold:p.Threshold||5});});saveAll();refreshAll();};reader.readAsArrayBuffer(f);};inp.click();}
function exportPDF(){const { jsPDF } = window.jspdf;const doc=new jsPDF();doc.autoTable({head:[['#','Name','Category','Balance','Threshold']],body:products.map((p,i)=>[i+1,p.name,p.category,computeBalance(p.id),p.threshold])});doc.save('products.pdf');}

function printStockReport() {
    const bannerUrl = 'banner.png'; // your banner image
    const productsData = products.map((p, i) => {
        return `<tr>
            <td>${i+1}</td>
            <td>${escapeHtml(p.name)}</td>
            <td>${computeBalance(p.id)}</td>
                    </tr>`;
    }).join('');

    const html = `
    <html>
    <head>
        <title>RAW Stock Report</title>
        <style>
            @media print {
                body {
                    margin: 0;
                    -webkit-print-color-adjust: exact;
                }
                img.bg {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 80%;
                    opacity: 0.3;
                    z-index: -1;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    background: transparent !important;
                    position: relative;
                    z-index: 1;
                }
                th, td {
                    padding: 10px;
                    border: 1px solid rgba(0,0,0,0.2);
                    background: transparent !important;
                }
                h2 {
                    text-align: center;
                    position: relative;
                    z-index: 1;
                }
            }
        </style>
    </head>
    <body>
        <img class="bg" src="${bannerUrl}" />
        <h2>RAW Stock Report</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    
                    <th>Balance</th>
                   
                </tr>
            </thead>
            <tbody>
                ${productsData}
            </tbody>
        </table>
    </body>
    </html>`;

    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
}
  

// EDIT PRODUCT
function editProduct(productId){
    const prod = products.find(p => p.id === productId);
    if(!prod) return;

    const newCode = prompt("Edit product code:", prod.code || "");
    if(newCode === null) return;

    const newName = prompt("Edit product name:", prod.name);
    if(newName === null || !newName.trim()) return alert("Name required");

    const newCategory = prompt("Edit category:", prod.category || "");
    if(newCategory === null) return;

    const newThreshold = prompt("Edit threshold:", prod.threshold || 5);
    if(newThreshold === null || isNaN(newThreshold)) return alert("Invalid threshold");

    const newBarcode = prompt("Edit barcode:", prod.barcode || "");
    if(newBarcode === null) return;

    const newGroupsInput = prompt(
        "Edit groups (comma separated):",
        Array.isArray(prod.groups) ? prod.groups.join(', ') : ''
    );
    if(newGroupsInput === null) return;

    const newExclusive = confirm("Exclusive to first group?");

    prod.code = newCode.trim();
    prod.name = newName.trim();
    prod.category = newCategory.trim();
    prod.threshold = Number(newThreshold);
    prod.barcode = newBarcode.trim();
    prod.groups = newGroupsInput
        .split(',')
        .map(g => g.trim())
        .filter(Boolean);
    prod.exclusive = newExclusive;

    saveAll();
    refreshAll();
}

// DELETE PRODUCT
function deleteProduct(productId){
    if(!confirm("Are you sure you want to delete this product? This will remove all its stock history.")) return;
    products = products.filter(p => p.id !== productId);
    stockMovements = stockMovements.filter(m => m.productId !== productId);
    saveAll();
    refreshAll();
}
/* ==========================
   ‚òÅÔ∏è CLOUD SYNC MODULE
========================== */


// ================================
// ‚òÅÔ∏è AUTO CLOUD SYNC MODULE
// ================================

function autoPullFromCloud() {
  if (!window.cloudDB) return console.warn("Cloud DB not ready");

  cloudDB.ref("stockManager").once("value")
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) return;

      products = data.products || [];
      stockMovements = data.stockMovements || [];

      localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
      localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements));

      refreshAll();

      const status = document.getElementById("status");
      if (status) status.textContent = "Status: Auto-loaded from Cloud ‚òÅÔ∏è";

      console.log("‚úÖ Auto pull completed");
    })
    .catch(err => {
      console.error("Auto pull failed:", err);
      refreshAll();
    });
}

function autoPushToCloud() {
  if (!window.cloudDB) return console.warn("Cloud DB not ready");

  cloudDB.ref("stockManager").set({
    products: products,
    stockMovements: stockMovements,
    syncedAt: new Date().toISOString()
  })
  .then(() => {
    const status = document.getElementById("status");
    if (status) status.textContent = "Status: Auto-synced to Cloud ‚òÅÔ∏è";
    console.log("‚úÖ Auto push completed");
  })
  .catch(err => console.error("Auto push failed:", err));
}

// ================================
// HOOK INTO LOCAL CHANGES
// ================================

// Wrap saveAll to auto push
const originalSaveAll = saveAll;
saveAll = function() {
  originalSaveAll();      // save locally
  autoPushToCloud();      // push changes to cloud
};

// Auto pull on page load
window.addEventListener("load", () => {
  autoPullFromCloud();
});

// UTILITY
function refreshAll(){
    renderProductsTable();
    renderStockIn();
    renderStockOut();
    renderCombinedHistory();
    populateCategoryFilter();
    applyPermissions();
}

refreshAll();
const sidebar = document.querySelector('.sidebar');
const mainContent = document.querySelector('.main');
const toggleBtn = document.getElementById('sidebarToggle');

toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('minimized');
    mainContent.classList.toggle('sidebar-minimized');
});

</script>

</main>
</div>
</body>
</html>
