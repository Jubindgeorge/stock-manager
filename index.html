<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stock Manager</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<!-- ‚òÅÔ∏è CLOUD SYNC ADDITION -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --sidebar-w: 260px;
  --muted: #6b6f76;
  --accent: #2c3e50;
  --accent-2: #2980b9;
  --danger: #c0392b;
  --badge-green: #2ecc71;
}

/* Reset & base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, system-ui, Arial, sans-serif;
  color: #111;
  background: transparent;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-position: center center;
  background-repeat: no-repeat;
  background-size: 750px auto;
  background-attachment: fixed;
  opacity: 1;
  z-index: -1;
  pointer-events: none;
}

/* App layout */
.app {
  display: none; /* shown after login / restore */
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: var(--sidebar-w);
  position: fixed;
  left: 0;
  top: 0;
  height: 100%;
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(5px);
  padding: 8px;
  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.08);
  overflow: auto;
  z-index: 20;
  border-right: 1px solid rgba(0, 0, 0, 0.04);
  border-radius: 0 10px 10px 0;
}

.sidebar.minimized {
  width: 60px;
  overflow: hidden;
  padding: 8px 4px;
  border-radius: 0 10px 10px 0;
  transition: width 0.3s ease;
}

.sidebar.minimized .sidebar-header div,
.sidebar.minimized .brand-title,
.sidebar.minimized .brand-sub,
.sidebar.minimized .sidebar-logo,
.sidebar.minimized .sidebar-menu,
.sidebar.minimized .sidebar-menu li span,
.sidebar.minimized .sidebar-footer {
  display: none;
}

.sidebar.minimized .sidebar-logo {
  width: 40px;
  height: 40px;
}

.sidebar-header {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 8px;
}

.sidebar-logo {
  width: 96px;
  height: 56px;
  object-fit: cover;
  border-radius: 8px;
}

.brand-title {
  font-size: 18px;
  margin: 0;
}

.brand-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

.sidebar-menu {
  list-style: none;
  padding: 0;
  margin: 12px 0 0;
}

.sidebar-menu li {
  padding: 12px 10px;
  display: flex;
  gap: 10px;
  align-items: center;
  cursor: pointer;
  border-left: 4px solid transparent;
  border-radius: 6px;
  transition: all 0.18s;
  color: #222;
}

.sidebar-menu li:hover {
  background: rgba(60, 120, 200, 0.06);
  transform: translateX(4px);
  border-left-color: rgba(41, 128, 185, 0.8);
}

.sidebar-menu li.active {
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: #fff;
  border-left-color: #fff;
  font-weight: 700;
}

.sidebar.minimized + .main { margin-left: 60px; }

.menu-title {
  font-weight: 700;
  background: rgba(0, 0, 0, 0.05);
}

.modal-box{
  background-color:white; 
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.08);
}  

.menu-title.collapsible {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.menu-title span.arrow {
  display: inline-block;
  font-size: 12px;
  transition: transform 0.2s ease;
}

.menu-title.open .arrow { transform: rotate(180deg); }

.submenu { padding-left: 36px !important; font-size: 14px; }

.subgroup {
  list-style: none;
  padding: 0;
  margin: 0;
  display: none;
}

.subgroup.open { display: block; }

.sidebar-footer {
  margin-top: 18px;
  font-size: 13px;
  color: var(--muted);
}

.admin-only { display: none; }

/* Main content */
.main {
  margin-left: calc(var(--sidebar-w) + 18px);
  width: 70%;
  padding: 18px;
  min-height: 100vh;
  background: transparent;
  transition: margin-left 0.3s ease;
}

.main.sidebar-minimized { margin-left: 60px; }

.top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.search {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.08);
  width: 320px;
  background: rgba(255, 255, 255, 0.55);
}

.small {
  padding: 8px 10px;
  border-radius: 8px;
  border: 2px solid rgba(0, 0, 0, 0.08);
  width: 220px;
  background: rgba(255, 255, 255, 0.66);
}

.btn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}

.btn.secondary { background: var(--accent-2); }
.btn.out { background: #dc2626; }
.btn.info { background: #16a34a; }

/* Pages & tables */
.page {
  background: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(5px);
  border-radius: 12px;
  width: 100%;
  min-height: calc(100vh - 40px);
  padding: 25px;
  border: 1px solid rgba(0, 0, 0, 0.05);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 10px;
  text-align: left;
}

th {
  background: #007bff;
  font-weight: 700;
  color: #fff;
}

.low-stock { color: var(--danger); font-weight: 700; }
.balance-qty { font-weight: bold; }

/* Modals */
.modal-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal {
  background: white;
  padding: 20px;
  border-radius: 12px;
  max-height: 80%;
  overflow-y: auto;
  width: 700px;
  max-width: 92vw;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.modal-close {
  cursor: pointer;
  background: none;
  border: none;
  font-size: 18px;
}

.modal-table {
  width: 100%;
  border-collapse: collapse;
}

.modal-table th,
.modal-table td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

/* Print styling */
@media print {
  body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  .print-bg {
    background-image: url('banner.png') !important;
    background-size: cover !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
  }
}

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #16a34a;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-weight: bold;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.toast.out { background-color: #dc2626; }

.dashboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  margin-top:15px;
}
.dash-card{
  background:#fff;
  border-radius:8px;
  padding:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  text-align:center;
}
.dash-card h3{ font-size:14px; color:#555; }
.dash-card div{ font-size:28px; font-weight:700; margin-top:6px; }

.fg-chart-box {
  height: 260px;
  max-height: 260px;
  overflow: hidden;
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="position:fixed; inset:0; background:#f3f4f6;
display:flex; align-items:center; justify-content:center; z-index:99999;">
  <div style="width:350px; background:white; padding:25px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15)">
    <h2 style="text-align:center">Stock Manager</h2>

    <div id="loginForm">
      <input id="loginUser" placeholder="Username" style="width:100%;padding:8px 10px;margin:10px 0;border: 1px solid rgba(0, 0, 0, 0.08);">
      <input id="loginPass" type="password" placeholder="Password" style="width:100%;padding:8px 10px;margin:10px 0;border: 1px solid rgba(0, 0, 0, 0.08);">
      <button class="btn" style="width:100%;" onclick="login()">Login</button>

      <p style="text-align:center;margin:10px 0;">Don't have an account?
        <span style="color:blue;cursor:pointer;" onclick="showSignup()">Sign Up</span>
      </p>

      <p style="text-align:center;margin:10px 0;">
        <span style="color:blue;cursor:pointer;" onclick="forgotPassword()">Forgot Password?</span>
      </p>

      <p id="loginMsg" style="color:red;text-align:center;margin-top:10px"></p>
    </div>

    <div id="signupForm" style="display:none">
      <input id="signupUser" placeholder="Username" style="width:90%;padding:10px;margin:10px 0">
      <input id="signupPass" type="password" placeholder="Password" style="width:90%;padding:10px;margin-bottom:10px">
      <select id="signupRole" style="width:100%;padding:10px;margin-bottom:10px">
        <option value="user">User</option>
      </select>
      <button class="btn" style="width:98%" onclick="signup()">Create Account</button>
      <p style="text-align:center;margin:10px 0;">Already have an account?
        <span style="color:blue;cursor:pointer;" onclick="showLogin()">Login</span>
      </p>
      <p id="signupMsg" style="color:red;text-align:center;margin-top:10px"></p>
    </div>
  </div>
</div>

<div class="app">
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img id="brandBanner" src="banner.png" class="sidebar-logo" onerror="this.style.display='none'">
      <div>
        <div class="brand-title">STOCK</div>
        <div class="brand-sub">Inventory ‚Ä¢ Public Sheet</div>
      </div>
      <button id="sidebarToggle" class="btn secondary" style="margin-left:auto;padding:4px 6px;font-size:14px">‚Üê</button>
    </div>

    <ul class="sidebar-menu" id="menu">

      <li id="usersMenu" class="menu-title collapsible admin-only">
        üë• Users <span class="arrow">‚ñæ</span>
      </li>
      <ul class="subgroup admin-only">
        <li class="submenu" data-page="userManagement">Manage Users</li>
      </ul>

      <li class="menu-title collapsible">üìä Dashboard <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="dashboardPage">üìä Dashboard</li>
      </ul>

      <li class="menu-title collapsible">üìä GRN <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="dashboard">üìä BOM</li>
<li class="submenu" data-page="billEntry">üì• Goods Recived Note </li>

      </ul>

      <li class="menu-title collapsible">üìà Store <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="products">üì¶ RM List</li>
        <li class="submenu admin-only" data-page="rmAddProduct">‚ûï Add RM Product</li>
        <li class="submenu" data-page="stockIn">‚¨Ü RM Stock In</li>
        <li class="submenu" data-page="stockOut">‚¨á RM Stock Out</li>
	<li class="submenu" data-page="rmDeliveryNote">üöö RM Delivery Note</li>

      </ul>

      <li class="menu-title collapsible">üßæ FG <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="fgStock">üì¶ FG Stock List</li>
        <li class="submenu admin-only" data-page="fgAddProduct">‚ûï Add FG Product</li>
        <li class="submenu" data-page="fgStockIn">‚¨Ü FG Stock In</li>
        <li class="submenu" data-page="fgStockOut">‚¨á FG Stock Out</li>
      </ul>
	 <li class="menu-title collapsible">üßæ Production <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
		<li class="submenu" data-page="productionEntry">üè≠ Production Entry</li>
      </ul>

      <li class="menu-title collapsible">üßæ Suppliers <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="suppliers">üìã Manage Raw Suppliers</li>
      </ul>

      <li class="menu-title collapsible">üíæ Report <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="history">üìö RM History</li>
        <li class="submenu" data-action="importExcel">üì• Import Excel</li>
        <li class="submenu" data-action="exportExcel">üì§ Export Excel</li>
        <li class="submenu" data-action="printStockReport">üñ®Ô∏è Print RM Stock Report</li>
        <li class="submenu" data-action="printFGStockReport">üñ®Ô∏è Print FG Stock Report</li>
        <li class="submenu" data-action="exportPDF">üìÑ Export PDF</li>
      </ul>

      <div class="sidebar-footer">Data stored locally; cloud optional.</div>
    </ul>
  </aside>

  <main class="main">
    <button onclick="logout()" class="btn out" style="position:fixed;top:10px;right:20px;z-index:999">Logout</button>

    <!-- USER MANAGEMENT -->
    <section id="userManagement" class="page" style="display:none">
      <h2>Manage Users</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Username</th>
            <th>Role/Permission</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px;">
        <input id="newUsername" placeholder="Username">
        <input id="newPassword" type="password" placeholder="Password">
        <select id="newRole">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn admin-only" onclick="addUser()">Add User</button>
      </div>
    </section>

    <!-- BOM / DASH TABLE -->
    <section id="dashboard" class="page" style="display:block">
      <h2>Bill Of Materials</h2>

      <div class="top">
        <div class="dash-search">
          <input type="text" id="dashboardSearch" class="search" placeholder="Search product / group..."
            oninput="handleDashboardSearch(this.value)">
          <button class="btn secondary" onclick="clearDashboardSearch()">Clear</button>
        </div>
      </div>

      <div style="overflow:auto">
        <table id="dashTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Balance</th>
              <th>Threshold</th>
              <th>Last IN</th>
              <th>Last OUT</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MAIN DASHBOARD -->
    <section id="dashboardPage" class="page" style="display:none">
      <h2>Dashboard</h2>

      <div class="dashboard-grid">
        <div class="dash-card">
          <h3>Total RM Products</h3>
          <div id="dashTotalProducts">0</div>
        </div>

        <div class="dash-card">
          <h3>Total RM Stock</h3>
          <div id="dashTotalStock">0</div>
        </div>

        <div class="dash-card">
          <h3>Low Stock Items</h3>
          <div id="dashLowStock">0</div>
        </div>

        <div class="dash-card" onclick="openFGFromDashboard()" style="cursor:pointer">
          <h3>Total FG Balance</h3>
          <div id="dashFGBalance">0</div>
        </div>

        <div class="dash-card" onclick="openFGFromDashboard()" style="cursor:pointer">
          <h3>FG Products</h3>
          <div id="dashFGTotalProducts">0</div>
        </div>

        <div class="dash-card" onclick="openLowFGFromDashboard()" style="cursor:pointer">
          <h3>Low FG Stock</h3>
          <div id="dashFGLowStock">0</div>
        </div>

        <div class="dash-card">
          <h3>Max FG Balance</h3>
          <div id="dashFGMaxBalance">-</div>
        </div>

        <div class="dash-card">
          <h3>Min FG Balance</h3>
          <div id="dashFGMinBalance">-</div>
        </div>
      </div>

      <div id="fgVolumeFilter" style="display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;font-size:14px"></div>

      <div class="fg-chart-box">
        <canvas id="fgStockChart"></canvas>
      </div>
    </section>

    <!-- FG STOCK LIST -->
    <section id="fgStock" class="page" style="display:none">
      <h2>Finished Goods Stock</h2>
      <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
        <input id="fgSearch" class="search" placeholder="Search FG products...">
      </div>
      <div style="overflow:auto; height: calc(100% - 140px);">
        <table id="fgTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Volume</th>
              <th>Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PRODUCTS (RM) -->
    <section id="products" class="page" style="display:none">
      <h2>Raw Material List</h2>

      <div style="margin-bottom:12px">
        <input id="productSearch" class="search" placeholder="Search products...">
      </div>

      <div style="overflow:auto;height:calc(100% - 120px)">
        <table id="productsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Code</th>
              <th>Name</th>
              <th>Category</th>
              <th>Balance</th>
              <th>Threshold</th>
              <th>Barcode</th>
              <th>History</th>
              <th>Edit</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
<!-- BILL OF ENTRY -->
<section id="billEntry" class="page" style="display:none">
  <h2>Goods Recived Note</h2>

  <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">

    <!-- BOE FORM -->
    <div style="flex:1;min-width:320px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
        <h3 style="margin:0">Create / Edit Bill of Entry</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn secondary" onclick="boeTriggerImport()">üì• Import Excel</button>
          <button class="btn info" onclick="printBOESummaryReport()">üñ®Ô∏è Print Bills Summary</button>
        </div>
      </div>

      <input id="boeFileInput" type="file" accept=".xlsx,.xls" style="display:none">

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <input id="boeNo" class="small" placeholder="Bill No / Entry No">
        <input id="boeDate" class="small" type="date">
        <select id="boeSupplier" class="small"></select>
        <input id="boeSupplierOther" class="small" placeholder="Supplier Name (if Other)" style="display:none">
      </div>

      <div style="overflow:auto;border:1px solid rgba(0,0,0,.08);border-radius:10px">
        <table style="margin:0">
          <thead>
            <tr>
              <th style="min-width:220px">RM Product</th>
              <th style="width:120px">Qty</th>
              <th>Remark</th>
              <th style="width:80px">Remove</th>
            </tr>
          </thead>
          <tbody id="boeItemsBody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn secondary" onclick="boeAddRow()">‚ûï Add Item</button>
        <button class="btn" onclick="submitBillEntry()">‚úÖ Save Bill & Stock IN</button>
        <button class="btn out" onclick="resetBillEntryForm()">Clear</button>

        <span id="boeEditBadge" style="margin-left:auto;font-weight:700;color:#0b5;display:none">
          EDITING MODE
        </span>
      </div>

    
    </div>

    <!-- BOE LIST -->
    <div style="flex:1;min-width:320px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)">
      <h3 style="margin-bottom:10px">Saved Bills</h3>

      <input id="boeSearch" class="search" placeholder="Search bill / supplier..." style="margin-bottom:10px">

      <div style="overflow:auto;max-height:520px;border:1px solid rgba(0,0,0,.08);border-radius:10px">
        <table id="boeTable" style="margin:0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Bill No</th>
              <th>Supplier</th>
              <th>Total Qty</th>
              <th>Items</th>
              <th style="min-width:240px">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<!-- BOE VIEW MODAL -->
<div id="boeViewModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="boeViewTitle">Bill of Entry</h3>
      <button class="modal-close" onclick="closeBOEView()">‚úñ</button>
    </div>

    <div id="boeViewMeta" style="margin-bottom:10px;color:#444"></div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn info" onclick="printBOEFromView()">üñ®Ô∏è Print This BOE</button>
      <button class="btn secondary admin-only" onclick="editBOEFromView()">‚úèÔ∏è Edit This BOE</button>
    </div>

    <table class="modal-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody id="boeViewBody"></tbody>
    </table>
  </div>
</div>



    <!-- ADD RM PRODUCT -->
    <section id="rmAddProduct" class="page" style="display:none">
      <h2>Add Raw Material Product</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px">
        <input id="newCode" class="small" placeholder="Product Code">
        <input id="newName" class="small" placeholder="Product Name">
        <input id="newCategory" class="small" placeholder="Category">
        <input id="newThreshold" class="small" type="number" placeholder="Low Stock Threshold">
        <input id="newBarcode" class="small" placeholder="Barcode">
        <input id="newGroups" class="small" placeholder="Groups (comma separated)">
        <label style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="newExclusive"> Exclusive to first group
        </label>
      </div>

      <button class="btn btn-add" onclick="addRMProduct()">Add Product</button>
    </section>

    <!-- STOCK IN -->
    <section id="stockIn" class="page" style="display:none">
      <h2>RM Stock In</h2>
      <input id="inSearch" class="search" placeholder="Search product">
      <button class="btn secondary" onclick="stockInHistoryModal()">View Stock IN History</button>
      <table id="stockInBody">
        <thead><tr><th>Product</th><th>Balance</th><th>Last IN</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- STOCK OUT -->
    <section id="stockOut" class="page" style="display:none">
      <h2>RM Stock Out</h2>
      <input id="outSearch" class="search" placeholder="Search product">
      <button class="btn info" onclick="stockOutHistoryModal()">View Stock OUT History</button>
      <table id="stockOutBody">
        <thead><tr><th>Product</th><th>Balance</th><th>Last OUT</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- COMBINED HISTORY -->
    <section id="history" class="page" style="display:none">
      <h2>RM Combined History</h2>
      <div style="margin-bottom:12px">
        <input id="historySearch" class="search" placeholder="Search combined history...">
      </div>
      <div style="overflow:auto; height: calc(100% - 120px);">
        <table id="historyTable">
          <thead>
            <tr><th>Date</th><th>Product</th><th>Type</th><th>Qty</th><th>Remark</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SUPPLIERS -->
    <section id="suppliers" class="page" style="display:none">
      <h2>Raw Material Suppliers</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <input id="newSupplierName" class="small" placeholder="Supplier Name">
        <input id="newSupplierContact" class="small" placeholder="Contact Info">
        <button id="addSupplierBtn" class="btn btn-add">Add Supplier</button>
      </div>
      <div style="margin-bottom:12px">
        <input id="supplierSearch" class="search" placeholder="Search suppliers...">
      </div>
      <div style="overflow:auto; height: calc(100% - 150px);">
        <table id="suppliersTable">
          <thead><tr><th>#</th><th>Name</th><th>Contact</th><th>Edit</th><th>Delete</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MODALS -->
    <div id="historyModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modalTitle">Product History</h3>
          <button onclick="closeHistoryModal()" class="modal-close">‚úñ</button>
        </div>
        <div class="modal-body">
          <table class="modal-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Product</th>
                <th>Type</th>
                <th>Qty</th>
                <th>Batch</th>
                <th>Expiry</th>
                <th>Remark</th>
              </tr>
            </thead>
            <tbody id="modalHistoryBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="stockInHistoryModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Stock IN History</h3>
          <button onclick="closeStockInHistory()" class="modal-close">‚úñ</button>
        </div>
        <div class="modal-body">
          <table class="modal-table">
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Remark</th></tr></thead>
            <tbody id="stockInHistoryPopupBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="stockOutHistoryModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Stock OUT History</h3>
          <button onclick="closeStockOutHistory()" class="modal-close">‚úñ</button>
        </div>
        <div class="modal-body">
          <table class="modal-table">
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Remark</th></tr></thead>
            <tbody id="stockOutHistoryPopupBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Stock Modal (RM + FG) -->
    <div id="stockModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modalProductName">Product Name</h3>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <p>Balance: <span id="modalProductBalance" style="font-weight:bold;">0</span> PCS</p>

        <div class="modal-inputs" style="padding:10px;">
          <input id="modalQty" class="small" type="number" placeholder="Enter quantity">
          <input id="modalRemark" class="small" placeholder="Enter remark (optional)">
        </div>

        <div style="padding:10px;" class="modal-actions">
          <button id="modalSave" class="btn">Submit</button>
          <button onclick="closeModal()" class="btn secondary">Close</button>
        </div>
      </div>
    </div>

    <!-- Success Toast -->
    <div id="stockToast" class="toast" style="display:none;"></div>

    <!-- FG STOCK IN -->
    <section id="fgStockIn" class="page" style="display:none">
      <h2>FG Stock In</h2>
      <input id="fgInSearch" class="search" placeholder="Search FG product...">
      <button class="btn secondary" onclick="fgStockInHistoryModal()">View FG IN History</button>

      <table>
        <thead>
          <tr><th>#</th><th>Product</th><th>Balance</th><th>Action</th></tr>
        </thead>
        <tbody id="fgStockInBody"></tbody>
      </table>
    </section>

    <!-- FG STOCK OUT -->
    <section id="fgStockOut" class="page" style="display:none">
      <h2>FG Stock Out</h2>
      <input id="fgOutSearch" class="search" placeholder="Search FG product...">
      <button class="btn info" onclick="fgStockOutHistoryModal()">View FG OUT History</button>

      <table>
        <thead>
          <tr><th>#</th><th>Product</th><th>Balance</th><th>Action</th></tr>
        </thead>
        <tbody id="fgStockOutBody"></tbody>
      </table>
    </section>

    <!-- ADD FG PRODUCT -->
    <section id="fgAddProduct" class="page" style="display:none">
      <h2>Add Finished Goods Product</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px">
        <input id="fgNewName" class="small" placeholder="Product Name">
        <input id="fgNewVolume" class="small" placeholder="Volume / Size">
        <input id="fgNewGroup" class="small" placeholder="Group Prefix (ALKHOR)">
        <input id="fgNewBatch" class="small" placeholder="Batch / Lot No">
        <input id="fgNewExpiry" class="small" type="date">
        <input id="fgNewThreshold" class="small" type="number" placeholder="Low Stock Threshold">
      </div>

      <button class="btn btn-add" onclick="addFGProduct()">Add FG Product</button>
      <hr style="margin:20px 0">
    </section>
<!-- PRODUCTION ENTRY -->
<section id="productionEntry" class="page" style="display:none">
  <h2>Production Entry (FG IN + RM OUT)</h2>

  <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">

    <!-- PRODUCTION FORM -->
    <div style="flex:1;min-width:320px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)">
      <h3 style="margin-bottom:10px">Create Production</h3>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <input id="prodNo" class="small" placeholder="Production No / Ref">
        <input id="prodDate" class="small" type="date">
        <select id="prodFG" class="small"></select>
        <input id="prodFGQty" class="small" type="number" min="0" step="1" placeholder="FG Qty Produced">
      </div>


      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn secondary" onclick="prodAddRMRow()">‚ûï Add RM Line</button>
        <button class="btn" onclick="submitProduction()">‚úÖ Save Production</button>
        <button class="btn out" onclick="resetProductionForm()">Clear</button>
      </div>

         </div>

    <!-- PRODUCTION LIST -->
    <div style="flex:1;min-width:320px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)">
      <h3 style="margin-bottom:10px">Saved Productions</h3>

      <input id="prodSearch" class="search" placeholder="Search prod no / FG..." style="margin-bottom:10px">

      <div style="overflow:auto;max-height:520px;border:1px solid rgba(0,0,0,.08);border-radius:10px">
        <table id="prodTable" style="margin:0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Prod No</th>
              <th>FG Product</th>
              <th>FG Qty</th>
              <th>RM Lines</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</section>


<!-- PRODUCTION VIEW MODAL -->
<div id="prodViewModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="prodViewTitle">Production</h3>
      <button class="modal-close" onclick="closeProdView()">‚úñ</button>
    </div>

    <div id="prodViewMeta" style="margin-bottom:10px;color:#444"></div>

    <h4 style="margin:10px 0 6px">FG Output</h4>
    <table class="modal-table">
      <thead>
        <tr>
          <th>FG Product</th>
          <th>Qty</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody id="prodViewFGBody"></tbody>
    </table>

    <h4 style="margin:14px 0 6px">RM Consumption</h4>
    <table class="modal-table">
      <thead>
        <tr>
          <th>RM Product</th>
          <th>Qty Used</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody id="prodViewRMBody"></tbody>
    </table>

    <!-- ‚úÖ ADD THIS (RM RETURN) -->
    <h4 style="margin:14px 0 6px">RM Return</h4>
    <table class="modal-table">
      <thead>
        <tr>
          <th>RM Product</th>
          <th>Qty Return</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody id="prodViewRMReturnBody"></tbody>
    </table>
  </div>
</div>

<!-- ‚úÖ RM DELIVERY NOTE -->
<section id="rmDeliveryNote" class="page" style="display:none">
  <h2>RM Delivery Note (Warehouse ‚Üí Factory)</h2>

  <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">

    <!-- DN FORM -->
    <div style="flex:1;min-width:320px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)">
      <h3 style="margin-bottom:10px">Create Delivery Note</h3>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <input id="dnNo" class="small" placeholder="Delivery Note No">
        <input id="dnDate" class="small" type="date">
        <input id="dnFrom" class="small" placeholder="From (Warehouse)" value="Main Store">
        <input id="dnTo" class="small" placeholder="To (Factory)" value="Factory">
        <input id="dnProdRef" class="small" placeholder="Production Ref (optional)">
      </div>

      <div style="margin-bottom:10px">
        <input id="dnRemark" class="search" placeholder="General Remark (optional)">
      </div>

      <div style="overflow:auto;border:1px solid rgba(0,0,0,.08);border-radius:10px">
        <table style="margin:0">
          <thead>
            <tr>
              <th style="min-width:240px">RM Product</th>
              <th style="width:120px">Qty</th>
              <th>Remark</th>
              <th style="width:80px">Remove</th>
            </tr>
          </thead>
          <tbody id="dnItemsBody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn secondary" onclick="dnAddRow()">‚ûï Add Item</button>
<button class="btn" onclick="submitDeliveryNote()">‚úÖ Save Delivery Note</button>
        <button class="btn out" onclick="resetDeliveryNoteForm()">Clear</button>
      </div>

         </div>

    <!-- DN LIST -->
    <div style="flex:1;min-width:320px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)">
      <h3 style="margin-bottom:10px">Saved Delivery Notes</h3>
      <input id="dnSearch" class="search" placeholder="Search DN no / remark..." style="margin-bottom:10px">

      <div style="overflow:auto;max-height:520px;border:1px solid rgba(0,0,0,.08);border-radius:10px">
        <table id="dnTable" style="margin:0">
          <thead>
            <tr>
              <th>Date</th>
              <th>DN No</th>
              <th>To</th>
              <th>Total Qty</th>
              <th>Items</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<!-- DN VIEW MODAL -->
<div id="dnViewModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="dnViewTitle">Delivery Note</h3>
      <button class="modal-close" onclick="closeDNView()">‚úñ</button>
    </div>

    <div id="dnViewMeta" style="margin-bottom:10px;color:#444"></div>

    <table class="modal-table">
      <thead>
        <tr>
          <th>RM Product</th>
          <th>Qty</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody id="dnViewBody"></tbody>
    </table>

    <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn secondary" onclick="printDNFromModal()">üñ® Print</button>
      <button class="btn out" onclick="closeDNView()">Close</button>
    </div>
  </div>
</div>

  </main>
</div>

<script>
/* =========================
   ‚úÖ GLOBALS
========================= */
let selectedFGVolumes = new Set();
let currentUser = null;
let fgChartInstance = null;

const loginScreen = document.getElementById('loginScreen');
const loginForm   = document.getElementById('loginForm');
const signupForm  = document.getElementById('signupForm');
const loginMsg    = document.getElementById('loginMsg');
const signupMsg   = document.getElementById('signupMsg');

/* =========================
   ‚úÖ FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBTtsOeQTpPwTEn_T9EDqt5i_0eyQuzGOA",
  authDomain: "stock-manager-703e6.firebaseapp.com",
  databaseURL: "https://stock-manager-703e6-default-rtdb.firebaseio.com",
  projectId: "stock-manager-703e6",
  storageBucket: "stock-manager-703e6.firebasestorage.app",
  messagingSenderId: "778548519096",
  appId: "1:778548519096:web:716f903fee993f4d85544d",
  measurementId: "G-G735N8XCQ2"
};

firebase.initializeApp(firebaseConfig);
const cloudDB = firebase.database();
window.cloudDB = cloudDB;

/* =========================
   ‚úÖ UTILITIES
========================= */
function genId(){ return 'id_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000); }
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function fmtDate(iso){
  if(!iso) return '-';
  const p = String(iso).split('-');
  if(p.length !== 3) return String(iso);
  return `${p[2]}/${p[1]}/${p[0]}`;
}
function escapeHtml(s){
  if(s == null) return '';
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
function normalizeGroup(g){
  return String(g || '').trim().toUpperCase().replace(/\s+/g,'');
}
function showToast(message, isError=false){
  const toast = document.getElementById('stockToast');
  if(!toast) return;
  toast.textContent = message;
  toast.classList.toggle('out', isError);
  toast.style.display = 'block';
  requestAnimationFrame(()=> toast.style.opacity = '1');
  setTimeout(()=>{
    toast.style.opacity = '0';
    setTimeout(()=> toast.style.display='none', 300);
  }, 2000);
}

/* =========================
   ‚úÖ OPTIONAL: FIX bannerUrl template issue
   (If you ever used src="${bannerUrl}" it won't work in HTML.)
========================= */
function setBanner(url){
  const img = document.getElementById('brandBanner');
  if(img) img.src = url || 'banner.png';
  // set background watermark
  document.body.style.setProperty('--banner-url', url || 'banner.png');
}
setBanner('banner.png');


function isUserTypingInForms(){
  const el = document.activeElement;
  if(!el) return false;

  // If cursor is inside any of these forms, DO NOT re-render/reset them
  const inForms = el.closest('#rmDeliveryNote, #billEntry, #productionEntry');
  const isField = el.matches('input, textarea, select');

  return !!(inForms && isField);
}

/* =========================
   ‚úÖ PAGE NAV
========================= */
function openPage(pageId){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const el = document.getElementById(pageId);
  if(el) el.style.display='block';

  // page-specific renders
  if(pageId === 'dashboardPage'){
    renderMainDashboard();
    renderFGVolumeFilter();
    renderFGChart();
  }
  if(pageId === 'dashboard'){
    renderDashboardGrouped();
  }
  if(pageId === 'suppliers'){
    renderSuppliers();
  }
if(pageId === 'billEntry'){
  renderBOESupplierDropdown();
  if(!document.getElementById('boeDate').value) document.getElementById('boeDate').value = todayISO();
  if(!document.getElementById('boeItemsBody').children.length) boeAddRow();
  renderBillsTable();
}
if(pageId === 'productionEntry'){
  renderProdFGDropdown();
  if(!document.getElementById('prodDate').value) document.getElementById('prodDate').value = todayISO();

  if(!document.getElementById('prodRMBody').children.length) prodAddRMRow();
  if(!document.getElementById('prodRMReturnBody').children.length) prodAddRMReturnRow();

  renderProductionsTable();
}
if(pageId === 'rmDeliveryNote'){
  if(!document.getElementById('dnDate').value) document.getElementById('dnDate').value = todayISO();
  if(!document.getElementById('dnItemsBody').children.length) dnAddRow();
  renderDNTable();
}


  refreshAll();
}

/* =========================
   ‚úÖ ADMIN DEFAULT USER
========================= */
const DEFAULT_ADMIN = {
  username: "admin",
  password: "admin123",
  role: "admin",
  permissionLevel: "full",
  createdAt: new Date().toISOString()
};

async function ensureAdminExists(){
  try{
    const snap = await cloudDB.ref('users').orderByChild('role').equalTo('admin').once('value');
    if(!snap.exists()){
      const userId = 'admin_' + Date.now().toString(36);
      await cloudDB.ref('users/' + userId).set(DEFAULT_ADMIN);
      console.log("‚úÖ Default admin created");
    }
  }catch(err){
    console.error("‚ùå ensureAdminExists error:", err);
  }
}
ensureAdminExists();

/* =========================
   ‚úÖ ROLE PERMISSIONS (ADMIN ALWAYS FULL POWER)
========================= */
const ROLE_PERMISSIONS = {
  full: { stockIn:true, stockOut:true,  add:true,  edit:true,  delete:true },
  half: { stockIn:true, stockOut:true, add:true,  edit:true,  delete:false },
  view: { stockIn:true, stockOut:true, add:false, edit:false, delete:false }
};

function getPerms(){
  if(currentUser?.role === 'admin') return ROLE_PERMISSIONS.full;
  return ROLE_PERMISSIONS[currentUser?.permissionLevel] || ROLE_PERMISSIONS.view;
}
function canStockOut(){ return !!getPerms().stockOut; }
function canAdd(){ return !!getPerms().add; }
function canEdit(){ return !!getPerms().edit; }
function canDelete(){ return !!getPerms().delete; }

function showAdminUI(){
  const isAdmin = currentUser?.role === 'admin';
  document.querySelectorAll('.admin-only').forEach(el=>{
    el.style.display = isAdmin ? '' : 'none';
  });
}

function applyPermissions(){
  showAdminUI();
  const p = getPerms();

  document.querySelectorAll('.btn-add').forEach(b => b.style.display = p.add ? 'inline-block' : 'none');
  document.querySelectorAll('.btn-edit').forEach(b => b.style.display = p.edit ? 'inline-block' : 'none');
  document.querySelectorAll('.btn-delete').forEach(b => b.style.display = p.delete ? 'inline-block' : 'none');
  document.querySelectorAll('.btn-stock-out').forEach(b => b.style.display = p.stockOut ? 'inline-block' : 'none');
}

/* =========================
   ‚úÖ AUTH UI
========================= */
function showSignup(){
  loginForm.style.display='none';
  signupForm.style.display='block';
  loginMsg.textContent='';
}
function showLogin(){
  loginForm.style.display='block';
  signupForm.style.display='none';
  signupMsg.textContent='';
}

async function signup(){
  const u = signupUser.value.trim();
  const p = signupPass.value;
  const role = signupRole.value;

  if(!u || !p){ signupMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(snap.exists()){ signupMsg.textContent="Username already taken"; return; }

    const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
    await cloudDB.ref('users/'+userId).set({
      username:u,
      password:p,
      role,
      permissionLevel:'view',
      createdAt:new Date().toISOString()
    });

    signupMsg.style.color="green";
    signupMsg.textContent="Account created! Please login.";
    showLogin();
  }catch(err){
    console.error(err);
    signupMsg.textContent="Signup failed";
  }
}

async function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value;

  if(!u || !p){ loginMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(!snap.exists()){ loginMsg.textContent="Invalid login"; return; }

    const userData = Object.values(snap.val())[0];
    if(userData.password !== p){ loginMsg.textContent="Invalid login"; return; }

    currentUser = userData;
    localStorage.setItem('sms_currentUser', JSON.stringify(currentUser));

    loginScreen.style.display='none';
    document.querySelector('.app').style.display='flex';

    applyPermissions();

    // ‚úÖ open pages
    if(currentUser.role === 'admin'){
      openPage('userManagement');
      renderUsersTable();
    }else{
      openPage('dashboardPage');
    }

  }catch(err){
    console.error(err);
    loginMsg.textContent="Login failed";
  }
}

function logout(){
  localStorage.removeItem('sms_currentUser');
  location.reload();
}

async function forgotPassword(){
  const username = prompt("Enter your username to reset password:");
  if(!username || !username.trim()) return;

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username.trim()).once('value');
    if(!snap.exists()){ alert("Username not found"); return; }

    const userId = Object.keys(snap.val())[0];
    const userData = snap.val()[userId];

    const newPass = prompt(`Enter new password for "${userData.username}":`);
    if(!newPass || !newPass.trim()) return alert("Password cannot be empty");

    await cloudDB.ref('users/'+userId+'/password').set(newPass.trim());
    alert("Password reset success. Login with new password.");
  }catch(err){
    console.error(err);
    alert("Failed to reset password");
  }
}

/* =========================
   ‚úÖ USER MANAGEMENT
========================= */
function changeUserPermission(username, level){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can change roles", true);
    return;
  }
  if(username === 'admin'){
    showToast("Admin permission cannot be changed", true);
    return;
  }

  cloudDB.ref('users').orderByChild('username').equalTo(username).once('value')
    .then(snap=>{
      if(!snap.exists()) return;
      const userId = Object.keys(snap.val())[0];
      cloudDB.ref('users/'+userId+'/permissionLevel').set(level);
      showToast("User permission updated ‚úÖ");
    });
}

async function deleteUser(username){
  if(!confirm(`Delete "${username}"?`)) return;

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
    if(!snap.exists()) return alert("User not found");

    const userId = Object.keys(snap.val())[0];
    const userData = snap.val()[userId];
    if(userData.role === 'admin') return alert("Cannot delete admin");

    await cloudDB.ref('users/'+userId).remove();
    showToast("User deleted ‚úÖ");
    renderUsersTable();
  }catch(err){
    console.error(err);
    alert("Failed to delete user");
  }
}

async function renderUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  if(!tbody) return;

  tbody.innerHTML = '';
  const snap = await cloudDB.ref('users').once('value');
  const users = snap.val() ? Object.values(snap.val()) : [];

  users.forEach((u,i)=>{
    const perm = u.permissionLevel || 'view';
    const isAdminRow = (u.role === 'admin' || u.username === 'admin');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(u.username)}</td>
      <td>
        ${
          isAdminRow
            ? `<b>Full (Admin)</b>`
            : (currentUser?.role === 'admin'
                ? `
                  <select onchange="changeUserPermission('${escapeHtml(u.username)}', this.value)">
                    <option value="full" ${perm==='full'?'selected':''}>Full</option>
                    <option value="half" ${perm==='half'?'selected':''}>Half</option>
                    <option value="view" ${perm==='view'?'selected':''}>View</option>
                  </select>
                `
                : escapeHtml(perm)
              )
        }
      </td>
      <td>
        ${
          (!isAdminRow && currentUser?.role === 'admin')
            ? `<button class="btn out" onclick="deleteUser('${escapeHtml(u.username)}')">Delete</button>`
            : ''
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function addUser(){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can add users", true);
    return;
  }

  const u = (document.getElementById('newUsername')?.value || '').trim();
  const p = (document.getElementById('newPassword')?.value || '');
  const role = (document.getElementById('newRole')?.value || 'user');

  if(!u || !p){ showToast("Username & password required", true); return; }

  const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
  if(snap.exists()){ showToast("Username already exists", true); return; }

  const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
  await cloudDB.ref('users/'+userId).set({
    username: u,
    password: p,
    role,
    permissionLevel: (role === 'admin' ? 'full' : 'view'),
    createdAt: new Date().toISOString()
  });

  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('newRole').value = 'user';

  showToast("User added ‚úÖ");
  renderUsersTable();
}

/* =========================
   ‚úÖ LOCAL STORAGE DATA (RM)
========================= */
const KEY_PRODUCTS = 'sms_products_final_v1';
const KEY_MOVES    = 'sms_movements_final_v1';

let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
let stockMovements = JSON.parse(localStorage.getItem(KEY_MOVES) || '[]');

function saveAll(){
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements));
}

function computeBalance(productId){
  let bal=0;
  stockMovements.forEach(m=>{
    if(m.productId===productId) bal += (m.type==='IN' ? Number(m.quantity||0) : -Number(m.quantity||0));
  });
  return bal>0 ? bal : 0;
}

function lastMovement(productId, type){
  const moves = stockMovements.filter(m=>m.productId===productId && m.type===type);
  if(!moves.length) return '-';
  return moves[moves.length-1].date || '-';
}

/* =========================
   ‚úÖ FG DATA
========================= */
let fgProducts  = JSON.parse(localStorage.getItem('sms_fg_products') || '[]');
let fgMovements = JSON.parse(localStorage.getItem('sms_fg_movements') || '[]');

function saveFGLocal(){
  localStorage.setItem('sms_fg_products', JSON.stringify(fgProducts));
  localStorage.setItem('sms_fg_movements', JSON.stringify(fgMovements));
}

function computeFGBalance(fgId){
  return fgMovements.reduce((sum,m)=>{
    if(m.fgId===fgId){
      return sum + (m.type==='IN'? Number(m.qty||0) : -Number(m.qty||0));
    }
    return sum;
  },0);
}

function initFGVolumeSelection(){
  if(selectedFGVolumes.size) return;
  fgProducts.forEach(f=>{
    const v = (f.volume||'').trim();
    if(v) selectedFGVolumes.add(v);
  });
}

/* =========================
   ‚úÖ DASHBOARD (MAIN CARDS)
========================= */
function getFGLowStockCount(){
  return fgProducts.filter(f => computeFGBalance(f.id) <= (Number(f.threshold ?? 5))).length;
}

function renderMainDashboard(){
  const totalProductsEl = document.getElementById('dashTotalProducts');
  const totalStockEl    = document.getElementById('dashTotalStock');
  const lowStockEl      = document.getElementById('dashLowStock');
  const fgBalanceEl     = document.getElementById('dashFGBalance');

  const fgTotalEl       = document.getElementById('dashFGTotalProducts');
  const fgLowEl         = document.getElementById('dashFGLowStock');
  const fgMaxEl         = document.getElementById('dashFGMaxBalance');
  const fgMinEl         = document.getElementById('dashFGMinBalance');

  if(!totalProductsEl || !totalStockEl || !lowStockEl || !fgBalanceEl) return;

  // RM
  totalProductsEl.textContent = products.length;

  let totalStock = 0;
  let lowStock = 0;
  products.forEach(p=>{
    const bal = computeBalance(p.id);
    totalStock += Number(bal)||0;
    if((Number(bal)||0) <= (Number(p.threshold ?? 5))) lowStock++;
  });

  totalStockEl.textContent = totalStock;
  lowStockEl.textContent = lowStock;

  // FG
  const fgTotal = fgProducts.reduce((sum,f)=> sum + computeFGBalance(f.id), 0);
  fgBalanceEl.textContent = fgTotal;

  if(fgTotalEl) fgTotalEl.textContent = fgProducts.length;
  if(fgLowEl) fgLowEl.textContent = getFGLowStockCount();

  if(fgMaxEl){
    const maxFG = fgProducts.reduce((max, f)=>{
      const bal = computeFGBalance(f.id);
      return (bal > max.balance) ? {name:f.name, balance:bal} : max;
    }, {name:'-', balance:-Infinity});
    fgMaxEl.textContent = (maxFG.balance === -Infinity) ? '-' : `${maxFG.name} (${maxFG.balance})`;
  }

  if(fgMinEl){
    const minFG = fgProducts.reduce((min, f)=>{
      const bal = computeFGBalance(f.id);
      return (bal < min.balance) ? {name:f.name, balance:bal} : min;
    }, {name:'-', balance:Infinity});
    fgMinEl.textContent = (minFG.balance === Infinity) ? '-' : `${minFG.name} (${minFG.balance})`;
  }
}

/* =========================
   ‚úÖ FG FILTER + CHART
========================= */
function renderFGVolumeFilter(){
  const wrap = document.getElementById('fgVolumeFilter');
  if(!wrap) return;

  const volumes = [...new Set(fgProducts.map(f=>(f.volume||'').trim()).filter(v=>v))].sort();
  wrap.innerHTML = '';

  // if nothing selected, select all
  if(!selectedFGVolumes.size){
    volumes.forEach(v=> selectedFGVolumes.add(v));
  }

  volumes.forEach(vol=>{
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems='center';
    label.style.gap='4px';
    label.style.cursor='pointer';

    const checked = selectedFGVolumes.has(vol);

    label.innerHTML = `
      <input type="checkbox" ${checked ? 'checked':''}>
      ${escapeHtml(vol)}
    `;

    label.querySelector('input').onchange = e=>{
      if(e.target.checked) selectedFGVolumes.add(vol);
      else selectedFGVolumes.delete(vol);

      // if user unchecks all -> auto select all again
      if(!selectedFGVolumes.size){
        volumes.forEach(v=> selectedFGVolumes.add(v));
        renderFGVolumeFilter();
      }
      renderFGChart();
    };

    wrap.appendChild(label);
  });
}

function renderFGChart(){
  const canvas = document.getElementById('fgStockChart');
  if(!canvas) return;

  const filteredFG = fgProducts.filter(f => selectedFGVolumes.has((f.volume||'').trim()));
  const labels = filteredFG.map(f => (f.name||'').length>12 ? f.name.slice(0,12)+'‚Ä¶' : f.name);
  const data   = filteredFG.map(f => computeFGBalance(f.id));

  if(fgChartInstance) fgChartInstance.destroy();
  if(!filteredFG.length) return;

  fgChartInstance = new Chart(canvas, {
    type:'bar',
    data:{ labels, datasets:[{ data, borderRadius:8, barThickness:22, backgroundColor:'rgba(41,128,185,0.65)' }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            title:(items)=> filteredFG[items[0].dataIndex].name,
            label:(ctx)=> `Balance: ${ctx.raw}`
          }
        }
      },
      scales:{ x:{ grid:{display:false} }, y:{ beginAtZero:true } }
    }
  });
}

/* =========================
   ‚úÖ FG PAGES (with LOW filter from dashboard)
========================= */
let fgOnlyLow = false;

function openFGFromDashboard(){ fgOnlyLow = false; openPage('fgStock'); }
function openLowFGFromDashboard(){ fgOnlyLow = true; openPage('fgStock'); }

function renderFGStock(){
  const tbody = document.querySelector('#fgTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;

    const bal = computeFGBalance(p.id);
    const thr = Number(p.threshold ?? 5);

    if(fgOnlyLow && !(bal <= thr)) return;

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.volume||'-')}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${bal}</td>
        <td>
          <button class="btn info" onclick="viewFGHistory('${p.id}')">üëÅ View</button>
          ${currentUser?.role === 'admin' ? `
            <button class="btn secondary btn-edit" onclick="editFGProduct('${p.id}')">‚úèÔ∏è Edit</button>
            <button class="btn out btn-delete" onclick="deleteFGProduct('${p.id}')">üóë Delete</button>
          `:''}
        </td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderFGStockIn(){
  const tbody = document.getElementById('fgStockInBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgInSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn" onclick="openFGModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}

function renderFGStockOut(){
  const tbody = document.getElementById('fgStockOutBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('fgOutSearch')?.value || '').toLowerCase().trim();
  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn out btn-stock-out" onclick="openFGModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function viewFGHistory(fgId){
  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  const modal = document.getElementById('historyModal');
  modal.style.display='flex';
  document.getElementById('modalTitle').textContent = `FG History ‚Äî ${fg.name}`;

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML='';

  fgMovements
    .filter(m=>m.fgId===fgId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.qty||0)}</td>
          <td>${escapeHtml(m.batch||fg.batch||'-')}</td>
          <td>${escapeHtml(m.expiry||fg.expiry||'-')}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
/* =========================
   ‚úÖ BILL OF ENTRY (BOE)
   - Bills create RM Stock IN automatically
   - Edit bill = revert old linked stock IN + re-post
   - Import Excel = bulk create bills + stock IN
   - Print = PDF for single bill + summary report
========================= */
const KEY_BILLS = 'sms_bills_v1';
let bills = JSON.parse(localStorage.getItem(KEY_BILLS) || '[]');

let boeEditingId = null;     // ‚úÖ editing mode
let boeLastViewedId = null;  // ‚úÖ used by view modal buttons

function saveBills(){
  localStorage.setItem(KEY_BILLS, JSON.stringify(bills));
}

function canStockIn(){
  if(currentUser?.role === 'admin') return true;
  const perms = (typeof getPerms === 'function') ? getPerms() : { stockIn:true };
  return !!perms.stockIn;
}

function resetBillEntryForm(){
  boeEditingId = null;
  const badge = document.getElementById('boeEditBadge');
  if(badge) badge.style.display = 'none';

  const no = document.getElementById('boeNo');
  const dt = document.getElementById('boeDate');
  const sp = document.getElementById('boeSupplier');
  const other = document.getElementById('boeSupplierOther');
  const body = document.getElementById('boeItemsBody');

  if(no) no.value = '';
  if(dt) dt.value = todayISO();
  if(sp) sp.value = '';
  if(other){ other.value=''; other.style.display='none'; }
  if(body) body.innerHTML = '';

  boeAddRow();
}

function boeSupplierDisplayName(){
  const sp = document.getElementById('boeSupplier');
  const other = document.getElementById('boeSupplierOther');
  if(!sp) return '';
  const val = sp.value;

  if(val === '__OTHER__'){
    return (other?.value || '').trim();
  }

  // suppliers may or may not exist in your file
  const list = (window.suppliers && Array.isArray(window.suppliers)) ? window.suppliers : [];
  const s = list.find(x => x.id === val);
  return (s?.name || val || '').trim();
}

function renderBOESupplierDropdown(){
  const sel = document.getElementById('boeSupplier');
  const other = document.getElementById('boeSupplierOther');
  if(!sel) return;

  const list = (window.suppliers && Array.isArray(window.suppliers)) ? window.suppliers : [];
  sel.innerHTML = `<option value="">Select Supplier</option>`;

  list.forEach(s=>{
    sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)}</option>`);
  });

  sel.insertAdjacentHTML('beforeend', `<option value="__OTHER__">Other...</option>`);

  sel.onchange = ()=>{
    if(!other) return;
    if(sel.value === '__OTHER__'){
      other.style.display = '';
      other.focus();
    }else{
      other.style.display = 'none';
      other.value = '';
    }
  };
}

function boeRowProductOptions(selectedId=''){
  if(!Array.isArray(products) || !products.length){
    return `<option value="">No RM products found</option>`;
  }
  const sorted = [...products].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  return `<option value="">Select RM Product</option>` + sorted.map(p=>{
    const sel = p.id === selectedId ? 'selected' : '';
    const code = p.code ? `(${p.code}) ` : '';
    return `<option ${sel} value="${escapeHtml(p.id)}">${escapeHtml(code + (p.name||''))}</option>`;
  }).join('');
}

function boeAddRow(prefill=null){
  const body = document.getElementById('boeItemsBody');
  if(!body) return;

  const rowId = 'boeRow_' + genId();
  const selectedProductId = prefill?.productId || '';
  const qty = prefill?.qty ?? '';
  const remark = prefill?.remark ?? '';

  body.insertAdjacentHTML('beforeend', `
    <tr id="${rowId}">
      <td>
        <select class="small" style="width:100%" data-boe="product">
          ${boeRowProductOptions(selectedProductId)}
        </select>
      </td>
      <td>
        <input class="small" type="number" min="0" step="1" style="width:100%" data-boe="qty" value="${escapeHtml(qty)}">
      </td>
      <td>
        <input class="small" style="width:100%" data-boe="remark" value="${escapeHtml(remark)}" placeholder="Remark (optional)">
      </td>
      <td style="text-align:center">
        <button class="btn out" style="padding:6px 10px" onclick="boeRemoveRow('${rowId}')">X</button>
      </td>
    </tr>
  `);
}

function boeRemoveRow(rowId){
  const tr = document.getElementById(rowId);
  if(tr) tr.remove();

  const body = document.getElementById('boeItemsBody');
  if(body && body.children.length === 0){
    boeAddRow();
  }
}

function getBOEItemsFromUI(){
  const body = document.getElementById('boeItemsBody');
  if(!body) return [];

  const items = [];
  [...body.querySelectorAll('tr')].forEach(tr=>{
    const prodSel = tr.querySelector('[data-boe="product"]');
    const qtyInp  = tr.querySelector('[data-boe="qty"]');
    const remInp  = tr.querySelector('[data-boe="remark"]');

    const productId = (prodSel?.value || '').trim();
    const qty = Number(qtyInp?.value || 0);
    const remark = (remInp?.value || '').trim();

    if(productId && qty > 0){
      items.push({ productId, qty, remark });
    }
  });

  return items;
}

function revertBillLinkedStock(billId){
  // remove all movements linked to this bill
  stockMovements = stockMovements.filter(m => m.billId !== billId);
}

function postBillStock(bill){
  (bill.items || []).forEach(it=>{
    stockMovements.push({
      id: genId(),
      productId: it.productId,
      type: 'IN',
      quantity: Number(it.qty || 0),
      date: bill.date,
      remark: `BOE ${bill.billNo}${it.remark ? ' - ' + it.remark : ''}`,
      billId: bill.id
    });
  });
}

function submitBillEntry(){
  if(!canStockIn()){
    showToast("Stock IN not allowed for your role", true);
    return;
  }

  const billNo = (document.getElementById('boeNo')?.value || '').trim();
  const billDate = (document.getElementById('boeDate')?.value || todayISO());
  const supplierId = (document.getElementById('boeSupplier')?.value || '').trim();
  const supplierName = boeSupplierDisplayName();

  if(!billNo){ showToast("Bill No is required", true); return; }
  if(!billDate){ showToast("Bill Date is required", true); return; }
  if(!supplierId){ showToast("Select supplier (or Other)", true); return; }
  if(supplierId === '__OTHER__' && !supplierName){ showToast("Enter supplier name", true); return; }

  const items = getBOEItemsFromUI();
  if(!items.length){ showToast("Add at least 1 item with qty > 0", true); return; }

  // ‚úÖ EDIT MODE
  if(boeEditingId){
    const idx = bills.findIndex(b=>b.id === boeEditingId);
    if(idx === -1){
      showToast("Bill not found (edit)", true);
      boeEditingId = null;
      return;
    }

    const old = bills[idx];

    // revert old stock movements
    revertBillLinkedStock(old.id);

    // update bill
    const updated = {
      ...old,
      billNo,
      date: billDate,
      supplierId,
      supplierName,
      items,
      updatedAt: new Date().toISOString(),
      updatedBy: currentUser?.username || ''
    };

    bills[idx] = updated;
    saveBills();

    // post new stock
    postBillStock(updated);

    saveAll();
    autoPushToCloud?.();
    refreshAll();

    showToast("Bill updated & stock re-posted ‚úÖ");
    resetBillEntryForm();
    renderBillsTable();
    return;
  }

  // ‚úÖ CREATE MODE
  const billId = 'boe_' + genId();
  const bill = {
    id: billId,
    billNo,
    date: billDate,
    supplierId,
    supplierName,
    items,
    createdAt: new Date().toISOString(),
    createdBy: currentUser?.username || ''
  };

  bills.push(bill);
  saveBills();

  postBillStock(bill);

  saveAll();
  autoPushToCloud?.();
  refreshAll();

  showToast("Bill saved & Stock IN created ‚úÖ");
  resetBillEntryForm();
  renderBillsTable();
}

function boeTotalQty(bill){
  return (bill.items || []).reduce((s,it)=> s + Number(it.qty||0), 0);
}

function renderBillsTable(){
  const tbody = document.querySelector('#boeTable tbody');
  if(!tbody) return;

  const q = (document.getElementById('boeSearch')?.value || '').toLowerCase().trim();
  tbody.innerHTML = '';

  const list = [...bills].sort((a,b)=> new Date(b.date) - new Date(a.date));

  list.forEach(b=>{
    const match =
      !q ||
      (b.billNo||'').toLowerCase().includes(q) ||
      (b.supplierName||'').toLowerCase().includes(q);

    if(!match) return;

    const total = boeTotalQty(b);
    const itemsCount = (b.items || []).length;

    const isAdmin = (currentUser?.role === 'admin');

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${fmtDate(b.date)}</td>
        <td>${escapeHtml(b.billNo)}</td>
        <td>${escapeHtml(b.supplierName || '')}</td>
        <td>${total}</td>
        <td>${itemsCount}</td>
        <td>
          <button class="btn info" onclick="viewBOE('${escapeHtml(b.id)}')">View</button>
          <button class="btn secondary" onclick="printBOE('${escapeHtml(b.id)}')">Print</button>
          ${isAdmin ? `<button class="btn secondary" onclick="openBOEForEdit('${escapeHtml(b.id)}')">Edit</button>` : ``}
          ${isAdmin ? `<button class="btn out" onclick="deleteBOE('${escapeHtml(b.id)}')">Delete</button>` : ``}
        </td>
      </tr>
    `);
  });

  applyPermissions?.();
}

function viewBOE(billId){
  const b = bills.find(x=>x.id===billId);
  if(!b) return;

  boeLastViewedId = billId;

  document.getElementById('boeViewTitle').textContent = `Bill of Entry ‚Äî ${b.billNo}`;
  document.getElementById('boeViewMeta').innerHTML =
    `<b>Date:</b> ${fmtDate(b.date)} &nbsp; | &nbsp; <b>Supplier:</b> ${escapeHtml(b.supplierName||'')}
     ${b.createdBy ? ` &nbsp; | &nbsp; <b>By:</b> ${escapeHtml(b.createdBy)}` : ''}`;

  const body = document.getElementById('boeViewBody');
  body.innerHTML = '';

  (b.items || []).forEach(it=>{
    const p = products.find(x=>x.id===it.productId);
    body.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(p?.name || 'Unknown')}</td>
        <td>${Number(it.qty||0)}</td>
        <td>${escapeHtml(it.remark||'')}</td>
      </tr>
    `);
  });

  document.getElementById('boeViewModal').style.display = 'flex';
}
function closeBOEView(){
  document.getElementById('boeViewModal').style.display = 'none';
}
function printBOEFromView(){
  if(!boeLastViewedId) return;
  printBOE(boeLastViewedId);
}
function editBOEFromView(){
  if(!boeLastViewedId) return;
  openBOEForEdit(boeLastViewedId);
  closeBOEView();
}

function openBOEForEdit(billId){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can edit bills", true);
    return;
  }

  const b = bills.find(x=>x.id===billId);
  if(!b) return;

  // go to BOE page
  openPage('billEntry');

  boeEditingId = billId;
  const badge = document.getElementById('boeEditBadge');
  if(badge) badge.style.display = '';

  document.getElementById('boeNo').value = b.billNo || '';
  document.getElementById('boeDate').value = b.date || todayISO();

  renderBOESupplierDropdown();
  const supplierSel = document.getElementById('boeSupplier');
  const other = document.getElementById('boeSupplierOther');

  if(supplierSel){
    // try set supplierId; if not exist, fallback to OTHER
    const hasOption = [...supplierSel.options].some(o => o.value === b.supplierId);
    if(hasOption){
      supplierSel.value = b.supplierId;
      if(other){ other.style.display='none'; other.value=''; }
    }else{
      supplierSel.value = '__OTHER__';
      if(other){
        other.style.display='';
        other.value = b.supplierName || '';
      }
    }
    supplierSel.dispatchEvent(new Event('change'));
  }

  const body = document.getElementById('boeItemsBody');
  body.innerHTML = '';
  (b.items || []).forEach(it=>{
    boeAddRow({ productId: it.productId, qty: it.qty, remark: it.remark });
  });
  if(!body.children.length) boeAddRow();

  showToast("Editing BOE ‚Äî update and Save ‚úÖ");
}

function deleteBOE(billId){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can delete bills", true);
    return;
  }

  const b = bills.find(x=>x.id===billId);
  if(!b) return;

  if(!confirm(`Delete BOE "${b.billNo}"?\nThis will also remove linked RM Stock IN movements.`)) return;

  bills = bills.filter(x=>x.id!==billId);
  saveBills();

  revertBillLinkedStock(billId);

  saveAll();
  autoPushToCloud?.();
  refreshAll();

  showToast("Bill deleted & stock reverted ‚úÖ");
}

/* =========================
   ‚úÖ PRINT PDF
========================= */
function printBOE(billId){
  const b = bills.find(x=>x.id===billId);
  if(!b){ showToast("Bill not found", true); return; }

  const { jsPDF } = window.jspdf || {};
  if(!jsPDF){ alert("jsPDF not loaded"); return; }

  const doc = new jsPDF({ unit:'pt', format:'a4' });

  doc.setFontSize(14);
  doc.text(`Bill of Entry: ${b.billNo}`, 40, 50);
  doc.setFontSize(10);
  doc.text(`Date: ${fmtDate(b.date)}   Supplier: ${b.supplierName || ''}`, 40, 70);

  const rows = (b.items || []).map(it=>{
    const p = products.find(x=>x.id===it.productId);
    return [
      p?.code || '',
      p?.name || 'Unknown',
      String(it.qty || 0),
      it.remark || ''
    ];
  });

  doc.autoTable({
    startY: 90,
    head: [['Code','Product','Qty','Remark']],
    body: rows,
    styles: { fontSize: 9, cellPadding: 4 },
    headStyles: { fillColor: [0,123,255] }
  });

  const total = boeTotalQty(b);
  const y = doc.lastAutoTable.finalY + 18;
  doc.setFontSize(11);
  doc.text(`Total Qty: ${total}`, 40, y);

  doc.save(`BOE_${b.billNo}.pdf`);
}

function printBOESummaryReport(){
  const { jsPDF } = window.jspdf || {};
  if(!jsPDF){ alert("jsPDF not loaded"); return; }

  const doc = new jsPDF({ unit:'pt', format:'a4' });

  doc.setFontSize(14);
  doc.text("BOE Summary Report", 40, 50);

  const list = [...bills].sort((a,b)=> new Date(b.date) - new Date(a.date));
  const rows = list.map(b=>[
    fmtDate(b.date),
    b.billNo || '',
    b.supplierName || '',
    String((b.items || []).length),
    String(boeTotalQty(b))
  ]);

  doc.autoTable({
    startY: 70,
    head: [['Date','Bill No','Supplier','Items','Total Qty']],
    body: rows,
    styles: { fontSize: 9, cellPadding: 4 },
    headStyles: { fillColor: [0,123,255] }
  });

  doc.save(`BOE_Summary.pdf`);
}

/* =========================
   ‚úÖ IMPORT EXCEL
   Expected columns (any order):
   BillNo, Date, Supplier, Product, Qty, Remark
   Product can be product Code or Name
========================= */
function boeTriggerImport(){
  const inp = document.getElementById('boeFileInput');
  if(!inp) return;
  inp.value = '';
  inp.click();
}

function parseExcelDateToISO(v){
  // excel can be number serial, Date, or string
  if(v instanceof Date && !isNaN(v)) return v.toISOString().split('T')[0];

  if(typeof v === 'number' && isFinite(v)){
    // Excel serial date -> JS date (1900 system)
    const d = new Date(Date.UTC(1899, 11, 30) + v * 86400000);
    return d.toISOString().split('T')[0];
  }

  const s = String(v || '').trim();
  if(!s) return '';

  const d2 = new Date(s);
  if(!isNaN(d2)) return d2.toISOString().split('T')[0];

  // try dd/mm/yyyy
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m){
    const dd = String(m[1]).padStart(2,'0');
    const mm = String(m[2]).padStart(2,'0');
    const yy = m[3];
    return `${yy}-${mm}-${dd}`;
  }

  return '';
}

function findProductIdByCodeOrName(val){
  const s = String(val || '').trim().toLowerCase();
  if(!s) return '';

  // match by code first
  let p = products.find(x => String(x.code||'').trim().toLowerCase() === s);
  if(p) return p.id;

  // then name
  p = products.find(x => String(x.name||'').trim().toLowerCase() === s);
  if(p) return p.id;

  // contains match
  p = products.find(x => String(x.name||'').toLowerCase().includes(s));
  return p ? p.id : '';
}

async function importBOEFromExcel(file){
  if(!file) return;
  if(!window.XLSX){ alert("XLSX not loaded"); return; }

  try{
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type:'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { defval:'', raw:true });

    if(!json.length){
      showToast("Excel is empty", true);
      return;
    }

    // normalize column names
    const rows = json.map(r=>{
      const obj = {};
      Object.keys(r).forEach(k=>{
        obj[String(k).trim().toLowerCase()] = r[k];
      });
      return obj;
    });

    // group by billno+date+supplier
    const groups = new Map();
    const unmatched = [];

    rows.forEach((r, idx)=>{
      const billNo = String(r.billno ?? r['bill no'] ?? r.entryno ?? r['entry no'] ?? '').trim();
      const dtRaw  = r.date ?? r['billdate'] ?? r['bill date'] ?? '';
      const dateISO = parseExcelDateToISO(dtRaw) || todayISO();

      const supplier = String(r.supplier ?? r['suppliername'] ?? r['supplier name'] ?? '').trim();

      const prodVal = r.product ?? r['productname'] ?? r['product name'] ?? r.code ?? r['productcode'] ?? r['product code'] ?? '';
      const qty = Number(r.qty ?? r.quantity ?? 0);
      const remark = String(r.remark ?? r.notes ?? '').trim();

      if(!billNo || !supplier || !prodVal || !(qty > 0)){
        // skip invalid row
        return;
      }

      const productId = findProductIdByCodeOrName(prodVal);
      if(!productId){
        unmatched.push({ row: idx+2, product: String(prodVal), billNo });
        return;
      }

      const key = `${billNo}__${dateISO}__${supplier}`;
      if(!groups.has(key)){
        groups.set(key, {
          billNo,
          date: dateISO,
          supplierName: supplier,
          supplierId: '__OTHER__',
          items: []
        });
      }

      groups.get(key).items.push({ productId, qty, remark });
    });

    if(!groups.size){
      showToast("No valid BOE rows found", true);
      return;
    }

    // create bills + post stock
    const createdIds = [];
    groups.forEach(g=>{
      const billId = 'boe_' + genId();
      const bill = {
        id: billId,
        billNo: g.billNo,
        date: g.date,
        supplierId: g.supplierId,
        supplierName: g.supplierName,
        items: g.items,
        createdAt: new Date().toISOString(),
        createdBy: currentUser?.username || ''
      };

      bills.push(bill);
      createdIds.push(billId);
      postBillStock(bill);
    });

    saveBills();
    saveAll();
    autoPushToCloud?.();
    refreshAll();
    renderBillsTable();

    if(unmatched.length){
      console.warn("Unmatched products:", unmatched);
      showToast(`Imported ‚úÖ (Unmatched: ${unmatched.length}, check console)`, false);
    }else{
      showToast(`Imported ‚úÖ (${createdIds.length} bills)`, false);
    }

  }catch(err){
    console.error(err);
    showToast("Import failed", true);
  }
}

// hook file input
(function initBOEImport(){
  const inp = document.getElementById('boeFileInput');
  if(!inp) return;
  inp.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    importBOEFromExcel(f);
  });
})();


/* =========================
   ‚úÖ PRODUCTION ENTRY
   - Creates FG IN + optional RM OUT
========================= */
const KEY_PRODUCTIONS = 'sms_productions_v1';
let productions = JSON.parse(localStorage.getItem(KEY_PRODUCTIONS) || '[]');

function saveProductions(){
  localStorage.setItem(KEY_PRODUCTIONS, JSON.stringify(productions));
}

function renderProdFGDropdown(){
  const sel = document.getElementById('prodFG');
  if(!sel) return;

  if(!Array.isArray(fgProducts) || !fgProducts.length){
    sel.innerHTML = `<option value="">No FG products found</option>`;
    return;
  }

  const sorted = [...fgProducts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  sel.innerHTML = `<option value="">Select FG Product</option>` +
    sorted.map(f=>{
      const vol = f.volume ? ` - ${f.volume}` : '';
      return `<option value="${escapeHtml(f.id)}">${escapeHtml((f.name||'') + vol)}</option>`;
    }).join('');
}

function prodRMOptions(selectedId=''){
  if(!Array.isArray(products) || !products.length){
    return `<option value="">No RM products found</option>`;
  }
  const sorted = [...products].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  return `<option value="">Select RM Product</option>` + sorted.map(p=>{
    const sel = p.id === selectedId ? 'selected' : '';
    const code = p.code ? `(${p.code}) ` : '';
    return `<option ${sel} value="${escapeHtml(p.id)}">${escapeHtml(code + (p.name||''))}</option>`;
  }).join('');
}

function prodAddRMRow(prefill=null){
  const body = document.getElementById('prodRMBody');
  if(!body) return;

  const rowId = 'prodRow_' + genId();
  const selectedProductId = prefill?.productId || '';
  const qty = prefill?.qty ?? '';
  const remark = prefill?.remark ?? '';

  body.insertAdjacentHTML('beforeend', `
    <tr id="${rowId}">
      <td>
        <select class="small" style="width:100%" data-prod="rmProduct">
          ${prodRMOptions(selectedProductId)}
        </select>
      </td>
      <td>
        <input class="small" type="number" min="0" step="1" style="width:100%" data-prod="rmQty" value="${escapeHtml(qty)}">
      </td>
      <td>
        <input class="small" style="width:100%" data-prod="rmRemark" value="${escapeHtml(remark)}" placeholder="Remark (optional)">
      </td>
      <td style="text-align:center">
        <button class="btn out" style="padding:6px 10px" onclick="prodRemoveRMRow('${rowId}')">X</button>
      </td>
    </tr>
  `);
}

function prodRemoveRMRow(rowId){
  const tr = document.getElementById(rowId);
  if(tr) tr.remove();

  const body = document.getElementById('prodRMBody');
  if(body && body.children.length === 0){
    prodAddRMRow(); // keep at least one row
  }
}

function getProdRMItemsFromUI(){
  const body = document.getElementById('prodRMBody');
  if(!body) return [];

  const items = [];
  [...body.querySelectorAll('tr')].forEach(tr=>{
    const prodSel = tr.querySelector('[data-prod="rmProduct"]');
    const qtyInp  = tr.querySelector('[data-prod="rmQty"]');
    const remInp  = tr.querySelector('[data-prod="rmRemark"]');

    const productId = (prodSel?.value || '').trim();
    const qty = Number(qtyInp?.value || 0);
    const remark = (remInp?.value || '').trim();

    if(productId && qty > 0){
      items.push({ productId, qty, remark });
    }
  });

  return items;
}

function resetProductionForm(){
  const no = document.getElementById('prodNo');
  const dt = document.getElementById('prodDate');
  const fg = document.getElementById('prodFG');
  const fgQty = document.getElementById('prodFGQty');
  const rem = document.getElementById('prodRemark');

  const usedBody = document.getElementById('prodRMBody');
  const retBody  = document.getElementById('prodRMReturnBody');

  if(no) no.value = '';
  if(dt) dt.value = todayISO();
  if(fg) fg.value = '';
  if(fgQty) fgQty.value = '';
  if(rem) rem.value = '';

  if(usedBody) usedBody.innerHTML = '';
  if(retBody)  retBody.innerHTML  = '';

  prodAddRMRow();
  prodAddRMReturnRow();
}


function submitProduction(){
  if(!canAdd()){
    showToast("No permission to create production", true);
    return;
  }

  const prodNo = (document.getElementById('prodNo')?.value || '').trim();
  const prodDate = (document.getElementById('prodDate')?.value || todayISO());
  const fgId = (document.getElementById('prodFG')?.value || '').trim();
  const fgQty = Number(document.getElementById('prodFGQty')?.value || 0);
  const remark = (document.getElementById('prodRemark')?.value || '').trim();

  if(!prodNo){ showToast("Production No is required", true); return; }
  if(!prodDate){ showToast("Production Date is required", true); return; }
  if(!fgId){ showToast("Select FG product", true); return; }
  if(!(fgQty > 0)){ showToast("FG Qty must be > 0", true); return; }

  const fg = fgProducts.find(x=>x.id===fgId);
  if(!fg){ showToast("FG product not found", true); return; }

  const rmUsed = getProdRMItemsFromUI();         // OUT
  const rmReturn = getProdRMReturnFromUI();      // IN

  // ‚úÖ Validate based on NET OUT per RM product:
  // netOut = sum(used) - sum(return)
  // require netOut <= current balance (only if netOut is positive)
  const usedMap = {};
  rmUsed.forEach(it=>{
    usedMap[it.productId] = (usedMap[it.productId] || 0) + Number(it.qty||0);
  });

  const retMap = {};
  rmReturn.forEach(it=>{
    retMap[it.productId] = (retMap[it.productId] || 0) + Number(it.qty||0);
  });

  const allIds = new Set([...Object.keys(usedMap), ...Object.keys(retMap)]);
  for(const pid of allIds){
    const netOut = (usedMap[pid] || 0) - (retMap[pid] || 0);
    if(netOut > 0){
      const bal = computeBalance(pid);
      if(netOut > Number(bal||0)){
        const p = products.find(x=>x.id===pid);
        showToast(`RM NET usage exceeds balance: ${p?.name || 'RM'} (Bal ${bal})`, true);
        return;
      }
    }
  }

  const productionId = 'prod_' + genId();

  const entry = {
    id: productionId,
    prodNo,
    date: prodDate,
    fgId,
    fgName: fg.name || '',
    fgQty,
    remark,
    rmUsed,
    rmReturn,
    createdAt: new Date().toISOString(),
    createdBy: currentUser?.username || ''
  };

  productions.push(entry);
  saveProductions();

  // ‚úÖ FG IN movement
  fgMovements.push({
    id: genId(),
    fgId,
    type: 'IN',
    qty: fgQty,
    batch: fg.batch || '',
    expiry: fg.expiry || '',
    date: prodDate,
    remark: `PROD ${prodNo}${remark ? ' - ' + remark : ''}`,
    productionId
  });

  // ‚úÖ RM OUT movements (Used)
  rmUsed.forEach(it=>{
    stockMovements.push({
      id: genId(),
      productId: it.productId,
      type: 'OUT',
      quantity: Number(it.qty || 0),
      date: prodDate,
      remark: `PROD ${prodNo} - Used for ${fg.name}${it.remark ? ' - ' + it.remark : ''}`,
      productionId
    });
  });

  // ‚úÖ RM IN movements (Return)
  rmReturn.forEach(it=>{
    stockMovements.push({
      id: genId(),
      productId: it.productId,
      type: 'IN',
      quantity: Number(it.qty || 0),
      date: prodDate,
      remark: `PROD ${prodNo} - RM Return from ${fg.name}${it.remark ? ' - ' + it.remark : ''}`,
      productionId
    });
  });

  saveAll();
  saveFGLocal();

  autoPushToCloud?.();
  autoPushFGToCloud?.();

  refreshAll();
  showToast("Production saved ‚úÖ");
  resetProductionForm();
}


function renderProductionsTable(){
  const tbody = document.querySelector('#prodTable tbody');
  if(!tbody) return;

  const q = (document.getElementById('prodSearch')?.value || '').toLowerCase().trim();
  tbody.innerHTML = '';

  const list = [...productions].sort((a,b)=> new Date(b.date) - new Date(a.date));

  list.forEach(p=>{
    const match =
      !q ||
      (p.prodNo||'').toLowerCase().includes(q) ||
      (p.fgName||'').toLowerCase().includes(q);

    if(!match) return;

const rmLines = (p.rmUsed || []).length + (p.rmReturn || []).length;
    const canDel = (currentUser?.role === 'admin');

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${fmtDate(p.date)}</td>
        <td>${escapeHtml(p.prodNo)}</td>
        <td>${escapeHtml(p.fgName || '')}</td>
        <td>${Number(p.fgQty || 0)}</td>
        <td>${rmLines}</td>
        <td>
          <button class="btn info" onclick="viewProduction('${escapeHtml(p.id)}')">View</button>
          ${canDel ? `<button class="btn out" onclick="deleteProduction('${escapeHtml(p.id)}')">Delete</button>` : ``}
        </td>
      </tr>
    `);
  });

  applyPermissions?.();
}

function viewProduction(id){
  const p = productions.find(x=>x.id===id);
  if(!p) return;

  document.getElementById('prodViewTitle').textContent = `Production ‚Äî ${p.prodNo}`;
  document.getElementById('prodViewMeta').innerHTML =
    `<b>Date:</b> ${fmtDate(p.date)} &nbsp; | &nbsp; <b>FG:</b> ${escapeHtml(p.fgName||'')}
     ${p.createdBy ? ` &nbsp; | &nbsp; <b>By:</b> ${escapeHtml(p.createdBy)}` : '' }
     ${p.remark ? ` <br><b>Remark:</b> ${escapeHtml(p.remark)}` : '' }`;

  // FG body
  const fgBody = document.getElementById('prodViewFGBody');
  fgBody.innerHTML = `
    <tr>
      <td>${escapeHtml(p.fgName || '')}</td>
      <td>${Number(p.fgQty || 0)}</td>
      <td>${escapeHtml(p.remark || '')}</td>
    </tr>
  `;

  // RM body
// RM USED body
const rmBody = document.getElementById('prodViewRMBody');
rmBody.innerHTML = '';
if(!(p.rmUsed || []).length){
  rmBody.innerHTML = `<tr><td colspan="3">No RM consumption</td></tr>`;
}else{
  (p.rmUsed || []).forEach(it=>{
    const rm = products.find(x=>x.id===it.productId);
    rmBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(rm?.name || 'Unknown')}</td>
        <td>${Number(it.qty || 0)}</td>
        <td>${escapeHtml(it.remark || '')}</td>
      </tr>
    `);
  });
}

// RM RETURN body
const retBody = document.getElementById('prodViewRMReturnBody');
retBody.innerHTML = '';
if(!(p.rmReturn || []).length){
  retBody.innerHTML = `<tr><td colspan="3">No RM return</td></tr>`;
}else{
  (p.rmReturn || []).forEach(it=>{
    const rm = products.find(x=>x.id===it.productId);
    retBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(rm?.name || 'Unknown')}</td>
        <td>${Number(it.qty || 0)}</td>
        <td>${escapeHtml(it.remark || '')}</td>
      </tr>
    `);
  });
}
  document.getElementById('prodViewModal').style.display = 'flex';
}

function closeProdView(){
  document.getElementById('prodViewModal').style.display = 'none';
}

function deleteProduction(id){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can delete production", true);
    return;
  }

  const p = productions.find(x=>x.id===id);
  if(!p) return;

  if(!confirm(`Delete Production "${p.prodNo}"?\nThis will also remove linked FG/RM movements.`)) return;

  productions = productions.filter(x=>x.id !== id);
  saveProductions();

  // remove linked movements
  stockMovements = stockMovements.filter(m => m.productionId !== id);
  fgMovements = fgMovements.filter(m => m.productionId !== id);

  saveAll();
  saveFGLocal();

  autoPushToCloud?.();
  autoPushFGToCloud?.();

  refreshAll();
  showToast("Production deleted & stock reverted ‚úÖ");
}
function prodAddRMReturnRow(prefill=null){
  const body = document.getElementById('prodRMReturnBody');
  if(!body) return;

  const rowId = 'prodRetRow_' + genId();
  const selectedProductId = prefill?.productId || '';
  const qty = prefill?.qty ?? '';
  const remark = prefill?.remark ?? '';

  body.insertAdjacentHTML('beforeend', `
    <tr id="${rowId}">
      <td>
        <select class="small" style="width:100%" data-prod="retProduct">
          ${prodRMOptions(selectedProductId)}
        </select>
      </td>
      <td>
        <input class="small" type="number" min="0" step="1" style="width:100%" data-prod="retQty" value="${escapeHtml(qty)}">
      </td>
      <td>
        <input class="small" style="width:100%" data-prod="retRemark" value="${escapeHtml(remark)}" placeholder="Remark (optional)">
      </td>
      <td style="text-align:center">
        <button class="btn out" style="padding:6px 10px" onclick="prodRemoveRMReturnRow('${rowId}')">X</button>
      </td>
    </tr>
  `);
}

function prodRemoveRMReturnRow(rowId){
  const tr = document.getElementById(rowId);
  if(tr) tr.remove();

  const body = document.getElementById('prodRMReturnBody');
  if(body && body.children.length === 0){
    prodAddRMReturnRow();
  }
}

function getProdRMReturnFromUI(){
  const body = document.getElementById('prodRMReturnBody');
  if(!body) return [];

  const items = [];
  [...body.querySelectorAll('tr')].forEach(tr=>{
    const prodSel = tr.querySelector('[data-prod="retProduct"]');
    const qtyInp  = tr.querySelector('[data-prod="retQty"]');
    const remInp  = tr.querySelector('[data-prod="retRemark"]');

    const productId = (prodSel?.value || '').trim();
    const qty = Number(qtyInp?.value || 0);
    const remark = (remInp?.value || '').trim();

    if(productId && qty > 0){
      items.push({ productId, qty, remark });
    }
  });

  return items;
}

/* =========================
   ‚úÖ RM DELIVERY NOTE (DN)
========================= */
const KEY_DN = 'sms_delivery_notes_v1';
let deliveryNotes = JSON.parse(localStorage.getItem(KEY_DN) || '[]');

function saveDeliveryNotes(){
  localStorage.setItem(KEY_DN, JSON.stringify(deliveryNotes));
}

function resetDeliveryNoteForm(){
  const no = document.getElementById('dnNo');
  const dt = document.getElementById('dnDate');
  const from = document.getElementById('dnFrom');
  const to = document.getElementById('dnTo');
  const pref = document.getElementById('dnProdRef');
  const rem = document.getElementById('dnRemark');
  const body = document.getElementById('dnItemsBody');

  if(no) no.value = '';
  if(dt) dt.value = todayISO();
  if(from) from.value = from.value || 'Main Store';
  if(to) to.value = to.value || 'Factory';
  if(pref) pref.value = '';
  if(rem) rem.value = '';
  if(body) body.innerHTML = '';

  dnAddRow();
}

function dnRowProductOptions(selectedId=''){
  if(!Array.isArray(products) || !products.length){
    return `<option value="">No RM products found</option>`;
  }
  const sorted = [...products].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  return `<option value="">Select RM Product</option>` + sorted.map(p=>{
    const sel = p.id === selectedId ? 'selected' : '';
    const code = p.code ? `(${p.code}) ` : '';
    return `<option ${sel} value="${escapeHtml(p.id)}">${escapeHtml(code + (p.name||''))}</option>`;
  }).join('');
}

function dnAddRow(prefill=null){
  const body = document.getElementById('dnItemsBody');
  if(!body) return;

  const rowId = 'dnRow_' + genId();
  const selectedProductId = prefill?.productId || '';
  const qty = prefill?.qty ?? '';
  const remark = prefill?.remark ?? '';

  body.insertAdjacentHTML('beforeend', `
    <tr id="${rowId}">
      <td>
        <select class="small" style="width:100%" data-dn="product">
          ${dnRowProductOptions(selectedProductId)}
        </select>
      </td>
      <td>
        <input class="small" type="number" min="0" step="1" style="width:100%" data-dn="qty" value="${escapeHtml(qty)}">
      </td>
      <td>
        <input class="small" style="width:100%" data-dn="remark" value="${escapeHtml(remark)}" placeholder="Remark (optional)">
      </td>
      <td style="text-align:center">
        <button class="btn out" style="padding:6px 10px" onclick="dnRemoveRow('${rowId}')">X</button>
      </td>
    </tr>
  `);
}

function dnRemoveRow(rowId){
  const tr = document.getElementById(rowId);
  if(tr) tr.remove();
  const body = document.getElementById('dnItemsBody');
  if(body && body.children.length === 0) dnAddRow();
}

function getDNItemsFromUI(){
  const body = document.getElementById('dnItemsBody');
  if(!body) return [];

  const items = [];
  [...body.querySelectorAll('tr')].forEach(tr=>{
    const prodSel = tr.querySelector('[data-dn="product"]');
    const qtyInp  = tr.querySelector('[data-dn="qty"]');
    const remInp  = tr.querySelector('[data-dn="remark"]');

    const productId = (prodSel?.value || '').trim();
    const qty = Number(qtyInp?.value || 0);
    const remark = (remInp?.value || '').trim();

    if(productId && qty > 0){
      items.push({ productId, qty, remark });
    }
  });

  return items;
}

function dnTotalQty(dn){
  return (dn.items || []).reduce((s,it)=> s + Number(it.qty||0), 0);
}

let lastDNViewedId = null;

function submitDeliveryNote(){
  // ‚úÖ No stock movement here (Production Entry handles stock out)

  const dnNo = (document.getElementById('dnNo')?.value || '').trim();
  const dnDate = (document.getElementById('dnDate')?.value || todayISO());
  const from = (document.getElementById('dnFrom')?.value || '').trim();
  const to = (document.getElementById('dnTo')?.value || '').trim();
  const prodRef = (document.getElementById('dnProdRef')?.value || '').trim();
  const generalRemark = (document.getElementById('dnRemark')?.value || '').trim();

  if(!dnNo){ showToast("DN No is required", true); return; }
  if(!dnDate){ showToast("DN Date is required", true); return; }
  if(!to){ showToast("To (Factory) is required", true); return; }

  const items = getDNItemsFromUI();
  if(!items.length){ showToast("Add at least 1 RM item (qty > 0)", true); return; }

  const dnId = 'dn_' + genId();

  const dn = {
    id: dnId,
    dnNo,
    date: dnDate,
    from,
    to,
    prodRef,
    generalRemark,
    items,
    createdAt: new Date().toISOString(),
    createdBy: currentUser?.username || ''
  };

  deliveryNotes.push(dn);
  saveDeliveryNotes();

  // ‚úÖ cloud sync (no stockMovements change)
  autoPushToCloud?.();
  refreshAll();

  showToast("Delivery Note saved ‚úÖ");
  resetDeliveryNoteForm();
}


function renderDNTable(){
  const tbody = document.querySelector('#dnTable tbody');
  if(!tbody) return;

  const q = (document.getElementById('dnSearch')?.value || '').toLowerCase().trim();
  tbody.innerHTML = '';

  const list = [...deliveryNotes].sort((a,b)=> new Date(b.date) - new Date(a.date));

  list.forEach(dn=>{
    const hay = `${dn.dnNo||''} ${dn.to||''} ${dn.prodRef||''} ${dn.generalRemark||''}`.toLowerCase();
    if(q && !hay.includes(q)) return;

    const total = dnTotalQty(dn);
    const itemsCount = (dn.items || []).length;
    const canDel = (currentUser?.role === 'admin');

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${fmtDate(dn.date)}</td>
        <td>${escapeHtml(dn.dnNo)}</td>
        <td>${escapeHtml(dn.to || '')}</td>
        <td>${total}</td>
        <td>${itemsCount}</td>
        <td>
          <button class="btn info" onclick="viewDN('${escapeHtml(dn.id)}')">View</button>
          <button class="btn secondary" onclick="printDN('${escapeHtml(dn.id)}')">Print</button>
          ${canDel ? `<button class="btn out" onclick="deleteDN('${escapeHtml(dn.id)}')">Delete</button>` : ``}
        </td>
      </tr>
    `);
  });

  applyPermissions?.();
}

function viewDN(id){
  const dn = deliveryNotes.find(x=>x.id===id);
  if(!dn) return;

  lastDNViewedId = id;

  document.getElementById('dnViewTitle').textContent = `Delivery Note ‚Äî ${dn.dnNo}`;
  document.getElementById('dnViewMeta').innerHTML =
    `<b>Date:</b> ${fmtDate(dn.date)}
     &nbsp; | &nbsp; <b>From:</b> ${escapeHtml(dn.from || '-')}
     &nbsp; | &nbsp; <b>To:</b> ${escapeHtml(dn.to || '-')}
     ${dn.prodRef ? ` &nbsp; | &nbsp; <b>Production Ref:</b> ${escapeHtml(dn.prodRef)}` : ''}
     ${dn.createdBy ? ` &nbsp; | &nbsp; <b>By:</b> ${escapeHtml(dn.createdBy)}` : ''}
     ${dn.generalRemark ? `<br><b>Remark:</b> ${escapeHtml(dn.generalRemark)}` : ''}`;

  const body = document.getElementById('dnViewBody');
  body.innerHTML = '';

  (dn.items || []).forEach(it=>{
    const p = products.find(x=>x.id===it.productId);
    body.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(p?.name || 'Unknown')}</td>
        <td>${Number(it.qty||0)}</td>
        <td>${escapeHtml(it.remark||'')}</td>
      </tr>
    `);
  });

  document.getElementById('dnViewModal').style.display = 'flex';
}

function closeDNView(){
  document.getElementById('dnViewModal').style.display = 'none';
}

function printDNFromModal(){
  if(!lastDNViewedId) return;
  printDN(lastDNViewedId);
}

function printDN(id){
  const dn = deliveryNotes.find(x=>x.id===id);
  if(!dn) return;

  const rows = (dn.items || []).map((it, idx)=>{
    const p = products.find(x=>x.id===it.productId);
    return {
      sr: idx+1,
      product: p?.name || 'Unknown',
      qty: Number(it.qty||0),
      remark: it.remark || ''
    };
  });

  const totalQty = rows.reduce((s,r)=> s + Number(r.qty||0), 0);

  const w = window.open('', '_blank');
  if(!w){ showToast("Popup blocked by browser", true); return; }

  w.document.write(`
    <html>
    <head>
      <title>Delivery Note ${escapeHtml(dn.dnNo)}</title>
      <style>
        body{font-family:Arial;padding:22px;color:#111}
        .head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
        .box{border:1px solid #ccc;border-radius:10px;padding:12px}
        h2{margin:0 0 6px}
        .meta{font-size:13px;line-height:1.6;color:#333}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:13px}
        th{background:#007bff;color:#fff}
        .foot{display:flex;justify-content:space-between;margin-top:18px;gap:12px}
        .sign{flex:1;border-top:1px dashed #999;padding-top:10px;font-size:13px}
        .small{font-size:12px;color:#555;margin-top:6px}
        .right{text-align:right}
      </style>
    </head>
    <body>
      <div class="head">
        <div>
          <h2>RM DELIVERY NOTE</h2>
          <div class="meta">
            <b>DN No:</b> ${escapeHtml(dn.dnNo)}<br>
            <b>Date:</b> ${escapeHtml(fmtDate(dn.date))}<br>
            <b>From:</b> ${escapeHtml(dn.from || '-')}<br>
            <b>To:</b> ${escapeHtml(dn.to || '-')}<br>
            ${dn.prodRef ? `<b>Production Ref:</b> ${escapeHtml(dn.prodRef)}<br>` : ``}
            ${dn.generalRemark ? `<b>Remark:</b> ${escapeHtml(dn.generalRemark)}<br>` : ``}
          </div>
        </div>
        <div class="box right">
          <div style="font-weight:700">Stock Manager</div>
          <div class="small">Printable Delivery Note</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:60px">Sr</th>
            <th>RM Product</th>
            <th style="width:120px">Qty</th>
            <th>Remark</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.sr}</td>
              <td>${escapeHtml(r.product)}</td>
              <td>${r.qty}</td>
              <td>${escapeHtml(r.remark)}</td>
            </tr>
          `).join('')}
          <tr>
            <td colspan="2" style="text-align:right"><b>Total</b></td>
            <td><b>${totalQty}</b></td>
            <td></td>
          </tr>
        </tbody>
      </table>

      <div class="foot">
        <div class="sign"><b>Prepared By</b><div class="small">Name / Sign</div></div>
        <div class="sign"><b>Issued By (Store)</b><div class="small">Name / Sign</div></div>
        <div class="sign"><b>Received By (Factory)</b><div class="small">Name / Sign</div></div>
      </div>

      <script>window.onload=()=>window.print();<\/script>
    </body>
    </html>
  `);

  w.document.close();
}

function deleteDN(id){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can delete DN", true);
    return;
  }
  const dn = deliveryNotes.find(x=>x.id===id);
  if(!dn) return;

  if(!confirm(`Delete DN "${dn.dnNo}"?`)) return;

  deliveryNotes = deliveryNotes.filter(x=>x.id!==id);
  saveDeliveryNotes();

  autoPushToCloud?.();
  refreshAll();

  showToast("DN deleted ‚úÖ");
}


function addFGProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const name = fgNewName.value.trim();
  const rawGroup = fgNewGroup.value.trim();
  if(!name || !rawGroup){ showToast("Name & Group required", true); return; }

  const group = normalizeGroup(rawGroup);

  fgProducts.push({
    id:'fg_' + genId(),
    name,
    group,
    volume: fgNewVolume.value.trim(),
    batch: fgNewBatch.value.trim(),
    expiry: fgNewExpiry.value,
    threshold: Number(fgNewThreshold.value || 5)
  });

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  fgNewName.value=''; fgNewVolume.value=''; fgNewGroup.value=''; fgNewBatch.value='';
  fgNewExpiry.value=''; fgNewThreshold.value='';

  showToast("FG product added ‚úÖ");
}

function editFGProduct(fgId){
  if(!canEdit()){ showToast("No permission to edit", true); return; }

  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  const newName = prompt("Edit Product Name:", fg.name);
  if(newName===null || !newName.trim()) return;

  const newVolume = prompt("Edit Volume / Size:", fg.volume || '');
  if(newVolume===null) return;

  const newGroup = prompt("Edit Group Prefix:", fg.group || '');
  if(newGroup===null || !newGroup.trim()) return;

  const newBatch = prompt("Edit Batch / Lot No:", fg.batch || '');
  if(newBatch===null) return;

  const newExpiry = prompt("Edit Expiry Date (YYYY-MM-DD):", fg.expiry || '');
  if(newExpiry===null) return;

  const newThreshold = prompt("Edit Low Stock Threshold:", fg.threshold ?? 5);
  if(newThreshold===null || isNaN(newThreshold)) return;

  fg.name = newName.trim();
  fg.volume = newVolume.trim();
  fg.group = normalizeGroup(newGroup);
  fg.batch = newBatch.trim();
  fg.expiry = newExpiry.trim();
  fg.threshold = Number(newThreshold);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  showToast("FG updated ‚úÖ");
}

function deleteFGProduct(fgId){
  if(!canDelete()){ showToast("No permission to delete", true); return; }

  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  if(!confirm(`Delete FG "${fg.name}"? (History also deleted)`)) return;

  fgProducts = fgProducts.filter(f=>f.id!==fgId);
  fgMovements = fgMovements.filter(m=>m.fgId!==fgId);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  showToast("FG deleted ‚úÖ");
}

/* =========================
   ‚úÖ RM PAGES
========================= */
function renderProductsTable(){
  const tbody = document.querySelector('#productsTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const localSearch = (document.getElementById('productSearch')?.value || '').trim().toLowerCase();

  let i=1;
  products.forEach(p=>{
    const name = (p.name||'').toLowerCase();
    const cat  = (p.category||'').toLowerCase();
    if(localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) return;

    const bal = computeBalance(p.id);

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${escapeHtml(p.category||'')}</td>
        <td>${bal}</td>
        <td>${Number(p.threshold ?? 5)}</td>
        <td>${escapeHtml(p.barcode||'')}</td>
        <td><button class="btn secondary" onclick="openHistory('${p.id}')">History</button></td>
        <td><button class="btn secondary btn-edit admin-only" onclick="editProduct('${p.id}')">Edit</button></td>
        <td><button class="btn out btn-delete admin-only" onclick="deleteProduct('${p.id}')">Delete</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderStockIn(){
  const tbody = document.querySelector('#stockInBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('inSearch')?.value || '').toLowerCase().trim();

  products.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'IN')}</td>
        <td><button class="btn" onclick="openStockModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}

function renderStockOut(){
  const tbody = document.querySelector('#stockOutBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('outSearch')?.value || '').toLowerCase().trim();

  products.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'OUT')}</td>
        <td><button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function renderCombinedHistory(){
  const tbody = document.querySelector('#historyTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = (document.getElementById('historySearch')?.value || '').toLowerCase().trim();

  stockMovements
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = products.find(p=>p.id===m.productId);
      if(!prod) return;

      const okSearch =
        !search ||
        (prod.name||'').toLowerCase().includes(search) ||
        (m.remark||'').toLowerCase().includes(search);

      if(!okSearch) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name||'')}</td>
          <td>${escapeHtml(m.type||'')}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

/* =========================
   ‚úÖ MODALS (RM + FG)
========================= */
let modalCurrent = null;

function openStockModal(productId, type){
  if(type === 'OUT' && !canStockOut()){
    showToast("Stock OUT not allowed for your role", true);
    return;
  }

  modalCurrent = { productId, type };
  const prod = products.find(p=>p.id===productId);
  if(!prod) return;

  document.getElementById('modalProductName').textContent = prod.name;
  document.getElementById('modalProductBalance').textContent = computeBalance(productId);
  document.getElementById('modalQty').value = '';
  document.getElementById('modalRemark').value = '';

  document.getElementById('stockModal').style.display = 'flex';

  document.getElementById('modalSave').onclick = ()=>{
    const qty = Number(document.getElementById('modalQty').value);
    const remark = document.getElementById('modalRemark').value.trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeBalance(productId)){ showToast("Quantity exceeds balance", true); return; }

    stockMovements.push({ id:genId(), productId, type, quantity:qty, date:todayISO(), remark });
    saveAll();
    autoPushToCloud();
    closeModal();
    refreshAll();
    showToast(`RM Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}

function openFGModal(fgId, type){
  if(type === 'OUT' && !canStockOut()){
    showToast("Stock OUT not allowed for your role", true);
    return;
  }

  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

  document.getElementById('modalProductName').textContent = fg.name;
  document.getElementById('modalProductBalance').textContent = computeFGBalance(fgId);
  document.getElementById('modalQty').value = '';
  document.getElementById('modalRemark').value = '';
  document.getElementById('stockModal').style.display = 'flex';

  document.getElementById('modalSave').onclick = ()=>{
    const qty = Number(document.getElementById('modalQty').value);
    const remark = document.getElementById('modalRemark').value.trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeFGBalance(fgId)){ showToast("Quantity exceeds FG balance", true); return; }

    fgMovements.push({
      id:genId(),
      fgId,
      type,
      qty,
      batch: fg.batch || '',
      expiry: fg.expiry || '',
      date: todayISO(),
      remark
    });

    saveFGLocal();
    autoPushFGToCloud();
    closeModal();
    refreshAll();
    showToast(`FG Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}

function closeModal(){
  document.getElementById('stockModal').style.display='none';
  modalCurrent = null;
}

/* RM history modal */
function openHistory(productId){
  const prod = products.find(p=>p.id===productId);
  if(!prod) return;

  const modal = document.getElementById('historyModal');
  modal.style.display='flex';

  document.getElementById('modalTitle').textContent = `RM History ‚Äî ${prod.name}`;

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.productId===productId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>-</td>
          <td>-</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}

function closeHistoryModal(){
  document.getElementById('historyModal').style.display='none';
}

/* RM Stock IN/OUT History modals */
function stockInHistoryModal(){
  const modal=document.getElementById('stockInHistoryModal');
  modal.style.display='flex';
  const tbody=document.getElementById('stockInHistoryPopupBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.type==='IN')
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = products.find(p=>p.id===m.productId);
      if(!prod) return;
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
function closeStockInHistory(){ document.getElementById('stockInHistoryModal').style.display='none'; }

function stockOutHistoryModal(){
  const modal=document.getElementById('stockOutHistoryModal');
  modal.style.display='flex';
  const tbody=document.getElementById('stockOutHistoryPopupBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.type==='OUT')
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = products.find(p=>p.id===m.productId);
      if(!prod) return;
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
function closeStockOutHistory(){ document.getElementById('stockOutHistoryModal').style.display='none'; }

/* FG IN/OUT History (use historyModal) */
function fgStockInHistoryModal(){
  const modal = document.getElementById("historyModal");
  modal.style.display = "flex";
  document.getElementById("modalTitle").textContent = "FG Stock IN History";

  const tbody = document.getElementById("modalHistoryBody");
  tbody.innerHTML = "";

  fgMovements
    .filter(m => m.type === "IN")
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id === m.fgId);
      if(!fg) return;
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>IN</td>
          <td>${Number(m.qty || 0)}</td>
          <td>${escapeHtml(m.batch || fg.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || fg.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

function fgStockOutHistoryModal(){
  const modal = document.getElementById("historyModal");
  modal.style.display = "flex";
  document.getElementById("modalTitle").textContent = "FG Stock OUT History";

  const tbody = document.getElementById("modalHistoryBody");
  tbody.innerHTML = "";

  fgMovements
    .filter(m => m.type === "OUT")
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id === m.fgId);
      if(!fg) return;
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>OUT</td>
          <td>${Number(m.qty || 0)}</td>
          <td>${escapeHtml(m.batch || fg.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || fg.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

/* =========================
   ‚úÖ RM ADD / EDIT / DELETE
========================= */
function addRMProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const code = (document.getElementById('newCode')?.value || '').trim();
  const name = (document.getElementById('newName')?.value || '').trim();
  const category = (document.getElementById('newCategory')?.value || '').trim();
  const threshold = Number(document.getElementById('newThreshold')?.value || 5);
  const barcode = (document.getElementById('newBarcode')?.value || '').trim();
  const groupsStr = (document.getElementById('newGroups')?.value || '').trim();
  const exclusive = !!document.getElementById('newExclusive')?.checked;

  if(!name){ showToast("Product name required", true); return; }

  const groups = groupsStr
    ? groupsStr.split(',').map(g=>g.trim()).filter(Boolean)
    : [];

  products.push({
    id: 'rm_' + genId(),
    code, name, category,
    threshold: isNaN(threshold) ? 5 : threshold,
    barcode,
    groups,
    exclusive
  });

  saveAll();
  autoPushToCloud();
  refreshAll();

  newCode.value=''; newName.value=''; newCategory.value='';
  newThreshold.value=''; newBarcode.value=''; newGroups.value='';
  newExclusive.checked=false;

  showToast("RM product added ‚úÖ");
}

function editProduct(productId){
  if(!canEdit()){
    showToast("No permission to edit", true);
    return;
  }

  const prod = products.find(p => p.id === productId);
  if(!prod) return;

  const newCode = prompt("Edit product code:", prod.code || "");
  if(newCode === null) return;

  const newName = prompt("Edit product name:", prod.name || "");
  if(newName === null || !newName.trim()){
    showToast("Name required", true);
    return;
  }

  const newCategory = prompt("Edit category:", prod.category || "");
  if(newCategory === null) return;

  const newThreshold = prompt("Edit threshold:", prod.threshold ?? 5);
  if(newThreshold === null || isNaN(Number(newThreshold))){
    showToast("Invalid threshold", true);
    return;
  }

  const newBarcode = prompt("Edit barcode:", prod.barcode || "");
  if(newBarcode === null) return;

  const newGroupsInput = prompt(
    "Edit groups (comma separated):",
    Array.isArray(prod.groups) ? prod.groups.join(', ') : ''
  );
  if(newGroupsInput === null) return;

  const newExclusive = confirm("Exclusive to first group?");

  prod.code = newCode.trim();
  prod.name = newName.trim();
  prod.category = (newCategory || '').trim();
  prod.threshold = Number(newThreshold);
  prod.barcode = (newBarcode || '').trim();
  prod.groups = (newGroupsInput || '')
    .split(',')
    .map(g => g.trim())
    .filter(Boolean);
  prod.exclusive = newExclusive;

  saveAll();
  autoPushToCloud();
  refreshAll();

  showToast("Product updated ‚úÖ");
}

function deleteProduct(productId){
  if(!canDelete()){
    showToast("No permission to delete", true);
    return;
  }

  const prod = products.find(p => p.id === productId);
  if(!prod) return;

  if(!confirm(`Delete "${prod.name}"?\nThis will remove all its stock history.`)) return;

  products = products.filter(p => p.id !== productId);
  stockMovements = stockMovements.filter(m => m.productId !== productId);

  saveAll();
  autoPushToCloud();
  refreshAll();

  showToast("Product deleted ‚úÖ");
}

/* =========================
   ‚úÖ BOM / DASHBOARD GROUPED TABLE
========================= */
let dashboardSearchText = "";
let selectedDashboardGroup = null;
let renamedGroups = JSON.parse(localStorage.getItem('renamedGroups') || '{}');

function handleDashboardSearch(value){
  dashboardSearchText = (value || "").toLowerCase().trim();
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function clearDashboardSearch(){
  const inp = document.getElementById('dashboardSearch');
  if(inp) inp.value = '';
  dashboardSearchText = '';
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function selectDashboardGroup(groupName){
  selectedDashboardGroup = groupName;
  renderDashboardGrouped();
}
function getFGStock(groupName){
  const key = normalizeGroup(groupName);
  let total = 0;
  fgProducts.forEach(fg=>{
    if(normalizeGroup(fg.group) === key){
      total += computeFGBalance(fg.id);
    }
  });
  return total;
}
function renameGroup(groupName){
  if(currentUser?.role !== 'admin'){
    showToast("Only admin can rename groups", true);
    return;
  }
  const newName = prompt(`Enter new display name for "${groupName}"`, renamedGroups[groupName] || groupName);
  if(!newName) return;

  renamedGroups[groupName] = newName.trim();
  localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
  saveRenamedGroupsToCloud();
  renderDashboardGrouped();
}
function saveRenamedGroupsToCloud(){
  cloudDB.ref("dashboardRenamedGroups").set(renamedGroups);
}
function loadRenamedGroupsFromCloud(){
  cloudDB.ref("dashboardRenamedGroups").once("value").then(snap=>{
    if(snap.exists()){
      renamedGroups = snap.val() || {};
      localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
      renderDashboardGrouped();
    }
  });
}

// Grouped BOM render (shows groups by default)
function renderDashboardGrouped(){
  const tbody = document.querySelector('#dashTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  const groupsMap = {};

  products.forEach(p=>{
    if(!Array.isArray(p.groups) || !p.groups.length) return;

    p.groups.forEach(g=>{
      if(!groupsMap[g]) groupsMap[g] = [];

      // exclusive products only show in first group
      if(p.exclusive && p.groups[0] !== g) return;

      groupsMap[g].push(p);
    });
  });

  const allGroups = Object.keys(groupsMap).sort((a,b)=>a.localeCompare(b));
  const search = dashboardSearchText;

  // If no groups configured, show info row
  if(!allGroups.length){
    tbody.insertAdjacentHTML('beforeend', `
      <tr><td colspan="6"><b>No BOM groups found.</b> Add "Groups" to RM products (comma separated).</td></tr>
    `);
    return;
  }

  allGroups.forEach(groupName=>{
    const displayName = renamedGroups[groupName] || groupName;

    const groupProducts = groupsMap[groupName].filter(p=>{
      const nm = (p.name||'').toLowerCase();
      const gp = displayName.toLowerCase();
      return !search || nm.includes(search) || gp.includes(search);
    });

    if(!groupProducts.length) return;
    if(selectedDashboardGroup && selectedDashboardGroup !== groupName) return;

    const fgBalance = getFGStock(groupName);

    const groupRow = document.createElement('tr');
    groupRow.innerHTML = `
      <td colspan="6" style="padding:18px;cursor:pointer;background:rgba(0,0,0,0.03)"
          onclick="selectDashboardGroup('${escapeHtml(groupName)}')">
        <b>${escapeHtml(displayName).toUpperCase()}</b>
        <span style="margin-left:40px;color:green;font-weight:bold">
          FG BALANCE: ${fgBalance}
        </span>
        ${
          currentUser?.role === 'admin'
            ? `<button class="btn secondary" style="margin-left:15px;padding:6px 10px"
                 onclick="event.stopPropagation(); renameGroup('${escapeHtml(groupName)}')">
                 Rename
               </button>`
            : ''
        }
      </td>
    `;
    tbody.appendChild(groupRow);

    // show products only when group is selected
    if(selectedDashboardGroup === groupName){
      groupProducts.forEach(p=>{
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td style="padding-left:25px">${escapeHtml(p.name||'')}</td>
            <td class="${bal <= Number(p.threshold ?? 5) ? 'low-stock':''}">${bal}</td>
            <td>${Number(p.threshold ?? 5)}</td>
            <td>${lastMovement(p.id,'IN')}</td>
            <td>${lastMovement(p.id,'OUT')}</td>
            <td>
              <button class="btn secondary" onclick="openHistory('${p.id}')">View</button>
              <button class="btn" onclick="openStockModal('${p.id}','IN')">Add IN</button>
              <button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock OUT</button>
            </td>
          </tr>
        `);
      });
    }
  });

  applyPermissions();
}

/* =========================
   ‚úÖ CLOUD SYNC (RM + FG)
========================= */
function autoPushToCloud(){
  cloudDB.ref("stockManager").set({
    products,
    stockMovements,
    bills,
    productions, 
    syncedAt: new Date().toISOString()
  });
}

function autoPullFGFromCloud(){
  cloudDB.ref('fgManager').once('value').then(snap=>{
    if(!snap.exists()) return;
    fgProducts = snap.val().products || [];
    fgMovements = snap.val().movements || [];
    saveFGLocal();
    initFGVolumeSelection();
    refreshAll();
  });
}

function autoPullFromCloud(){
  cloudDB.ref("stockManager").once("value")
    .then(snapshot=>{
      const data = snapshot.val();
      if(!data) return;
      products = data.products || [];
      stockMovements = data.stockMovements || [];
	bills = data.bills || bills || [];
	saveBills();
	productions = data.productions || productions || [];
	saveProductions();
	deliveryNotes = data.deliveryNotes || deliveryNotes || [];
	saveDeliveryNotes();


      saveAll();
      refreshAll();
    })
    .catch(err=> console.error("Auto pull failed:", err));
}




/* =========================
   ‚úÖ REPORTS + EXPORT/IMPORT
========================= */
function printStockReport(){
  const rows = products
    .slice()
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    .map(p=>({
      Code: p.code || '',
      Product: p.name || '',
      Category: p.category || '',
      Balance: computeBalance(p.id),
      Threshold: Number(p.threshold ?? 5),
      LastIN: lastMovement(p.id,'IN'),
      LastOUT: lastMovement(p.id,'OUT')
    }));

  const w = window.open('', '_blank');
  if(!w) { showToast("Popup blocked by browser", true); return; }

  w.document.write(`
    <html><head><title>RM Stock Report</title>
    <style>
      body{font-family:Arial;padding:18px}
      h2{margin:0 0 12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ccc;padding:8px;text-align:left}
      th{background:#007bff;color:#fff}
    </style>
    </head><body class="print-bg">
    <h2>RM Stock Report</h2>
    <p>Date: ${new Date().toLocaleString()}</p>
    <table>
      <thead><tr>
        <th>Code</th><th>Product</th><th>Category</th><th>Balance</th><th>Threshold</th><th>Last IN</th><th>Last OUT</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.Code)}</td>
            <td>${escapeHtml(r.Product)}</td>
            <td>${escapeHtml(r.Category)}</td>
            <td>${r.Balance}</td>
            <td>${r.Threshold}</td>
            <td>${escapeHtml(r.LastIN)}</td>
            <td>${escapeHtml(r.LastOUT)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function printFGStockReport(){
  const rows = fgProducts
    .slice()
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    .map(f=>({
      Product: f.name || '',
      Volume: f.volume || '',
      Group: f.group || '',
      Balance: computeFGBalance(f.id),
      Threshold: Number(f.threshold ?? 5),
      Batch: f.batch || '',
      Expiry: f.expiry || ''
    }));

  const w = window.open('', '_blank');
  if(!w) { showToast("Popup blocked by browser", true); return; }

  w.document.write(`
    <html><head><title>FG Stock Report</title>
    <style>
      body{font-family:Arial;padding:18px}
      h2{margin:0 0 12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ccc;padding:8px;text-align:left}
      th{background:#16a34a;color:#fff}
    </style>
    </head><body>
    <h2>FG Stock Report</h2>
    <p>Date: ${new Date().toLocaleString()}</p>
    <table>
      <thead><tr>
        <th>Product</th><th>Volume</th><th>Group</th><th>Balance</th><th>Threshold</th><th>Batch</th><th>Expiry</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.Product)}</td>
            <td>${escapeHtml(r.Volume)}</td>
            <td>${escapeHtml(r.Group)}</td>
            <td>${r.Balance}</td>
            <td>${r.Threshold}</td>
            <td>${escapeHtml(r.Batch)}</td>
            <td>${escapeHtml(r.Expiry)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function exportExcel(){
  try{
    const wb = XLSX.utils.book_new();

    const rmProducts = products.map(p=>({
      id:p.id, code:p.code||'', name:p.name||'', category:p.category||'',
      threshold:Number(p.threshold ?? 5), barcode:p.barcode||'',
      groups: Array.isArray(p.groups)? p.groups.join(', ') : '',
      exclusive: !!p.exclusive
    }));
    const rmMoves = stockMovements.map(m=>({
      id:m.id, productId:m.productId, type:m.type, quantity:Number(m.quantity||0),
      date:m.date||'', remark:m.remark||''
    }));
    const fgProds = fgProducts.map(f=>({
      id:f.id, name:f.name||'', volume:f.volume||'', group:f.group||'',
      threshold:Number(f.threshold ?? 5), batch:f.batch||'', expiry:f.expiry||''
    }));
    const fgMoves = fgMovements.map(m=>({
      id:m.id, fgId:m.fgId, type:m.type, qty:Number(m.qty||0),
      date:m.date||'', batch:m.batch||'', expiry:m.expiry||'', remark:m.remark||''
    }));

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rmProducts), 'RM_Products');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rmMoves), 'RM_Movements');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fgProds), 'FG_Products');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fgMoves), 'FG_Movements');

    XLSX.writeFile(wb, `StockManager_${todayISO()}.xlsx`);
    showToast("Excel exported ‚úÖ");
  }catch(e){
    console.error(e);
    showToast("Excel export failed", true);
  }
}

function importExcel(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.xlsx,.xls';
  inp.onchange = (ev)=>{
    const file = ev.target.files?.[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const firstSheetName = wb.SheetNames[0];
        const ws = wb.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:''});

        let added = 0;
        rows.forEach(r=>{
          const name = String(r.name || r.Name || r.PRODUCT || r.Product || '').trim();
          if(!name) return;

          products.push({
            id: 'rm_' + genId(),
            code: String(r.code || r.Code || '').trim(),
            name,
            category: String(r.category || r.Category || '').trim(),
            threshold: Number(r.threshold || r.Threshold || 5) || 5,
            barcode: String(r.barcode || r.Barcode || '').trim(),
            groups: String(r.groups || r.Groups || '').split(',').map(x=>x.trim()).filter(Boolean),
            exclusive: String(r.exclusive || r.Exclusive || '').toLowerCase() === 'true'
          });
          added++;
        });

        saveAll();
        autoPushToCloud();
        refreshAll();
        showToast(`Imported ${added} RM products ‚úÖ`);
      }catch(err){
        console.error(err);
        showToast("Import failed", true);
      }
    };
    reader.readAsArrayBuffer(file);
  };
  inp.click();
}

function exportPDF(){
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');

    const rows = products
      .slice()
      .sort((a,b)=>(a.name||'').localeCompare(b.name||''))
      .map(p=>[
        p.code||'',
        p.name||'',
        p.category||'',
        String(computeBalance(p.id)),
        String(Number(p.threshold ?? 5)),
        lastMovement(p.id,'IN'),
        lastMovement(p.id,'OUT')
      ]);

    doc.text(`RM Stock Report - ${todayISO()}`, 40, 40);

    doc.autoTable({
      startY: 60,
      head: [['Code','Product','Category','Balance','Threshold','Last IN','Last OUT']],
      body: rows,
      styles: { fontSize: 9 }
    });

    doc.save(`RM_Stock_Report_${todayISO()}.pdf`);
    showToast("PDF exported ‚úÖ");
  }catch(e){
    console.error(e);
    showToast("PDF export failed", true);
  }
}

/* =========================
   ‚úÖ SUPPLIERS (local)
========================= */
const KEY_SUPPLIERS = 'sms_suppliers_v1';
let suppliers = JSON.parse(localStorage.getItem(KEY_SUPPLIERS) || '[]');

function saveSuppliers(){
  localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(suppliers));
}

function renderSuppliers(){
  const tbody = document.querySelector('#suppliersTable tbody');
  if(!tbody) return;

  const q = (document.getElementById('supplierSearch')?.value || '').toLowerCase().trim();
  tbody.innerHTML = '';

  const list = suppliers.filter(s=>{
    if(!q) return true;
    return (s.name||'').toLowerCase().includes(q) || (s.contact||'').toLowerCase().includes(q);
  });

  list.forEach((s, idx)=>{
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${idx+1}</td>
        <td>${escapeHtml(s.name||'')}</td>
        <td>${escapeHtml(s.contact||'')}</td>
        <td><button class="btn secondary btn-edit" onclick="editSupplier('${s.id}')">Edit</button></td>
        <td><button class="btn out btn-delete" onclick="deleteSupplier('${s.id}')">Delete</button></td>
      </tr>
    `);
  });

  applyPermissions();
}

function addSupplier(){
  if(!canAdd()){ showToast("No permission to add", true); return; }
  const name = (document.getElementById('newSupplierName')?.value || '').trim();
  const contact = (document.getElementById('newSupplierContact')?.value || '').trim();
  if(!name){ showToast("Supplier name required", true); return; }

  suppliers.push({ id:'sup_'+genId(), name, contact });
  saveSuppliers();
  renderSuppliers();
  document.getElementById('newSupplierName').value='';
  document.getElementById('newSupplierContact').value='';
  showToast("Supplier added ‚úÖ");
}
function editSupplier(id){
  if(!canEdit()){ showToast("No permission to edit", true); return; }
  const s = suppliers.find(x=>x.id===id);
  if(!s) return;

  const name = prompt("Supplier name:", s.name||'');
  if(name === null || !name.trim()) return;

  const contact = prompt("Contact info:", s.contact||'');
  if(contact === null) return;

  s.name = name.trim();
  s.contact = contact.trim();
  saveSuppliers();
  renderSuppliers();
  showToast("Supplier updated ‚úÖ");
}
function deleteSupplier(id){
  if(!canDelete()){ showToast("No permission to delete", true); return; }
  if(!confirm("Delete this supplier?")) return;

  suppliers = suppliers.filter(x=>x.id!==id);
  saveSuppliers();
  renderSuppliers();
  showToast("Supplier deleted ‚úÖ");
}

/* =========================
   ‚úÖ EVENTS / MENU / INIT
========================= */
// Sidebar collapsible
document.querySelectorAll('.menu-title.collapsible').forEach(m=>{
  m.addEventListener('click', ()=>{
    m.classList.toggle('open');
    m.nextElementSibling?.classList.toggle('open');
  });
});

// submenu navigation
document.querySelectorAll('.submenu').forEach(sm=>{
  sm.addEventListener('click', ()=>{
    const page = sm.dataset.page;
    const action = sm.dataset.action;
    if(page) openPage(page);
    if(action && typeof window[action]==='function') window[action]();
  });
});

// Searches
document.getElementById('productSearch')?.addEventListener('input', renderProductsTable);
document.getElementById('inSearch')?.addEventListener('input', renderStockIn);
document.getElementById('outSearch')?.addEventListener('input', renderStockOut);
document.getElementById('historySearch')?.addEventListener('input', renderCombinedHistory);
document.getElementById('fgSearch')?.addEventListener('input', renderFGStock);
document.getElementById('fgInSearch')?.addEventListener('input', renderFGStockIn);
document.getElementById('fgOutSearch')?.addEventListener('input', renderFGStockOut);
document.getElementById('supplierSearch')?.addEventListener('input', renderSuppliers);
document.getElementById('addSupplierBtn')?.addEventListener('click', addSupplier);
document.getElementById('boeSearch')?.addEventListener('input', renderBillsTable);
document.getElementById('prodSearch')?.addEventListener('input', renderProductionsTable);
document.getElementById('dnSearch')?.addEventListener('input', renderDNTable);

// Sidebar toggle
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');
const mainWrap = document.querySelector('.main');

if(sidebarToggle && sidebar){
  sidebarToggle.addEventListener('click', ()=>{
    sidebar.classList.toggle('minimized');
    if(mainWrap) mainWrap.classList.toggle('sidebar-minimized');
    sidebarToggle.textContent = sidebar.classList.contains('minimized') ? '‚Üí' : '‚Üê';
  });
}

// ‚úÖ session restore
const savedUser = localStorage.getItem('sms_currentUser');
if(savedUser){
  currentUser = JSON.parse(savedUser);
  loginScreen.style.display='none';
  document.querySelector('.app').style.display='flex';
  applyPermissions();
  openPage('dashboardPage');
}

/* initial pulls */
window.addEventListener('load', ()=>{
  initFGVolumeSelection();
  loadRenamedGroupsFromCloud();
  autoPullFGFromCloud();
  autoPullFromCloud();
  refreshAll();
});

/* =========================
   ‚úÖ REFRESH ALL
========================= */
function refreshAll(){
  renderProductsTable();
  renderStockIn();
  renderStockOut();
  renderCombinedHistory();

  renderFGStock();
  renderFGStockIn();
  renderFGStockOut();
  renderProductionsTable();
  renderDNTable();

  renderMainDashboard();
  renderDashboardGrouped();
  renderBillsTable();
  applyPermissions();
}


/* Expose to window (safe) */
window.handleDashboardSearch = handleDashboardSearch;
window.clearDashboardSearch = clearDashboardSearch;
window.fgStockInHistoryModal = fgStockInHistoryModal;
window.fgStockOutHistoryModal = fgStockOutHistoryModal;
window.printStockReport = printStockReport;
window.printFGStockReport = printFGStockReport;
window.exportExcel = exportExcel;
window.importExcel = importExcel;
window.exportPDF = exportPDF;
window.openFGFromDashboard = openFGFromDashboard;
window.openLowFGFromDashboard = openLowFGFromDashboard;
</script>

</body>
</html>
