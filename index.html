<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stock Manager</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<!-- ‚òÅÔ∏è CLOUD SYNC ADDITION -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --sidebar-w:260px;
  --muted:#6b6f76;
  --accent:#2c3e50;
  --accent-2:#2980b9;
  --danger:#c0392b;
  --badge-green:#2ecc71;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;color:#111;background:transparent;}
body::before{content:"";position:fixed;inset:0;background-position:center center;background-repeat:no-repeat;background-size:750px auto;background-attachment:fixed;opacity:1;z-index:-1;pointer-events:none;}
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-w);position:fixed;left:0;top:0;height:100%;background:rgba(255,255,255,0.65);backdrop-filter:blur(5px);padding:8px;box-shadow:4px 0 20px rgba(0,0,0,.08);overflow:auto;z-index:20;border-right:1px solid rgba(0,0,0,0.04);border-radius:0 10px 10px 0;}
.sidebar-header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.sidebar-logo{width:96px;height:56px;object-fit:cover;border-radius:8px}
.brand-title{font-size:18px;margin:0}
.brand-sub{font-size:12px;color:var(--muted);margin-top:4px}
.sidebar-menu{list-style:none;padding:0;margin:12px 0 0}
.sidebar-menu li{padding:12px 10px;display:flex;gap:10px;align-items:center;cursor:pointer;border-left:4px solid transparent;border-radius:6px;transition:all .18s;color:#222;}
.menu-title{font-weight:700;background:rgba(0,0,0,0.05);}
.submenu{padding-left:36px !important;font-size:14px;}
.subgroup{list-style:none;padding:0;margin:0;display:none;}
.subgroup.open{display:block;}
.menu-title.collapsible{display:flex;justify-content:space-between;align-items:center;}
.arrow{font-size:12px;transition:transform .2s ease;}
.menu-title.open .arrow{transform:rotate(180deg);}
.sidebar-menu li:hover{ background:rgba(60,120,200,0.06); transform:translateX(4px); border-left-color: rgba(41,128,185,0.8); }
.sidebar-menu li.active{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; border-left-color:#fff; font-weight:700; }
.sidebar-footer{margin-top:18px;font-size:13px;color:var(--muted)}
.main{margin-left:calc(var(--sidebar-w) + 18px);width:70%; padding:18px; min-height:100vh; background: transparent;}
.top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.search{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);width:320px; background: rgba(255,255,255,0.55); }
.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.secondary{background:var(--accent-2)}
.btn.out{background:#dc2626}
.btn.info{background:#16a34a}
.page {background:rgba(255,255,255,0.5);backdrop-filter:blur(5px);border-radius:12px;width:100%;min-height:calc(100vh - 40px);padding:25px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 6px 25px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
th{background:rgba(255,255,255,0.6);font-weight:700}
.low-stock{color:var(--danger);font-weight:700}
.balance-qty{font-weight:bold}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:9999;}
.modal-box,.modal{background:white;padding:20px;border-radius:12px;max-height:80%;overflow-y:auto;width:600px;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.modal-close{cursor:pointer;background:none;border:none;font-size:18px;}
.modal-table{width:100%;border-collapse:collapse;}
.modal-table th,.modal-table td{border:1px solid #ccc;padding:8px;text-align:left;}
@media print {
    body {
        -webkit-print-color-adjust: exact; /* Chrome/Safari */
        print-color-adjust: exact;         /* Firefox */
    }
    .print-bg {
        background-image: url('banner.png') !important;
        background-size: cover !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
    }
}

</style>
</head>

<body>
<div class="app">
<aside class="sidebar">
<div class="sidebar-header">
<img src="banner.png" class="sidebar-logo" onerror="this.style.display='none'">
<div><div class="brand-title">STOCK</div><div class="brand-sub">Inventory ‚Ä¢ Public Sheet</div></div>
</div>
<ul class="sidebar-menu" id="menu">
<li class="menu-title collapsible" data-page="dashboard">üìä Dashboard<span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="dashboard">üìä Dashboard</li>
<li class="submenu" data-action="printStockReport">üñ®Ô∏è Print Stock Report</li>
<li class="submenu" data-action="exportPDF">üìÑ Export PDF</li>
</ul>
<li class="menu-title collapsible">üì¶ Products<span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="products">üì¶ Add Products</li>
</ul>
<li class="menu-title collapsible">üìà Stock <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="stockIn">‚¨Ü Stock In</li>
<li class="submenu" data-page="stockOut">‚¨á Stock Out</li>
<li class="submenu" data-page="history">üìö Combined History</li>
</ul>
<li class="menu-title collapsible">üíæ Backup <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-action="importExcel">üì• Import Excel</li>
<li class="submenu" data-action="exportExcel">üì§ Export Excel</li>
<li class="submenu" onclick="pushToCloud()">‚òÅÔ∏è Upload to Cloud</li>
<li class="submenu" onclick="pullFromCloud()">‚¨áÔ∏è Download from Cloud</li>

</ul>
<div class="sidebar-footer">Data stored locally; cloud optional.</div>
</ul>
</aside>

<main class="main"><!-- DASHBOARD -->
<section id="dashboard" class="page" style="display:block">
<h2>Dashboard</h2>
<div class="top">
<input id="globalSearch" class="search" placeholder="Search products, categories or history...">
</div>
<div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
<div>Category:
<select id="categoryFilter" class="small">
<option value="">All</option>
</select>
</div>
<div>Low threshold:
<input id="globalThreshold" type="number" class="small" value="5" style="width:80px">
</div>
<div style="margin-left:auto" class="small" id="status">Status: Local</div>
</div>
<div style="overflow:auto">
<table id="dashTable">
<thead><tr><th>#</th><th>Product</th><th>Category</th><th>Balance</th><th>Last IN</th><th>Last OUT</th><th>Last Date</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>

<!-- PRODUCTS -->
<section id="products" class="page" style="display:none">
<h2>Add Products</h2>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
<input id="newName" class="small" placeholder="Product Name">
<input id="newCategory" class="small" placeholder="Category">
<input id="newThreshold" class="small" placeholder="Threshold" type="number" style="width:110px">
<button id="addProductBtn" class="btn">Add Product</button>
</div>
<div style="margin-bottom:12px">
<input id="productSearch" class="search" placeholder="Search products...">
</div>
<div style="overflow:auto; height: calc(100% - 170px);">
<table id="productsTable">
<thead><tr><th>#</th><th>Name</th><th>Category</th><th>Balance</th><th>Threshold</th><th>History</th><th>Edit</th><th>Delete</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>

<!-- STOCK IN -->
<section id="stockIn" class="page" style="display:none">
<h2>Stock In</h2>
<input id="inSearch" class="search" placeholder="Search product">
<button class="btn secondary" onclick="stockInHistoryModal()">View Stock IN History</button>
<table id="stockInBody">
<thead><tr><th>Product</th><th>Balance</th><th>Last IN</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- STOCK OUT -->
<section id="stockOut" class="page" style="display:none">
<h2>Stock Out</h2>
<input id="outSearch" class="search" placeholder="Search product">
<button class="btn info" onclick="stockOutHistoryModal()">View Stock OUT History</button>
<table id="stockOutBody">
<thead><tr><th>Product</th><th>Balance</th><th>Last OUT</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- COMBINED HISTORY -->
<section id="history" class="page" style="display:none">
<h2>Combined History</h2>
<div style="margin-bottom:12px">
<input id="historySearch" class="search" placeholder="Search combined history...">
</div>
<div style="overflow:auto; height: calc(100% - 120px);">
<table id="historyTable"><thead><tr><th>Date</th><th>Product</th><th>Type</th><th>Qty</th></tr></thead><tbody></tbody></table>
</div>
</section>

<!-- MODALS -->
<div id="historyModal" class="modal-backdrop">
<div class="modal-box">
<div class="modal-header">
<h3 id="modalTitle">Product History</h3>
<button onclick="closeHistoryModal()" class="modal-close">‚úñ</button>
</div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Type</th><th>Qty</th></tr></thead>
<tbody id="modalHistoryBody"></tbody></table>
</div>
</div>
</div>

<div id="stockInHistoryModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3>Stock IN History</h3><button onclick="closeStockInHistory()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Product</th><th>Qty</th></tr></thead>
<tbody id="stockInHistoryPopupBody"></tbody>
</table>
</div>
</div>
</div>

<div id="stockOutHistoryModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3>Stock OUT History</h3><button onclick="closeStockOutHistory()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Product</th><th>Qty</th></tr></thead>
<tbody id="stockOutHistoryPopupBody"></tbody>
</table>
</div>
</div>
</div>

<div id="stockModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3 id="modalTitle">Stock </h3><button onclick="closeModal()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<p>Product: <b id="modalProductName"></b></p>
<p>Balance: <b id="modalProductBalance"></b></p>
<input id="modalQty" type="number" placeholder="Enter quantity">
<p id="successMsg" class="success"></p>
</div>
<div class="modal-actions">
<button class="btn secondary" onclick="closeModal()">Cancel</button>
<button class="btn" id="modalSave">Save</button>
</div>
</div>
</div>

<script>
// FULL JS LOGIC START
const KEY_PRODUCTS='sms_products_final_v1';
const KEY_MOVES='sms_movements_final_v1';
let products=JSON.parse(localStorage.getItem(KEY_PRODUCTS)||'[]');
let stockMovements=JSON.parse(localStorage.getItem(KEY_MOVES)||'[]');
if(!localStorage.getItem(KEY_PRODUCTS)){
    products = [
        {id:genId(),name:'download',category:'from cloud',threshold:5},
        {id:genId(),name:'0',category:'0',threshold:10},
        {id:genId(),name:'1',category:'1',threshold:50}
    ];
    stockMovements = [
        {id:genId(),productId:products[0].id,type:'IN',quantity:20,date:todayISO()},
        {id:genId(),productId:products[1].id,type:'IN',quantity:15,date:todayISO()},
        {id:genId(),productId:products[2].id,type:'IN',quantity:100,date:todayISO()}
    ];
    saveAll();
}

function saveAll(){localStorage.setItem(KEY_PRODUCTS,JSON.stringify(products));localStorage.setItem(KEY_MOVES,JSON.stringify(stockMovements));document.getElementById('status')&&(document.getElementById('status').textContent='Status: Local saved');}
function genId(){return'id_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);}
function todayISO(){return new Date().toISOString().split('T')[0];}
function fmtDate(iso){if(!iso)return'-';const p=iso.split('-');return`${p[2]}/${p[1]}/${p[0]}`;}
function escapeHtml(s){if(s==null)return'';return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function computeBalance(productId){let bal=0;stockMovements.forEach(m=>{if(m.productId===productId){bal+=m.type==='IN'?m.quantity:-m.quantity;}});return bal>0?bal:0;}
function lastMovement(productId,type){const rows=stockMovements.filter(m=>m.productId===productId&&m.type===type);return rows.length?fmtDate(rows[rows.length-1].date):'-';}
function populateCategoryFilter() {
    const catSelect = document.getElementById('categoryFilter');
    if(!catSelect) return;
    const cats = [...new Set(products.map(p=>p.category).filter(c=>c))];
    catSelect.innerHTML = '<option value="">All</option>';
    cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.toLowerCase();
        opt.textContent = c;
        catSelect.appendChild(opt);
    });
}


// Render Dashboard
function renderDashboard() {
    const tbody = document.querySelector('#dashTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const catFilter = (document.getElementById('categoryFilter').value || '').trim().toLowerCase();
    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const threshold = Number(document.getElementById('globalThreshold').value || 5);

    products.forEach((p,i) => {
        const productName = p.name.toLowerCase();
        const productCat = (p.category || '').toLowerCase();

        if(catFilter && productCat !== catFilter) return; // Category filter
        if(globalSearch && !productName.includes(globalSearch) && !productCat.includes(globalSearch)) return; // Global search

        const bal = computeBalance(p.id);
        const ins = stockMovements.filter(m=>m.productId===p.id && m.type==='IN');
        const outs = stockMovements.filter(m=>m.productId===p.id && m.type==='OUT');
        const lastIn = ins.length > 0 ? fmtDate(ins[ins.length-1].date) : '-';
        const lastOut = outs.length > 0 ? fmtDate(outs[outs.length-1].date) : '-';
        const ld = [...ins,...outs].sort((a,b)=>new Date(a.date)-new Date(b.date));
        const lastDate = ld.length > 0 ? fmtDate(ld[ld.length-1].date) : '-';

        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${i+1}</td>
                <td>${escapeHtml(p.name)}</td>
                <td>${escapeHtml(p.category)}</td>
                <td class="${bal <= p.threshold ? 'low-stock' : 'balance-qty'}">${bal}</td>
                <td>${lastIn}</td>
                <td>${lastOut}</td>
                <td>${lastDate}</td>
                <td><button class="btn secondary" onclick="openHistory('${p.id}')">View</button></td>
            </tr>
        `);
    });
}

function renderProductsTable() {
    const tbody = document.querySelector('#productsTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('productSearch').value || '').trim().toLowerCase();

    products.forEach((p,i) => {
        const name = p.name.toLowerCase();
        const cat = (p.category || '').toLowerCase();
        if((localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) ||
           (globalSearch && !name.includes(globalSearch) && !cat.includes(globalSearch))) return;

        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${i+1}</td>
                <td>${escapeHtml(p.name)}</td>
                <td>${escapeHtml(p.category)}</td>
                <td>${bal}</td>
                <td>${p.threshold || 5}</td>
                <td><button class="btn secondary" onclick="openHistory('${p.id}')">History</button></td>
                <td><button class="btn secondary" onclick="editProduct('${p.id}')">Edit</button></td>
                <td><button class="btn secondary" onclick="deleteProduct('${p.id}')">Delete</button></td>
            </tr>
        `);
    });
}

function renderStockIn() {
    const tbody = document.querySelector('#stockInBody tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('inSearch').value || '').trim().toLowerCase();

    products.forEach(p => {
        const name = p.name.toLowerCase();
        if((localSearch && !name.includes(localSearch)) || (globalSearch && !name.includes(globalSearch))) return;
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${escapeHtml(p.name)}</td>
                <td>${bal}</td>
                <td>${lastMovement(p.id,'IN')}</td>
                <td><button class="btn" onclick="openStockModal('${p.id}','IN')">Add</button></td>
            </tr>
        `);
    });
}
function renderStockOut() {
    const tbody = document.querySelector('#stockOutBody tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('outSearch').value || '').trim().toLowerCase();

    products.forEach(p => {
        const name = p.name.toLowerCase();
        if((localSearch && !name.includes(localSearch)) || (globalSearch && !name.includes(globalSearch))) return;
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${escapeHtml(p.name)}</td>
                <td>${bal}</td>
                <td>${lastMovement(p.id,'OUT')}</td>
                <td><button class="btn out" onclick="openStockModal('${p.id}','OUT')">Remove</button></td>
            </tr>
        `);
    });
}

function renderCombinedHistory() {
    const tbody = document.querySelector('#historyTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const globalSearch = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
    const localSearch = (document.getElementById('historySearch').value || '').trim().toLowerCase();

    stockMovements.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m => {
        const prod = products.find(p => p.id === m.productId);
        if(!prod) return;
        const name = prod.name.toLowerCase();
        const cat = (prod.category||'').toLowerCase();
        if((localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) ||
           (globalSearch && !name.includes(globalSearch) && !cat.includes(globalSearch))) return;

        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${fmtDate(m.date)}</td>
                <td>${escapeHtml(prod.name)}</td>
                <td>${m.type}</td>
                <td>${m.quantity}</td>
            </tr>
        `);
    });
}


// MODALS
let modalCurrent=null;
function openStockModal(productId,type){modalCurrent={productId,type};const prod=products.find(p=>p.id===productId);if(!prod)return;document.getElementById('modalProductName').textContent=prod.name;document.getElementById('modalProductBalance').textContent=computeBalance(productId);document.getElementById('modalQty').value='';document.getElementById('stockModal').style.display='flex';document.getElementById('modalSave').onclick=()=>{let qty=Number(document.getElementById('modalQty').value);if(qty<=0){alert('Invalid quantity');return;}if(type==='OUT'&&qty>computeBalance(productId)){alert('Quantity exceeds balance');return;}stockMovements.push({id:genId(),productId,type,quantity:qty,date:todayISO()});saveAll();closeModal();refreshAll();};}
function closeModal(){document.getElementById('stockModal').style.display='none';modalCurrent=null;}
function openHistory(productId){const modal=document.getElementById('historyModal');modal.style.display='flex';const tbody=document.getElementById('modalHistoryBody');tbody.innerHTML='';stockMovements.filter(m=>m.productId===productId).sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m=>{tbody.insertAdjacentHTML('beforeend',`<tr><td>${fmtDate(m.date)}</td><td>${m.type}</td><td>${m.quantity}</td></tr>`);});}
function closeHistoryModal(){document.getElementById('historyModal').style.display='none';}
function stockInHistoryModal(){const modal=document.getElementById('stockInHistoryModal');modal.style.display='flex';const tbody=document.getElementById('stockInHistoryPopupBody');tbody.innerHTML='';stockMovements.filter(m=>m.type==='IN').sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m=>{const prod=products.find(p=>p.id===m.productId);if(!prod)return;tbody.insertAdjacentHTML('beforeend',`<tr><td>${fmtDate(m.date)}</td><td>${escapeHtml(prod.name)}</td><td>${m.quantity}</td></tr>`);});}
function closeStockInHistory(){document.getElementById('stockInHistoryModal').style.display='none';}
function stockOutHistoryModal(){const modal=document.getElementById('stockOutHistoryModal');modal.style.display='flex';const tbody=document.getElementById('stockOutHistoryPopupBody');tbody.innerHTML='';stockMovements.filter(m=>m.type==='OUT').sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(m=>{const prod=products.find(p=>p.id===m.productId);if(!prod)return;tbody.insertAdjacentHTML('beforeend',`<tr><td>${fmtDate(m.date)}</td><td>${escapeHtml(prod.name)}</td><td>${m.quantity}</td></tr>`);});}
function closeStockOutHistory(){document.getElementById('stockOutHistoryModal').style.display='none';}

// NAV
document.querySelectorAll('.menu-title.collapsible').forEach(m=>{m.addEventListener('click',()=>{m.classList.toggle('open');m.nextElementSibling.classList.toggle('open');});});
document.querySelectorAll('.submenu').forEach(sm=>{sm.addEventListener('click',()=>{const page=sm.dataset.page;const action=sm.dataset.action;if(page){document.querySelectorAll('.page').forEach(p=>p.style.display='none');document.getElementById(page).style.display='block';refreshAll();}if(action){window[action]?.();}});});

// ADD PRODUCT
document.getElementById('addProductBtn').addEventListener('click',()=>{const name=document.getElementById('newName').value.trim();const cat=document.getElementById('newCategory').value.trim();const threshold=Number(document.getElementById('newThreshold').value||5);if(!name)return alert('Enter product name');products.push({id:genId(),name:name,category:cat,threshold});saveAll();document.getElementById('newName').value='';document.getElementById('newCategory').value='';document.getElementById('newThreshold').value='';refreshAll();});

// SEARCHES
document.getElementById('productSearch').addEventListener('input',renderProductsTable);
document.getElementById('inSearch').addEventListener('input',renderStockIn);
document.getElementById('outSearch').addEventListener('input',renderStockOut);
document.getElementById('historySearch').addEventListener('input',renderCombinedHistory);
document.getElementById('globalSearch').addEventListener('input',()=>{renderDashboard();renderProductsTable();renderStockIn();renderStockOut();renderCombinedHistory();});
document.getElementById('categoryFilter').addEventListener('change', () => {
    renderDashboard();
});document.getElementById('globalThreshold').addEventListener('input',renderDashboard);

// EXPORT / IMPORT
function exportExcel(){const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(products.map(p=>({Name:p.name,Category:p.category,Threshold:p.threshold,Balance:computeBalance(p.id)})));XLSX.utils.book_append_sheet(wb,ws,'Products');XLSX.writeFile(wb,'products.xlsx');}
function importExcel(){const inp=document.createElement('input');inp.type='file';inp.accept='.xlsx,.xls';inp.onchange=()=>{const f=inp.files[0];const reader=new FileReader();reader.onload=e=>{const data=new Uint8Array(e.target.result);const wb=XLSX.read(data,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];const json=XLSX.utils.sheet_to_json(ws);json.forEach(p=>{if(p.Name)products.push({id:genId(),name:p.Name,category:p.Category||'',threshold:p.Threshold||5});});saveAll();refreshAll();};reader.readAsArrayBuffer(f);};inp.click();}
function exportPDF(){const { jsPDF } = window.jspdf;const doc=new jsPDF();doc.autoTable({head:[['#','Name','Category','Balance','Threshold']],body:products.map((p,i)=>[i+1,p.name,p.category,computeBalance(p.id),p.threshold])});doc.save('products.pdf');}

function printStockReport() {
    const bannerUrl = 'banner.png'; // your banner image
    const productsData = products.map((p, i) => {
        return `<tr>
            <td>${i+1}</td>
            <td>${escapeHtml(p.name)}</td>
            <td>${computeBalance(p.id)}</td>
                    </tr>`;
    }).join('');

    const html = `
    <html>
    <head>
        <title>RAW Stock Report</title>
        <style>
            @media print {
                body {
                    margin: 0;
                    -webkit-print-color-adjust: exact;
                }
                img.bg {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 80%;
                    opacity: 0.3;
                    z-index: -1;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    background: transparent !important;
                    position: relative;
                    z-index: 1;
                }
                th, td {
                    padding: 10px;
                    border: 1px solid rgba(0,0,0,0.2);
                    background: transparent !important;
                }
                h2 {
                    text-align: center;
                    position: relative;
                    z-index: 1;
                }
            }
        </style>
    </head>
    <body>
        <img class="bg" src="${bannerUrl}" />
        <h2>RAW Stock Report</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    
                    <th>Balance</th>
                   
                </tr>
            </thead>
            <tbody>
                ${productsData}
            </tbody>
        </table>
    </body>
    </html>`;

    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
}


// EDIT PRODUCT
function editProduct(productId){
    const prod = products.find(p => p.id === productId);
    if(!prod) return;
    const newName = prompt("Edit product name:", prod.name);
    if(newName === null) return; // Cancel
    const newCategory = prompt("Edit category:", prod.category || "");
    if(newCategory === null) return; // Cancel
    const newThreshold = prompt("Edit threshold:", prod.threshold || 5);
    if(newThreshold === null || isNaN(Number(newThreshold))) return alert("Invalid threshold");
    
    prod.name = newName.trim();
    prod.category = newCategory.trim();
    prod.threshold = Number(newThreshold);
    saveAll();
    refreshAll();
}

// DELETE PRODUCT
function deleteProduct(productId){
    if(!confirm("Are you sure you want to delete this product? This will remove all its stock history.")) return;
    products = products.filter(p => p.id !== productId);
    stockMovements = stockMovements.filter(m => m.productId !== productId);
    saveAll();
    refreshAll();
}
/* ==========================
   ‚òÅÔ∏è CLOUD SYNC MODULE
========================== */

/* üî¥ REPLACE WITH YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBTtsOeQTpPwTEn_T9EDqt5i_0eyQuzGOA",
  authDomain: "stock-manager-703e6.firebaseapp.com",
  databaseURL: "https://stock-manager-703e6-default-rtdb.firebaseio.com",
  projectId: "stock-manager-703e6",
  storageBucket: "stock-manager-703e6.firebasestorage.app",
  messagingSenderId: "778548519096",
  appId: "1:778548519096:web:716f903fee993f4d85544d",
  measurementId: "G-G735N8XCQ2"
};

firebase.initializeApp(firebaseConfig);
const cloudDB = firebase.database(); // Use the same variable as in your functions
window.cloudDB = cloudDB;  
console.log("‚úÖ Firebase initialized");
/* --------------------------
   UPLOAD LOCAL ‚Üí CLOUD
-------------------------- */
function pushToCloud() {
  cloudDB.ref("stockManager").set({
    products: products,
    stockMovements: stockMovements,
    syncedAt: new Date().toISOString()
  })
  .then(() => {
    document.getElementById("status").textContent = "Status: Synced to Cloud ‚òÅÔ∏è";
    alert("Data uploaded to cloud successfully");
  })
  .catch(err => alert("Cloud upload failed: " + err.message));
}

/* --------------------------
   DOWNLOAD CLOUD ‚Üí LOCAL
-------------------------- */
function pullFromCloud() {
  cloudDB.ref("stockManager").once("value")
  .then(snapshot => {
    const data = snapshot.val();
    if (!data) return alert("No cloud data found");

    products = data.products || [];
    stockMovements = data.stockMovements || [];

    localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
    localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements));

    refreshAll(); // Keep your balance, stock in/out, and dashboard updates intact
    document.getElementById("status").textContent = "Status: Loaded from Cloud ‚¨áÔ∏è";
    alert("Cloud data loaded successfully");
  })
  .catch(err => alert("Cloud download failed: " + err.message));
}


// UTILITY
function refreshAll(){renderDashboard();renderProductsTable();renderStockIn();renderStockOut();renderCombinedHistory();populateCategoryFilter();}
refreshAll();
</script>

</main>
</div>
</body>
</html>
