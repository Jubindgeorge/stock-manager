<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stock Manager</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<!-- ‚òÅÔ∏è CLOUD SYNC ADDITION -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --sidebar-w: 260px;
  --muted: #6b6f76;
  --accent: #2c3e50;
  --accent-2: #2980b9;
  --danger: #c0392b;
  --badge-green: #2ecc71;
}

/* Reset & base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, system-ui, Arial, sans-serif;
  color: #111;
  background: transparent;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-position: center center;
  background-repeat: no-repeat;
  background-size: 750px auto;
  background-attachment: fixed;
  opacity: 1;
  z-index: -1;
  pointer-events: none;
}

/* App layout */
.app {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: var(--sidebar-w);
  position: fixed;
  left: 0;
  top: 0;
  height: 100%;
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(5px);
  padding: 8px;
  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.08);
  overflow: auto;
  z-index: 20;
  border-right: 1px solid rgba(0, 0, 0, 0.04);
  border-radius: 0 10px 10px 0;
}

.sidebar.minimized {
  width: 60px;
  overflow: hidden;
  padding: 8px 4px;
  border-radius: 0 10px 10px 0;
  transition: width 0.3s ease;
}

.sidebar.minimized .sidebar-header div,
.sidebar.minimized .brand-title,
.sidebar.minimized .brand-sub,
.sidebar.minimized .sidebar-logo,
.sidebar.minimized .sidebar-menu,
.sidebar.minimized .sidebar-menu li span,
.sidebar.minimized .sidebar-footer {
  display: none;
}

.sidebar.minimized .sidebar-logo {
  width: 40px;
  height: 40px;
}

.sidebar-header {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 8px;
}

.sidebar-logo {
  width: 96px;
  height: 56px;
  object-fit: cover;
  border-radius: 8px;
}

.brand-title {
  font-size: 18px;
  margin: 0;
}

.brand-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

.sidebar-menu {
  list-style: none;
  padding: 0;
  margin: 12px 0 0;
}

.sidebar-menu li {
  padding: 12px 10px;
  display: flex;
  gap: 10px;
  align-items: center;
  cursor: pointer;
  border-left: 4px solid transparent;
  border-radius: 6px;
  transition: all 0.18s;
  color: #222;
}

.sidebar-menu li:hover {
  background: rgba(60, 120, 200, 0.06);
  transform: translateX(4px);
  border-left-color: rgba(41, 128, 185, 0.8);
}

.sidebar-menu li.active {
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: #fff;
  border-left-color: #fff;
  font-weight: 700;
}
.sidebar.minimized + .main {
    margin-left: 60px;
}

.menu-title {
  font-weight: 700;
  background: rgba(0, 0, 0, 0.05);
}
.modal-box{
background-color:white; 
padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.08);

}  
.menu-title.collapsible {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.menu-title span.arrow {
  display: inline-block;
  font-size: 12px;
  transition: transform 0.2s ease;
}

.menu-title.open .arrow {
  transform: rotate(180deg);
}

.submenu {
  padding-left: 36px !important;
  font-size: 14px;
}

.subgroup {
  list-style: none;
  padding: 0;
  margin: 0;
  display: none;
}

.subgroup.open {
  display: block;
}

.sidebar-footer {
  margin-top: 18px;
  font-size: 13px;
  color: var(--muted);
}

.admin-only {
  display: none;
}

/* Main content */
.main {
  margin-left: calc(var(--sidebar-w) + 18px);
  width: 70%;
  padding: 18px;
  min-height: 100vh;
  background: transparent;
  transition: margin-left 0.3s ease;
}

.main.sidebar-minimized {
  margin-left: 60px;
}

.top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.search {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.08);
  width: 320px;
  background: rgba(255, 255, 255, 0.55);
}
.small {
    padding: 8px 10px;
    border-radius: 8px;
    border: 2px solid rgba(0, 0, 0, 0.08);
    width: 220px;
    background: rgba(255, 255, 255, 0.66);
}
.btn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}

.btn.secondary {
  background: var(--accent-2);
}

.btn.out {
  background: #dc2626;
}

.btn.info {
  background: #16a34a;
}

/* Pages & tables */
.page {
  background: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(5px);
  border-radius: 12px;
  width: 100%;
  min-height: calc(100vh - 40px);
  padding: 25px;
  border: 1px solid rgba(0, 0, 0, 0.05);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 10px;
  text-align: left;
}

th {
  background: #007bff;
  font-weight: 700;
}

.low-stock {
  color: var(--danger);
  font-weight: 700;
}

.balance-qty {
  font-weight: bold;
}

/* Modals */
.modal-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal {
  background: white;
  padding: 20px;
  border-radius: 12px;
  max-height: 80%;
  overflow-y: auto;
  width: 500px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  justify-content:center;
  align-items:center; z-index:2000;
}


.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.modal-close {
  cursor: pointer;
  background: none;
  border: none;
  font-size: 18px;
}

.modal-table {
  width: 100%;
  border-collapse: collapse;
}

.modal-table th,
.modal-table td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

/* Print styling */
@media print {
  body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .print-bg {
    background-image: url('banner.png') !important;
    background-size: cover !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
  }
}
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #16a34a; /* green for success */
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    font-weight: bold;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.toast.out {
    background-color: #dc2626; /* red for stock OUT if needed */
}
.dashboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  margin-top:15px;
}

.dash-card{
  background:#fff;
  border-radius:8px;
  padding:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  text-align:center;
}
.dash-card h3{
  font-size:14px;
  color:#555;
}
.dash-card div{
  font-size:28px;
  font-weight:700;
  margin-top:6px;
}


</style>
</head>

<body>
<div id="loginScreen" style="position:fixed; inset:0; background:#f3f4f6;
display:flex; align-items:center; justify-content:center; z-index:99999;">
  <div style="width:350px; background:white; padding:25px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15)">
    <h2 style="text-align:center">Stock Manager</h2>
    
    <div id="loginForm">
      <input id="loginUser" placeholder="Username" style="width:100%;padding:8px 10px;margin:10px 0;border: 1px solid rgba(0, 0, 0, 0.08);">
      <input id="loginPass" type="password" placeholder="Password" style="width:100%;padding:8px 10px;margin:10px 0;border: 1px solid rgba(0, 0, 0, 0.08);">
      <button class="btn" style="width:100%;" onclick="login()">Login</button>
      <p style="text-align:center;margin:10px 0;">Don't have an account? <span style="color:blue;cursor:pointer;" onclick="showSignup()">Sign Up</span></p><p style="text-align:center;margin:10px 0;">
    <span style="color:blue;cursor:pointer;" onclick="forgotPassword()">Forgot Password?</span>
</p>

      <p id="loginMsg" style="color:red;text-align:center;margin-top:10px"></p>
    </div>

    <div id="signupForm" style="display:none">
      <input id="signupUser" placeholder="Username" style="width:90%;padding:10px;margin:10px 0">
      <input id="signupPass" type="password" placeholder="Password" style="width:90%;padding:10px;margin-bottom:10px">
      <select id="signupRole" style="width:100%;padding:10px;margin-bottom:10px">
        <option value="user">User</option>
              </select>
      <button class="btn" style="width:98%" onclick="signup()">Create Account</button>
      <p style="text-align:center;margin:10px 0;">Already have an account? <span style="color:blue;cursor:pointer;" onclick="showLogin()">Login</span></p>

      <p id="signupMsg" style="color:red;text-align:center;margin-top:10px"></p>

    </div>

  </div>
</div>


<div class="app">
<aside id="sidebar" class="sidebar">
<div class="sidebar-header">
    <img src="banner.png" class="sidebar-logo" onerror="this.style.display='none'">
    <div>
        <div class="brand-title">STOCK</div>
        <div class="brand-sub">Inventory ‚Ä¢ Public Sheet</div>
    </div>
    <button id="sidebarToggle" class="btn secondary" style="margin-left:auto;padding:4px 6px;font-size:14px">‚Üê</button>
</div>


<ul class="sidebar-menu" id="menu">

<li id="usersMenu" class="menu-title collapsible admin-only">
  üë• Users <span class="arrow">‚ñæ</span>
</li>
<ul class="subgroup admin-only">
  <li class="submenu" data-page="userManagement">Manage Users</li>
</ul>
<li class="menu-title collapsible" data-page="dashboardPage">üìä Dashboard<span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="dashboardPage">üìäDashboard</li>

</ul>
<li class="menu-title collapsible" data-page="dashboard">üìä Bill Of Materials<span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="dashboard">üìäBOM</li>

</ul>
<li class="menu-title collapsible">üìà Store <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="products">üì¶  RM List</li>
  <li class="submenu admin-only" data-page="rmAddProduct">‚ûï Add RM Product</li>
<li class="submenu" data-page="stockIn">‚¨Ü RM Stock In</li>
<li class="submenu" data-page="stockOut">‚¨á RM Stock Out</li>
</ul>

 <li class="menu-title collapsible">üßæ FG <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
  <li class="submenu" data-page="fgStock">üì¶ FG Stock List</li>
<li class="submenu admin-only" data-page="fgAddProduct">‚ûï Add FG Product</li>
  <li class="submenu" data-page="fgStockIn">‚¨Ü FG Stock In</li>
  <li class="submenu" data-page="fgStockOut">‚¨á FG Stock Out</li>
</ul>


 <li class="menu-title collapsible">üßæ Suppliers <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
     <li class="submenu" data-page="suppliers">üìã Manage Raw Suppliers</li>
</ul>

            
<li class="menu-title collapsible">üíæ Report <span class="arrow">‚ñæ</span></li>
<ul class="subgroup">
<li class="submenu" data-page="history">üìö RM History</li>
<li class="submenu" data-action="importExcel">üì• Import Excel</li>
<li class="submenu" data-action="exportExcel">üì§ Export Excel</li>
<li class="submenu" data-action="printStockReport">üñ®Ô∏è Print Stock Report</li>
<li class="submenu" data-action="exportPDF">üìÑ Export PDF</li>
</ul>
<div class="sidebar-footer">Data stored locally; cloud optional.</div>
</ul>
</aside>

<main class="main">
<button onclick="logout()" class="btn out" style="position:fixed;top:10px;right:20px;z-index:999">Logout</button>
<section id="userManagement" class="page" style="display:none">
  <h2>Manage Users</h2>
  <table id="usersTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Username</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:12px;">
    <input id="newUsername" placeholder="Username">
    <input id="newPassword" type="password" placeholder="Password">
    <select id="newRole">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <button class="btn admin-only" onclick="addUser()">Add User</button>
  </div>
</section>

<section id="dashboard" class="page" style="display:block">
<h2>Bill Of Materials</h2>
<div class="top">
<div class="dash-search">
   <input type="text" id="dashboardSearch" class="search" placeholder="Search product..."
       oninput="handleDashboardSearch(this.value)">

</div></div>
<div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
<div style="overflow:auto">
<table id="dashTable">
<thead>
<tr>
    <th>Product </th>
 <th>Balance</th>
   <th>threshold</th>
<th>Last IN</th><th>Last OUT</th>
    <th colspan="3">Actions</th>
   

</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>


<div id="dashboardPage" class="page" style="display:none">

<div class="dashboard-grid">

  <div class="dash-card">
    <h3>Total RM Products</h3>
    <div id="dashTotalProducts">0</div>
  </div>

  <div class="dash-card">
    <h3>Total RM Stock</h3>
    <div id="dashTotalStock">0</div>
  </div>

  <div class="dash-card">
    <h3>Low Stock Items</h3>
    <div id="dashLowStock">0</div>
  </div>

  <div class="dash-card">
    <h3>Total FG Balance</h3>
    <div id="dashFGBalance">0</div>
  </div>

  <div class="dash-card">
    <h3>FG Products</h3>
    <div id="dashFGTotalProducts">0</div>
  </div>

  <div class="dash-card">
    <h3>Low FG Stock</h3>
    <div id="dashFGLowStock">0</div>
  </div>

  <div class="dash-card">
    <h3>Max FG Balance</h3>
    <div id="dashFGMaxBalance">-</div>
  </div>

  <div class="dash-card">
    <h3>Min FG Balance</h3>
    <div id="dashFGMinBalance">-</div>
  </div>

</div>
<div>
<canvas id="fgStockChart" width="400" height="200"></canvas>
</div>
</div>




<section id="fgStock" class="page" style="display:none">
  <h2>Finished Goods Stock</h2>
  <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
    <input id="fgSearch" class="search" placeholder="Search FG products...">
  </div>
  <div style="overflow:auto; height: calc(100% - 140px);">
    <table id="fgTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Product</th>
          <th>Volume</th>
          <th>Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Modal for daily stock -->
<div id="fgModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;max-height:80%;overflow:auto; width:90%;">
    <h3 id="fgModalTitle">Product Stock Details</h3>
    <table id="modalTable">
      <thead>
        <tr id="modalHead"></tr>
      </thead>
      <tbody id="modalBody"></tbody>
    </table>
    <button onclick="document.getElementById('fgModal').style.display='none'">Close</button>
  </div>
</div>

<!-- PRODUCTS -->
<section id="products" class="page" style="display:none">
  <h2>Raw Material List</h2>

  <div style="margin-bottom:12px">
    <input id="productSearch" class="search" placeholder="Search products...">
  </div>

  <div style="overflow:auto;height:calc(100% - 120px)">
    <table id="productsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Code</th>
          <th>Name</th>
          <th>Category</th>
          <th>Balance</th>
          <th>Threshold</th>
          <th>Barcode</th>
          <th>History</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<section id="rmAddProduct" class="page" style="display:none">
  <h2>Add Raw Material Product</h2>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px">
    <input id="newCode" class="small" placeholder="Product Code">
    <input id="newName" class="small" placeholder="Product Name">
    <input id="newCategory" class="small" placeholder="Category">
    <input id="newThreshold" class="small" type="number" placeholder="Low Stock Threshold">
    <input id="newBarcode" class="small" placeholder="Barcode">
    <input id="newGroups" class="small" placeholder="Groups (comma separated)">
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="newExclusive"> Exclusive to first group
    </label>
  </div>

  <button class="btn admin-only" onclick="addRMProduct()">Add Product</button>
</section>


<!-- STOCK IN -->
<section id="stockIn" class="page" style="display:none">
<h2>Stock In</h2>
<input id="inSearch" class="search" placeholder="Search product">
<button class="btn secondary" onclick="stockInHistoryModal()">View Stock IN History</button>
<table id="stockInBody">
<thead><tr><th>Product</th><th>Balance</th><th>Last IN</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- STOCK OUT -->
<section id="stockOut" class="page" style="display:none">
<h2>Stock Out</h2>
<input id="outSearch" class="search" placeholder="Search product">
<button class="btn info" onclick="stockOutHistoryModal()">View Stock OUT History</button>
<table id="stockOutBody">
<thead><tr><th>Product</th><th>Balance</th><th>Last OUT</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- COMBINED HISTORY -->
<section id="history" class="page" style="display:none">
<h2>Combined History</h2>
<div style="margin-bottom:12px">
<input id="historySearch" class="search" placeholder="Search combined history...">
</div>
<div style="overflow:auto; height: calc(100% - 120px);">
<table id="historyTable"><thead><tr>
  <th>Date</th><th>Product</th><th>Type</th><th>Qty</th><th>Remark</th>
</tr>
</thead><tbody></tbody></table>
</div>
</section>
 <!-- SUPPLIERS PAGE -->
        <section id="suppliers" class="page" style="display:none">
            <h2>Raw Material Suppliers</h2>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
                <input id="newSupplierName" class="small" placeholder="Supplier Name">
                <input id="newSupplierContact" class="small" placeholder="Contact Info">
                <button id="addSupplierBtn" class="btn">Add Supplier</button>
            </div>
            <div style="margin-bottom:12px">
                <input id="supplierSearch" class="search" placeholder="Search suppliers...">
            </div>
            <div style="overflow:auto; height: calc(100% - 150px);">
                <table id="suppliersTable">
                    <thead><tr><th>#</th><th>Name</th><th>Contact</th><th>Edit</th><th>Delete</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
<!-- MODALS -->
<div id="historyModal" class="modal-backdrop">
<div class="modal-box">
<div class="modal-header">
<h3 id="modalTitle">Product History</h3>
<button onclick="closeHistoryModal()" class="modal-close">‚úñ</button>
</div>
<div class="modal-body">
<table class="modal-table"><thead>
  <tr>
    <th>Date</th>
    <th>Product</th>   <!-- ‚úÖ NAME ADDED -->
    <th>Type</th>
    <th>Qty</th>
    <th>Batch</th>
    <th>Expiry</th>
    <th>Remark</th>
  </tr>
</thead>

<tbody id="modalHistoryBody"></tbody></table>
</div>
</div>
</div>

<div id="stockInHistoryModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3>Stock IN History</h3><button onclick="closeStockInHistory()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Remark</th></tr>
</thead>
<tbody id="stockInHistoryPopupBody"></tbody>
</table>
</div>
</div>
</div>

<div id="stockOutHistoryModal" class="modal-backdrop">
<div class="modal">
<div class="modal-header"><h3>Stock OUT History</h3><button onclick="closeStockOutHistory()" class="modal-close">‚úñ</button></div>
<div class="modal-body">
<table class="modal-table"><thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Remark</th></tr>
</thead>
<tbody id="stockOutHistoryPopupBody"></tbody>
</table>
</div>
</div>
</div>

<!-- Stock Modal -->
<div id="stockModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalProductName">Product Name</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>

    <p>Balance: <span id="modalProductBalance" style="font-weight:bold;">0</span>  PCS</p>

    <div class="modal-inputs" style="padding:10px;">
      <input id="modalQty" class="small" type="number"  placeholder="Enter quantity">
      <input id="modalRemark" class="small"  placeholder="Enter remark (optional)"></input>
    </div>

    <div  style="padding:10px;" class="modal-actions">
      <button id="modalSave" class="btn">Submit</button>
      <button onclick="closeModal()" class="btn secondary">Close</button>
    </div>
  </div>
</div>

<!-- Success Toast -->
<div id="stockToast" class="toast" style="display:none;"></div>

<section id="fgStockIn" class="page" style="display:none">
  <h2>FG Stock In</h2>

  <input id="fgInSearch" class="search" placeholder="Search FG product...">
<button class="btn secondary" onclick="fgStockInHistoryModal()">
  View FG IN History
</button>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Product</th>
        <th>Balance</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="fgStockInBody"></tbody>
  </table>
</section>
<section id="fgStockOut" class="page" style="display:none">
  <h2>FG Stock Out</h2>

  <input id="fgOutSearch" class="search" placeholder="Search FG product...">
<button class="btn info" onclick="fgStockOutHistoryModal()">
  View FG OUT History
</button>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Product</th>
        <th>Balance</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="fgStockOutBody"></tbody>
  </table>
</section>
<section id="fgAddProduct" class="page" style="display:none">
  <h2>Add Finished Goods Product</h2>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px">
    <input id="fgNewName" class="small" placeholder="Product Name">
<input id="fgNewVolume" class="small" placeholder="Volume / Size">
<input id="fgNewGroup" class="small" placeholder="Group Prefix (ALKHOR)">
<input id="fgNewBatch" class="small" placeholder="Batch / Lot No">
<input id="fgNewExpiry" class="small" type="date">
<input id="fgNewThreshold" class="small" type="number" placeholder="Low Stock Threshold">
</div>

  <button class="btn" onclick="addFGProduct()">Add FG Product</button>

  <hr style="margin:20px 0">

 
</section>

<script>


let currentUser = null;
const savedUser = localStorage.getItem('sms_currentUser');
if (savedUser) {
    currentUser = JSON.parse(savedUser);
    document.getElementById('loginScreen').style.display = 'none';
    document.querySelector('.app').style.display = 'flex';
}


/* üî¥ REPLACE WITH YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBTtsOeQTpPwTEn_T9EDqt5i_0eyQuzGOA",
  authDomain: "stock-manager-703e6.firebaseapp.com",
  databaseURL: "https://stock-manager-703e6-default-rtdb.firebaseio.com",
  projectId: "stock-manager-703e6",
  storageBucket: "stock-manager-703e6.firebasestorage.app",
  messagingSenderId: "778548519096",
  appId: "1:778548519096:web:716f903fee993f4d85544d",
  measurementId: "G-G735N8XCQ2"
};

firebase.initializeApp(firebaseConfig);
const cloudDB = firebase.database(); // Use the same variable as in your functions
window.cloudDB = cloudDB;  
console.log("‚úÖ Firebase initialized");
loadRenamedGroupsFromCloud();


async function ensureAdminExists() {
    try {
        const snapshot = await cloudDB.ref('users').orderByChild('role').equalTo('admin').once('value');
        if(!snapshot.exists()) {
            const userId = 'admin_' + Date.now().toString(36);
            await cloudDB.ref('users/' + userId).set(DEFAULT_ADMIN);
            console.log("Default admin created");
        } else {
            console.log("Admin already exists");
        }
    } catch(err) {
        console.error("Error checking/creating admin:", err);
    }
}

// Call this on app load
ensureAdminExists();



function applyPermissions() {
    if (!currentUser) return;

    const isAdmin = currentUser.role === 'admin';

    document.querySelectorAll('.admin-only').forEach(el => {
        // Use inline-block to make buttons appear properly
        el.style.display = isAdmin ? 'inline-block' : 'none';
    });

    // Protect admin-only pages
    if (!isAdmin && document.getElementById('userManagement').style.display === 'block') {
        document.getElementById('userManagement').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
    }
}

/* ==========================
   üîê ADVANCED LOGIN SYSTEM
========================== */
const DEFAULT_ADMIN = {
    username: "admin",
    password: "admin123",  // change this after first login
    role: "admin",
    createdAt: new Date().toISOString()
};


// Show forms
function showSignup(){ loginForm.style.display='none'; signupForm.style.display='block'; loginMsg.textContent=''; }
function showLogin(){ loginForm.style.display='block'; signupForm.style.display='none'; signupMsg.textContent=''; }

const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const loginMsg = document.getElementById('loginMsg');
const signupMsg = document.getElementById('signupMsg');

async function signup() {
  const u = signupUser.value.trim();
  const p = signupPass.value;
  const role = signupRole.value;

  if(!u || !p) { signupMsg.textContent="Enter username & password"; return; }

  try {
    const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(snapshot.exists()){ signupMsg.textContent="Username already taken"; return; }

    const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
    await cloudDB.ref('users/'+userId).set({username:u,password:p,role,createdAt:new Date().toISOString()});

    signupMsg.style.color="green"; signupMsg.textContent="Account created! Please login.";
    showLogin();
  } catch(err){
    console.error(err);
    signupMsg.textContent="Signup failed";
  }
}

async function login() {
  const u = loginUser.value.trim();
  const p = loginPass.value;

  if(!u || !p){ loginMsg.textContent="Enter username & password"; return; }

  try {
    const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(!snapshot.exists()){ loginMsg.textContent="Invalid login"; return; }

    const userData = Object.values(snapshot.val())[0]; // get first match
    if(userData.password !== p){ loginMsg.textContent="Invalid login"; return; }

    currentUser = userData;
    localStorage.setItem('sms_currentUser', JSON.stringify(currentUser));

    loginScreen.style.display='none';
    document.querySelector('.app').style.display='flex';
    applyPermissions();

    // Show Users page automatically if admin
    if(currentUser.role === 'admin') {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('userManagement').style.display = 'block';
        renderUsersTable();
    }

  } catch(err){
    console.error(err);
    loginMsg.textContent="Login failed";
  }
document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
document.getElementById('dashboardPage').style.display = 'block';
renderDashboardGrouped();
}

function logout(){
  localStorage.removeItem('sms_currentUser');
  location.reload();
}

async function addUser() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value;
    const role = document.getElementById('newRole').value;

    if(!username || !password) {
        alert("Enter username and password");
        return;
    }

    try {
        // Check if username exists
        const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
        if(snapshot.exists()) {
            alert("Username already taken");
            return;
        }

        const userId = 'u_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000);
        await cloudDB.ref('users/' + userId).set({
            username,
            password,
            role,
            createdAt: new Date().toISOString()
        });

        alert("User added successfully!");
        // Optionally, clear inputs
        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';

        // Refresh users table if you have a function for that
        renderUsersTable();

    } catch(err) {
        console.error(err);
        alert("Failed to add user");
    }
}

async function forgotPassword() {
    const username = prompt("Enter your username to reset password:");
    if(!username || !username.trim()) return;

    try {
        const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(username.trim()).once('value');
        if(!snapshot.exists()){
            alert("Username not found");
            return;
        }

        const userId = Object.keys(snapshot.val())[0];
        const userData = snapshot.val()[userId];

        // For simplicity, we just ask for a new password
        const newPass = prompt(`Enter new password for "${userData.username}":`);
        if(!newPass || !newPass.trim()) return alert("Password cannot be empty");

        await cloudDB.ref('users/' + userId + '/password').set(newPass.trim());
        alert("Password successfully reset. You can now login with the new password.");
    } catch(err){
        console.error(err);
        alert("Failed to reset password");
    }
}

// Delete a user (cannot delete admin)
async function deleteUser(username) {
    if(!confirm(`Are you sure you want to delete "${username}"?`)) return;

    try {
        const snapshot = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
        if(!snapshot.exists()) return alert("User not found");

        const userId = Object.keys(snapshot.val())[0];
        const userData = snapshot.val()[userId];

        if(userData.role === 'admin') return alert("Cannot delete admin");

        await cloudDB.ref('users/' + userId).remove();
        alert("User deleted successfully!");
        renderUsersTable(); // refresh table
    } catch(err) {
        console.error(err);
        alert("Failed to delete user");
    }
}

// Render users table
async function renderUsersTable() {
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    const snapshot = await cloudDB.ref('users').once('value');
    const users = snapshot.val() ? Object.values(snapshot.val()) : [];

    users.forEach((u,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${u.username}</td>
            <td>${u.role}</td>
<td>
  ${u.role !== 'admin' && currentUser.role==='admin' ? `<button class="btn out" onclick="deleteUser('${u.username}')">Delete</button>` : ''}
</td>
        `;
        tbody.appendChild(tr);
    });
}


// FULL JS LOGIC START
const KEY_GROUP_ALIASES = 'sms_group_aliases_v1';
let groupAliases = JSON.parse(localStorage.getItem(KEY_GROUP_ALIASES) || '{}');

function saveGroupAliases() {
    localStorage.setItem(KEY_GROUP_ALIASES, JSON.stringify(groupAliases));
}

const KEY_PRODUCTS = 'sms_products_final_v1';
const KEY_MOVES    = 'sms_movements_final_v1';

let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
let stockMovements = JSON.parse(localStorage.getItem(KEY_MOVES) || '[]');

if (!products.length) {
    products = [
        {id:'p1', name:'Product A', category:'Cat1', threshold:5, groups:['Group1'], exclusive:true},
        {id:'p2', name:'Product B', category:'Cat1', threshold:10, groups:['Group1','Group2'], exclusive:false},
        {id:'p3', name:'Product C', category:'Cat2', threshold:8, groups:['Group2'], exclusive:true},
        {id:'p4', name:'Product D', category:'Cat2', threshold:7, groups:['Group2','Group3'], exclusive:false},
        {id:'p5', name:'Product E', category:'Cat3', threshold:12, groups:['Group3'], exclusive:true}
    ];

    stockMovements = [
        {id:genId(), productId:'p1', type:'IN',  quantity:20,  date:todayISO()},
        {id:genId(), productId:'p2', type:'IN',  quantity:15,  date:todayISO()},
        {id:genId(), productId:'p3', type:'IN',  quantity:100, date:todayISO()}
    ];

    saveAll();
}

function saveAll(){localStorage.setItem(KEY_PRODUCTS,JSON.stringify(products));localStorage.setItem(KEY_MOVES,JSON.stringify(stockMovements));document.getElementById('status')&&(document.getElementById('status').textContent='Status: Local saved');}
function genId(){return'id_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);}
function todayISO(){return new Date().toISOString().split('T')[0];}
function fmtDate(iso){if(!iso)return'-';const p=iso.split('-');return`${p[2]}/${p[1]}/${p[0]}`;}
function escapeHtml(s){if(s==null)return'';return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function computeBalance(productId){
    let bal=0;
    stockMovements.forEach(m=>{
        if(m.productId===productId){bal += m.type==='IN'? m.quantity : -m.quantity;}
    });
    return bal>0?bal:0;
}

function lastMovement(productId,type){
    const moves = stockMovements.filter(m=>m.productId===productId && m.type===type);
    if(!moves.length) return '-';
    return moves[moves.length-1].date;
}function populateCategoryFilter() {
    const catSelect = document.getElementById('categoryFilter');
    if(!catSelect) return;
    const cats = [...new Set(products.map(p=>p.category).filter(c=>c))];
    catSelect.innerHTML = '<option value="">All</option>';
    cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.toLowerCase();
        opt.textContent = c;
        catSelect.appendChild(opt);
    });
}


function normalizeGroup(g){
  return String(g || '')
    .trim()
    .toUpperCase()
    .replace(/\s+/g,'');
}

function getFGStock(groupName) {
    const key = normalizeGroup(groupName);
    let total = 0;

    fgProducts.forEach(fg => {
        if (normalizeGroup(fg.group) === key) {
            total += computeFGBalance(fg.id);
        }
    });

    return total;
}


// Render dashboard (products RAW only)
// Load renamed groups from localStorage
let renamedGroups = {};


// Save renamed groups to localStorage
function saveRenamedGroups() {
    localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
}
function searchDashboard() {
    const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase().trim();
    renderDashboardGrouped(searchTerm);
}
function handleDashboardSearch(value){
    dashboardSearchText = value.toLowerCase().trim();
    selectedDashboardGroup = null;
    renderDashboardGrouped();
}



let dashboardSearchText = "";
let selectedDashboardGroup = null;
let dashboardInitialized = false;

// Dashboard rendering

function renderDashboardGrouped(){

    const tbody = document.querySelector('#dashTable tbody');
    tbody.innerHTML = '';

    // Show nothing until user searches
    if (!dashboardSearchText && !selectedDashboardGroup) {
        dashboardInitialized = false;
        return;
    }

    const groupsMap = {};

    products.forEach(p=>{
        if(!Array.isArray(p.groups)) return;
        p.groups.forEach(g=>{
            if(!groupsMap[g]) groupsMap[g] = [];
            if(p.exclusive && p.groups[0] !== g) return;
            groupsMap[g].push(p);
        });
    });

    Object.keys(groupsMap).sort().forEach(groupName => {

        const displayName = renamedGroups[groupName] || groupName;

        const groupProducts = groupsMap[groupName].filter(p=>{
            const name = p.name.toLowerCase();
            const disp = displayName.toLowerCase();
            return name.includes(dashboardSearchText) || disp.includes(dashboardSearchText);
        });

        if(!groupProducts.length) return;

        // If one group is selected ‚Üí hide others
        if(selectedDashboardGroup && selectedDashboardGroup !== groupName) return;

        const fgBalance = getFGStock(groupName);

        const groupRow = document.createElement('tr');
        groupRow.innerHTML = `
            <td colspan="6" style="padding:18px;cursor:pointer"
                onclick="selectDashboardGroup('${groupName}')">
                <b>${displayName.toUpperCase()}</b>
                <span style="margin-left:50px;color:green;font-weight:bold">
                    FG BALANCE: ${fgBalance}
                </span>
                ${currentUser?.role === 'admin'
                  ? `<button style="margin-left:15px" onclick="event.stopPropagation(); renameGroup('${groupName}')">Rename</button>`
                  : ''}
            </td>
        `;
        tbody.appendChild(groupRow);

        // Only show products if this group is selected
        if(selectedDashboardGroup === groupName){
            groupProducts.forEach(p=>{
                const bal = computeBalance(p.id);
                tbody.insertAdjacentHTML('beforeend',`
                    <tr>
                        <td style="padding-left:25px">${p.name}</td>
                        <td>${bal}</td>
                        <td>${p.threshold}</td>
                        <td>${lastMovement(p.id,'IN')}</td>
                        <td>${lastMovement(p.id,'OUT')}</td>
                        <td>
                            <button class="btn secondary" onclick="openHistory('${p.id}')">View</button>
                            <button class="btn" onclick="openStockModal('${p.id}','IN')">Add IN</button>
                            <button class="btn" onclick="openStockModal('${p.id}','OUT')">Stock OUT</button>
                        </td>
                    </tr>
                `);
            });
        }

    });
}
let fgChartInstance = null; // Keep chart instance to update later

function renderMainDashboard() {
    // ----------------------------
    // Elements
    // ----------------------------
    const totalProductsEl = document.getElementById('dashTotalProducts');
    const totalStockEl = document.getElementById('dashTotalStock');
    const lowStockEl = document.getElementById('dashLowStock');
    const fgBalanceEl = document.getElementById('dashFGBalance');

    const fgTotalEl = document.getElementById('dashFGTotalProducts');
    const fgLowEl = document.getElementById('dashFGLowStock');
    const fgMaxEl = document.getElementById('dashFGMaxBalance');
    const fgMinEl = document.getElementById('dashFGMinBalance');
    const fgChartEl = document.getElementById('fgStockChart');

    if (!totalProductsEl || !totalStockEl || !lowStockEl || !fgBalanceEl) {
        console.warn('Dashboard elements not found!');
        return;
    }

    const safeProducts = Array.isArray(products) ? products : [];
    const safeFGProducts = Array.isArray(fgProducts) ? fgProducts : [];

    // ----------------------------
    // Main Products
    // ----------------------------
    totalProductsEl.textContent = safeProducts.length;

    let totalStock = 0;
    let lowStock = 0;

    safeProducts.forEach(p => {
        const bal = typeof computeBalance === 'function' ? computeBalance(p.id) : 0;
        const numericBal = Number(bal) || 0;
        totalStock += numericBal;
        if (numericBal <= (p.threshold ?? 5)) lowStock++;
    });
dashFGLowStock.textContent = getFGLowStockCount();

    totalStockEl.textContent = totalStock;
    lowStockEl.textContent = lowStock;

    // ----------------------------
    // Finished Goods Analysis
    // ----------------------------
const fgTotal = safeFGProducts.reduce(
  (sum, f) => sum + computeFGBalance(f.id),
  0
);
    fgBalanceEl.textContent = fgTotal;

    if (fgTotalEl) fgTotalEl.textContent = safeFGProducts.length;

    if (fgLowEl) {
       const lowFG = safeFGProducts.filter(
  f => computeFGBalance(f.id) <= (f.threshold ?? 5)
);

    }

    if (fgMaxEl) {
        const maxFG = safeFGProducts.reduce((max, f) => {
  const bal = computeFGBalance(f.id);
  return bal > max.balance ? { name: f.name, balance: bal } : max;
}, { name: '-', balance: 0 });
        fgMaxEl.textContent = `${maxFG.name} (${maxFG.balance})`;
    }

    if (fgMinEl) {
        const minFG = safeFGProducts.reduce((min, f) => {
  const bal = computeFGBalance(f.id);
  return bal < min.balance ? { name: f.name, balance: bal } : min;
}, { name: '-', balance: Infinity });
        fgMinEl.textContent = minFG.balance === Infinity ? '-' : `${minFG.name} (${minFG.balance})`;
    }

    // ----------------------------
    // FG Stock Chart
    // ----------------------------
    if (fgChartEl) {
        const labels = safeFGProducts.map(f => f.name);
        const data = safeFGProducts.map(f => Number(f.balance) || 0);

        const chartData = {
            labels: labels,
            datasets: [{
                label: 'FG Stock Balance',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };

        const chartOptions = {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            },
            scales: {
                y: { beginAtZero: true }
            }
        };

        // Destroy previous chart if exists
        if (fgChartInstance) fgChartInstance.destroy();

        fgChartInstance = new Chart(fgChartEl, {
            type: 'bar', // or 'pie'
            data: chartData,
            options: chartOptions
        });
    }
}

// Call after DOM is loaded
window.addEventListener('DOMContentLoaded', renderMainDashboard);


// Rename group **only for dashboard display**
function renameGroup(groupName){
    const newName = prompt('Enter new display name for "' + groupName + '"');
    if(!newName) return;

    renamedGroups[groupName] = newName;

    localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
    saveRenamedGroupsToCloud();   // ‚òÅÔ∏è SAVE TO CLOUD

    renderDashboardGrouped();
}

function saveRenamedGroupsToCloud(){
    cloudDB.ref('dashboardRenamedGroups').set(renamedGroups);
}

function loadRenamedGroupsFromCloud(){
    cloudDB.ref('dashboardRenamedGroups').on('value', snap=>{
        if(snap.exists()){
            renamedGroups = snap.val();
            localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
            renderDashboardGrouped();
        }
    });
}



// Add Supplier
const KEY_SUPPLIERS = 'sms_suppliers_v1';
let suppliers = JSON.parse(localStorage.getItem(KEY_SUPPLIERS) || '[]');

const addSupplierBtn = document.getElementById('addSupplierBtn');
if(addSupplierBtn){
    addSupplierBtn.addEventListener('click', () => {
        const name = document.getElementById('newSupplierName').value.trim();
        const contact = document.getElementById('newSupplierContact').value.trim();
        if(!name) return alert('Enter supplier name');

        suppliers.push({ id: genId(), name, contact });
        localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(suppliers));

        document.getElementById('newSupplierName').value = '';
        document.getElementById('newSupplierContact').value = '';

        renderSuppliersTable();
    });
}


// Render Suppliers Table
function renderSuppliersTable() {
    const tbody = document.querySelector('#suppliersTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const search = (document.getElementById('supplierSearch').value || '').trim().toLowerCase();
    suppliers.forEach((s,i) => {
        if(search && !s.name.toLowerCase().includes(search) && !s.contact.toLowerCase().includes(search)) return;
        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${i+1}</td>
                <td>${escapeHtml(s.name)}</td>
                <td>${escapeHtml(s.contact)}</td>
                <td><button class="btn secondary" onclick="editSupplier('${s.id}')">Edit</button></td>
                <td><button class="btn secondary" onclick="deleteSupplier('${s.id}')">Delete</button></td>
            </tr>
        `);
    });
}

// Edit Supplier
function editSupplier(id){
    const sup = suppliers.find(s => s.id === id);
    if(!sup) return;
    const newName = prompt("Edit supplier name:", sup.name);
    if(newName===null) return;
    const newContact = prompt("Edit contact info:", sup.contact || '');
    if(newContact===null) return;
    sup.name = newName.trim();
    sup.contact = newContact.trim();
    localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(suppliers));
    renderSuppliersTable();
}

// Delete Supplier
function deleteSupplier(id){
    if(!confirm("Delete this supplier?")) return;
    suppliers = suppliers.filter(s => s.id !== id);
    localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(suppliers));
    renderSuppliersTable();
}

// Supplier search
const supplierSearch = document.getElementById('supplierSearch');
if(supplierSearch){
  supplierSearch.addEventListener('input', renderSuppliersTable);
}



function selectDashboardGroup(groupName){
    selectedDashboardGroup = groupName;
    renderDashboardGrouped();
}






// Render Table
function renderFGStock() {
  const tbody = document.querySelector('#fgTable tbody');
  if (!tbody) return;

  tbody.innerHTML = '';
  const search = (document.getElementById('fgSearch').value || '')
    .toLowerCase().trim();

  let index = 1;

  // ‚úÖ SORT FG PRODUCTS ALPHABETICALLY
  const sortedFG = [...fgProducts].sort((a, b) =>
    a.name.localeCompare(b.name)
  );

  sortedFG.forEach(p => {
    const name = (p.name || '').toLowerCase();
    if (search && !name.includes(search)) return;

    const bal = computeFGBalance(p.id);

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${index++}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.volume || '-')}</td>
        <td>${bal}</td>
        <td>
          <button class="btn info" onclick="viewFGHistory('${p.id}')">üëÅ View</button>
          ${currentUser?.role === 'admin' ? `
            <button class="btn secondary" onclick="editFGProduct('${p.id}')">‚úèÔ∏è Edit</button>
            <button class="btn out" onclick="deleteFGProduct('${p.id}')">üóë Delete</button>
          ` : ''}
        </td>
      </tr>
    `);
  });
}

function fgStockInHistoryModal(){
  const modal = document.getElementById('historyModal');
  modal.style.display = 'flex';

  document.getElementById('modalTitle').textContent = 'FG Stock IN History';

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML = '';

  fgMovements
    .filter(m => m.type === 'IN')
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id===m.fgId);
      if(!fg) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td> <!-- ‚úÖ NAME -->
          <td>IN</td>
          <td>${m.qty}</td>
          <td>${escapeHtml(m.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

function fgStockOutHistoryModal(){
  const modal = document.getElementById('historyModal');
  modal.style.display = 'flex';

  document.getElementById('modalTitle').textContent = 'FG Stock OUT History';

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML = '';

  fgMovements
    .filter(m => m.type === 'OUT')
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id===m.fgId);
      if(!fg) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td> <!-- ‚úÖ NAME -->
          <td>OUT</td>
          <td>${m.qty}</td>
          <td>${escapeHtml(m.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

function viewFGHistory(fgId){
  const fg = fgProducts.find(f => f.id === fgId);
  if(!fg) return;

  const modal = document.getElementById('historyModal');
  modal.style.display = 'flex';

  document.getElementById('modalTitle').textContent =
    `FG History ‚Äî ${fg.name}`;

  const tbody = document.getElementById('modalHistoryBody');
  tbody.innerHTML = '';

  fgMovements
    .filter(m => m.fgId === fgId)
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>${m.type}</td>
          <td>${m.qty}</td>
          <td>${escapeHtml(m.batch || '-')}</td>
          <td>${escapeHtml(m.expiry || '-')}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
    });
}

let fgMovements = JSON.parse(localStorage.getItem('sms_fg_movements') || '[]');

function saveFGMovements(){
  localStorage.setItem('sms_fg_movements', JSON.stringify(fgMovements));
}
function computeFGBalance(fgId){
  return fgMovements.reduce((sum,m)=>{
    if(m.fgId===fgId){
      return sum + (m.type==='IN'? m.qty : -m.qty);
    }
    return sum;
  },0);
}
/* ==========================
   üíæ FG LOCAL SAVE FUNCTION
========================== */
function saveFGLocal(){
  localStorage.setItem('sms_fg_products', JSON.stringify(fgProducts));
  localStorage.setItem('sms_fg_movements', JSON.stringify(fgMovements));
}

function renderFGStockIn(){
  const tbody = document.getElementById('fgStockInBody');
  if(!tbody) return;

  tbody.innerHTML = '';
  const search = (fgInSearch.value || '').toLowerCase();

  // ‚úÖ SORT ALPHABETICALLY
  const sortedFG = [...fgProducts].sort((a,b)=>
    a.name.localeCompare(b.name)
  );

  sortedFG.forEach((p,i)=>{
    if(search && !p.name.toLowerCase().includes(search)) return;

    const bal = computeFGBalance(p.id);

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td>
          <button class="btn" onclick="openFGModal('${p.id}','IN')">
            Stock In
          </button>
        </td>
      </tr>
    `);
  });
}
function renderFGStockOut(){
  const tbody = document.getElementById('fgStockOutBody');
  if(!tbody) return;

  tbody.innerHTML = '';
  const search = (fgOutSearch.value || '').toLowerCase();

  // ‚úÖ SORT ALPHABETICALLY
  const sortedFG = [...fgProducts].sort((a,b)=>
    a.name.localeCompare(b.name)
  );

  sortedFG.forEach((p,i)=>{
    if(search && !p.name.toLowerCase().includes(search)) return;

    const bal = computeFGBalance(p.id);

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td>
          <button class="btn out" onclick="openFGModal('${p.id}','OUT')">
            Stock Out
          </button>
        </td>
      </tr>
    `);
  });
}

function openFGModal(fgId,type){
  const fg = fgProducts.find(f=>f.id===fgId);
  if(!fg) return;

document.getElementById('modalProductName').textContent = fg.name;
  document.getElementById('modalProductBalance').textContent = computeFGBalance(fgId);
  stockModal.style.display='flex';

  modalSave.onclick = ()=>{
    const qty = Number(modalQty.value);
    const remark = modalRemark.value.trim();

    if(qty<=0) return alert("Invalid qty");
    if(type==='OUT' && qty > computeFGBalance(fgId))
      return alert("Exceeds balance");

    fgMovements.push({
      id: genId(),
      fgId,
      type,
      qty,
      batch: fg.batch,
      expiry: fg.expiry,
      date: todayISO(),
      remark
    });

    saveFGLocal();
    autoPushFGToCloud();
    closeModal();
    refreshAll();
  };
}
function normalizeGroup(g){
  return String(g || '')
    .trim()
    .toUpperCase()
    .replace(/\s+/g,'');
}
function addFGProduct(){
  const name = fgNewName.value.trim();
  const rawGroup = fgNewGroup.value.trim();

  if(!name || !rawGroup){
    showToast("Name & Group required", true);
    return;
  }

  const group = normalizeGroup(rawGroup);

  fgProducts.push({
    id: 'fg_' + genId(),
    name,
    group,
    volume: fgNewVolume.value.trim(),
    batch: fgNewBatch.value.trim(),
    expiry: fgNewExpiry.value,
    threshold: Number(fgNewThreshold.value || 5)
  });

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  // ‚úÖ CLEAR INPUTS
  fgNewName.value = '';
  fgNewVolume.value = '';
  fgNewGroup.value = '';
  fgNewBatch.value = '';
  fgNewExpiry.value = '';
  fgNewThreshold.value = '';

  // ‚úÖ SUCCESS TOAST
  showToast("FG product added successfully ‚úÖ");
}

function renderFGHistory(){
  const tbody = document.getElementById('fgHistoryBody');
  if(!tbody) return;
  tbody.innerHTML='';

  fgMovements
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const fg = fgProducts.find(f=>f.id===m.fgId);
      if(!fg) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>${m.type}</td>
          <td>${m.qty}</td>
          <td>${m.batch||'-'}</td>
          <td>${m.expiry||'-'}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
function getFGLowStockCount(){
  return fgProducts.filter(f=>computeFGBalance(f.id)<=f.threshold).length;
}
function editFGProduct(fgId){
  const fg = fgProducts.find(f => f.id === fgId);
  if (!fg) return;

  const newName = prompt("Edit Product Name:", fg.name);
  if (newName === null || !newName.trim()) return;

  const newVolume = prompt("Edit Volume / Size:", fg.volume || '');
  if (newVolume === null) return;

const newGroup = prompt(
  "Edit Group Prefix:",
  fg.group || ''
);

  if (newGroup === null || !newGroup.trim()) return;

  const newBatch = prompt("Edit Batch / Lot No:", fg.batch || '');
  if (newBatch === null) return;

  const newExpiry = prompt("Edit Expiry Date (YYYY-MM-DD):", fg.expiry || '');
  if (newExpiry === null) return;

  const newThreshold = prompt("Edit Low Stock Threshold:", fg.threshold || 5);
  if (newThreshold === null || isNaN(newThreshold)) return;

  fg.name = newName.trim();
  fg.volume = newVolume.trim();
  fg.batch = newBatch.trim();
  fg.expiry = newExpiry.trim();
  fg.threshold = Number(newThreshold);
  fg.group = newGroup.trim().toUpperCase();


  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();
}
function deleteFGProduct(fgId){
  const fg = fgProducts.find(f => f.id === fgId);
  if (!fg) return;

  if (!confirm(`Delete FG product "${fg.name}"?\nThis will also delete its stock history.`)) {
    return;
  }

  // Remove product
  fgProducts = fgProducts.filter(f => f.id !== fgId);

  // Remove related movements
  fgMovements = fgMovements.filter(m => m.fgId !== fgId);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();
}

function getFGExpiringSoon(days=30){
  const now = new Date();
  return fgProducts.filter(f=>{
    if(!f.expiry) return false;
    const diff = (new Date(f.expiry)-now)/(1000*60*60*24);
    return diff<=days;
  }).length;
}
function autoPushFGToCloud(){
  if(!cloudDB) return;
  cloudDB.ref('fgManager').set({
    products: fgProducts,
    movements: fgMovements,
    syncedAt: new Date().toISOString()
  });
}

function autoPullFGFromCloud(){
  if(!cloudDB) return;

  cloudDB.ref('fgManager').once('value').then(snap=>{
    if(!snap.exists()) return;

    fgProducts = snap.val().products || [];
    fgMovements = snap.val().movements || [];

    saveFGLocal();

    // üî• FORCE BOM & DASHBOARD UPDATE
    renderDashboardGrouped();
    renderMainDashboard();
  });
}


window.addEventListener('load', autoPullFGFromCloud);
let fgProducts = JSON.parse(localStorage.getItem('sms_fg_products') || '[]');

// Search input
document.getElementById('fgSearch').addEventListener('input', renderFGStock);

// Show Modal for daily stock
function showModal(id){
    const product = fgProducts.find(p=>p.id===id);
    if(!product) return;

    document.getElementById('fgModalTitle').innerText = product.name;
    const modalHead = document.getElementById('modalHead');
    const modalBody = document.getElementById('modalBody');

    modalHead.innerHTML = '<th>Date</th><th>Stock</th>';
    modalBody.innerHTML = '';

    Object.entries(product.dailyStock).forEach(([date, val])=>{
        modalBody.insertAdjacentHTML('beforeend', `<tr><td>${date}</td><td>${val}</td></tr>`);
    });

    document.getElementById('fgModal').style.display = 'flex';
}

// Helper
function escapeHtml(text){
    return text.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function renderProductsTable() {
    const tbody = document.querySelector('#productsTable tbody');
    if (!tbody) return;

    // Clear previous rows  üî• THIS FIXES MOST OF YOUR ISSUE
    tbody.innerHTML = '';

    const globalSearchEl = document.getElementById('globalSearch');
    const productSearchEl = document.getElementById('productSearch');

    const globalSearch = globalSearchEl ? globalSearchEl.value.trim().toLowerCase() : '';
    const localSearch  = productSearchEl ? productSearchEl.value.trim().toLowerCase() : '';

    let index = 1;

    products.forEach(p => {
        const name = p.name.toLowerCase();
        const cat  = (p.category || '').toLowerCase();

        if (
            (localSearch  && !name.includes(localSearch)  && !cat.includes(localSearch)) ||
            (globalSearch && !name.includes(globalSearch) && !cat.includes(globalSearch))
        ) return;

        const bal = computeBalance(p.id);

        tbody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${index++}</td>
                <td>${escapeHtml(p.code || '')}</td>
                <td>${escapeHtml(p.name)}</td>
                <td>${escapeHtml(p.category)}</td>
                <td>${bal}</td>
                <td>${p.threshold || 5}</td>
                <td>${escapeHtml(p.barcode || '')}</td>
                <td><button class="btn secondary" onclick="openHistory('${p.id}')">History</button></td>
                <td><button class="btn secondary admin-only" onclick="editProduct('${p.id}')">Edit</button></td>
                <td><button class="btn secondary admin-only" onclick="deleteProduct('${p.id}')">Delete</button></td>
            </tr>
        `);
    });
applyPermissions();

}
function addRMProduct(){
  const code = newCode.value.trim();
  const name = newName.value.trim();
  const category = newCategory.value.trim();
  const threshold = Number(newThreshold.value || 5);
  const barcode = newBarcode.value.trim();
  const groups = newGroups.value
    .split(',')
    .map(g => g.trim())
    .filter(Boolean);
  const exclusive = newExclusive.checked;

  if(!name){
    alert("Product name required");
    return;
  }

  products.push({
    id: genId(),
    code,
    name,
    category,
    threshold,
    barcode,
    groups,
    exclusive
  });

  saveAll();
  refreshAll();
showToast("Raw material product added successfully");
  // clear inputs
  newCode.value = '';
  newName.value = '';
  newCategory.value = '';
  newThreshold.value = '';
  newBarcode.value = '';
  newGroups.value = '';
  newExclusive.checked = false;
}


function renderStockIn() {
    const tbody = document.querySelector('#stockInBody tbody'); // Correct
    if(!tbody) return;
    tbody.innerHTML = '';

    const search = (document.getElementById('inSearch').value || '').toLowerCase().trim();

    products.forEach(p => {
        const name = p.name.toLowerCase();
        if(search && !name.includes(search)) return;

        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${escapeHtml(p.name)}</td>
                <td>${bal}</td>
                <td>${lastMovement(p.id, 'IN')}</td>
                <td><button class="btn" onclick="openStockModal('${p.id}','IN')">Stock In</button></td>
            </tr>
        `);
    });
}


function renderStockOut() {
    const tbody = document.querySelector('#stockOutBody tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const outSearchEl = document.getElementById('outSearch');
    const localSearch = outSearchEl ? outSearchEl.value.trim().toLowerCase() : '';

    products.forEach(p => {
        const name = p.name.toLowerCase();
        if(localSearch && !name.includes(localSearch)) return;
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend',`
            <tr>
                <td>${escapeHtml(p.name)}</td>
                <td>${bal}</td>
                <td>${lastMovement(p.id,'OUT')}</td>
                <td><button class="btn out" onclick="openStockModal('${p.id}','OUT')">Stock Out</button></td>
            </tr>
        `);
    });
}

function renderCombinedHistory() {
    const tbody = document.querySelector('#historyTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const search = (historySearch.value || '').toLowerCase();

    stockMovements
      .slice()
      .sort((a,b)=>new Date(b.date)-new Date(a.date))
      .forEach(m => {
        const prod = products.find(p => p.id === m.productId);
        if(!prod) return;

        if(search && !prod.name.toLowerCase().includes(search) &&
           !(m.remark||'').toLowerCase().includes(search)) return;

        tbody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${fmtDate(m.date)}</td>
                <td>${escapeHtml(prod.name)}</td>
                <td>${m.type}</td>
                <td>${m.quantity}</td>
                <td>${escapeHtml(m.remark || '')}</td>
            </tr>
        `);
    });
}



// MODALS
let modalCurrent=null;
function openStockModal(productId, type) {
    modalCurrent = { productId, type };
    const prod = products.find(p => p.id === productId);
    if(!prod) return;

    document.getElementById('modalProductName').textContent = prod.name;
    document.getElementById('modalProductBalance').textContent = computeBalance(productId);
    document.getElementById('modalQty').value = '';
    document.getElementById('modalRemark').value = ''; // Clear remark
    document.getElementById('stockModal').style.display = 'flex';

  document.getElementById('modalSave').onclick = () => {
    let qty = Number(document.getElementById('modalQty').value);
    let remark = document.getElementById('modalRemark').value.trim();

    // Validation
    if (qty <= 0) {
        alert('Invalid quantity');
        return;
    }
    if (type === 'OUT' && qty > computeBalance(productId)) {
        alert('Quantity exceeds balance');
        return;
    }

    // Add stock movement
    stockMovements.push({
        id: genId(),
        productId,
        type,
        quantity: qty,
        date: todayISO(),
        remark
    });

    // Save & refresh
    saveAll();
    closeModal();
    refreshAll();


    // --- Show Toast after submission ---
    const toast = document.getElementById('stockToast');
    toast.textContent = `Stock ${type === 'IN' ? 'added' : 'removed'} successfully!`;
    toast.classList.toggle('out', type === 'OUT'); // red if OUT, green if IN
    toast.style.display = 'block';
    
    // Fade in
    requestAnimationFrame(() => {
        toast.style.opacity = '1';
    });

    // Hide after 1 second
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.style.display = 'none', 300);
    }, 2000); // 1000ms = 1 second
}};
function showToast(message, isError = false) {
  const toast = document.getElementById('stockToast');
  if (!toast) return;

  toast.textContent = message;
  toast.classList.toggle('out', isError);
  toast.style.display = 'block';

  requestAnimationFrame(() => {
    toast.style.opacity = '1';
  });

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.style.display = 'none', 300);
  }, 2000);
}


function closeModal(){document.getElementById('stockModal').style.display='none';modalCurrent=null;}
function openHistory(productId){
    const modal = document.getElementById('historyModal');
    modal.style.display = 'flex';

    const tbody = document.getElementById('modalHistoryBody');
    tbody.innerHTML = '';

    stockMovements
      .filter(m => m.productId === productId)
      .sort((a,b)=>new Date(b.date)-new Date(a.date))
      .forEach(m=>{
        tbody.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${fmtDate(m.date)}</td>
            <td>${m.type}</td>
            <td>${m.quantity}</td>
            <td>${escapeHtml(m.remark || '')}</td>
          </tr>
        `);
      });
}

function closeHistoryModal(){document.getElementById('historyModal').style.display='none';}
function stockInHistoryModal(){
  const modal=document.getElementById('stockInHistoryModal');
  modal.style.display='flex';

  const tbody=document.getElementById('stockInHistoryPopupBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.type==='IN')
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod=products.find(p=>p.id===m.productId);
      if(!prod) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${m.quantity}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
  });
}

function closeStockInHistory(){document.getElementById('stockInHistoryModal').style.display='none';}
function stockOutHistoryModal(){
  const modal=document.getElementById('stockOutHistoryModal');
  modal.style.display='flex';

  const tbody=document.getElementById('stockOutHistoryPopupBody');
  tbody.innerHTML='';

  stockMovements
    .filter(m=>m.type==='OUT')
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod=products.find(p=>p.id===m.productId);
      if(!prod) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${m.quantity}</td>
          <td>${escapeHtml(m.remark || '')}</td>
        </tr>
      `);
  });
}

function closeStockOutHistory(){document.getElementById('stockOutHistoryModal').style.display='none';}

// NAV
document.querySelectorAll('.menu-title.collapsible').forEach(m=>{
    m.addEventListener('click',()=>{
        m.classList.toggle('open');
        m.nextElementSibling.classList.toggle('open');
    });
});
document.querySelectorAll('.submenu').forEach(sm => {
  sm.addEventListener('click', () => {

    const page = sm.dataset.page;
    const action = sm.dataset.action;

    // Handle page navigation
    if (page) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');

      // Show selected page
      const target = document.getElementById(page);
      if (target) target.style.display = 'block';

      // Refresh common data
      refreshAll();

      // ‚úÖ VERY IMPORTANT: force dashboard refresh
      if (page === 'dashboardPage') {
        renderMainDashboard();
      }
    }

    // Handle actions (export, print, import, etc.)
    if (action && typeof window[action] === 'function') {
      window[action]();
    }

  });
});



// SIDEBAR TOGGLE
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.querySelector('.app'); // your main content wrapper

if (sidebarToggle && sidebar && mainContent) {
    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('minimized');
        mainContent.classList.toggle('sidebar-minimized');

        // Change button arrow direction
        if(sidebar.classList.contains('minimized')){
            sidebarToggle.textContent = '‚Üí';
        } else {
            sidebarToggle.textContent = '‚Üê';
        }
    });
}


// ADD PRODUCT
const addProductBtn = document.getElementById('addProductBtn');
if (addProductBtn) {
    addProductBtn.addEventListener('click', () => {
        const codeEl = document.getElementById('newCode');
        const nameEl = document.getElementById('newName');
        const categoryEl = document.getElementById('newCategory');
        const thresholdEl = document.getElementById('newThreshold');
        const barcodeEl = document.getElementById('newBarcode');
        const groupsEl = document.getElementById('newGroups');
        const exclusiveEl = document.getElementById('newExclusive');

        if (!nameEl || !codeEl || !categoryEl || !thresholdEl || !barcodeEl || !groupsEl || !exclusiveEl) {
            console.warn("Some input fields are missing, cannot add product.");
            return;
        }

        const code = codeEl.value.trim();
        const name = nameEl.value.trim();
        const category = categoryEl.value.trim();
        const threshold = Number(thresholdEl.value || 5);
        const barcode = barcodeEl.value.trim();
        const groupsInput = groupsEl.value.trim();
        const exclusive = exclusiveEl.checked;

        if (!name) { alert("Product name required"); return; }

        const groups = groupsInput ? groupsInput.split(',').map(g => g.trim()).filter(g => g) : [];

        const newProduct = {
            id: genId(),
            code,
            name,
            category,
            threshold,
            barcode,
            groups,
            exclusive
        };

        products.push(newProduct);
        saveAll();
        renderProductsTable();
        renderDashboardGrouped();

        // Clear form
        codeEl.value = '';
        nameEl.value = '';
        categoryEl.value = '';
        thresholdEl.value = '';
        barcodeEl.value = '';
        groupsEl.value = '';
        exclusiveEl.checked = false;
    });
}


// SEARCHES
const productSearch = document.getElementById('productSearch');
if (productSearch) productSearch.addEventListener('input', renderProductsTable);

const inSearch = document.getElementById('inSearch');
if (inSearch) inSearch.addEventListener('input', renderStockIn);

const outSearch = document.getElementById('outSearch');
if (outSearch) outSearch.addEventListener('input', renderStockOut);

const historySearch = document.getElementById('historySearch');
if (historySearch) historySearch.addEventListener('input', renderCombinedHistory);

// const globalSearch = document.getElementById('globalSearch');
// if (globalSearch) globalSearch.addEventListener('input', () => {
//     renderDashboardGrouped();
//     renderProductsTable();
//     renderStockIn();
//     renderStockOut();
//     renderCombinedHistory();
// });

const categoryFilter = document.getElementById('categoryFilter');
if (categoryFilter) categoryFilter.addEventListener('change', () => renderDashboardGrouped());

const globalThreshold = document.getElementById('globalThreshold');
if (globalThreshold) globalThreshold.addEventListener('input', renderDashboardGrouped);

// EXPORT / IMPORT
function exportExcel(){const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(products.map(p=>({Name:p.name,Category:p.category,Threshold:p.threshold,Balance:computeBalance(p.id)})));XLSX.utils.book_append_sheet(wb,ws,'Products');XLSX.writeFile(wb,'products.xlsx');}
function importExcel(){const inp=document.createElement('input');inp.type='file';inp.accept='.xlsx,.xls';inp.onchange=()=>{const f=inp.files[0];const reader=new FileReader();reader.onload=e=>{const data=new Uint8Array(e.target.result);const wb=XLSX.read(data,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];const json=XLSX.utils.sheet_to_json(ws);json.forEach(p=>{if(p.Name)products.push({id:genId(),name:p.Name,category:p.Category||'',threshold:p.Threshold||5});});saveAll();refreshAll();};reader.readAsArrayBuffer(f);};inp.click();}
function exportPDF(){const { jsPDF } = window.jspdf;const doc=new jsPDF();doc.autoTable({head:[['#','Name','Category','Balance','Threshold']],body:products.map((p,i)=>[i+1,p.name,p.category,computeBalance(p.id),p.threshold])});doc.save('products.pdf');}

function printStockReport() {
    const bannerUrl = 'banner.png'; // your banner image
    const productsData = products.map((p, i) => {
        return `<tr>
            <td>${i+1}</td>
            <td>${escapeHtml(p.name)}</td>
            <td>${computeBalance(p.id)}</td>
                    </tr>`;
    }).join('');

    const html = `
    <html>
    <head>
        <title>RAW Stock Report</title>
        <style>
            @media print {
                body {
                    margin: 0;
                    -webkit-print-color-adjust: exact;
                }
                img.bg {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 80%;
                    opacity: 0.3;
                    z-index: -1;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    background: transparent !important;
                    position: relative;
                    z-index: 1;
                }
                th, td {
                    padding: 10px;
                    border: 1px solid rgba(0,0,0,0.2);
                    background: transparent !important;
                }
                h2 {
                    text-align: center;
                    position: relative;
                    z-index: 1;
                }
            }
        </style>
    </head>
    <body>
        <img class="bg" src="${bannerUrl}" />
        <h2>RAW Stock Report</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    
                    <th>Balance</th>
                   
                </tr>
            </thead>
            <tbody>
                ${productsData}
            </tbody>
        </table>
    </body>
    </html>`;

    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
}
  

// EDIT PRODUCT
function editProduct(productId){
    const prod = products.find(p => p.id === productId);
    if(!prod) return;

    const newCode = prompt("Edit product code:", prod.code || "");
    if(newCode === null) return;

    const newName = prompt("Edit product name:", prod.name);
    if(newName === null || !newName.trim()) return alert("Name required");

    const newCategory = prompt("Edit category:", prod.category || "");
    if(newCategory === null) return;

    const newThreshold = prompt("Edit threshold:", prod.threshold || 5);
    if(newThreshold === null || isNaN(newThreshold)) return alert("Invalid threshold");

    const newBarcode = prompt("Edit barcode:", prod.barcode || "");
    if(newBarcode === null) return;

    const newGroupsInput = prompt(
        "Edit groups (comma separated):",
        Array.isArray(prod.groups) ? prod.groups.join(', ') : ''
    );
    if(newGroupsInput === null) return;

    const newExclusive = confirm("Exclusive to first group?");

    prod.code = newCode.trim();
    prod.name = newName.trim();
    prod.category = newCategory.trim();
    prod.threshold = Number(newThreshold);
    prod.barcode = newBarcode.trim();
    prod.groups = newGroupsInput
        .split(',')
        .map(g => g.trim())
        .filter(Boolean);
    prod.exclusive = newExclusive;

    saveAll();
    refreshAll();
}

// DELETE PRODUCT
function deleteProduct(productId){
    if(!confirm("Are you sure you want to delete this product? This will remove all its stock history.")) return;
    products = products.filter(p => p.id !== productId);
    stockMovements = stockMovements.filter(m => m.productId !== productId);
    saveAll();
    refreshAll();
}
/* ==========================
   ‚òÅÔ∏è CLOUD SYNC MODULE
========================== */


// ================================
// ‚òÅÔ∏è AUTO CLOUD SYNC MODULE
// ================================

function autoPullFromCloud() {
  if (!window.cloudDB) return console.warn("Cloud DB not ready");

  cloudDB.ref("stockManager").once("value")
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) return;

      products = data.products || [];
      stockMovements = data.stockMovements || [];

      localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
      localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements));

      refreshAll();
      const status = document.getElementById("status");
      if (status) status.textContent = "Status: Auto-loaded from Cloud ‚òÅÔ∏è";

      console.log("‚úÖ Auto pull completed");
    })
    .catch(err => {
      console.error("Auto pull failed:", err);
      refreshAll();
    });
}

function autoPushToCloud() {
  if (!window.cloudDB) return console.warn("Cloud DB not ready");

  cloudDB.ref("stockManager").set({
    products: products,
    stockMovements: stockMovements,
    syncedAt: new Date().toISOString()
  })
  .then(() => {
    const status = document.getElementById("status");
    if (status) status.textContent = "Status: Auto-synced to Cloud ‚òÅÔ∏è";
    console.log("‚úÖ Auto push completed");
  })
  .catch(err => console.error("Auto push failed:", err));
}

// ================================
// HOOK INTO LOCAL CHANGES
// ================================

// Wrap saveAll to auto push
const originalSaveAll = saveAll;
saveAll = function() {
  originalSaveAll();      // save locally
  autoPushToCloud();      // push changes to cloud
};

// Auto pull on page load
window.addEventListener("load", () => {
  autoPullFromCloud();
});
function loadRenamedGroupsFromCloud() {
    if (!window.cloudDB) return;

    cloudDB.ref("dashboardRenamedGroups").once("value")
        .then(snapshot => {
            if (snapshot.exists()) {
                renamedGroups = snapshot.val();
                localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
                renderDashboardGrouped();
                console.log("‚òÅÔ∏è Renamed groups loaded from cloud");
            }
        });
}

function saveRenamedGroupsToCloud() {
    if (!window.cloudDB) return;

    cloudDB.ref("dashboardRenamedGroups").set(renamedGroups)
        .then(() => console.log("‚òÅÔ∏è Renamed groups saved to cloud"));
}


// UTILITY
function refreshAll(){
  renderProductsTable();
  renderStockIn();
  renderStockOut();
  renderCombinedHistory();

  renderFGStock();
  renderFGStockIn();
  renderFGStockOut();
  renderFGHistory();

  renderMainDashboard();
  applyPermissions();
}



refreshAll();


</script>

</main>
</div>
</body>
</html>
