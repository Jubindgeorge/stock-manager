<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stock Manager</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* =========================================
   Stock Manager CSS (Bootstrap SAFE)
   - Does NOT override: .row, .col-*, .card, .modal, .table, .btn
   - Custom UI uses sm-* prefixes
========================================= */

:root{
  --sidebar-w: 260px;

  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b6f76;

  --accent:#2c3e50;
  --accent-2:#2980b9;
  --danger:#c0392b;

  --line:#e7e9ee;
  --shadow:0 10px 30px rgba(0,0,0,.08);
  --radius:14px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* Generic helpers */
.muted{ color: var(--muted) !important; }
.right{ text-align:right !important; }
.sm-link{ color:#2563eb; cursor:pointer; font-weight:700; }
.low-stock{ color:#dc2626; font-weight:800; }

/* App wrapper */
.app{ display:none; min-height:100vh; }

/* =========================================
   LOGIN
========================================= */
.sm-login-screen{
  position:fixed; inset:0;
  background:#f3f4f6;
  display:flex; align-items:center; justify-content:center;
  z-index:99999;
}
.sm-login-card{
  width:360px;
  background:#fff;
  padding:24px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
}
.sm-login-input{
  width:100%;
  padding:10px 12px;
  margin:10px 0;
  border:1px solid rgba(0,0,0,.12);
  border-radius:10px;
}
.sm-msg{ margin-top:10px; text-align:center; font-size:13px; }
.sm-msg-error{ color:#dc2626; }

/* =========================================
   SIDEBAR
========================================= */
.sidebar{
  width: var(--sidebar-w);
  position:fixed; left:0; top:0; height:100%;
  background: rgba(255,255,255,.85);
  backdrop-filter: blur(6px);
  padding: 10px;
  overflow:auto;
  z-index:20;
  border-right:1px solid rgba(0,0,0,.06);
  box-shadow: 4px 0 20px rgba(0,0,0,.08);
  border-radius: 0 10px 10px 0;
  transition: width .25s ease, padding .25s ease;
}
.sidebar.minimized{
  width:60px;
  padding:10px 6px;
  overflow:hidden;
}
.sidebar.minimized .sidebar-header div,
.sidebar.minimized .brand-title,
.sidebar.minimized .brand-sub,
.sidebar.minimized .sidebar-logo,
.sidebar.minimized .sidebar-menu,
.sidebar.minimized .sidebar-footer{
  display:none;
}

.sidebar-header{
  display:flex; gap:12px; align-items:center;
  margin-bottom:10px;
}
.sidebar-logo{
  width:96px; height:56px; object-fit:cover;
  border-radius:8px;
}
.brand-title{ font-size:18px; font-weight:800; margin:0; }
.brand-sub{ font-size:12px; color:var(--muted); margin-top:2px; }
.sm-btn-compact{ padding:4px 8px !important; }

.sidebar-menu{ list-style:none; padding:0; margin:10px 0 0; }
.sidebar-menu li{
  padding:12px 10px;
  display:flex; gap:10px; align-items:center;
  cursor:pointer;
  border-left:4px solid transparent;
  border-radius:10px;
  transition:all .18s ease;
  color:#222;
}
.sidebar-menu li:hover{
  background: rgba(60,120,200,.06);
  transform: translateX(4px);
  border-left-color: rgba(41,128,185,.8);
}
.menu-link{ font-weight:700; }
.menu-title{
  font-weight:800;
  background: rgba(0,0,0,.05);
}
.menu-title.collapsible{
  display:flex; justify-content:space-between; align-items:center;
}
.menu-title span.arrow{ font-size:12px; transition:transform .2s ease; }
.menu-title.open .arrow{ transform: rotate(180deg); }

.submenu{ padding-left:36px !important; font-size:14px; }
.subgroup{ list-style:none; padding:0; margin:0; display:none; }
.subgroup.open{ display:block; }

.sidebar-footer{ margin-top:16px; font-size:13px; color:var(--muted); }
.admin-only{ display:none; }

/* =========================================
   MAIN
========================================= */
.main{
  margin-left: calc(var(--sidebar-w) + 18px);
  padding:18px;
  min-height:100vh;
  transition: margin-left .25s ease;
}
.sidebar.minimized + .main{ margin-left: 60px; }
body.sm-sidebar-min .main{ margin-left: 60px; }

.sm-logout{
  position:fixed;
  top:10px; right:20px;
  z-index:999;
}

/* =========================================
   PAGE CONTAINER
========================================= */
.page{
  background: rgba(255,255,255,.75);
  backdrop-filter: blur(6px);
  border-radius: 12px;
  width:100%;
  min-height: calc(100vh - 40px);
  padding: 20px;
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 6px 25px rgba(0,0,0,.10);
}

/* =========================================
   CUSTOM inputs
========================================= */
.sm-search{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.10);
  width:320px;
  background: rgba(255,255,255,.90);
}
.sm-small{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.12);
  width:220px;
  background: rgba(255,255,255,.95);
}
.sm-lbl{ display:block; font-size:12px; color:var(--muted); margin:6px 0; }
.sm-inp{ width:100%; padding:10px; border:1px solid #d7dbe2; border-radius:10px; background:#fff; }

/* =========================================
   CUSTOM CARD + GRID (NO Bootstrap conflicts)
========================================= */
.sm-card{
  background: var(--card);
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
  border: 1px solid rgba(0,0,0,.04);
  margin-bottom: 12px;
}

/* =========================================
   TOAST
========================================= */
#stockToast{
  position:fixed;
  top:20px;
  right:20px;
  background:#16a34a;
  color:#fff;
  padding:10px 20px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.20);
  font-weight:700;
  z-index:10000;
  opacity:0;
  transition:opacity .25s ease;
  display:none;
}
#stockToast.out{ background:#dc2626; }

/* =========================================
   BOE SEARCH DROP DOWN (RM searchable)
========================================= */
.rm-search-wrap{ position:relative; }
.rm-search-input{
  width:100%;
  padding:8px 10px;
  border:1px solid rgba(0,0,0,.15);
  border-radius:10px;
  outline:none;
  background:#fff;
}
.rm-search-dd{
  position:absolute;
  top:calc(100% + 6px);
  left:0; right:0;
  max-height:240px;
  overflow:auto;
  background:#fff;
  border:1px solid rgba(0,0,0,.12);
  border-radius:10px;
  box-shadow:0 10px 20px rgba(0,0,0,.12);
  z-index:9999;
  display:none;
}
.rm-search-item{
  padding:8px 10px;
  cursor:pointer;
  border-bottom:1px solid rgba(0,0,0,.06);
}
.rm-search-item:last-child{ border-bottom:none; }
.rm-search-item:hover{ background:rgba(41,128,185,.10); }
.rm-search-item.active{ background:rgba(41,128,185,.18); font-weight:700; }
.rm-search-empty{ padding:10px; color:var(--muted); font-size:13px; }

/* =========================================
   SIMPLE APP MODAL
========================================= */
.app-modal{
  position:fixed;
  inset:0;
  z-index:9999;
}
.app-modal-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.45);
}
.app-modal-box{
  position:relative;
  max-width:900px;
  margin:5vh auto;
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
}
.app-modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #eee;
  margin-bottom:12px;
}
.app-modal-body{
  max-height:70vh;
  overflow:auto;
}

/* ===== Custom button skins (Bootstrap-safe) ===== */
.btn.secondary{
  background:#f3f4f6;
  border:1px solid rgba(0,0,0,.15);
  color:#111;
}
.btn.secondary:hover{ background:#e9edf2; }

.btn.info{
  background:#0ea5e9;
  border:1px solid rgba(0,0,0,.08);
  color:#fff;
}
.btn.info:hover{ filter:brightness(.95); }

.btn.out{
  background:#dc2626;
  border:1px solid rgba(0,0,0,.08);
  color:#fff;
}
.btn.out:hover{ filter:brightness(.95); }

@media print{
  body{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
}
</style>
</head>

<body>

<!-- =========================
     LOGIN SCREEN
========================= -->
<div id="loginScreen" class="sm-login-screen">
  <div class="sm-login-card">
    <h2 class="text-center mb-3">Stock Manager</h2>

    <div id="loginForm">
      <input id="loginUser" class="sm-login-input" placeholder="Username">
      <input id="loginPass" class="sm-login-input" type="password" placeholder="Password">
      <button class="btn btn-primary w-100" onclick="login()">Login</button>

      <p class="text-center mt-3 mb-2">
        Don't have an account?
        <span class="sm-link" onclick="showSignup()">Sign Up</span>
      </p>

      <p class="text-center mb-2">
        <span class="sm-link" onclick="forgotPassword()">Forgot Password?</span>
      </p>

      <p id="loginMsg" class="sm-msg sm-msg-error"></p>
    </div>

    <div id="signupForm" style="display:none">
      <input id="signupUser" class="sm-login-input" placeholder="Username">
      <input id="signupPass" class="sm-login-input" type="password" placeholder="Password">
      <select id="signupRole" class="form-select mb-2">
        <option value="user">User</option>
      </select>
      <button class="btn btn-success w-100" onclick="signup()">Create Account</button>

      <p class="text-center mt-3 mb-0">
        Already have an account?
        <span class="sm-link" onclick="showLogin()">Login</span>
      </p>

      <p id="signupMsg" class="sm-msg sm-msg-error"></p>
    </div>
  </div>
</div>

<!-- =========================
     APP
========================= -->
<div class="app">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img id="brandBanner" src="banner.png" class="sidebar-logo" onerror="this.style.display='none'">
      <div>
        <div class="brand-title">STOCK</div>
        <div class="brand-sub">Inventory ‚Ä¢ Public Sheet</div>
      </div>
      <button id="sidebarToggle" class="btn btn-outline-secondary sm-btn-compact" type="button">‚Üê</button>
    </div>

    <ul class="sidebar-menu" id="menu">

      <li id="usersMenu" class="menu-title collapsible admin-only">
        Users <span class="arrow">‚ñæ</span>
      </li>
      <ul class="subgroup admin-only">
        <li class="submenu" data-page="userManagement">Manage Users</li>
      </ul>

      <li class="menu-link" data-page="dashboardPage">Dashboard</li>

      <li class="menu-title collapsible">Purchase <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="billEntry">Goods Received Note</li>
        <li class="submenu" data-page="suppliers">Manage Raw Suppliers</li>
      </ul>

      <li class="menu-title collapsible">Store <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="products">Stock Ledger</li>
        <li class="submenu admin-only" data-page="rmAddProduct">Add Product</li>
        <li class="submenu" data-page="stockIn">Physical Entry In</li>
        <li class="submenu" data-page="stockOut">Physical Entry Out</li>
        <li class="submenu" data-page="rmDeliveryNote">Delivery Note</li>
      </ul>

      <li class="menu-title collapsible">Finished Goods <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="fgStock">Stock Ledger</li>
        <li class="submenu admin-only" data-page="fgAddProduct">Add Product</li>
        <li class="submenu" data-page="fgStockIn">Physical Entry In</li>
        <li class="submenu" data-page="fgStockOut">Physical Entry Out</li>
      </ul>

      <li class="menu-title collapsible">Manufacture <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="productionAuto">Production Entry</li>
        <li class="submenu" data-page="pageProductionRecords">Saved Production</li>
      </ul>

      <li class="menu-title collapsible">Report <span class="arrow">‚ñæ</span></li>
      <ul class="subgroup">
        <li class="submenu" data-page="history">RM History</li>
        <li class="submenu" data-action="importExcel">Import Excel</li>
        <li class="submenu" data-action="exportExcel">Export Excel</li>
        <li class="submenu" data-action="printStockReport">Print RM Stock Report</li>
        <li class="submenu" data-action="printFGStockReport">Print FG Stock Report</li>
        <li class="submenu" data-action="exportPDF">Export PDF</li>
      </ul>

      <div class="sidebar-footer">Data stored locally; cloud optional.</div>
    </ul>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <button onclick="logout()" class="btn btn-danger sm-logout">Logout</button>

    <!-- USER MANAGEMENT -->
    <section id="userManagement" class="page" style="display:none">
      <h2>Manage Users</h2>
      <div class="table-responsive">
        <table id="usersTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Username</th><th>Role/Permission</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-2">
        <input id="newUsername" class="form-control" style="max-width:260px" placeholder="Username">
        <input id="newPassword" class="form-control" style="max-width:260px" type="password" placeholder="Password">
        <select id="newRole" class="form-select" style="max-width:220px">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn btn-primary admin-only" onclick="addUser()">Add User</button>
      </div>
    </section>

    <!-- MAIN DASHBOARD -->
    <section id="dashboardPage" class="page container-fluid py-3" style="display:none">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <h2 class="m-0">Dashboard</h2>
          <div class="text-muted small" id="dashUpdatedAt">‚Äî</div>
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="Dashboard.refresh()">
            Refresh
          </button>
          <button class="btn btn-primary btn-sm" type="button" onclick="openFGFromDashboard()">
            Open FG
          </button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="text-muted small">Total RM Products</div>
              <div class="fs-2 fw-semibold" id="dashTotalProducts">0</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="text-muted small">Total RM Stock</div>
              <div class="fs-2 fw-semibold" id="dashTotalStock">0</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="text-muted small">Low Stock Items (RM)</div>
              <div class="fs-2 fw-semibold" id="dashLowStock">0</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100" role="button" onclick="openFGFromDashboard()" style="cursor:pointer">
            <div class="card-body">
              <div class="text-muted small">Total FG Balance</div>
              <div class="fs-2 fw-semibold" id="dashFGBalance">0</div>
              <div class="small text-muted mt-1">Click to open FG</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100" role="button" onclick="openFGFromDashboard()" style="cursor:pointer">
            <div class="card-body">
              <div class="text-muted small">FG Products</div>
              <div class="fs-2 fw-semibold" id="dashFGTotalProducts">0</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100" role="button" onclick="openLowFGFromDashboard()" style="cursor:pointer">
            <div class="card-body">
              <div class="text-muted small">Low FG Stock</div>
              <div class="fs-2 fw-semibold" id="dashFGLowStock">0</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="text-muted small">Max FG Balance</div>
              <div class="fs-2 fw-semibold" id="dashFGMaxBalance">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="text-muted small">Min FG Balance</div>
              <div class="fs-2 fw-semibold" id="dashFGMinBalance">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <!-- FILTERS + CHART -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="fw-semibold">FG Balance Chart</div>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <div class="text-muted small">Volume filter:</div>
              <div id="fgVolumeFilter" class="d-flex gap-2 flex-wrap"></div>
            </div>
          </div>

          <div class="mt-3" style="height:360px">
            <canvas id="fgStockChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- RM PRODUCTS -->
    <section id="products" class="page" style="display:none">
      <h2>Raw Material List</h2>

      <div class="mb-3 d-flex gap-2 flex-wrap">
        <input id="productSearch" class="sm-search" placeholder="Search products...">
        <button class="btn btn-outline-secondary" onclick="refreshAll()">Refresh</button>
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="productsTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>#</th><th>Code</th><th>Name</th><th>Category</th><th>Balance</th>
            <th>Threshold</th><th>Barcode</th><th>History</th><th>Edit</th><th>Delete</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADD RM PRODUCT -->
    <section id="rmAddProduct" class="page" style="display:none">
      <h2>Add Raw Material Product</h2>

      <div class="d-flex gap-2 flex-wrap mb-3">
        <input id="newCode" class="sm-small" placeholder="Product Code">
        <input id="newName" class="sm-small" placeholder="Product Name">
        <input id="newCategory" class="sm-small" placeholder="Category">
        <input id="newThreshold" class="sm-small" type="number" placeholder="Low Stock Threshold">
        <input id="newBarcode" class="sm-small" placeholder="Barcode">
        <input id="newGroups" class="sm-small" placeholder="Groups (comma separated)">
        <input id="newQtyPerFG" class="sm-small" type="number" step="0.0001" placeholder="Qty per FG (BOM)">
        <label class="d-flex align-items-center gap-2">
          <input type="checkbox" id="newExclusive"> Exclusive to first group
        </label>
      </div>

      <button class="btn btn-primary" onclick="addRMProduct()">Add Product</button>
    </section>

    <!-- STOCK IN -->
    <section id="stockIn" class="page" style="display:none">
      <h2>RM Stock In</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="inSearch" class="sm-search" placeholder="Search product">
        <button class="btn btn-outline-secondary" onclick="stockInHistoryModal()">View Stock IN History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle" id="stockInBody">
          <thead class="table-light">
          <tr><th>Product Code</th><th>Product Name</th><th>Balance</th><th>Last IN</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- STOCK OUT -->
    <section id="stockOut" class="page" style="display:none">
      <h2>RM Stock Out</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="outSearch" class="sm-search" placeholder="Search product">
        <button class="btn btn-info" onclick="stockOutHistoryModal()">View Stock OUT History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle" id="stockOutBody">
          <thead class="table-light">
          <tr><th>Product Code</th><th>Product Name</th><th>Balance</th><th>Last OUT</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- COMBINED HISTORY -->
    <section id="history" class="page" style="display:none">
      <h2>RM Combined History</h2>
      <div class="mb-3">
        <input id="historySearch" class="sm-search" placeholder="Search combined history...">
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="historyTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr><th>Date</th><th>Product</th><th>Type</th><th>Qty</th><th>Remark</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SUPPLIERS -->
    <section id="suppliers" class="page" style="display:none">
      <h2>Raw Material Suppliers</h2>

      <form id="supplierForm" class="d-flex gap-2 flex-wrap align-items-center mb-3" autocomplete="on">
        <div>
          <input id="newSupplierName" class="sm-small form-control" type="text" placeholder="Supplier Name" required>
        </div>
        <div>
          <input id="newSupplierContact" class="sm-small form-control" type="text" placeholder="Address Info">
        </div>
        <div>
          <input id="newSupplierPhone" class="sm-small form-control" type="tel" placeholder="Phone">
        </div>
        <div>
          <input id="newSupplierEmail" class="sm-small form-control" type="email" placeholder="Email">
        </div>
        <button id="addSupplierBtn" type="submit" class="btn btn-primary">Add Supplier</button>
      </form>

      <div class="mb-3">
        <input id="supplierSearch" class="sm-search form-control" type="search" placeholder="Search suppliers..." autocomplete="off">
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="suppliersTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Name</th><th>Address</th><th>Phone</th><th>Email</th><th>Edit</th><th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- FG STOCK LIST -->
    <section id="fgStock" class="page" style="display:none">
      <h2>Finished Goods Stock</h2>
      <div class="d-flex gap-2 flex-wrap mb-3">
        <input id="fgSearch" class="sm-search" placeholder="Search FG products / Product Code / Volume...">
      </div>

      <div class="table-responsive" style="max-height:65vh">
        <table id="fgTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Product Code</th>
            <th>Barcode</th>
            <th>Product</th>
            <th>Volume</th>
            <th>Balance</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADD FG PRODUCT -->
    <section id="fgAddProduct" class="page" style="display:none">
      <h2>Add Finished Goods Product</h2>

      <div class="d-flex gap-2 flex-wrap mb-3">
        <input id="fgNewProductcode" class="sm-small" placeholder="Product Code">
        <input id="fgNewBarcode" class="sm-small" placeholder="Barcode">
        <input id="fgNewName" class="sm-small" placeholder="Product Name">
        <input id="fgNewVolume" class="sm-small" placeholder="Volume / Size">
        <input id="fgNewGroup" class="sm-small" placeholder="Group Prefix (ALKHOR)">
        <input id="fgNewBatch" class="sm-small" placeholder="Batch / Lot No">
        <input id="fgNewExpiry" class="sm-small" type="date">
        <input id="fgNewThreshold" class="sm-small" type="number" placeholder="Low Stock Threshold">
      </div>

      <button class="btn btn-primary" onclick="addFGProduct()">Add FG Product</button>
    </section>

    <!-- FG STOCK IN -->
    <section id="fgStockIn" class="page" style="display:none">
      <h2>FG Stock In</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="fgInSearch" class="sm-search" placeholder="Search FG product...">
        <button class="btn btn-outline-secondary" onclick="fgStockInHistoryModal()">View FG IN History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr><th>#</th><th>Product Code</th><th>Product</th><th>Balance</th><th>Action</th></tr>
          </thead>
          <tbody id="fgStockInBody"></tbody>
        </table>
      </div>
    </section>

    <!-- FG STOCK OUT -->
    <section id="fgStockOut" class="page" style="display:none">
      <h2>FG Stock Out</h2>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="fgOutSearch" class="sm-search" placeholder="Search FG product...">
        <button class="btn btn-info" onclick="fgStockOutHistoryModal()">View FG OUT History</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
          <tr><th>#</th><th>Product Code</th><th>Product</th><th>Balance</th><th>Action</th></tr>
          </thead>
          <tbody id="fgStockOutBody"></tbody>
        </table>
      </div>
    </section>

    <!-- BILL OF ENTRY -->
    <section id="billEntry" class="page" style="display:none;">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h2 class="m-0">Goods Received Note</h2>
          <div class="text-muted small">Create, manage and print Bill of Entry (BOE)</div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-secondary" onclick="boeTriggerImport()">üì• Import Excel</button>
          <button class="btn btn-success" onclick="printBOESummaryReport()">üñ®Ô∏è Bills Summary</button>
        </div>
      </div>

      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white d-flex align-items-center justify-content-between">
          <div class="fw-bold">Create / Edit Bill of Entry</div>
          <span id="boeEditBadge" class="badge text-bg-success" style="display:none;">EDITING MODE</span>
        </div>

        <div class="card-body">
          <input id="boeFileInput" type="file" accept=".xlsx,.xls" class="d-none">

          <div class="row g-2 mb-3">
            <div class="col-12 col-md-6">
              <input id="boeNo" class="form-control" placeholder="Bill No / Entry No">
            </div>
            <div class="col-12 col-md-6">
              <input id="boeDate" type="date" class="form-control">
            </div>
            <div class="col-12 col-md-6">
              <select id="boeSupplier" class="form-select"></select>
            </div>
            <div class="col-12 col-md-6">
              <input id="boeSupplierOther" class="form-control" placeholder="Supplier Name (if Other)" style="display:none">
            </div>
          </div>

          <div class="border rounded-3">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>RM Product</th>
                  <th style="width:120px">Qty</th>
                  <th>Remark</th>
                  <th class="text-center" style="width:110px">Remove</th>
                </tr>
              </thead>
              <tbody id="boeItemsBody"></tbody>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-outline-primary" onclick="boeAddRow()">‚ûï Add Item</button>
            <button class="btn btn-primary" onclick="submitBillEntry()">‚úÖ Save Bill & Stock IN</button>
            <button class="btn btn-danger" onclick="resetBillEntryForm()">Clear</button>
          </div>

          <div class="text-muted small mt-2">
            Tip: Add multiple items then save once to stock-in all at the same time.
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <div class="fw-bold">Saved Bills</div>
          <input id="boeSearch" class="form-control" style="max-width:320px" placeholder="Search bill / supplier...">
        </div>

        <div class="card-body p-0">
          <div class="table-responsive" style="max-height:55vh; overflow:auto;">
            <table id="boeTable" class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th>Date</th>
                  <th>Product Code</th>
                  <th>Bill No</th>
                  <th>Product Name</th>
                  <th>Supplier</th>
                  <th class="text-end">Total Qty</th>
                  <th class="text-center">Items</th>
                  <th style="min-width:240px">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-white text-muted small">
          Tip: Use search to filter bills instantly.
        </div>
      </div>
    </section>

    <!-- PRODUCTION ENTRY -->
    <section class="page" id="productionAuto" style="display:none">
      <div class="sm-card d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div>
          <div class="h5 mb-1 fw-semibold">Production Entry</div>
          <div class="text-muted small">FG IN + RM OUT, with optional RM Damage.</div>
        </div>
        <div class="small text-muted">Tip: Search FG ‚Üí enter Qty ‚Üí check BOM ‚Üí Save</div>
      </div>

      <div class="sm-card">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Production No</label>
            <input id="prodNo" class="form-control" placeholder="PROD-001">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Date</label>
            <input id="prodDate" type="date" class="form-control">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">FG Product</label>
            <div class="position-relative" id="prodFGWrap">
              <input id="productionFGSearch" class="form-control" placeholder="Search FG..." autocomplete="off">
              <div id="prodFGList" class="list-group position-absolute w-100 shadow"
                   style="z-index:2000; max-height:260px; overflow:auto; display:none;"></div>
              <select id="prodFG" class="d-none"></select>
            </div>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label fw-semibold">FG Qty</label>
            <input id="prodFGQty" type="number" class="form-control text-end" min="0" step="0.01" value="1">
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Production Remark (optional)</label>
            <input id="prodRemark" class="form-control" placeholder="Batch / Operator / Shift...">
          </div>
        </div>
      </div>

      <div class="sm-card">
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-2">
          <div class="fw-semibold">BOM Consumption <span class="text-muted fw-normal">(FG BOM √ó FG Qty)</span></div>
          <div class="text-muted small">Damage is added to usage.</div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="min-width:240px">RM Product</th>
                <th class="text-end" style="min-width:120px">Required</th>
                <th class="text-end" style="min-width:140px">Damage</th>
                <th class="text-end" style="min-width:120px">Net Used</th>
                <th class="text-muted small">Balance</th>
              </tr>
            </thead>
            <tbody id="prodBOMBody">
              <tr><td colspan="5" class="text-muted">Select FG to load BOM.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="sm-card d-flex justify-content-end gap-2 flex-wrap">
        <button class="btn btn-outline-secondary" type="button" onclick="resetProductionForm()">Reset</button>
        <button class="btn btn-primary" type="button" onclick="submitProduction()">Save Production</button>
      </div>
    </section>

    <!-- PRODUCTION RECORDS -->
    <section class="page" id="pageProductionRecords" style="display:none">
      <div class="sm-card">
        <b>Production Records</b>
        <div class="muted">View production entries and their RM Used/Damage.</div>
      </div>

      <div class="sm-card" style="overflow:auto">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th>Date</th><th>Prod No</th><th>FG</th><th class="text-end">FG Qty</th>
              <th class="text-end">RM Lines</th><th>Created By</th><th>Actions</th>
            </tr>
            </thead>
            <tbody id="prodTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RM DELIVERY NOTE -->
    <section id="rmDeliveryNote" class="page" style="display:none">
      <h2>RM Delivery Note (Warehouse ‚Üí Factory)</h2>

      <div class="d-flex gap-3 flex-wrap align-items-start">

        <div class="sm-card" style="flex:1;min-width:320px">
          <h3 class="mb-2">Create Delivery Note</h3>

          <div class="d-flex gap-2 flex-wrap mb-2">
            <input id="dnNo" class="sm-small" placeholder="Delivery Note No">
            <input id="dnDate" class="sm-small" type="date">
            <input id="dnFrom" class="sm-small" placeholder="From (Warehouse)" value="Main Store">
            <input id="dnTo" class="sm-small" placeholder="To (Factory)" value="Factory">
            <input id="dnProdRef" class="sm-small" placeholder="Production Ref (optional)">
          </div>

          <div class="mb-2">
            <input id="dnRemark" class="sm-search" placeholder="General Remark (optional)">
          </div>

          <div class="table-responsive border rounded-3">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
              <tr><th style="min-width:240px">RM Product</th><th style="width:120px">Qty</th><th>Remark</th><th style="width:80px">Remove</th></tr>
              </thead>
              <tbody id="dnItemsBody"></tbody>
            </table>
          </div>

          <div class="d-flex gap-2 flex-wrap mt-2">
            <button class="btn btn-outline-secondary" onclick="dnAddRow()">‚ûï Add Item</button>
            <button class="btn btn-primary" onclick="submitDeliveryNote()">‚úÖ Save Delivery Note</button>
            <button class="btn btn-danger" onclick="resetDeliveryNoteForm()">Clear</button>
          </div>
        </div>

        <div class="sm-card" style="flex:1;min-width:320px">
          <h3 class="mb-2">Saved Delivery Notes</h3>
          <input id="dnSearch" class="sm-search mb-2" placeholder="Search DN no / remark...">

          <div class="table-responsive border rounded-3" style="max-height:520px">
            <table id="dnTable" class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
              <tr><th>Date</th><th>DN No</th><th>To</th><th>Total Qty</th><th>Items</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- DN VIEW MODAL -->
    <div id="dnViewModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <div>
            <div id="dnViewTitle" style="font-weight:700;font-size:16px;">Delivery Note</div>
            <div id="dnViewMeta" style="font-size:12px;color:#666;margin-top:4px;"></div>
          </div>
          <button type="button" class="btn out" onclick="closeDNView()" style="padding:6px 10px;">Close</button>
        </div>

        <div style="padding:12px 14px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <button type="button" class="btn secondary" onclick="printDNFromModal()">Print</button>
          </div>

          <div style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:10px;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:#f7f7f7;">
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">RM Product</th>
                  <th style="text-align:right;padding:10px;border-bottom:1px solid #eee;width:120px;">Qty</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Remark</th>
                </tr>
              </thead>
              <tbody id="dnViewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALS (History / Stock Modal) -->
    <div id="historyModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(980px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <h3 id="modalTitle" style="margin:0;font-size:16px;">History</h3>
          <button class="btn out" onclick="closeHistoryModal()" style="padding:6px 10px;">Close</button>
        </div>
        <div style="padding:12px 14px; max-height:70vh; overflow:auto;">
          <table class="table table-sm">
            <thead class="table-light">
              <tr>
                <th>Date</th><th>Product</th><th>Type</th><th>Qty</th><th>Batch</th><th>Expiry</th><th>Remark</th>
              </tr>
            </thead>
            <tbody id="modalHistoryBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="stockModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(520px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <h3 id="modalProductName" style="margin:0;font-size:16px;">Product</h3>
          <button class="btn out" onclick="closeStockModal()" style="padding:6px 10px;">Close</button>
        </div>
        <div style="padding:12px 14px;">
          <p class="mb-2">Balance: <span id="modalProductBalance" class="fw-bold">0</span></p>
          <div class="d-flex gap-2 flex-wrap">
            <input id="modalQty" class="form-control" type="number" placeholder="Enter quantity">
            <input id="modalRemark" class="form-control" placeholder="Enter remark (optional)">
          </div>
          <div class="d-flex gap-2 mt-3">
            <button id="modalSave" class="btn btn-primary">Submit</button>
            <button onclick="closeStockModal()" class="btn btn-outline-secondary">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GENERIC APP MODAL -->
    <div id="modal" class="app-modal" style="display:none">
      <div class="app-modal-backdrop" onclick="closeModal()"></div>
      <div class="app-modal-box">
        <div class="app-modal-header">
          <h5 id="modalTitle2">Modal</h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="closeModal()">‚úñ</button>
        </div>
        <div id="modalBody" class="app-modal-body"></div>
      </div>
    </div>

    <!-- BOE VIEW MODAL -->
    <div id="boeViewModal" class="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.45);">
      <div style="width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;">
          <div>
            <div id="boeViewTitle" style="font-weight:700;font-size:16px;">Bill of Entry</div>
            <div id="boeViewMeta" style="font-size:12px;color:#666;margin-top:4px;"></div>
          </div>
          <button type="button" class="btn out" onclick="BOE.closeView()" style="padding:6px 10px;">Close</button>
        </div>

        <div style="padding:12px 14px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <button type="button" class="btn secondary" onclick="BOE.printFromView()">Print</button>
            <button type="button" class="btn secondary" onclick="BOE.editFromView()">Edit</button>
          </div>

          <div style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:10px;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:#f7f7f7;">
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">RM Product</th>
                  <th style="text-align:right;padding:10px;border-bottom:1px solid #eee;width:120px;">Qty</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Remark</th>
                </tr>
              </thead>
              <tbody id="boeViewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="stockToast"></div>

  </main>
</div>


<script>
/* =========================================================
   ‚úÖ STOCK MANAGER ‚Äî FULL SCRIPT (CLEAN + CONSOLIDATED)
   - Removes duplicates (autoPullFromCloud / saveProductions / saveAllRM etc.)
   - Fixes undefined vars (bills, KEY_BILLS scope, deleteProduct audit bug)
   - Keeps modules: Auth + Roles, Audit, RM, FG, BOE, Production, DN, Suppliers,
     Dashboard grouped, Cloud sync (single source of truth)
========================================================= */

/* =========================
   ‚úÖ GLOBALS / STATE
========================= */
let selectedFGVolumes = new Set();
let currentUser = null;
let fgChartInstance = null;

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

const loginScreen = $('#loginScreen');
const loginForm   = $('#loginForm');
const signupForm  = $('#signupForm');
const loginMsg    = $('#loginMsg');
const signupMsg   = $('#signupMsg');

/* =========================
   ‚úÖ FIREBASE INIT (compat)
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBTtsOeQTpPwTEn_T9EDqt5i_0eyQuzGOA",
  authDomain: "stock-manager-703e6.firebaseapp.com",
  databaseURL: "https://stock-manager-703e6-default-rtdb.firebaseio.com",
  projectId: "stock-manager-703e6",
  storageBucket: "stock-manager-703e6.firebasestorage.app",
  messagingSenderId: "778548519096",
  appId: "1:778548519096:web:716f903fee993f4d85544d",
  measurementId: "G-G735N8XCQ2"
};

try{
  firebase.initializeApp(firebaseConfig);
}catch(e){
  // ignore "already exists"
}
const cloudDB = firebase.database();
window.cloudDB = cloudDB;

const CLOUD_PATH = "stockManager/v1"; // ‚úÖ single path
window.CLOUD_PATH = CLOUD_PATH;

/* =========================
   ‚úÖ UTILITIES
========================= */
function genId(){ return 'id_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000); }
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function nowISO(){ return new Date().toISOString(); }
function fmtDate(iso){
  if(!iso) return '-';
  const p = String(iso).split('-');
  if(p.length !== 3) return String(iso);
  return `${p[2]}/${p[1]}/${p[0]}`;
}
function escapeHtml(s){
  if(s == null) return '';
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
function normalizeGroup(g){
  return String(g || '').trim().toUpperCase().replace(/\s+/g,'');
}
function showToast(message, isError=false){
  const toast = $('#stockToast');
  if(!toast) return;
  toast.textContent = message;
  toast.classList.toggle('out', isError);
  toast.style.display = 'block';
  requestAnimationFrame(()=> toast.style.opacity = '1');
  setTimeout(()=>{
    toast.style.opacity = '0';
    setTimeout(()=> toast.style.display='none', 300);
  }, 2000);
}
function setBanner(url){
  const img = $('#brandBanner');
  if(img) img.src = url || 'banner.png';
  document.body.style.setProperty('--banner-url', url || 'banner.png');
}
setBanner('banner.png');

function who(){ return (currentUser?.username || currentUser?.user || "unknown"); }

/* =========================
   ‚úÖ PAGE NAV
========================= */
function openPage(pageId){
  $$('.page').forEach(p=>p.style.display='none');
  const el = document.getElementById(pageId);
  if(el) el.style.display='block';

  if(pageId === 'dashboardPage'){
    renderMainDashboard();
    renderFGVolumeFilter();
    renderFGChart();
  }
  if(pageId === 'dashboard'){
    renderDashboardGrouped();
  }
  if(pageId === 'suppliers'){
    renderSuppliers();
  }
  if(pageId === 'billEntry'){
    renderBOESupplierDropdown();
    const dt = $('#boeDate');
    if(dt && !dt.value) dt.value = todayISO();
    const body = $('#boeItemsBody');
    if(body && !body.children.length) boeAddRow();
    BOE?.renderTable?.();
  }
  if(pageId === 'productionAuto' || pageId === 'productionEntry'){
    renderProdFGDropdown();
    const dt = $('#prodDate');
    if(dt && !dt.value) dt.value = todayISO();
    renderBOM();
    renderProductionsTable();
  }
  if(pageId === 'pageProductionRecords'){
    renderProductionsTable();
  }
  if(pageId === 'rmDeliveryNote'){
    const dt = $('#dnDate');
    if(dt && !dt.value) dt.value = todayISO();
    const body = $('#dnItemsBody');
    if(body && !body.children.length) dnAddRow();
    renderDNTable();
  }

  refreshAll();
}
window.openPage = openPage;

/* =========================
   ‚úÖ ADMIN DEFAULT USER
========================= */
const DEFAULT_ADMIN = {
  username: "admin",
  password: "admin123",
  role: "admin",
  permissionLevel: "full",
  createdAt: nowISO()
};

async function ensureAdminExists(){
  try{
    const snap = await cloudDB.ref('users').orderByChild('role').equalTo('admin').once('value');
    if(!snap.exists()){
      const userId = 'admin_' + Date.now().toString(36);
      await cloudDB.ref('users/' + userId).set(DEFAULT_ADMIN);
      console.log("‚úÖ Default admin created");
    }
  }catch(err){
    console.error("‚ùå ensureAdminExists error:", err);
  }
}
ensureAdminExists();

/* =========================
   ‚úÖ ROLE PERMISSIONS
========================= */
const ROLE_PERMISSIONS = {
  full: { stockIn:true, stockOut:true, add:true, edit:true, delete:true },
  half: { stockIn:true, stockOut:true, add:true, edit:true, delete:false },
  view: { stockIn:true, stockOut:true, add:false, edit:false, delete:false }
};

function getPerms(){
  if(currentUser?.role === 'admin') return ROLE_PERMISSIONS.full;
  return ROLE_PERMISSIONS[currentUser?.permissionLevel] || ROLE_PERMISSIONS.view;
}
function canStockOut(){ return !!getPerms().stockOut; }
function canAdd(){ return !!getPerms().add; }
function canEdit(){ return !!getPerms().edit; }
function canDelete(){ return !!getPerms().delete; }

function showAdminUI(){
  const isAdmin = currentUser?.role === 'admin';
  $$('.admin-only').forEach(el=>{ el.style.display = isAdmin ? '' : 'none'; });
}
function applyPermissions(){
  showAdminUI();
  const p = getPerms();
  $$('.btn-add').forEach(b => b.style.display = p.add ? 'inline-block' : 'none');
  $$('.btn-edit').forEach(b => b.style.display = p.edit ? 'inline-block' : 'none');
  $$('.btn-delete').forEach(b => b.style.display = p.delete ? 'inline-block' : 'none');
  $$('.btn-stock-out').forEach(b => b.style.display = p.stockOut ? 'inline-block' : 'none');
}
window.applyPermissions = applyPermissions;

/* =========================
   ‚úÖ AUTH UI
========================= */
function showSignup(){
  if(loginForm) loginForm.style.display='none';
  if(signupForm) signupForm.style.display='block';
  if(loginMsg) loginMsg.textContent='';
}
function showLogin(){
  if(loginForm) loginForm.style.display='block';
  if(signupForm) signupForm.style.display='none';
  if(signupMsg) signupMsg.textContent='';
}
window.showSignup = showSignup;
window.showLogin = showLogin;

async function signup(){
  const signupUser = $('#signupUser');
  const signupPass = $('#signupPass');
  const signupRole = $('#signupRole');

  const u = (signupUser?.value || '').trim();
  const p = (signupPass?.value || '');
  const role = (signupRole?.value || 'user');

  if(!u || !p){ if(signupMsg) signupMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(snap.exists()){ if(signupMsg) signupMsg.textContent="Username already taken"; return; }

    const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
    await cloudDB.ref('users/'+userId).set({
      username:u,
      password:p,
      role,
      permissionLevel:'view',
      createdAt: nowISO()
    });

    if(signupMsg){
      signupMsg.style.color="green";
      signupMsg.textContent="Account created! Please login.";
    }
    showLogin();
  }catch(err){
    console.error(err);
    if(signupMsg) signupMsg.textContent="Signup failed";
  }
}
window.signup = signup;

async function login(){
  const loginUser = $('#loginUser');
  const loginPass = $('#loginPass');

  const u = (loginUser?.value || '').trim();
  const p = (loginPass?.value || '');

  if(!u || !p){ if(loginMsg) loginMsg.textContent="Enter username & password"; return; }

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
    if(!snap.exists()){ if(loginMsg) loginMsg.textContent="Invalid login"; return; }

    const userData = Object.values(snap.val() || {})[0];
    if(userData?.password !== p){ if(loginMsg) loginMsg.textContent="Invalid login"; return; }

    currentUser = userData;
    localStorage.setItem('sms_currentUser', JSON.stringify(currentUser));

    if(loginScreen) loginScreen.style.display='none';
    const app = $('.app');
    if(app) app.style.display='flex';

    applyPermissions();

    if(currentUser.role === 'admin'){
      openPage('userManagement');
      renderUsersTable();
    }else{
      openPage('dashboardPage');
    }
  }catch(err){
    console.error(err);
    if(loginMsg) loginMsg.textContent="Login failed";
  }
}
window.login = login;

function logout(){
  localStorage.removeItem('sms_currentUser');
  location.reload();
}
window.logout = logout;

async function forgotPassword(){
  const username = prompt("Enter your username to reset password:");
  if(!username || !username.trim()) return;

  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username.trim()).once('value');
    if(!snap.exists()){ alert("Username not found"); return; }

    const userId = Object.keys(snap.val() || {})[0];
    const userData = (snap.val() || {})[userId];

    const newPass = prompt(`Enter new password for "${userData.username}":`);
    if(!newPass || !newPass.trim()) return alert("Password cannot be empty");

    await cloudDB.ref('users/'+userId+'/password').set(newPass.trim());
    alert("Password reset success. Login with new password.");
  }catch(err){
    console.error(err);
    alert("Failed to reset password");
  }
}
window.forgotPassword = forgotPassword;

/* =========================
   ‚úÖ USER MANAGEMENT
========================= */
function changeUserPermission(username, level){
  if(currentUser?.role !== 'admin'){ showToast("Only admin can change roles", true); return; }
  if(username === 'admin'){ showToast("Admin permission cannot be changed", true); return; }

  cloudDB.ref('users').orderByChild('username').equalTo(username).once('value')
    .then(snap=>{
      if(!snap.exists()) return;
      const userId = Object.keys(snap.val() || {})[0];
      cloudDB.ref('users/'+userId+'/permissionLevel').set(level);
      showToast("User permission updated ‚úÖ");
    });
}
window.changeUserPermission = changeUserPermission;

async function deleteUser(username){
  if(!confirm(`Delete "${username}"?`)) return;
  try{
    const snap = await cloudDB.ref('users').orderByChild('username').equalTo(username).once('value');
    if(!snap.exists()) return alert("User not found");
    const userId = Object.keys(snap.val() || {})[0];
    const userData = (snap.val() || {})[userId];
    if(userData.role === 'admin') return alert("Cannot delete admin");
    await cloudDB.ref('users/'+userId).remove();
    showToast("User deleted ‚úÖ");
    renderUsersTable();
  }catch(err){
    console.error(err);
    alert("Failed to delete user");
  }
}
window.deleteUser = deleteUser;

async function renderUsersTable(){
  const tbody = $('#usersTable tbody');
  if(!tbody) return;

  tbody.innerHTML = '';
  const snap = await cloudDB.ref('users').once('value');
  const users = snap.val() ? Object.values(snap.val()) : [];

  users.forEach((u,i)=>{
    const perm = u.permissionLevel || 'view';
    const isAdminRow = (u.role === 'admin' || u.username === 'admin');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(u.username)}</td>
      <td>
        ${
          isAdminRow
            ? `<b>Full (Admin)</b>`
            : (currentUser?.role === 'admin'
              ? `
                <select onchange="changeUserPermission('${escapeHtml(u.username)}', this.value)">
                  <option value="full" ${perm==='full'?'selected':''}>Full</option>
                  <option value="half" ${perm==='half'?'selected':''}>Half</option>
                  <option value="view" ${perm==='view'?'selected':''}>View</option>
                </select>
              `
              : escapeHtml(perm)
            )
        }
      </td>
      <td>
        ${
          (!isAdminRow && currentUser?.role === 'admin')
            ? `<button class="btn out" onclick="deleteUser('${escapeHtml(u.username)}')">Delete</button>`
            : ''
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}
window.renderUsersTable = renderUsersTable;

async function addUser(){
  if(currentUser?.role !== 'admin'){ showToast("Only admin can add users", true); return; }

  const u = ($('#newUsername')?.value || '').trim();
  const p = ($('#newPassword')?.value || '');
  const role = ($('#newRole')?.value || 'user');

  if(!u || !p){ showToast("Username & password required", true); return; }

  const snap = await cloudDB.ref('users').orderByChild('username').equalTo(u).once('value');
  if(snap.exists()){ showToast("Username already exists", true); return; }

  const userId = 'u_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*1000);
  await cloudDB.ref('users/'+userId).set({
    username: u,
    password: p,
    role,
    permissionLevel: (role === 'admin' ? 'full' : 'view'),
    createdAt: nowISO()
  });

  if($('#newUsername')) $('#newUsername').value = '';
  if($('#newPassword')) $('#newPassword').value = '';
  if($('#newRole')) $('#newRole').value = 'user';

  showToast("User added ‚úÖ");
  renderUsersTable();
}
window.addUser = addUser;

/* =========================
   ‚úÖ AUDIT LOG
========================= */
const KEY_AUDIT = "sm_audit_v1";
let auditLog = JSON.parse(localStorage.getItem(KEY_AUDIT) || "[]");

function saveAudit(){ localStorage.setItem(KEY_AUDIT, JSON.stringify(auditLog)); }

function logChange(action, entityId, details = {}){
  auditLog.push({ id: "log_" + genId(), at: nowISO(), by: who(), action, entityId, details });
  if(auditLog.length > 5000) auditLog = auditLog.slice(auditLog.length - 5000);
  saveAudit();
}
window.logChange = logChange;

/* =========================
   ‚úÖ LOCAL STORAGE KEYS
========================= */
const KEY_PRODUCTS = 'sms_products_final_v1';
const KEY_MOVES    = 'sms_movements_final_v1';

const KEY_FG_PRODS = 'sms_fg_products';
const KEY_FG_MOVES = 'sms_fg_movements';

const KEY_SUPPLIERS = "sms_suppliers_v1";
const KEY_BILLS     = "sms_bills_v1";
const KEY_PROD      = "sms_productions_v1";
const KEY_DN        = "sms_delivery_notes_v1";

/* =========================
   ‚úÖ RM DATA
========================= */
let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
let stockMovements = JSON.parse(localStorage.getItem(KEY_MOVES) || '[]');

function saveRM(){
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products || []));
  localStorage.setItem(KEY_MOVES, JSON.stringify(stockMovements || []));
}
window.saveRM = saveRM;

function computeBalance(productId){
  let bal=0;
  (stockMovements||[]).forEach(m=>{
    if(m.productId===productId) bal += (m.type==='IN' ? Number(m.quantity||0) : -Number(m.quantity||0));
  });
  return bal>0 ? bal : 0;
}
function lastMovement(productId, type){
  const moves = (stockMovements||[]).filter(m=>m.productId===productId && m.type===type);
  if(!moves.length) return '-';
  return moves[moves.length-1].date || '-';
}
window.computeBalance = computeBalance;

/* =========================
   ‚úÖ FG DATA
========================= */
let fgProducts  = JSON.parse(localStorage.getItem(KEY_FG_PRODS) || '[]');
let fgMovements = JSON.parse(localStorage.getItem(KEY_FG_MOVES) || '[]');

function saveFGLocal(){
  localStorage.setItem(KEY_FG_PRODS, JSON.stringify(fgProducts || []));
  localStorage.setItem(KEY_FG_MOVES, JSON.stringify(fgMovements || []));
}
window.saveFGLocal = saveFGLocal;

function computeFGBalance(fgId){
  return (fgMovements||[]).reduce((sum,m)=>{
    if(m.fgId===fgId) return sum + (m.type==='IN'? Number(m.qty||0) : -Number(m.qty||0));
    return sum;
  },0);
}
window.computeFGBalance = computeFGBalance;

function initFGVolumeSelection(){
  if(selectedFGVolumes.size) return;
  (fgProducts||[]).forEach(f=>{
    const v = (f.volume||'').trim();
    if(v) selectedFGVolumes.add(v);
  });
}
window.initFGVolumeSelection = initFGVolumeSelection;

/* =========================
   ‚úÖ DASHBOARD (MAIN CARDS)
========================= */
function getFGLowStockCount(){
  return (fgProducts||[]).filter(f => computeFGBalance(f.id) <= (Number(f.threshold ?? 5))).length;
}

function renderMainDashboard(){
  const totalProductsEl = document.getElementById('dashTotalProducts');
  const totalStockEl    = document.getElementById('dashTotalStock');
  const lowStockEl      = document.getElementById('dashLowStock');
  const fgBalanceEl     = document.getElementById('dashFGBalance');

  const fgTotalEl       = document.getElementById('dashFGTotalProducts');
  const fgLowEl         = document.getElementById('dashFGLowStock');
  const fgMaxEl         = document.getElementById('dashFGMaxBalance');
  const fgMinEl         = document.getElementById('dashFGMinBalance');

  // If the 4 main RM cards don't exist, just exit safely
  if(!totalProductsEl || !totalStockEl || !lowStockEl || !fgBalanceEl) return;

  // --------------------
  // RM cards
  // --------------------
  const rmList = Array.isArray(products) ? products : [];
  const rmMoves = Array.isArray(stockMovements) ? stockMovements : [];

  totalProductsEl.textContent = rmList.length;

  let totalStock = 0;
  let lowStock = 0;

  rmList.forEach(p=>{
    const bal = Number(computeBalance?.(p.id) || 0);
    totalStock += bal;

    const thr = Number(p.threshold ?? 5);
    if(bal <= thr) lowStock++;
  });

  totalStockEl.textContent = totalStock;
  lowStockEl.textContent = lowStock;

  // --------------------
  // FG cards
  // --------------------
  const fgList = Array.isArray(fgProducts) ? fgProducts : [];

  const fgTotalBalance = fgList.reduce((sum,f)=> sum + Number(computeFGBalance?.(f.id) || 0), 0);
  fgBalanceEl.textContent = fgTotalBalance;

  if(fgTotalEl) fgTotalEl.textContent = fgList.length;

  if(fgLowEl){
    const lowCount = fgList.filter(f=>{
      const bal = Number(computeFGBalance?.(f.id) || 0);
      const thr = Number(f.threshold ?? 5);
      return bal <= thr;
    }).length;
    fgLowEl.textContent = lowCount;
  }

  // Max FG
  if(fgMaxEl){
    if(!fgList.length){
      fgMaxEl.textContent = '-';
    }else{
      let maxFG = { name:'-', balance: -Infinity };
      fgList.forEach(f=>{
        const bal = Number(computeFGBalance?.(f.id) || 0);
        if(bal > maxFG.balance){
          maxFG = { name: (f.name || '-'), balance: bal };
        }
      });
      fgMaxEl.textContent = (maxFG.balance === -Infinity) ? '-' : `${maxFG.name} (${maxFG.balance})`;
    }
  }

  // Min FG  ‚úÖ (NO "min" variable anywhere)
  if(fgMinEl){
    if(!fgList.length){
      fgMinEl.textContent = '-';
    }else{
      let minFG = { name:'-', balance: Infinity };
      fgList.forEach(f=>{
        const bal = Number(computeFGBalance?.(f.id) || 0);
        if(bal < minFG.balance){
          minFG = { name: (f.name || '-'), balance: bal };
        }
      });
      fgMinEl.textContent = (minFG.balance === Infinity) ? '-' : `${minFG.name} (${minFG.balance})`;
    }
  }
}

window.renderMainDashboard = renderMainDashboard;

/* =========================
   ‚úÖ FG FILTER + CHART
========================= */
function renderFGVolumeFilter(){
  const wrap = $('#fgVolumeFilter');
  if(!wrap) return;

  const volumes = [...new Set((fgProducts||[]).map(f=>(f.volume||'').trim()).filter(Boolean))].sort();
  wrap.innerHTML = '';

  if(!selectedFGVolumes.size){
    volumes.forEach(v=> selectedFGVolumes.add(v));
  }

  volumes.forEach(vol=>{
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems='center';
    label.style.gap='4px';
    label.style.cursor='pointer';

    const checked = selectedFGVolumes.has(vol);

    label.innerHTML = `
      <input type="checkbox" ${checked ? 'checked':''}>
      ${escapeHtml(vol)}
    `;

    label.querySelector('input').onchange = e=>{
      if(e.target.checked) selectedFGVolumes.add(vol);
      else selectedFGVolumes.delete(vol);

      if(!selectedFGVolumes.size){
        volumes.forEach(v=> selectedFGVolumes.add(v));
        renderFGVolumeFilter();
      }
      renderFGChart();
    };

    wrap.appendChild(label);
  });
}
window.renderFGVolumeFilter = renderFGVolumeFilter;

function renderFGChart(){
  const canvas = $('#fgStockChart');
  if(!canvas || !window.Chart) return;

  const filteredFG = (fgProducts||[]).filter(f => selectedFGVolumes.has((f.volume||'').trim()));
  const labels = filteredFG.map(f => (f.name||'').length>12 ? f.name.slice(0,12)+'‚Ä¶' : f.name);
  const data   = filteredFG.map(f => computeFGBalance(f.id));

  if(fgChartInstance) fgChartInstance.destroy();
  if(!filteredFG.length) return;

  fgChartInstance = new Chart(canvas, {
    type:'bar',
    data:{ labels, datasets:[{ data, borderRadius:8, barThickness:22, backgroundColor:'rgba(41,128,185,0.65)' }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            title:(items)=> filteredFG[items[0].dataIndex].name,
            label:(ctx)=> `Balance: ${ctx.raw}`
          }
        }
      },
      scales:{ x:{ grid:{display:false} }, y:{ beginAtZero:true } }
    }
  });
}
window.renderFGChart = renderFGChart;

/* =========================
   ‚úÖ FG PAGES
========================= */
let fgOnlyLow = false;
function openFGFromDashboard(){ fgOnlyLow = false; openPage('fgStock'); }
function openLowFGFromDashboard(){ fgOnlyLow = true; openPage('fgStock'); }
window.openFGFromDashboard = openFGFromDashboard;
window.openLowFGFromDashboard = openLowFGFromDashboard;

function renderFGStock(){
  const tbody = $('#fgTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = ($('#fgSearch')?.value || '').toLowerCase().trim();
  const sorted = [...(fgProducts||[])].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;

    const bal = computeFGBalance(p.id);
    const thr = Number(p.threshold ?? 5);

    if(fgOnlyLow && !(bal <= thr)) return;

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.productcode||'-')}</td>
        <td>${escapeHtml(p.barcode||'-')}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.volume||'-')}</td>
        <td class="${bal <= thr ? 'low-stock' : ''}">${bal}</td>
        <td>
          <button class="btn info" onclick="viewFGHistory('${p.id}')">üëÅ View</button>
          ${currentUser?.role === 'admin' ? `
            <button class="btn secondary btn-edit" onclick="editFGProduct('${p.id}')">‚úèÔ∏è Edit</button>
            <button class="btn out btn-delete" onclick="deleteFGProduct('${p.id}')">üóë Delete</button>
          `:''}
        </td>
      </tr>
    `);
  });

  applyPermissions();
}
window.renderFGStock = renderFGStock;

function renderFGStockIn(){
  const tbody = $('#fgStockInBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = ($('#fgInSearch')?.value || '').toLowerCase().trim();
  const sorted = [...(fgProducts||[])].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.productcode||'-')}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn" onclick="openFGModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}
window.renderFGStockIn = renderFGStockIn;

function renderFGStockOut(){
  const tbody = $('#fgStockOutBody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = ($('#fgOutSearch')?.value || '').toLowerCase().trim();
  const sorted = [...(fgProducts||[])].sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  let i=1;
  sorted.forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeFGBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.productcode||'-')}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${bal}</td>
        <td><button class="btn out btn-stock-out" onclick="openFGModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}
window.renderFGStockOut = renderFGStockOut;

function viewFGHistory(fgId){
  const fg = (fgProducts||[]).find(f=>f.id===fgId);
  if(!fg) return;

  const modal = $('#historyModal');
  if(!modal) return;

  modal.style.display='flex';
  $('#modalTitle').textContent = `FG History ‚Äî ${fg.name}`;

  const tbody = $('#modalHistoryBody');
  if(!tbody) return;
  tbody.innerHTML='';

  (fgMovements||[])
    .filter(m=>m.fgId===fgId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(fg.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.qty||0)}</td>
          <td>${escapeHtml(m.batch||fg.batch||'-')}</td>
          <td>${escapeHtml(m.expiry||fg.expiry||'-')}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
window.viewFGHistory = viewFGHistory;

/* =========================================================
   ‚úÖ BOE MODULE (GLOBAL, NO DUPLICATES)
========================================================= */
window.BOE = (() => {
  // bills live in localStorage KEY_BILLS
  let bills = JSON.parse(localStorage.getItem(KEY_BILLS) || '[]');
  window.savedBills = bills; // backward compatibility

  let editingId = null;
  let lastViewedId = null;

  const rmCode = (p) => String(p?.code || p?.productCode || p?.sku || p?.barcode || '').trim();
  const rmName = (p) => String(p?.name || 'Unnamed').trim();
  const rmLabel = (p) => (rmCode(p) ? `(${rmCode(p)}) ${rmName(p)}` : rmName(p)).trim();

  function saveBills(){
    localStorage.setItem(KEY_BILLS, JSON.stringify(bills || []));
    window.savedBills = bills;
  }
  window.saveBills = saveBills; // old code safety

  function canStockIn(){
    if(currentUser?.role === 'admin') return true;
    return !!getPerms().stockIn;
  }

  function getSupplierNameFromUI(){
    const sel = $('#boeSupplier');
    const other = $('#boeSupplierOther');
    if(!sel) return '';
    if(sel.value === '__OTHER__') return (other?.value || '').trim();

    const list = Array.isArray(window.suppliers) ? window.suppliers : [];
    const s = list.find(x => x.id === sel.value);
    return (s?.name || sel.value || '').trim();
  }

  function renderSupplierDropdown(){
    const sel = $('#boeSupplier');
    const other = $('#boeSupplierOther');
    if(!sel) return;

    const list = Array.isArray(window.suppliers) ? window.suppliers : [];
    sel.innerHTML = `<option value="">Select Supplier</option>`;

    list.forEach(s=>{
      sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)}</option>`);
    });

    sel.insertAdjacentHTML('beforeend', `<option value="__OTHER__">Other...</option>`);

    sel.onchange = () => {
      if(!other) return;
      if(sel.value === '__OTHER__'){
        other.style.display = '';
        other.focus();
      }else{
        other.style.display = 'none';
        other.value = '';
      }
    };
  }

  /* --- RM search per row --- */
  function initRowSearch(tr){
    const input = tr.querySelector('[data-boe="productSearch"]');
    const dd = tr.querySelector('.rm-search-dd');
    if(!input || !dd) return;
    if(input._inited) return;
    input._inited = true;

    let results = [];
    let active = -1;

    const close = () => { dd.style.display='none'; dd.innerHTML=''; active=-1; };
    const open  = () => { dd.style.display='block'; };

    const clearSelection = () => {
      input.dataset.productId = '';
      input.setAttribute('data-product-id','');
    };

    const render = (list) => {
      results = list;
      if(!list.length){
        dd.innerHTML = `<div class="rm-search-empty">No matches</div>`;
        open(); return;
      }
      dd.innerHTML = list.map((p,i)=>`
        <div class="rm-search-item" data-i="${i}">
          ${escapeHtml(rmLabel(p))}
        </div>
      `).join('');
      open();
    };

    const search = () => {
      const q = (input.value||'').toLowerCase().trim();
      const all = [...(products||[])].sort((a,b)=> rmLabel(a).localeCompare(rmLabel(b)));

      if(!q) return render(all.slice(0,25));

      const out = all.filter(p=>{
        const t = rmLabel(p).toLowerCase();
        const c = rmCode(p).toLowerCase();
        return t.includes(q) || c.includes(q);
      }).slice(0,50);

      render(out);
    };

    const select = (p) => {
      input.value = rmLabel(p);
      input.dataset.productId = p.id;
      input.setAttribute('data-product-id', p.id);
      close();
    };

    const highlight = () => {
      const items = [...dd.querySelectorAll('.rm-search-item')];
      items.forEach((el,i)=> el.classList.toggle('active', i===active));
      dd.querySelector(`.rm-search-item[data-i="${active}"]`)?.scrollIntoView({block:'nearest'});
    };

    input.addEventListener('focus', search);
    input.addEventListener('input', ()=>{ clearSelection(); search(); });

    input.addEventListener('keydown', (e)=>{
      const isOpen = dd.style.display !== 'none';
      if((e.key==='ArrowDown' || e.key==='Enter') && !isOpen){ search(); return; }
      if(!isOpen) return;

      if(e.key==='ArrowDown'){ e.preventDefault(); active = Math.min(active+1, results.length-1); highlight(); }
      if(e.key==='ArrowUp'){ e.preventDefault(); active = Math.max(active-1, 0); highlight(); }
      if(e.key==='Escape'){ close(); }
      if(e.key==='Enter'){
        if(active>=0 && results[active]){ e.preventDefault(); select(results[active]); }
      }
    });

    dd.addEventListener('mousedown', (e)=>{
      const item = e.target.closest('.rm-search-item');
      if(!item) return;
      e.preventDefault();
      const i = Number(item.dataset.i);
      if(Number.isFinite(i) && results[i]) select(results[i]);
    });

    const onDocDown = (e)=>{ if(!tr.contains(e.target)) close(); };
    document.addEventListener('mousedown', onDocDown);
    tr._cleanup = ()=> document.removeEventListener('mousedown', onDocDown);
  }

  function addRow(prefill=null){
    const body = $('#boeItemsBody');
    if(!body) return;

    const rowId = 'boeRow_' + genId();

    const productId = String(prefill?.productId || '').trim();
    const qty = (prefill?.qty ?? '');
    const remark = (prefill?.remark ?? '');

    let prefillText = '';
    if(productId){
      const p = (products||[]).find(x=>x?.id === productId);
      if(p) prefillText = rmLabel(p);
    }

    body.insertAdjacentHTML('beforeend', `
      <tr id="${rowId}">
        <td>
          <div class="rm-search-wrap">
            <input class="rm-search-input small"
              placeholder="Search RM..."
              autocomplete="off"
              data-boe="productSearch"
              data-product-id="${escapeHtml(productId)}"
              value="${escapeHtml(prefillText)}">
            <div class="rm-search-dd"></div>
          </div>
        </td>

        <td><input class="small" type="number" min="0" step="1" style="width:100%" data-boe="qty" value="${escapeHtml(String(qty))}"></td>
        <td><input class="small" style="width:100%" data-boe="remark" value="${escapeHtml(String(remark))}" placeholder="Remark (optional)"></td>

        <td style="text-align:center">
          <button class="btn out" style="padding:6px 10px" type="button" data-boe="remove">X</button>
        </td>
      </tr>
    `);

    const tr = document.getElementById(rowId);
    if(!tr) return;

    initRowSearch(tr);

    tr.querySelector('[data-boe="remove"]')?.addEventListener('click', ()=>{
      if(typeof tr._cleanup === 'function') tr._cleanup();
      tr.remove();
      if(!$('#boeItemsBody')?.children.length) addRow();
    });
  }

  function resetForm(){
    editingId = null;
    const badge = $('#boeEditBadge');
    if(badge) badge.style.display = 'none';

    const no = $('#boeNo');
    const dt = $('#boeDate');
    const sp = $('#boeSupplier');
    const other = $('#boeSupplierOther');
    const body = $('#boeItemsBody');

    if(no) no.value = '';
    if(dt) dt.value = todayISO();
    if(sp) sp.value = '';
    if(other){ other.value=''; other.style.display='none'; }
    if(body) body.innerHTML = '';

    addRow();
  }

  function getItemsFromUI(){
    const body = $('#boeItemsBody');
    if(!body) return [];

    const out = [];
    [...body.querySelectorAll('tr')].forEach(tr=>{
      const rmInp  = tr.querySelector('[data-boe="productSearch"]');
      const qtyInp = tr.querySelector('[data-boe="qty"]');
      const remInp = tr.querySelector('[data-boe="remark"]');

      const productId = String(rmInp?.dataset.productId || rmInp?.getAttribute('data-product-id') || '').trim();
      const qty = Number(qtyInp?.value || 0);
      const remark = (remInp?.value || '').trim();

      if(!productId) return;
      if(qty <= 0) return;

      out.push({ productId, qty, remark });
    });
    return out;
  }

  function revertLinkedStock(billId){
    stockMovements = (stockMovements||[]).filter(m => m.billId !== billId);
  }

  function postStock(bill){
    (bill.items||[]).forEach(it=>{
      stockMovements.push({
        id: genId(),
        productId: it.productId,
        type: 'IN',
        quantity: Number(it.qty || 0),
        date: bill.date,
        remark: `BOE ${bill.billNo}${it.remark ? ' - ' + it.remark : ''}`,
        billId: bill.id,
        createdAt: nowISO(),
        createdBy: who()
      });
    });
  }

  function submit(){
    if(!canStockIn()){ showToast("Stock IN not allowed for your role", true); return; }

    const billNo = ($('#boeNo')?.value || '').trim();
    const billDate = ($('#boeDate')?.value || todayISO());
    const supplierId = ($('#boeSupplier')?.value || '').trim();
    const supplierName = getSupplierNameFromUI();

    if(!billNo) return showToast("Bill No is required", true);
    if(!billDate) return showToast("Bill Date is required", true);
    if(!supplierId) return showToast("Select supplier (or Other)", true);
    if(supplierId === '__OTHER__' && !supplierName) return showToast("Enter supplier name", true);

    const items = getItemsFromUI();
    if(!items.length) return showToast("Add at least 1 item (select RM + qty > 0)", true);

    // EDIT
    if(editingId){
      const idx = bills.findIndex(b=>b.id === editingId);
      if(idx === -1){ editingId=null; return showToast("Bill not found (edit)", true); }

      const old = bills[idx];
      revertLinkedStock(old.id);

      const updated = {
        ...old,
        billNo,
        date: billDate,
        supplierId,
        supplierName,
        items,
        updatedAt: nowISO(),
        updatedBy: who()
      };

      bills[idx] = updated;
      saveBills();
      postStock(updated);

      logChange("BOE_EDIT", updated.id, {
        billNo: updated.billNo,
        date: updated.date,
        supplier: updated.supplierName,
        lines: (updated.items || []).length
      });

      saveRM();
      autoPushToCloud();
      refreshAll();

      showToast("Bill updated & stock re-posted ‚úÖ");
      resetForm();
      renderTable();
      return;
    }

    // CREATE
    const bill = {
      id: 'boe_' + genId(),
      billNo,
      date: billDate,
      supplierId,
      supplierName,
      items,
      createdAt: nowISO(),
      createdBy: who()
    };

    bills.push(bill);
    saveBills();
    postStock(bill);

    logChange("BOE_CREATE", bill.id, {
      billNo: bill.billNo,
      date: bill.date,
      supplier: bill.supplierName,
      lines: (bill.items || []).length
    });

    saveRM();
    autoPushToCloud();
    refreshAll();

    showToast("Bill saved & Stock IN created ‚úÖ");
    resetForm();
    renderTable();
  }

  const totalQty = (b)=> (b.items||[]).reduce((s,it)=> s + Number(it.qty||0), 0);

  function renderTable(){
    const tbody = $('#boeTable tbody');
    if(!tbody) return;

    const q = ($('#boeSearch')?.value || '').toLowerCase().trim();
    tbody.innerHTML = '';

    const list = [...bills].sort((a,b)=> new Date(b.date) - new Date(a.date));
    const isAdmin = currentUser?.role === 'admin';

    const codesSummary = (b)=>{
      const set = new Set();
      (b.items||[]).forEach(it=>{
        const p = (products||[]).find(x=>x.id===it.productId);
        const c = rmCode(p);
        if(c) set.add(c);
      });
      return [...set].join(', ');
    };

    const namesSummary = (b)=>{
      const set = new Set();
      (b.items||[]).forEach(it=>{
        const p = (products||[]).find(x=>x.id===it.productId);
        const n = rmName(p);
        if(n) set.add(n);
      });
      return [...set].join(', ');
    };

    list.forEach(b=>{
      const match =
        !q ||
        String(b.billNo||'').toLowerCase().includes(q) ||
        String(b.supplierName||'').toLowerCase().includes(q) ||
        codesSummary(b).toLowerCase().includes(q) ||
        namesSummary(b).toLowerCase().includes(q);

      if(!match) return;

      const codesText = escapeHtml(codesSummary(b) || '-');
      const namesText = escapeHtml(namesSummary(b) || '-');

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${fmtDate(b.date)}</td>
          <td title="${codesText}">${codesText}</td>
          <td>${escapeHtml(b.billNo||'')}</td>
          <td title="${namesText}">${namesText}</td>
          <td>${escapeHtml(b.supplierName||'')}</td>
          <td>${totalQty(b)}</td>
          <td>${(b.items||[]).length}</td>
          <td>
            <button class="btn info" type="button" onclick="BOE.view('${escapeHtml(b.id)}')">View</button>
            <button class="btn secondary" type="button" onclick="BOE.print('${escapeHtml(b.id)}')">Print</button>
            ${isAdmin ? `<button class="btn secondary" type="button" onclick="BOE.openEdit('${escapeHtml(b.id)}')">Edit</button>` : ``}
            ${isAdmin ? `<button class="btn out" type="button" onclick="BOE.remove('${escapeHtml(b.id)}')">Delete</button>` : ``}
          </td>
        </tr>
      `);
    });

    applyPermissions();
  }

  function view(billId){
    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    lastViewedId = billId;

    $('#boeViewTitle').textContent = `Bill of Entry ‚Äî ${b.billNo}`;
    $('#boeViewMeta').innerHTML =
      `<b>Date:</b> ${fmtDate(b.date)} &nbsp; | &nbsp; <b>Supplier:</b> ${escapeHtml(b.supplierName||'')}
       ${b.createdBy ? ` &nbsp; | &nbsp; <b>By:</b> ${escapeHtml(b.createdBy)}` : ''}`;

    const body = $('#boeViewBody');
    if(body) body.innerHTML = '';

    (b.items||[]).forEach(it=>{
      const p = (products||[]).find(x=>x.id===it.productId);
      body?.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${escapeHtml(p ? rmLabel(p) : 'Unknown')}</td>
          <td>${Number(it.qty||0)}</td>
          <td>${escapeHtml(it.remark||'')}</td>
        </tr>
      `);
    });

    const modal = $('#boeViewModal');
    if(modal) modal.style.display = 'flex';
  }

  function closeView(){ const m = $('#boeViewModal'); if(m) m.style.display='none'; }
  function printFromView(){ if(lastViewedId) print(lastViewedId); }
  function editFromView(){ if(lastViewedId){ openEdit(lastViewedId); closeView(); } }

  function openEdit(billId){
    if(currentUser?.role !== 'admin') return showToast("Only admin can edit bills", true);
    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    openPage('billEntry');

    editingId = billId;
    const badge = $('#boeEditBadge');
    if(badge) badge.style.display = '';

    $('#boeNo').value = b.billNo || '';
    $('#boeDate').value = b.date || todayISO();

    renderSupplierDropdown();

    const supplierSel = $('#boeSupplier');
    const other = $('#boeSupplierOther');

    if(supplierSel){
      const has = [...supplierSel.options].some(o => o.value === b.supplierId);
      if(has){
        supplierSel.value = b.supplierId;
        if(other){ other.style.display='none'; other.value=''; }
      }else{
        supplierSel.value = '__OTHER__';
        if(other){ other.style.display=''; other.value = b.supplierName || ''; }
      }
      supplierSel.dispatchEvent(new Event('change'));
    }

    const body = $('#boeItemsBody');
    if(body) body.innerHTML = '';
    (b.items||[]).forEach(it=> addRow({ productId: it.productId, qty: it.qty, remark: it.remark }));
    if(body && !body.children.length) addRow();

    showToast("Editing BOE ‚Äî update and Save ‚úÖ");
  }

  function remove(billId){
    if(currentUser?.role !== 'admin') return showToast("Only admin can delete bills", true);
    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    if(!confirm(`Delete BOE "${b.billNo}"?\nThis will also remove linked RM Stock IN movements.`)) return;

    bills = bills.filter(x=>x.id !== billId);
    window.savedBills = bills;
    saveBills();
    revertLinkedStock(billId);

    logChange("BOE_DELETE", billId, { billNo: b.billNo, date: b.date, supplier: b.supplierName });

    saveRM();
    autoPushToCloud();
    refreshAll();

    showToast("Bill deleted & stock reverted ‚úÖ");
    renderTable();
  }

  function print(billId){
    const b = bills.find(x=>x.id===billId);
    if(!b) return;

    const hasPDF = !!(window.jspdf?.jsPDF);
    const hasAutoTable = !!(window.jspdf?.jsPDF && window.jspdf?.jsPDF.API?.autoTable);

    if(hasPDF){
      const doc = new window.jspdf.jsPDF();
      doc.setFontSize(14);
      doc.text(`Goods Received Note (BOE) - ${b.billNo}`, 14, 16);
      doc.setFontSize(10);
      doc.text(`Date: ${fmtDate(b.date)}    Supplier: ${b.supplierName || ''}`, 14, 24);

      const rows = (b.items||[]).map((it, idx)=>{
        const p = (products||[]).find(x=>x.id===it.productId);
        return [ String(idx+1), p ? rmLabel(p) : 'Unknown', String(Number(it.qty||0)), it.remark || '' ];
      });

      if(hasAutoTable){
        doc.autoTable({ startY: 30, head: [['#','RM Product','Qty','Remark']], body: rows });
      }else{
        let y = 34;
        rows.forEach(r=>{ doc.text(`${r[0]}. ${r[1]} | Qty: ${r[2]} | ${r[3]}`, 14, y); y += 6; });
      }
      doc.save(`BOE_${b.billNo}.pdf`);
      return;
    }

    const w = window.open('', '_blank');
    if(!w) return showToast("Popup blocked by browser", true);

    const itemsHtml = (b.items||[]).map(it=>{
      const p = (products||[]).find(x=>x.id===it.productId);
      return `<tr><td>${escapeHtml(p ? rmLabel(p) : 'Unknown')}</td><td>${Number(it.qty||0)}</td><td>${escapeHtml(it.remark||'')}</td></tr>`;
    }).join('');

    w.document.write(`
      <html><head><title>BOE ${escapeHtml(b.billNo)}</title>
      <style>
        body{font-family:Arial;padding:16px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ddd;padding:8px;font-size:12px}
        th{background:#f3f3f3}
      </style>
      </head><body>
        <h2>Goods Received Note (BOE) - ${escapeHtml(b.billNo)}</h2>
        <div><b>Date:</b> ${fmtDate(b.date)} &nbsp; <b>Supplier:</b> ${escapeHtml(b.supplierName||'')}</div>
        <br/>
        <table>
          <thead><tr><th>RM Product</th><th>Qty</th><th>Remark</th></tr></thead>
          <tbody>${itemsHtml}</tbody>
        </table>
        <script>window.print();<\/script>
      </body></html>
    `);
    w.document.close();
  }

  function init(){
    renderSupplierDropdown();
    const dt = $('#boeDate');
    if(dt && !dt.value) dt.value = todayISO();

    const body = $('#boeItemsBody');
    if(body && !body.children.length) addRow();

    $('#boeSearch')?.addEventListener('input', renderTable);
    renderTable();
  }

  return {
    init,
    renderSupplierDropdown,
    addRow,
    resetForm,
    submit,
    renderTable,
    view,
    closeView,
    print,
    printFromView,
    editFromView,
    openEdit,
    remove,
    saveBills,
    // expose bills safely (used by cloud)
    getBills: ()=> bills,
    setBills: (arr)=>{ bills = Array.isArray(arr)? arr : []; window.savedBills=bills; saveBills(); }
  };
})();

const BOE = window.BOE;
window.BOE = BOE;

/* wrappers */
function renderBOESupplierDropdown(){ BOE.renderSupplierDropdown(); }
function boeAddRow(){ BOE.addRow(); }
function submitBillEntry(){ BOE.submit(); }
function resetBillEntryForm(){ BOE.resetForm(); }
function closeBOEView(){ BOE.closeView(); }
function printBOEFromView(){ BOE.printFromView(); }
function editBOEFromView(){ BOE.editFromView(); }

window.renderBOESupplierDropdown = renderBOESupplierDropdown;
window.boeAddRow = boeAddRow;
window.submitBillEntry = submitBillEntry;

/* =========================
   ‚úÖ PRODUCTION MODULE
========================= */
let productions = JSON.parse(localStorage.getItem(KEY_PROD) || '[]');
window.productions = productions;

function saveProductions(){
  localStorage.setItem(KEY_PROD, JSON.stringify(productions || []));
  window.productions = productions;
}
window.saveProductions = saveProductions;

function canProduction(){
  if(!currentUser) return true;
  const role = String(currentUser.role || '').toLowerCase();
  return role === 'admin' || role === 'manager' || role === 'production';
}
window.canProduction = canProduction;

function bomKey(v){ return normalizeGroup(v); }

function getBOMRMForFG(fgId){
  const fg = (fgProducts||[]).find(x => String(x.id) === String(fgId));
  if(!fg) return { fg:null, key:'', list:[] };
  const key = bomKey(fg.group); // ‚úÖ fg.group only

  const list = (products||[]).filter(rm=>{
    const gs = Array.isArray(rm.groups) ? rm.groups : [];
    if(!gs.length) return false;
    const use = rm.exclusive ? [gs[0]] : gs;
    return use.some(g => bomKey(g) === key);
  });

  return { fg, key, list };
}
window.getBOMRMForFG = getBOMRMForFG;

function renderBOM(){
  const fgId  = String($('#prodFG')?.value || '').trim();
  const fgQty = Number($('#prodFGQty')?.value || 0) || 0;
  const body  = $('#prodBOMBody');
  if(!body) return;

  body.innerHTML = '';

  if(!fgId){
    body.innerHTML = `<tr><td colspan="5" class="text-muted">Select FG product</td></tr>`;
    return;
  }

  const { fg, key, list } = getBOMRMForFG(fgId);

  if(!fg){ body.innerHTML = `<tr><td colspan="5" class="text-muted">FG not found</td></tr>`; return; }
  if(!key){ body.innerHTML = `<tr><td colspan="5" class="text-muted">This FG has no group set</td></tr>`; return; }
  if(!list.length){
    body.innerHTML = `<tr><td colspan="5" class="text-muted">
      No RM found in group: <b>${escapeHtml(key)}</b><br>
      (Add same group inside RM ‚Üí Groups field)
    </td></tr>`;
    return;
  }

  list.forEach(rm=>{
    const per = Number(rm.qtyPerFG || 1);
    const req = per * fgQty;

    body.insertAdjacentHTML('beforeend', `
      <tr data-rm="${escapeHtml(String(rm.id))}">
        <td><b>${escapeHtml(rm.name || 'Unknown')}</b></td>
        <td class="text-end reqQty">${Number(req.toFixed(6))}</td>
        <td class="text-end">
          <input class="form-control form-control-sm damQty"
                 type="number" min="0" step="0.0001" value="0"
                 oninput="calcNetUsed(this)">
        </td>
        <td class="text-end netUsed">${Number(req.toFixed(6))}</td>
        <td class="text-muted small">
          Bal: <span class="rmBal">${Number(computeBalance(rm.id) || 0)}</span>
        </td>
      </tr>
    `);
  });
}
window.renderBOM = renderBOM;

function calcNetUsed(el){
  const tr = el.closest('tr');
  if(!tr) return;

  const req = Number(tr.querySelector('.reqQty')?.textContent || 0);
  let dmg = Number(tr.querySelector('.damQty')?.value || 0);

  if(dmg < 0) dmg = 0;
  if(dmg > req) dmg = req;

  tr.querySelector('.damQty').value = String(dmg);
  const net = Math.max(0, req - dmg);
  tr.querySelector('.netUsed').textContent = Number(net.toFixed(6));
}
window.calcNetUsed = calcNetUsed;

function collectRMLines(){
  const rows = [...document.querySelectorAll('#prodBOMBody tr[data-rm]')];
  return rows.map(tr=>{
    const rmId = String(tr.dataset.rm || '').trim();
    const req  = Number(tr.querySelector('.reqQty')?.textContent || 0);
    const dmg  = Number(tr.querySelector('.damQty')?.value || 0);
    const net  = Number((req - dmg).toFixed(6));
    return { rmId, req, dmg, net };
  }).filter(l => l.rmId);
}

function validateProductionInput(prodNo, fgId, fgQty, rmLines){
  if(!prodNo) return "Production No required";
  if(!fgId) return "Select FG product";
  if(!(fgQty > 0)) return "FG Qty must be > 0";
  if(!rmLines.length) return "No BOM rows found";

  for(const l of rmLines){
    if(l.dmg < 0) return "Damage cannot be negative";
    if(l.dmg > l.req) return "Damage cannot exceed Required";
    if(l.net > 0){
      const bal = Number(computeBalance(l.rmId) || 0);
      if(l.net > bal){
        const p = (products||[]).find(x => x.id === l.rmId);
        return `RM stock insufficient: ${p?.name || 'RM'} (Bal ${bal})`;
      }
    }
  }
  return "";
}

function submitProduction(){
  if(!canProduction()){ showToast("No permission to create production", true); return; }

  const prodNo   = String($('#prodNo')?.value || '').trim();
  const prodDate = String($('#prodDate')?.value || todayISO());
  const fgId     = String($('#prodFG')?.value || '').trim();
  const fgQty    = Number($('#prodFGQty')?.value || 0);
  const remark   = String($('#prodRemark')?.value || '').trim();

  const rmLines = collectRMLines();
  const err = validateProductionInput(prodNo, fgId, fgQty, rmLines);
  if(err){ showToast(err, true); return; }

  const fg = (fgProducts||[]).find(x => x.id === fgId);
  const productionId = 'prod_' + genId();

  const record = {
    id: productionId,
    prodNo,
    date: prodDate,
    fgId,
    fgName: fg?.name || '',
    fgQty,
    remark,
    rmLines: rmLines.map(({rmId, req, dmg}) => ({ rmId, req, dmg })),
    createdAt: nowISO(),
    createdBy: who()
  };

  productions.push(record);

  fgMovements.push({
    id: genId(),
    fgId,
    type: 'IN',
    qty: fgQty,
    date: prodDate,
    remark: `PROD ${prodNo}${remark ? ' - ' + remark : ''}`,
    productionId,
    createdAt: nowISO(),
    createdBy: who()
  });

  rmLines.forEach(l=>{
    if(l.net > 0){
      stockMovements.push({
        id: genId(),
        productId: l.rmId,
        type: 'OUT',
        quantity: l.net,
        date: prodDate,
        remark: `PROD ${prodNo} RM Used`,
        productionId,
        createdAt: nowISO(),
        createdBy: who()
      });
    }
    if(l.dmg > 0){
      stockMovements.push({
        id: genId(),
        productId: l.rmId,
        type: 'OUT',
        quantity: Number(l.dmg.toFixed(6)),
        date: prodDate,
        remark: `PROD ${prodNo} RM Damage`,
        productionId,
        createdAt: nowISO(),
        createdBy: who()
      });
    }
  });

  logChange("PROD_CREATE", productionId, { prodNo, date: prodDate, fgName: fg?.name || '', fgQty });

  saveProductions();
  saveRM();
  saveFGLocal();

  autoPushFGToCloud();
  autoPushToCloud();

  refreshAll();
  showToast("Production saved ‚úÖ");

  if($('#prodNo')) $('#prodNo').value = '';
  if($('#prodRemark')) $('#prodRemark').value = '';
  if($('#prodFG')) $('#prodFG').value = '';
  if($('#prodFGQty')) $('#prodFGQty').value = 1;
  const bomBody = $('#prodBOMBody');
  if(bomBody) bomBody.innerHTML = `<tr><td colspan="5" class="text-muted">Select FG product</td></tr>`;

  openPage('pageProductionRecords');
  renderProductionsTable();
}
window.submitProduction = submitProduction;

function renderProductionsTable(){
  const tb = $('#prodTableBody');
  if(!tb) return;

  const list = Array.isArray(productions) ? productions : [];
  const rows = list.slice().sort((a,b)=> (b.date||'').localeCompare(a.date||''));

  tb.innerHTML = rows.length ? '' : `<tr><td colspan="7" class="muted">No production records</td></tr>`;

  rows.forEach(p=>{
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(p.date||'')}</td>
        <td><b>${escapeHtml(p.prodNo||'')}</b></td>
        <td>${escapeHtml(p.fgName||'')}</td>
        <td class="right">${Number(p.fgQty||0)}</td>
        <td class="right">${(p.rmLines||[]).length}</td>
        <td>${escapeHtml(p.createdBy||'')}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" onclick="viewProduction('${escapeHtml(p.id)}')">View</button>
        </td>
      </tr>
    `);
  });
}
window.renderProductionsTable = renderProductionsTable;

function renderProdFGDropdown(){
  const sel = $('#prodFG');
  if(!sel) return;

  const list = Array.isArray(fgProducts) ? fgProducts : [];
  sel.innerHTML = `<option value="">Select FG Product</option>`;
  list.slice().sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
    .forEach(f=>{
      sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(f.id)}">${escapeHtml(f.name||'Unnamed')}</option>`);
    });
}
window.renderProdFGDropdown = renderProdFGDropdown;

/* Simple modal for production view */
function closeAppModal(){
  const modal = $('#modal');
  if(modal) modal.style.display = 'none';
}
window.closeModal = window.closeModal || closeAppModal;

function viewProduction(id){
  const p = (productions||[]).find(x => String(x.id) === String(id));
  if(!p){ showToast("Production not found", true); return; }

  const modal = $('#modal');
  if(!modal){ alert("Modal element #modal not found"); return; }

  const titleEl = $('#modalTitle2') || $('#modalTitle');
  const bodyEl  = $('#modalBody');

  const lines = (p.rmLines || []).map(l=>{
    const rm = (products||[]).find(x=>x.id===l.rmId);
    const net = Number((Number(l.req||0) - Number(l.dmg||0)).toFixed(6));
    return `
      <tr>
        <td>${escapeHtml(rm?.name || 'Unknown')}</td>
        <td class="text-end"><b>${net}</b></td>
        <td class="text-end">${Number(l.dmg || 0)}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="3" class="text-muted">No lines</td></tr>`;

  if(titleEl) titleEl.textContent = `Production ${p.prodNo || ''}`;
  if(bodyEl){
    bodyEl.innerHTML = `
      <div class="row g-2">
        <div class="col-12 col-md-3"><div class="text-muted small">Date</div><b>${escapeHtml(p.date||'')}</b></div>
        <div class="col-12 col-md-6"><div class="text-muted small">FG</div><b>${escapeHtml(p.fgName||'')}</b></div>
        <div class="col-12 col-md-3"><div class="text-muted small">FG Qty</div><b>${Number(p.fgQty||0)}</b></div>
        <div class="col-12"><div class="text-muted small">Remark</div><div>${escapeHtml(p.remark||'')}</div></div>
        <div class="col-12 mt-2" style="overflow:auto">
          <b>RM Lines</b>
          <table class="table table-sm mt-2">
            <thead class="table-light">
              <tr><th>RM</th><th class="text-end">Net Used</th><th class="text-end">Damage</th></tr>
            </thead>
            <tbody>${lines}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  modal.style.display = 'block';
}
window.viewProduction = viewProduction;

/* =========================
   ‚úÖ DELIVERY NOTE (DN)
========================= */
let deliveryNotes = JSON.parse(localStorage.getItem(KEY_DN) || '[]');
window.deliveryNotes = deliveryNotes;

function saveDeliveryNotes(){
  localStorage.setItem(KEY_DN, JSON.stringify(deliveryNotes || []));
  window.deliveryNotes = deliveryNotes;
}
window.saveDeliveryNotes = saveDeliveryNotes;

function resetDeliveryNoteForm(){
  if($('#dnNo')) $('#dnNo').value = '';
  if($('#dnDate')) $('#dnDate').value = todayISO();
  if($('#dnFrom')) $('#dnFrom').value = $('#dnFrom').value || 'Main Store';
  if($('#dnTo')) $('#dnTo').value = $('#dnTo').value || 'Factory';
  if($('#dnProdRef')) $('#dnProdRef').value = '';
  if($('#dnRemark')) $('#dnRemark').value = '';
  const body = $('#dnItemsBody');
  if(body) body.innerHTML = '';
  dnAddRow();
}
window.resetDeliveryNoteForm = resetDeliveryNoteForm;

function dnRowProductOptions(selectedId=''){
  if(!Array.isArray(products) || !products.length){
    return `<option value="">No RM products found</option>`;
  }
  const sorted = [...products].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  return `<option value="">Select RM Product</option>` + sorted.map(p=>{
    const sel = p.id === selectedId ? 'selected' : '';
    const code = p.code ? `(${p.code}) ` : '';
    return `<option ${sel} value="${escapeHtml(p.id)}">${escapeHtml(code + (p.name||''))}</option>`;
  }).join('');
}

function dnAddRow(prefill=null){
  const body = $('#dnItemsBody');
  if(!body) return;

  const rowId = 'dnRow_' + genId();
  const selectedProductId = prefill?.productId || '';
  const qty = prefill?.qty ?? '';
  const remark = prefill?.remark ?? '';

  body.insertAdjacentHTML('beforeend', `
    <tr id="${rowId}">
      <td>
        <select class="small" style="width:100%" data-dn="product">
          ${dnRowProductOptions(selectedProductId)}
        </select>
      </td>
      <td>
        <input class="small" type="number" min="0" step="1" style="width:100%" data-dn="qty" value="${escapeHtml(qty)}">
      </td>
      <td>
        <input class="small" style="width:100%" data-dn="remark" value="${escapeHtml(remark)}" placeholder="Remark (optional)">
      </td>
      <td style="text-align:center">
        <button class="btn out" style="padding:6px 10px" type="button" onclick="dnRemoveRow('${rowId}')">X</button>
      </td>
    </tr>
  `);
}
window.dnAddRow = dnAddRow;

function dnRemoveRow(rowId){
  document.getElementById(rowId)?.remove();
  const body = $('#dnItemsBody');
  if(body && body.children.length === 0) dnAddRow();
}
window.dnRemoveRow = dnRemoveRow;

function getDNItemsFromUI(){
  const body = $('#dnItemsBody');
  if(!body) return [];

  const items = [];
  [...body.querySelectorAll('tr')].forEach(tr=>{
    const prodSel = tr.querySelector('[data-dn="product"]');
    const qtyInp  = tr.querySelector('[data-dn="qty"]');
    const remInp  = tr.querySelector('[data-dn="remark"]');

    const productId = (prodSel?.value || '').trim();
    const qty = Number(qtyInp?.value || 0);
    const remark = (remInp?.value || '').trim();

    if(productId && qty > 0) items.push({ productId, qty, remark });
  });

  return items;
}

function dnTotalQty(dn){ return (dn.items || []).reduce((s,it)=> s + Number(it.qty||0), 0); }

let lastDNViewedId = null;

function submitDeliveryNote(){
  const dnNo = ($('#dnNo')?.value || '').trim();
  const dnDate = ($('#dnDate')?.value || todayISO());
  const from = ($('#dnFrom')?.value || '').trim();
  const to = ($('#dnTo')?.value || '').trim();
  const prodRef = ($('#dnProdRef')?.value || '').trim();
  const generalRemark = ($('#dnRemark')?.value || '').trim();

  if(!dnNo){ showToast("DN No is required", true); return; }
  if(!dnDate){ showToast("DN Date is required", true); return; }
  if(!to){ showToast("To (Factory) is required", true); return; }

  const items = getDNItemsFromUI();
  if(!items.length){ showToast("Add at least 1 RM item (qty > 0)", true); return; }

  const dnId = 'dn_' + genId();
  const dn = {
    id: dnId,
    dnNo,
    date: dnDate,
    from,
    to,
    prodRef,
    generalRemark,
    items,
    createdAt: nowISO(),
    createdBy: who()
  };

  deliveryNotes.push(dn);
  window.deliveryNotes = deliveryNotes;
  saveDeliveryNotes();

  logChange("DN_CREATE", dnId, { dnNo, date: dnDate, to, lines: items.length });

  autoPushToCloud();
  refreshAll();

  showToast("Delivery Note saved ‚úÖ");
  resetDeliveryNoteForm();
}
window.submitDeliveryNote = submitDeliveryNote;

function renderDNTable(){
  const tbody = $('#dnTable tbody');
  if(!tbody) return;

  const q = ($('#dnSearch')?.value || '').toLowerCase().trim();
  tbody.innerHTML = '';

  const list = [...(deliveryNotes||[])].sort((a,b)=> new Date(b.date) - new Date(a.date));

  list.forEach(dn=>{
    const hay = `${dn.dnNo||''} ${dn.to||''} ${dn.prodRef||''} ${dn.generalRemark||''}`.toLowerCase();
    if(q && !hay.includes(q)) return;

    const total = dnTotalQty(dn);
    const itemsCount = (dn.items || []).length;
    const canDel = (currentUser?.role === 'admin');

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${fmtDate(dn.date)}</td>
        <td>${escapeHtml(dn.dnNo)}</td>
        <td>${escapeHtml(dn.to || '')}</td>
        <td>${total}</td>
        <td>${itemsCount}</td>
        <td>
          <button class="btn info" onclick="viewDN('${escapeHtml(dn.id)}')">View</button>
          <button class="btn secondary" onclick="printDN('${escapeHtml(dn.id)}')">Print</button>
          ${canDel ? `<button class="btn out" onclick="deleteDN('${escapeHtml(dn.id)}')">Delete</button>` : ``}
        </td>
      </tr>
    `);
  });

  applyPermissions();
}
window.renderDNTable = renderDNTable;

function viewDN(id){
  const dn = (deliveryNotes||[]).find(x=>x.id===id);
  if(!dn) return;

  lastDNViewedId = id;

  $('#dnViewTitle').textContent = `Delivery Note ‚Äî ${dn.dnNo}`;
  $('#dnViewMeta').innerHTML =
    `<b>Date:</b> ${fmtDate(dn.date)}
     &nbsp; | &nbsp; <b>From:</b> ${escapeHtml(dn.from || '-')}
     &nbsp; | &nbsp; <b>To:</b> ${escapeHtml(dn.to || '-')}
     ${dn.prodRef ? ` &nbsp; | &nbsp; <b>Production Ref:</b> ${escapeHtml(dn.prodRef)}` : ''}
     ${dn.createdBy ? ` &nbsp; | &nbsp; <b>By:</b> ${escapeHtml(dn.createdBy)}` : ''}
     ${dn.generalRemark ? `<br><b>Remark:</b> ${escapeHtml(dn.generalRemark)}` : ''}`;

  const body = $('#dnViewBody');
  if(body) body.innerHTML = '';

  (dn.items || []).forEach(it=>{
    const p = (products||[]).find(x=>x.id===it.productId);
    body?.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(p?.name || 'Unknown')}</td>
        <td>${Number(it.qty||0)}</td>
        <td>${escapeHtml(it.remark||'')}</td>
      </tr>
    `);
  });

  $('#dnViewModal').style.display = 'flex';
}
window.viewDN = viewDN;

function closeDNView(){ const m = $('#dnViewModal'); if(m) m.style.display='none'; }
window.closeDNView = closeDNView;

function printDNFromModal(){ if(lastDNViewedId) printDN(lastDNViewedId); }
window.printDNFromModal = printDNFromModal;

function printDN(id){
  const dn = (deliveryNotes||[]).find(x=>x.id===id);
  if(!dn) return;

  const rows = (dn.items || []).map((it, idx)=>{
    const p = (products||[]).find(x=>x.id===it.productId);
    return { sr: idx+1, product: p?.name || 'Unknown', qty: Number(it.qty||0), remark: it.remark || '' };
  });

  const totalQty = rows.reduce((s,r)=> s + Number(r.qty||0), 0);

  const w = window.open('', '_blank');
  if(!w){ showToast("Popup blocked by browser", true); return; }

  const logoUrl = "pdflogo.png";

  w.document.write(`
  <html>
  <head>
    <title>Delivery Note ${escapeHtml(dn.dnNo)}</title>
    <style>
      body{font-family:Arial;padding:22px;color:#111}
      .head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;gap:14px}
      .leftHead{display:flex;gap:12px;align-items:flex-start}
      .logo{width:70px;height:70px;object-fit:contain;border:1px solid #ddd;border-radius:10px;padding:6px;background:#fff}
      .box{border:1px solid #ccc;border-radius:10px;padding:12px}
      h2{margin:0 0 6px}
      .meta{font-size:13px;line-height:1.6;color:#333}
      table{width:100%;border-collapse:collapse;margin-top:12px}
      th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:13px}
      th{background:#007bff;color:#fff}
      .foot{display:flex;justify-content:space-between;margin-top:18px;gap:12px}
      .sign{flex:1;border-top:1px dashed #999;padding-top:10px;font-size:13px}
      .small{font-size:12px;color:#555;margin-top:6px}
      .right{text-align:right}
    </style>
  </head>

  <body>
    <div class="head">
      <div class="leftHead">
        <img class="logo" src="${logoUrl}" alt="Logo">
        <div>
          <h2>RM DELIVERY NOTE</h2>
          <div class="meta">
            <b>DN No:</b> ${escapeHtml(dn.dnNo)}<br>
            <b>Date:</b> ${escapeHtml(fmtDate(dn.date))}<br>
            <b>From:</b> ${escapeHtml(dn.from || '-')}<br>
            <b>To:</b> ${escapeHtml(dn.to || '-')}<br>
            ${dn.prodRef ? `<b>Production Ref:</b> ${escapeHtml(dn.prodRef)}<br>` : ``}
            ${dn.generalRemark ? `<b>Remark:</b> ${escapeHtml(dn.generalRemark)}<br>` : ``}
          </div>
        </div>
      </div>

      <div class="box right">
        <div style="font-weight:700">Stock Manager</div>
        <div class="small">Printable Delivery Note</div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:60px">Sr</th>
          <th>RM Product</th>
          <th style="width:120px">Qty</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${r.sr}</td>
            <td>${escapeHtml(r.product)}</td>
            <td>${r.qty}</td>
            <td>${escapeHtml(r.remark)}</td>
          </tr>
        `).join('')}
        <tr>
          <td colspan="2" style="text-align:right"><b>Total</b></td>
          <td><b>${totalQty}</b></td>
          <td></td>
        </tr>
      </tbody>
    </table>

    <div class="foot">
      <div class="sign"><b>Prepared By</b><div class="small">Name / Sign</div></div>
      <div class="sign"><b>Issued By (Store)</b><div class="small">Name / Sign</div></div>
      <div class="sign"><b>Received By (Factory)</b><div class="small">Name / Sign</div></div>
    </div>

    <script>window.onload=()=>window.print();<\/script>
  </body>
  </html>
  `);

  w.document.close();
}
window.printDN = printDN;

function deleteDN(id){
  if(currentUser?.role !== 'admin'){ showToast("Only admin can delete DN", true); return; }
  const dn = (deliveryNotes||[]).find(x=>x.id===id);
  if(!dn) return;
  if(!confirm(`Delete DN "${dn.dnNo}"?`)) return;

  deliveryNotes = (deliveryNotes||[]).filter(x=>x.id!==id);
  window.deliveryNotes = deliveryNotes;
  saveDeliveryNotes();

  logChange("DN_DELETE", id, { dnNo: dn.dnNo, date: dn.date });

  autoPushToCloud();
  refreshAll();
  showToast("DN deleted ‚úÖ");
}
window.deleteDN = deleteDN;

/* =========================
   ‚úÖ SUPPLIERS
========================= */
window.suppliers = JSON.parse(localStorage.getItem(KEY_SUPPLIERS) || "[]");

function saveSuppliers(){
  localStorage.setItem(KEY_SUPPLIERS, JSON.stringify(window.suppliers || []));
}
window.saveSuppliers = saveSuppliers;

function renderSuppliers(){
  const tbody = $("#suppliersTable tbody");
  if(!tbody) return;

  const q = ($("#supplierSearch")?.value || "").toLowerCase().trim();
  const list = Array.isArray(window.suppliers) ? window.suppliers : [];

  const filtered = list
    .filter(s=>{
      const hay = `${s.name||""} ${s.contact||""} ${s.phone||""} ${s.email||""}`.toLowerCase();
      return !q || hay.includes(q);
    })
    .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||"")));

  tbody.innerHTML = filtered.length ? "" : `<tr><td colspan="7" class="text-muted">No suppliers found</td></tr>`;

  filtered.forEach((s, idx)=>{
    const canEditRow = (currentUser?.role === "admin") || canEdit();
    const canDelRow  = (currentUser?.role === "admin") || canDelete();

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${idx+1}</td>
        <td><b>${escapeHtml(s.name||"")}</b></td>
        <td>${escapeHtml(s.contact||"")}</td>
        <td>${escapeHtml(s.phone||"")}</td>
        <td>${escapeHtml(s.email||"")}</td>
        <td>${canEditRow ? `<button class="btn secondary btn-sm" type="button" onclick="editSupplier('${escapeHtml(s.id)}')">Edit</button>` : ``}</td>
        <td>${canDelRow ? `<button class="btn out btn-sm" type="button" onclick="deleteSupplier('${escapeHtml(s.id)}')">Delete</button>` : ``}</td>
      </tr>
    `);
  });

  renderBOESupplierDropdown();
}
window.renderSuppliers = renderSuppliers;

function addSupplier(){
  if(!canAdd()){ showToast("No permission to add supplier", true); return; }

  const name = ($("#newSupplierName")?.value || "").trim();
  const contact = ($("#newSupplierContact")?.value || "").trim();
  const phone = ($("#newSupplierPhone")?.value || "").trim();
  const email = ($("#newSupplierEmail")?.value || "").trim();

  if(!name){ showToast("Supplier name required", true); return; }

  const exists = (window.suppliers || []).some(s => (s.name||"").toLowerCase() === name.toLowerCase());
  if(exists){ showToast("Supplier already exists", true); return; }

  window.suppliers.push({
    id: "sup_" + genId(),
    name,
    contact,
    phone,
    email,
    createdAt: nowISO(),
    createdBy: who()
  });

  saveSuppliers();
  autoPushToCloud();
  renderSuppliers();
  showToast("Supplier added ‚úÖ");

  if($("#newSupplierName")) $("#newSupplierName").value = "";
  if($("#newSupplierContact")) $("#newSupplierContact").value = "";
  if($("#newSupplierPhone")) $("#newSupplierPhone").value = "";
  if($("#newSupplierEmail")) $("#newSupplierEmail").value = "";
}
window.addSupplier = addSupplier;

function editSupplier(id){
  if(!canEdit()){ showToast("No permission to edit supplier", true); return; }

  const s = (window.suppliers || []).find(x => x.id === id);
  if(!s) return;

  const newName = prompt("Supplier Name:", s.name || "");
  if(newName === null) return;
  const newAddr = prompt("Address Info:", s.contact || "");
  if(newAddr === null) return;
  const newPhone = prompt("Phone:", s.phone || "");
  if(newPhone === null) return;
  const newEmail = prompt("Email:", s.email || "");
  if(newEmail === null) return;

  s.name = String(newName).trim();
  s.contact = String(newAddr).trim();
  s.phone = String(newPhone).trim();
  s.email = String(newEmail).trim();
  s.updatedAt = nowISO();
  s.updatedBy = who();

  saveSuppliers();
  autoPushToCloud();
  renderSuppliers();
  showToast("Supplier updated ‚úÖ");
}
window.editSupplier = editSupplier;

function deleteSupplier(id){
  if(!canDelete()){ showToast("No permission to delete supplier", true); return; }

  const s = (window.suppliers || []).find(x => x.id === id);
  if(!s) return;
  if(!confirm(`Delete supplier "${s.name}"?`)) return;

  window.suppliers = (window.suppliers || []).filter(x => x.id !== id);
  saveSuppliers();
  autoPushToCloud();
  renderSuppliers();
  showToast("Supplier deleted ‚úÖ");
}
window.deleteSupplier = deleteSupplier;

/* =========================
   ‚úÖ FG CRUD
========================= */
function autoPushFGToCloud(){
  if(!cloudDB) return Promise.resolve();

  const payload = {
    products: Array.isArray(fgProducts) ? fgProducts : [],
    movements: Array.isArray(fgMovements) ? fgMovements : [],
    updatedAt: nowISO()
  };

  return cloudDB.ref("fgManager").set(payload).catch(err=>{
    console.error("autoPushFGToCloud failed:", err);
    showToast("FG sync failed (check Firebase rules)", true);
  });
}
window.autoPushFGToCloud = autoPushFGToCloud;

function autoPullFGFromCloud(){
  if(!cloudDB) return Promise.resolve();

  return cloudDB.ref("fgManager").once("value")
    .then(snap=>{
      if(!snap.exists()) return;
      const data = snap.val() || {};
      const normArr = (v) => Array.isArray(v) ? v : (v && typeof v === "object" ? Object.values(v) : []);
      fgProducts  = normArr(data.products);
      fgMovements = normArr(data.movements);

      saveFGLocal();
      initFGVolumeSelection();
      refreshAll();
      renderProdFGDropdown();
      renderBOM();
    })
    .catch(err=>{
      console.error("autoPullFGFromCloud failed:", err);
      showToast("FG pull failed (check Firebase rules)", true);
    });
}
window.autoPullFGFromCloud = autoPullFGFromCloud;

function addFGProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const elCode = $('#fgNewProductcode');
  const elBar  = $('#fgNewBarcode');
  const elName = $('#fgNewName');
  const elVol  = $('#fgNewVolume');
  const elGrp  = $('#fgNewGroup');
  const elBat  = $('#fgNewBatch');
  const elExp  = $('#fgNewExpiry');
  const elThr  = $('#fgNewThreshold');

  const name = (elName?.value || "").trim();
  const rawGroup = (elGrp?.value || "").trim();
  if(!name || !rawGroup){ showToast("Name & Group required", true); return; }

  fgProducts.push({
    id: 'fg_' + genId(),
    name,
    group: normalizeGroup(rawGroup),
    productcode: (elCode?.value || "").trim(),
    barcode: (elBar?.value || "").trim(),
    volume: (elVol?.value || "").trim(),
    batch: (elBat?.value || "").trim(),
    expiry: (elExp?.value || "").trim(),
    threshold: Number(elThr?.value || 5)
  });

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();

  if(elName) elName.value = '';
  if(elVol) elVol.value = '';
  if(elGrp) elGrp.value = '';
  if(elBat) elBat.value = '';
  if(elExp) elExp.value = '';
  if(elThr) elThr.value = '';
  if(elCode) elCode.value = '';
  if(elBar) elBar.value = '';

  showToast("FG product added ‚úÖ");
}
window.addFGProduct = addFGProduct;

function editFGProduct(fgId){
  if(!canEdit()){ showToast("No permission to edit", true); return; }
  const fg = (fgProducts||[]).find(f => f.id === fgId);
  if(!fg) return;

  const newProductcode = prompt("Edit Product Code:", fg.productcode || "");
  if(newProductcode === null) return;
  const newBarcode = prompt("Edit Product barcode:", fg.barcode || "");
  if(newBarcode === null) return;
  const newName = prompt("Edit Product Name:", fg.name || "");
  if(newName === null) return;
  if(!newName.trim()){ showToast("Name required", true); return; }
  const newVolume = prompt("Edit Volume / Size:", fg.volume || "");
  if(newVolume === null) return;
  const newGroup = prompt("Edit Group Prefix:", fg.group || "");
  if(newGroup === null) return;
  if(!newGroup.trim()){ showToast("Group required", true); return; }
  const newBatch = prompt("Edit Batch / Lot No:", fg.batch || "");
  if(newBatch === null) return;
  const newExpiry = prompt("Edit Expiry Date (YYYY-MM-DD):", fg.expiry || "");
  if(newExpiry === null) return;
  const newThreshold = prompt("Edit Low Stock Threshold:", String(fg.threshold ?? 5));
  if(newThreshold === null) return;
  if(isNaN(Number(newThreshold))){ showToast("Threshold must be a number", true); return; }

  fg.name       = newName.trim();
  fg.productcode= String(newProductcode||'').trim();
  fg.barcode    = String(newBarcode||'').trim();
  fg.volume     = String(newVolume||'').trim();
  fg.group      = normalizeGroup(newGroup);
  fg.batch      = String(newBatch||'').trim();
  fg.expiry     = String(newExpiry||'').trim();
  fg.threshold  = Number(newThreshold);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();
  showToast("FG updated ‚úÖ");
}
window.editFGProduct = editFGProduct;

function deleteFGProduct(fgId){
  if(!canDelete()){ showToast("No permission to delete", true); return; }

  const fg = (fgProducts||[]).find(f => f.id === fgId);
  if(!fg) return;
  if(!confirm(`Delete FG "${fg.name}"? (History also deleted)`)) return;

  fgProducts = (fgProducts||[]).filter(f => f.id !== fgId);
  fgMovements = (fgMovements||[]).filter(m => m.fgId !== fgId);

  saveFGLocal();
  autoPushFGToCloud();
  refreshAll();
  showToast("FG deleted ‚úÖ");
}
window.deleteFGProduct = deleteFGProduct;

/* =========================
   ‚úÖ RM PAGES + CRUD + MODALS
========================= */
function renderProductsTable(){
  const tbody = $('#productsTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const localSearch = ($('#productSearch')?.value || '').trim().toLowerCase();

  let i=1;
  (products||[]).forEach(p=>{
    const name = (p.name||'').toLowerCase();
    const cat  = (p.category||'').toLowerCase();
    if(localSearch && !name.includes(localSearch) && !cat.includes(localSearch)) return;

    const bal = computeBalance(p.id);

    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${escapeHtml(p.category||'')}</td>
        <td>${bal}</td>
        <td>${Number(p.threshold ?? 5)}</td>
        <td>${escapeHtml(p.barcode||'')}</td>
        <td><button class="btn secondary" onclick="openHistory('${p.id}')">History</button></td>
        <td><button class="btn secondary btn-edit admin-only" onclick="editProduct('${p.id}')">Edit</button></td>
        <td><button class="btn out btn-delete admin-only" onclick="deleteProduct('${p.id}')">Delete</button></td>
      </tr>
    `);
  });

  applyPermissions();
}
window.renderProductsTable = renderProductsTable;

function renderStockIn(){
  const tbody = $('#stockInBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = ($('#inSearch')?.value || '').toLowerCase().trim();

  (products||[]).forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'IN')}</td>
        <td><button class="btn" onclick="openStockModal('${p.id}','IN')">Stock In</button></td>
      </tr>
    `);
  });
}
window.renderStockIn = renderStockIn;

function renderStockOut(){
  const tbody = $('#stockOutBody tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = ($('#outSearch')?.value || '').toLowerCase().trim();

  (products||[]).forEach(p=>{
    if(search && !(p.name||'').toLowerCase().includes(search)) return;
    const bal = computeBalance(p.id);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${escapeHtml(p.code||'')}</td>
        <td>${escapeHtml(p.name||'')}</td>
        <td>${bal}</td>
        <td>${lastMovement(p.id,'OUT')}</td>
        <td><button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock Out</button></td>
      </tr>
    `);
  });

  applyPermissions();
}
window.renderStockOut = renderStockOut;

function renderCombinedHistory(){
  const tbody = $('#historyTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const search = ($('#historySearch')?.value || '').toLowerCase().trim();

  (stockMovements||[])
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      const prod = (products||[]).find(p=>p.id===m.productId);
      if(!prod) return;

      const okSearch =
        !search ||
        (prod.name||'').toLowerCase().includes(search) ||
        (m.remark||'').toLowerCase().includes(search);

      if(!okSearch) return;

      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name||'')}</td>
          <td>${escapeHtml(m.type||'')}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
window.renderCombinedHistory = renderCombinedHistory;

/* Stock modal (RM + FG share) */
let modalCurrent = null;

function openStockModal(productId, type){
  if(type === 'OUT' && !canStockOut()){ showToast("Stock OUT not allowed for your role", true); return; }
  modalCurrent = { productId, type };

  const prod = (products||[]).find(p=>p.id===productId);
  if(!prod) return;

  $('#modalProductName').textContent = prod.name;
  $('#modalProductBalance').textContent = computeBalance(productId);
  $('#modalQty').value = '';
  $('#modalRemark').value = '';

  $('#stockModal').style.display = 'flex';

  $('#modalSave').onclick = ()=>{
    const qty = Number($('#modalQty')?.value || 0);
    const remark = ($('#modalRemark')?.value || '').trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeBalance(productId)){ showToast("Quantity exceeds balance", true); return; }

    stockMovements.push({
      id: genId(),
      productId,
      type,
      quantity: qty,
      date: todayISO(),
      remark,
      createdAt: nowISO(),
      createdBy: who()
    });

    logChange(type === 'IN' ? "RM_STOCK_IN" : "RM_STOCK_OUT", productId, { qty, remark });

    saveRM();
    autoPushToCloud();
    closeModal();
    refreshAll();
    showToast(`RM Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}
window.openStockModal = openStockModal;

function openFGModal(fgId, type){
  if(type === 'OUT' && !canStockOut()){ showToast("Stock OUT not allowed for your role", true); return; }

  const fg = (fgProducts||[]).find(f=>f.id===fgId);
  if(!fg) return;

  $('#modalProductName').textContent = fg.name;
  $('#modalProductBalance').textContent = computeFGBalance(fgId);
  $('#modalQty').value = '';
  $('#modalRemark').value = '';
  $('#stockModal').style.display = 'flex';

  $('#modalSave').onclick = ()=>{
    const qty = Number($('#modalQty')?.value || 0);
    const remark = ($('#modalRemark')?.value || '').trim();

    if(qty <= 0){ showToast("Invalid quantity", true); return; }
    if(type==='OUT' && qty > computeFGBalance(fgId)){ showToast("Quantity exceeds FG balance", true); return; }

    fgMovements.push({
      id: genId(),
      fgId,
      type,
      qty,
      batch: fg.batch || '',
      expiry: fg.expiry || '',
      date: todayISO(),
      remark,
      createdAt: nowISO(),
      createdBy: who()
    });

    logChange(type === 'IN' ? "FG_STOCK_IN" : "FG_STOCK_OUT", fgId, { qty, remark });

    saveFGLocal();
    autoPushFGToCloud();
    closeModal();
    refreshAll();
    showToast(`FG Stock ${type==='IN'?'added':'removed'} ‚úÖ`);
  };
}
window.openFGModal = openFGModal;

function closeModal(){
  const stockModal = $('#stockModal');
  if(stockModal) stockModal.style.display = 'none';

  const appModal = $('#modal');
  if(appModal) appModal.style.display = 'none';

  modalCurrent = null;
}
window.closeModal = closeModal;

function openHistory(productId){
  const prod = (products||[]).find(p=>p.id===productId);
  if(!prod) return;

  const modal = $('#historyModal');
  if(!modal) return;

  modal.style.display='flex';
  $('#modalTitle').textContent = `RM History ‚Äî ${prod.name}`;

  const tbody = $('#modalHistoryBody');
  if(!tbody) return;
  tbody.innerHTML='';

  (stockMovements||[])
    .filter(m=>m.productId===productId)
    .slice()
    .sort((a,b)=>new Date(b.date)-new Date(a.date))
    .forEach(m=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${fmtDate(m.date)}</td>
          <td>${escapeHtml(prod.name)}</td>
          <td>${escapeHtml(m.type)}</td>
          <td>${Number(m.quantity||0)}</td>
          <td>-</td>
          <td>-</td>
          <td>${escapeHtml(m.remark||'')}</td>
        </tr>
      `);
    });
}
window.openHistory = openHistory;

function closeHistoryModal(){ const m = $('#historyModal'); if(m) m.style.display='none'; }
window.closeHistoryModal = closeHistoryModal;

function addRMProduct(){
  if(!canAdd()){ showToast("No permission to add", true); return; }

  const code = ($('#newCode')?.value || '').trim();
  const name = ($('#newName')?.value || '').trim();
  const category = ($('#newCategory')?.value || '').trim();
  const threshold = Number($('#newThreshold')?.value || 5);
  const barcode = ($('#newBarcode')?.value || '').trim();
  const groupsStr = ($('#newGroups')?.value || '').trim();
  const exclusive = !!$('#newExclusive')?.checked;

  if(!name){ showToast("Product name required", true); return; }

  const groups = groupsStr ? groupsStr.split(',').map(g=>g.trim()).filter(Boolean) : [];

  products.push({
    id: 'rm_' + genId(),
    code, name, category,
    threshold: isNaN(threshold) ? 5 : threshold,
    barcode,
    groups,
    exclusive
  });

  logChange("RM_ADD", products[products.length-1].id, { name, code });

  saveRM();
  autoPushToCloud();
  refreshAll();

  if($('#newCode')) $('#newCode').value='';
  if($('#newName')) $('#newName').value='';
  if($('#newCategory')) $('#newCategory').value='';
  if($('#newThreshold')) $('#newThreshold').value='';
  if($('#newBarcode')) $('#newBarcode').value='';
  if($('#newGroups')) $('#newGroups').value='';
  if($('#newExclusive')) $('#newExclusive').checked=false;

  showToast("RM product added ‚úÖ");
}
window.addRMProduct = addRMProduct;

function editProduct(productId){
  if(!canEdit()){ showToast("No permission to edit", true); return; }

  const prod = (products||[]).find(p => p.id === productId);
  if(!prod) return;

  const newCode = prompt("Edit product code:", prod.code || "");
  if(newCode === null) return;

  const newName = prompt("Edit product name:", prod.name || "");
  if(newName === null || !newName.trim()){ showToast("Name required", true); return; }

  const newCategory = prompt("Edit category:", prod.category || "");
  if(newCategory === null) return;

  const newThreshold = prompt("Edit threshold:", prod.threshold ?? 5);
  if(newThreshold === null || isNaN(Number(newThreshold))){ showToast("Invalid threshold", true); return; }

  const newBarcode = prompt("Edit barcode:", prod.barcode || "");
  if(newBarcode === null) return;

  const newGroupsInput = prompt("Edit groups (comma separated):", Array.isArray(prod.groups) ? prod.groups.join(', ') : '');
  if(newGroupsInput === null) return;

  const newExclusive = confirm("Exclusive to first group?");

  prod.code = String(newCode||'').trim();
  prod.name = newName.trim();
  prod.category = String(newCategory||'').trim();
  prod.threshold = Number(newThreshold);
  prod.barcode = String(newBarcode||'').trim();
  prod.groups = String(newGroupsInput || '').split(',').map(g => g.trim()).filter(Boolean);
  prod.exclusive = !!newExclusive;

  logChange("RM_EDIT", productId, { name: prod.name, code: prod.code });

  saveRM();
  autoPushToCloud();
  refreshAll();

  showToast("Product updated ‚úÖ");
}
window.editProduct = editProduct;

function deleteProduct(productId){
  if(!canDelete()){ showToast("No permission to delete", true); return; }

  const prod = (products||[]).find(p => p.id === productId);
  if(!prod) return;

  if(!confirm(`Delete "${prod.name}"?\nThis will remove all its stock history.`)) return;

  products = (products||[]).filter(p => p.id !== productId);
  stockMovements = (stockMovements||[]).filter(m => m.productId !== productId);

  logChange("RM_DELETE", productId, { name: prod.name });

  saveRM();
  autoPushToCloud();
  refreshAll();

  showToast("Product deleted ‚úÖ");
}
window.deleteProduct = deleteProduct;

/* =========================================================
   ‚úÖ DASHBOARD GROUPED (BOM)
========================================================= */
let dashboardSearchText = "";
let selectedDashboardGroup = null;
let renamedGroups = JSON.parse(localStorage.getItem('renamedGroups') || '{}');

function handleDashboardSearch(value){
  dashboardSearchText = (value || "").toLowerCase().trim();
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function clearDashboardSearch(){
  if($('#dashboardSearch')) $('#dashboardSearch').value = '';
  dashboardSearchText = '';
  selectedDashboardGroup = null;
  renderDashboardGrouped();
}
function selectDashboardGroup(groupName){
  selectedDashboardGroup = groupName;
  renderDashboardGrouped();
}
function getFGStock(groupName){
  const key = normalizeGroup(groupName);
  let total = 0;
  (fgProducts||[]).forEach(fg=>{
    if(normalizeGroup(fg.group) === key) total += computeFGBalance(fg.id);
  });
  return total;
}
function renameGroup(groupName){
  if(currentUser?.role !== 'admin'){ showToast("Only admin can rename groups", true); return; }
  const newName = prompt(`Enter new display name for "${groupName}"`, renamedGroups[groupName] || groupName);
  if(!newName) return;

  renamedGroups[groupName] = newName.trim();
  localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
  saveRenamedGroupsToCloud();
  renderDashboardGrouped();
}
function saveRenamedGroupsToCloud(){ cloudDB.ref("dashboardRenamedGroups").set(renamedGroups); }
function loadRenamedGroupsFromCloud(){
  cloudDB.ref("dashboardRenamedGroups").once("value").then(snap=>{
    if(snap.exists()){
      renamedGroups = snap.val() || {};
      localStorage.setItem('renamedGroups', JSON.stringify(renamedGroups));
      renderDashboardGrouped();
    }
  });
}

function renderDashboardGrouped(){
  const tbody = $('#dashTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  const groupsMap = {};

  (products||[]).forEach(p=>{
    if(!Array.isArray(p.groups) || !p.groups.length) return;

    p.groups.forEach(g=>{
      if(!groupsMap[g]) groupsMap[g] = [];
      if(p.exclusive && p.groups[0] !== g) return;
      groupsMap[g].push(p);
    });
  });

  const allGroups = Object.keys(groupsMap).sort((a,b)=>a.localeCompare(b));
  const search = dashboardSearchText;

  if(!allGroups.length){
    tbody.insertAdjacentHTML('beforeend', `
      <tr><td colspan="6"><b>No BOM groups found.</b> Add "Groups" to RM products (comma separated).</td></tr>
    `);
    return;
  }

  allGroups.forEach(groupName=>{
    const displayName = renamedGroups[groupName] || groupName;

    const groupProducts = groupsMap[groupName].filter(p=>{
      const nm = (p.name||'').toLowerCase();
      const gp = displayName.toLowerCase();
      return !search || nm.includes(search) || gp.includes(search);
    });

    if(!groupProducts.length) return;
    if(selectedDashboardGroup && selectedDashboardGroup !== groupName) return;

    const fgBalance = getFGStock(groupName);

    const groupRow = document.createElement('tr');
    groupRow.innerHTML = `
      <td colspan="7" style="padding:18px;cursor:pointer;background:rgba(0,0,0,0.03)"
          onclick="selectDashboardGroup('${escapeHtml(groupName)}')">
        <b>${escapeHtml(displayName).toUpperCase()}</b>
        <span style="margin-left:40px;color:green;font-weight:bold">
          FG BALANCE: ${fgBalance}
        </span>
        ${
          currentUser?.role === 'admin'
            ? `<button class="btn secondary" style="margin-left:15px;padding:6px 10px"
                 onclick="event.stopPropagation(); renameGroup('${escapeHtml(groupName)}')">
                 Rename
               </button>`
            : ''
        }
      </td>
    `;
    tbody.appendChild(groupRow);

    if(selectedDashboardGroup === groupName){
      groupProducts.forEach(p=>{
        const bal = computeBalance(p.id);
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${escapeHtml(p.code||'')}</td>
            <td style="padding-left:25px">${escapeHtml(p.name||'')}</td>
            <td class="${bal <= Number(p.threshold ?? 5) ? 'low-stock':''}">${bal}</td>
            <td>${Number(p.threshold ?? 5)}</td>
            <td>${lastMovement(p.id,'IN')}</td>
            <td>${lastMovement(p.id,'OUT')}</td>
            <td>
              <button class="btn secondary" onclick="openHistory('${p.id}')">View</button>
              <button class="btn" onclick="openStockModal('${p.id}','IN')">Add IN</button>
              <button class="btn out btn-stock-out" onclick="openStockModal('${p.id}','OUT')">Stock OUT</button>
            </td>
          </tr>
        `);
      });
    }
  });

  applyPermissions();
}
window.renderDashboardGrouped = renderDashboardGrouped;
window.handleDashboardSearch = handleDashboardSearch;
window.clearDashboardSearch = clearDashboardSearch;
window.selectDashboardGroup = selectDashboardGroup;
window.renameGroup = renameGroup;

/* =========================================================
   ‚úÖ CLOUD SYNC (SINGLE VERSION)
========================================================= */
function autoPushToCloud(){
  if(!cloudDB) return;

  const payload = {
    products: (products || []),
    stockMovements: (stockMovements || []),
    fgProducts: (fgProducts || []),
    fgMovements: (fgMovements || []),
    suppliers: (window.suppliers || []),
    bills: (JSON.parse(localStorage.getItem(KEY_BILLS) || '[]')),
    productions: (productions || []),
    deliveryNotes: (deliveryNotes || []),
    auditLog: (auditLog || []),
    updatedAt: nowISO()
  };

  cloudDB.ref(CLOUD_PATH).set(payload)
    .then(()=> console.log("‚òÅÔ∏è pushed:", CLOUD_PATH))
    .catch(err=> console.error("‚òÅÔ∏è push failed:", err));
}
window.autoPushToCloud = autoPushToCloud;

async function autoPullFromCloud(){
  if(!cloudDB) return;

  try{
    const snap = await cloudDB.ref(CLOUD_PATH).once("value");
    const data = snap.val();
    if(!data){ console.warn("‚òÅÔ∏è no data at:", CLOUD_PATH); return; }

    if(Array.isArray(data.products)) products = data.products;
    if(Array.isArray(data.stockMovements)) stockMovements = data.stockMovements;

    if(Array.isArray(data.fgProducts)) fgProducts = data.fgProducts;
    if(Array.isArray(data.fgMovements)) fgMovements = data.fgMovements;

    if(Array.isArray(data.suppliers)) window.suppliers = data.suppliers;

    if(Array.isArray(data.bills)){
      localStorage.setItem(KEY_BILLS, JSON.stringify(data.bills));
      window.savedBills = data.bills;
      BOE?.setBills?.(data.bills);
    }

    if(Array.isArray(data.productions)){
      productions = data.productions;
      window.productions = productions;
      localStorage.setItem(KEY_PROD, JSON.stringify(productions));
    }

    if(Array.isArray(data.deliveryNotes)){
      deliveryNotes = data.deliveryNotes;
      window.deliveryNotes = deliveryNotes;
      localStorage.setItem(KEY_DN, JSON.stringify(deliveryNotes));
    }

    if(Array.isArray(data.auditLog)){
      auditLog = data.auditLog;
      saveAudit();
    }

    // persist locals
    saveRM();
    saveFGLocal();
    saveSuppliers();
    saveProductions();
    saveDeliveryNotes();

    refreshAll();
    BOE?.renderTable?.();
    renderBOESupplierDropdown();

    console.log("‚òÅÔ∏è pulled:", CLOUD_PATH);
  }catch(err){
    console.error("‚òÅÔ∏è pull failed:", err);
  }
}
window.autoPullFromCloud = autoPullFromCloud;

/* =========================
   ‚úÖ REFRESH ALL (SAFE)
========================= */
let _wired = false;

function refreshAll(){
  renderProductsTable();
  renderStockIn();
  renderStockOut();
  renderCombinedHistory();

  renderFGStock();
  renderFGStockIn();
  renderFGStockOut();

  renderProductionsTable();
  renderDNTable();

  renderMainDashboard();
  renderDashboardGrouped();

  renderSuppliers();
  BOE?.renderTable?.();

  applyPermissions();
}
window.refreshAll = refreshAll;

/* =========================
   ‚úÖ INIT / EVENTS
========================= */
function wireEventsOnce(){
  if(_wired) return;
  _wired = true;

  // Sidebar collapsible
  $$('.menu-title.collapsible').forEach(m=>{
    m.addEventListener('click', ()=>{
      m.classList.toggle('open');
      m.nextElementSibling?.classList.toggle('open');
    });
  });

  // submenu navigation
  $$('.submenu').forEach(sm=>{
    sm.addEventListener('click', ()=>{
      const page = sm.dataset.page;
      const action = sm.dataset.action;
      if(page) openPage(page);
      if(action && typeof window[action]==='function') window[action]();
    });
  });

  $$('[data-page]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const page = el.dataset.page;
      openPage(page);
    });
  });

  // Searches
  $('#productSearch')?.addEventListener('input', renderProductsTable);
  $('#inSearch')?.addEventListener('input', renderStockIn);
  $('#outSearch')?.addEventListener('input', renderStockOut);
  $('#historySearch')?.addEventListener('input', renderCombinedHistory);

  $('#fgSearch')?.addEventListener('input', renderFGStock);
  $('#fgInSearch')?.addEventListener('input', renderFGStockIn);
  $('#fgOutSearch')?.addEventListener('input', renderFGStockOut);

  $('#supplierSearch')?.addEventListener('input', renderSuppliers);
  $('#addSupplierBtn')?.addEventListener('click', addSupplier);

  $('#boeSearch')?.addEventListener('input', ()=> BOE?.renderTable?.());

  $('#prodSearch')?.addEventListener('input', renderProductionsTable);
  $('#dnSearch')?.addEventListener('input', renderDNTable);

  $('#prodFG')?.addEventListener('change', renderBOM);
  $('#prodFGQty')?.addEventListener('input', renderBOM);

  // Sidebar toggle
  const sidebarToggle = $('#sidebarToggle');
  const sidebar = $('#sidebar');
  const mainWrap = $('.main');

  if(sidebarToggle && sidebar){
    sidebarToggle.addEventListener('click', ()=>{
      sidebar.classList.toggle('minimized');
      if(mainWrap) mainWrap.classList.toggle('sidebar-minimized');
      sidebarToggle.textContent = sidebar.classList.contains('minimized') ? '‚Üí' : '‚Üê';
    });
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  wireEventsOnce();

  // session restore
  const savedUser = localStorage.getItem('sms_currentUser');
  if(savedUser){
    currentUser = JSON.parse(savedUser);
    if(loginScreen) loginScreen.style.display='none';
    const app = $('.app');
    if(app) app.style.display='flex';
    applyPermissions();
    openPage('dashboardPage');
  }else{
    // show login if exists
    if(loginScreen) loginScreen.style.display='flex';
  }

  initFGVolumeSelection();
  loadRenamedGroupsFromCloud();

  BOE?.init?.();

  // Pull cloud (then refresh)
  autoPullFGFromCloud();
  autoPullFromCloud();

  refreshAll();
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
